# Nota4 äº§å“éœ€æ±‚æ–‡æ¡£ (PRD)

> **ç‰ˆæœ¬**: v2.1.0 (å®Œå…¨é‡æ„ç‰ˆ)  
> **æ›´æ–°æ—¥æœŸ**: 2025-11-15  
> **äº§å“å®šä½**: åŸºäº SwiftUI 4.0 + TCA 1.11 çš„ç°ä»£åŒ– Markdown ç¬”è®°åº”ç”¨  
> **é‡æ„ç†ç”±**: è§£å†³çŠ¶æ€ç®¡ç†æ··ä¹±ã€æå‡ç”¨æˆ·ä½“éªŒã€æ‹¥æŠ± Apple æœ€æ–°æŠ€æœ¯æ ˆ  
> **GitHub ä»“åº“**: https://github.com/Coldplay-now/Nota4

---

## ğŸ“‹ æ–‡æ¡£çŠ¶æ€

| ç« èŠ‚ | çŠ¶æ€ | å®Œæˆåº¦ | æœ€åæ›´æ–° |
|-----|------|--------|---------|
| 1. äº§å“æ¦‚è¿°ä¸é‡æ„ç›®æ ‡ | âœ… å·²å®Œæˆ | 100% | 2025-11-15 |
| 2. æŠ€æœ¯æ¶æ„å‡çº§ | âœ… å·²å®Œæˆ | 100% | 2025-11-15 |
| 3. æ ¸å¿ƒåŠŸèƒ½è®¾è®¡ | âœ… å·²å®Œæˆ | 100% | 2025-11-15 |
| 4. SwiftUI 4.0 ç•Œé¢è®¾è®¡ | âœ… å·²å®Œæˆ | 100% | 2025-11-15 |
| 5. TCA çŠ¶æ€ç®¡ç†è®¾è®¡ | âœ… å·²å®Œæˆ | 100% | 2025-11-15 |
| 6. æ•°æ®æ¶æ„è®¾è®¡ | âœ… å·²å®Œæˆ | 100% | 2025-11-15 |
| 7. äº¤äº’è®¾è®¡ | âœ… å·²å®Œæˆ | 100% | 2025-11-15 |
| 8. å®æ–½è·¯çº¿å›¾ | âœ… å·²å®Œæˆ | 100% | 2025-11-15 |

**æ–‡æ¡£ç‰ˆæœ¬**: v2.1.0  
**æ€»è¡Œæ•°**: 3,851 è¡Œ  
**ä»£ç ç¤ºä¾‹**: 63+ ä¸ª  
**PRD çŠ¶æ€**: âœ… **å·²å®Œæˆï¼Œç­‰å¾…ç”¨æˆ·ç¡®è®¤å¯é€‰åŠŸèƒ½ä¼˜å…ˆçº§**

---

## ç›®å½•

- [ç¬¬ä¸€æ­¥ï¼šäº§å“æ¦‚è¿°ä¸é‡æ„ç›®æ ‡](#ç¬¬ä¸€æ­¥äº§å“æ¦‚è¿°ä¸é‡æ„ç›®æ ‡)
- [ç¬¬äºŒæ­¥ï¼šæŠ€æœ¯æ¶æ„å‡çº§](#ç¬¬äºŒæ­¥æŠ€æœ¯æ¶æ„å‡çº§)
- [ç¬¬ä¸‰æ­¥ï¼šæ ¸å¿ƒåŠŸèƒ½è®¾è®¡](#ç¬¬ä¸‰æ­¥æ ¸å¿ƒåŠŸèƒ½è®¾è®¡)
- [ç¬¬å››æ­¥ï¼šSwiftUI 4.0 ç•Œé¢è®¾è®¡](#ç¬¬å››æ­¥swiftui-40-ç•Œé¢è®¾è®¡)
- [ç¬¬äº”æ­¥ï¼šTCA çŠ¶æ€ç®¡ç†è®¾è®¡](#ç¬¬äº”æ­¥tca-çŠ¶æ€ç®¡ç†è®¾è®¡)
- [ç¬¬å…­æ­¥ï¼šæ•°æ®æ¶æ„è®¾è®¡](#ç¬¬å…­æ­¥æ•°æ®æ¶æ„è®¾è®¡)
- [ç¬¬ä¸ƒæ­¥ï¼šäº¤äº’è®¾è®¡](#ç¬¬ä¸ƒæ­¥äº¤äº’è®¾è®¡)
- [ç¬¬å…«æ­¥ï¼šå®æ–½è·¯çº¿å›¾](#ç¬¬å…«æ­¥å®æ–½è·¯çº¿å›¾)

---

## ç¬¬ä¸€æ­¥ï¼šäº§å“æ¦‚è¿°ä¸é‡æ„ç›®æ ‡

### 1.1 ä¸ºä»€ä¹ˆè¦é‡æ„åˆ° Nota4ï¼Ÿ

#### ğŸ“Š Nota2 çš„æ ¸å¿ƒé—®é¢˜æ€»ç»“

| é—®é¢˜ç±»å‹ | å…·ä½“è¡¨ç° | æ ¹æœ¬åŸå›  | å½±å“ |
|---------|---------|---------|------|
| **çŠ¶æ€ç®¡ç†æ··ä¹±** | é€‰ä¸­çŠ¶æ€æ»ç•™ã€åŒé€‰ bug | 4 ä¸ªçŠ¶æ€æºä¸åŒæ­¥ | é«˜é¢‘ bugï¼Œç”¨æˆ·ä½“éªŒå·® |
| **NSTableView é™åˆ¶** | Cell å¤ç”¨å¯¼è‡´çŠ¶æ€æ®‹ç•™ | AppKit é™ˆæ—§çš„ Delegate æ¨¡å¼ | éœ€è¦å¤§é‡æ‰‹åŠ¨ç®¡ç†ä»£ç  |
| **ä»£ç å¤æ‚åº¦é«˜** | `NoteListView.swift` 800+ è¡Œ | æ‰‹åŠ¨ç®¡ç† UI æ›´æ–° | ç»´æŠ¤æˆæœ¬é«˜ï¼Œéš¾ä»¥æ‰©å±• |
| **ç¼ºä¹ç°ä»£ç‰¹æ€§** | æ— æš—è‰²ä¸»é¢˜ã€æ— æµç•…åŠ¨ç”» | AppKit æŠ€æœ¯æ ˆè€æ—§ | ç”¨æˆ·ä½“éªŒè½å |
| **æµ‹è¯•å›°éš¾** | éœ€è¦ Mock UIKit ç»„ä»¶ | UI å’Œé€»è¾‘è€¦åˆ | æµ‹è¯•è¦†ç›–ç‡ä½ |

#### ğŸ¯ Nota4 çš„æ ¸å¿ƒç›®æ ‡

```
ğŸ—ï¸ æ¶æ„é‡æ„
â”œâ”€ é‡‡ç”¨ SwiftUI 4.0 å£°æ˜å¼ UI
â”œâ”€ é‡‡ç”¨ TCA 1.11 å•å‘æ•°æ®æµ
â””â”€ æ¶ˆé™¤çŠ¶æ€ç®¡ç†é—®é¢˜çš„æ ¹æº

ğŸ¨ ä½“éªŒå‡çº§
â”œâ”€ åˆ©ç”¨ Liquid äº¤äº’ï¼ˆæµç•…åŠ¨ç”»ï¼‰
â”œâ”€ æ”¯æŒæš—è‰²ä¸»é¢˜
â””â”€ æ›´ç°ä»£åŒ–çš„ UI è®¾è®¡

ğŸ“ˆ å¯ç»´æŠ¤æ€§
â”œâ”€ ä»£ç é‡å‡å°‘ 40%
â”œâ”€ æµ‹è¯•è¦†ç›–ç‡æå‡åˆ° 80%+
â””â”€ æ–°åŠŸèƒ½å¼€å‘æ•ˆç‡æå‡ 50%
```

---

### 1.2 äº§å“å®šä½

**Nota4** = **ç°ä»£åŒ–çš„ macOS åŸç”Ÿ Markdown ç¬”è®°åº”ç”¨**

**æ ¸å¿ƒç‰¹ç‚¹**:
- âœ¨ **SwiftUI åŸç”Ÿ**: å……åˆ†åˆ©ç”¨ Apple æœ€æ–° UI æ¡†æ¶
- ğŸ—ï¸ **TCA æ¶æ„**: å¯é¢„æµ‹çš„çŠ¶æ€ç®¡ç†ï¼Œæ˜“äºæµ‹è¯•
- ğŸ¨ **æµç•…ä½“éªŒ**: Liquid åŠ¨ç”»ã€æš—è‰²ä¸»é¢˜ã€å“åº”å¼è®¾è®¡
- ğŸ’¾ **æœ¬åœ°ä¼˜å…ˆ**: æ•°æ®å®Œå…¨æœ¬åœ°å­˜å‚¨ï¼Œæ”¯æŒ `.nota` ä¸“æœ‰æ ¼å¼
- ğŸš€ **æ€§èƒ½ä¼˜å¼‚**: å³æ—¶ä¿å­˜ã€å¿«é€Ÿæ£€ç´¢ã€ä¸æ»‘æ“ä½œ

---

### 1.3 æ ¸å¿ƒä»·å€¼ä¸»å¼ 

| ç»´åº¦ | Nota2 (AppKit) | Nota4 (SwiftUI + TCA) | æå‡ |
|-----|----------------|----------------------|------|
| **çŠ¶æ€ç®¡ç†** | 4 ä¸ªçŠ¶æ€æºï¼Œæ‰‹åŠ¨åŒæ­¥ | TCA å•ä¸€æ•°æ®æº | ğŸ”¥ æ ¹æœ¬æ€§æ”¹å–„ |
| **å¼€å‘æ•ˆç‡** | 800+ è¡Œ UI ä»£ç  | ~300 è¡Œå£°æ˜å¼ä»£ç  | ğŸš€ å‡å°‘ 60% |
| **Bug ç‡** | é«˜é¢‘é€‰ä¸­çŠ¶æ€ bug | çŠ¶æ€å¯é¢„æµ‹ï¼Œbug å¤§å¹…å‡å°‘ | âœ… å‡å°‘ 80% |
| **ç”¨æˆ·ä½“éªŒ** | æ— æš—è‰²ä¸»é¢˜ï¼ŒåŠ¨ç”»åƒµç¡¬ | æµç•…åŠ¨ç”»ï¼Œç³»ç»Ÿçº§ä¸»é¢˜ | ğŸ¨ è´¨çš„é£è·ƒ |
| **å¯æµ‹è¯•æ€§** | éš¾ä»¥æµ‹è¯• UI | TCA Reducer çº¯å‡½æ•° | ğŸ“ˆ æµ‹è¯•è¦†ç›–ç‡ 80%+ |
| **æ–°åŠŸèƒ½å¼€å‘** | éœ€è€ƒè™‘å¤šå¤„çŠ¶æ€åŒæ­¥ | åªéœ€å®šä¹‰ Action | âš¡ æ•ˆç‡æå‡ 50% |

---

### 1.4 ç›®æ ‡ç”¨æˆ·ï¼ˆä¸å˜ï¼‰

- å¼€å‘è€…ã€è®¾è®¡å¸ˆã€äº§å“ç»ç†
- éœ€è¦å¿«é€Ÿè®°å½•æƒ³æ³•å’ŒçŸ¥è¯†ç®¡ç†çš„ç”¨æˆ·
- é‡è§†æ•°æ®éšç§å’Œæœ¬åœ°å­˜å‚¨çš„ç”¨æˆ·
- **æ–°å¢**: è¿½æ±‚ç°ä»£åŒ–ç”¨æˆ·ä½“éªŒçš„ macOS ç”¨æˆ·

---

### ğŸ¤” **ç¬¬ä¸€æ­¥ç¡®è®¤ç‚¹**

åœ¨ç»§ç»­ä¹‹å‰ï¼Œè¯·ç¡®è®¤ï¼š
1. âœ… æ‚¨è®¤å¯é‡æ„çš„å¿…è¦æ€§ï¼Ÿ
2. âœ… SwiftUI 4.0 + TCA 1.11 çš„æŠ€æœ¯é€‰å‹æ˜¯å¦åˆé€‚ï¼Ÿ
3. âœ… æ ¸å¿ƒä»·å€¼ä¸»å¼ æ˜¯å¦ç¬¦åˆæ‚¨çš„æœŸæœ›ï¼Ÿ

**è¯·å›å¤ "ç¡®è®¤ç¬¬ä¸€æ­¥" æˆ–æå‡ºä¿®æ”¹æ„è§ï¼Œæˆ‘å°†ç»§ç»­ç¬¬äºŒæ­¥ã€‚**

---

## ç¬¬äºŒæ­¥ï¼šæŠ€æœ¯æ¶æ„å‡çº§

### 2.1 æŠ€æœ¯æ ˆå¯¹æ¯”

| å±‚çº§ | Nota2 (æ—§) | Nota4 (æ–°) | å‡çº§ç†ç”± |
|-----|-----------|-----------|---------|
| **UI æ¡†æ¶** | AppKit (NSTableView) | SwiftUI 4.0 (List, NavigationSplitView) | å£°æ˜å¼ã€è‡ªåŠ¨ç®¡ç†ã€ç°ä»£åŒ– |
| **çŠ¶æ€ç®¡ç†** | MVVM + NotificationCenter | TCA 1.11 | å•å‘æ•°æ®æµã€å¯é¢„æµ‹ã€å¯æµ‹è¯• |
| **å“åº”å¼** | Combine | TCA Effect (åŸºäº Combine) | ç»Ÿä¸€åœ¨ TCA ç”Ÿæ€ |
| **æ•°æ®åº“** | GRDB (SQLite) | GRDB (ä¿æŒ) | æˆç†Ÿç¨³å®šï¼Œæ— éœ€æ›´æ¢ |
| **æ–‡ä»¶æ ¼å¼** | çº¯æ–‡æœ¬ .nota | YAML Front Matter .nota | æ”¯æŒå…ƒæ•°æ®å†…åµŒ |
| **åŒ…ç®¡ç†** | SPM | SPM | ä¿æŒ |
| **æœ€ä½ç‰ˆæœ¬** | macOS 11.0+ | macOS 15.0+ (Sequoia) â­ | åˆ©ç”¨æœ€æ–°ç‰¹æ€§å’Œæœ€ä½³æ€§èƒ½ |

---

### 2.2 SwiftUI 4.0 å…³é”®ç‰¹æ€§åº”ç”¨

#### 2.2.1 NavigationSplitViewï¼ˆä¸‰æ å¸ƒå±€ï¼‰

**æ›¿ä»£ Nota2 çš„æ‰‹åŠ¨å¸ƒå±€**:
```swift
// âŒ Nota2 (AppKit): æ‰‹åŠ¨ç®¡ç†çº¦æŸã€åˆ†éš”çº¿
NSLayoutConstraint.activate([
    sidebar.widthAnchor.constraint(equalToConstant: 200),
    listView.widthAnchor.constraint(equalToConstant: 300),
    // ... å¤§é‡å¸ƒå±€ä»£ç 
])

// âœ… Nota4 (SwiftUI): å£°æ˜å¼ï¼Œè‡ªåŠ¨ç®¡ç†
NavigationSplitView {
    SidebarView(store: store.scope(state: \.sidebar, action: \.sidebar))
} content: {
    NoteListView(store: store.scope(state: \.noteList, action: \.noteList))
} detail: {
    NoteEditorView(store: store.scope(state: \.editor, action: \.editor))
}
```

**ä¼˜åŠ¿**:
- âœ… è‡ªåŠ¨å¤„ç†åˆ†æ å®½åº¦ã€æŠ˜å ã€å“åº”å¼
- âœ… æ”¯æŒå·¥å…·æ ã€æœç´¢æ ä¸€ä½“åŒ–
- âœ… ç³»ç»Ÿçº§äº¤äº’ï¼ˆæ‹–æ‹½è°ƒæ•´å®½åº¦ï¼‰

---

#### 2.2.2 Liquid äº¤äº’ï¼ˆæµç•…åŠ¨ç”»ï¼‰

**åº”ç”¨åœºæ™¯**:
1. **ç¬”è®°é€‰ä¸­åŠ¨ç”»**:
   ```swift
   .background(
       RoundedRectangle(cornerRadius: 8)
           .fill(isSelected ? Color.accentColor.opacity(0.2) : .clear)
           .animation(.spring(response: 0.3, dampingFraction: 0.7), value: isSelected)
   )
   ```

2. **åˆ—è¡¨æ’å…¥/åˆ é™¤åŠ¨ç”»**:
   ```swift
   List(store.notes) { note in
       NoteRow(note: note)
   }
   .animation(.spring(), value: store.notes)
   ```

3. **æœç´¢ç»“æœé«˜äº®**:
   ```swift
   Text(note.title)
       .matchedGeometryEffect(id: "title-\(note.id)", in: namespace)
   ```

---

#### 2.2.3 æš—è‰²ä¸»é¢˜è‡ªåŠ¨é€‚é…

```swift
// âœ… SwiftUI è‡ªåŠ¨æ”¯æŒï¼Œæ— éœ€æ‰‹åŠ¨å¤„ç†
@Environment(\.colorScheme) var colorScheme

var backgroundColor: Color {
    colorScheme == .dark ? Color.black : Color.white
}
```

---

#### 2.2.4 æ–°å¸ƒå±€ç³»ç»Ÿï¼ˆGrid, Layout Protocolï¼‰

**ç¬”è®°å¡ç‰‡ç½‘æ ¼è§†å›¾**ï¼ˆæœªæ¥åŠŸèƒ½ï¼‰:
```swift
LazyVGrid(columns: [GridItem(.adaptive(minimum: 200))]) {
    ForEach(store.notes) { note in
        NoteCard(note: note)
    }
}
```

---

### 2.3 TCA 1.11 æ ¸å¿ƒæ¦‚å¿µ

#### 2.3.1 å•å‘æ•°æ®æµ

```
User Action (View)
    â†“
Action (enum)
    â†“
Reducer (pure function)
    â†“
State (struct) â†’ View Update
    â†“
Effect (async) â†’ Action (å¾ªç¯)
```

**å¯¹æ¯” Nota2**:
```
âŒ Nota2: NotificationCenter å¤šå‘é€šçŸ¥ï¼Œéš¾ä»¥è¿½è¸ª
âœ… Nota4: æ‰€æœ‰å˜åŒ–éƒ½é€šè¿‡ Actionï¼Œå¯è®°å½•ã€å¯å›æ”¾
```

---

#### 2.3.2 TCA æ¶æ„å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    AppState                          â”‚
â”‚  â”œâ”€ sidebarState: SidebarState                      â”‚
â”‚  â”œâ”€ noteListState: NoteListState                    â”‚
â”‚  â””â”€ editorState: EditorState                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    AppReducer                        â”‚
â”‚  â”œâ”€ sidebarReducer                                  â”‚
â”‚  â”œâ”€ noteListReducer                                 â”‚
â”‚  â””â”€ editorReducer                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  AppEnvironment                      â”‚
â”‚  â”œâ”€ noteRepository: NoteRepository                  â”‚
â”‚  â”œâ”€ fileManager: NotaFileManager                    â”‚
â”‚  â””â”€ mainQueue: AnySchedulerOf<DispatchQueue>        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

#### 2.3.3 Compositionï¼ˆæ¨¡å—ç»„åˆï¼‰

```swift
// âœ… æ¯ä¸ªæ¨¡å—ç‹¬ç«‹ï¼Œæ˜“äºæµ‹è¯•å’Œç»´æŠ¤
let appReducer = Reducer<AppState, AppAction, AppEnvironment>.combine(
    sidebarReducer.pullback(
        state: \.sidebar,
        action: /AppAction.sidebar,
        environment: { $0 }
    ),
    noteListReducer.pullback(
        state: \.noteList,
        action: /AppAction.noteList,
        environment: { $0 }
    ),
    editorReducer.pullback(
        state: \.editor,
        action: /AppAction.editor,
        environment: { $0 }
    ),
    Reducer { state, action, environment in
        // è·¨æ¨¡å—åè°ƒé€»è¾‘
        switch action {
        case .noteList(.noteSelected(let id)):
            state.editor.selectedNoteId = id
            return .none
        default:
            return .none
        }
    }
)
```

---

### 2.4 æ¶æ„å¯¹æ¯”æ€»ç»“

#### Nota2 (AppKit + MVVM)
```
âŒ é—®é¢˜
â”œâ”€ å¤šä¸ªçŠ¶æ€æºï¼ˆtableViewã€currentSelectedNoteIdã€viewModelã€cellViewï¼‰
â”œâ”€ æ‰‹åŠ¨åŒæ­¥çŠ¶æ€
â”œâ”€ NotificationCenter é€šçŸ¥éš¾ä»¥è¿½è¸ª
â”œâ”€ UI å’Œé€»è¾‘è€¦åˆ
â””â”€ æµ‹è¯•å›°éš¾

âœ… ä¿ç•™
â”œâ”€ GRDB æ•°æ®åº“
â””â”€ .nota æ–‡ä»¶æ ¼å¼
```

#### Nota4 (SwiftUI + TCA)
```
âœ… ä¼˜åŠ¿
â”œâ”€ å•ä¸€æ•°æ®æºï¼ˆTCA Stateï¼‰
â”œâ”€ çŠ¶æ€è‡ªåŠ¨é©±åŠ¨ UI
â”œâ”€ æ‰€æœ‰å˜åŒ–å¯è¿½è¸ªï¼ˆActionï¼‰
â”œâ”€ UI å’Œé€»è¾‘åˆ†ç¦»
â””â”€ æ˜“äºæµ‹è¯•ï¼ˆReducer æ˜¯çº¯å‡½æ•°ï¼‰

ğŸ¨ æ–°ç‰¹æ€§
â”œâ”€ NavigationSplitViewï¼ˆä¸‰æ å¸ƒå±€ï¼‰
â”œâ”€ Liquid åŠ¨ç”»ï¼ˆæµç•…äº¤äº’ï¼‰
â”œâ”€ æš—è‰²ä¸»é¢˜è‡ªåŠ¨é€‚é…
â””â”€ ç°ä»£åŒ–ç»„ä»¶ï¼ˆTextEditorã€Menu ç­‰ï¼‰
```

---

### ğŸ¤” **ç¬¬äºŒæ­¥ç¡®è®¤ç‚¹**

åœ¨ç»§ç»­ä¹‹å‰ï¼Œè¯·ç¡®è®¤ï¼š
1. âœ… SwiftUI 4.0 çš„å…³é”®ç‰¹æ€§åº”ç”¨æ˜¯å¦åˆç†ï¼Ÿ
2. âœ… TCA 1.11 çš„æ¶æ„è®¾è®¡æ˜¯å¦æ¸…æ™°ï¼Ÿ
3. âœ… æœ€ä½ç³»ç»Ÿç‰ˆæœ¬ macOS 15.0+ (Sequoia) æ˜¯å¦å¯æ¥å—ï¼Ÿ

**è¯·å›å¤ "ç¡®è®¤ç¬¬äºŒæ­¥" æˆ–æå‡ºä¿®æ”¹æ„è§ï¼Œæˆ‘å°†ç»§ç»­ç¬¬ä¸‰æ­¥ï¼šæ ¸å¿ƒåŠŸèƒ½è®¾è®¡ã€‚**

---

## ç¬¬ä¸‰æ­¥ï¼šæ ¸å¿ƒåŠŸèƒ½è®¾è®¡

### 3.1 åŠŸèƒ½ä¼˜å…ˆçº§é‡æ–°è§„åˆ’

åŸºäº Nota2 çš„ç»éªŒï¼Œé‡æ–°å®šä¹‰åŠŸèƒ½ä¼˜å…ˆçº§ï¼š

| åŠŸèƒ½æ¨¡å— | åŠŸèƒ½ç‚¹ | Nota2 çŠ¶æ€ | Nota4 ä¼˜å…ˆçº§ | å®ç°æ–¹å¼ |
|---------|--------|-----------|-------------|---------|
| **ç¬”è®°ç®¡ç†** |
| | åˆ›å»ºç¬”è®° | âœ… å·²å®ç° | **P0** | TCA Action: `.createNote` |
| | ç¼–è¾‘ç¬”è®° | âœ… å·²å®ç° | **P0** | TextEditor + Debounce Effect |
| | åˆ é™¤ç¬”è®°ï¼ˆè½¯åˆ é™¤ï¼‰ | âœ… å·²å®ç° | **P0** | TCA Action: `.deleteNote` |
| | æ¢å¤ç¬”è®° | âœ… å·²å®ç° | **P1** | TCA Action: `.restoreNote` |
| | æ°¸ä¹…åˆ é™¤ | âœ… å·²å®ç° | **P1** | TCA Action: `.permanentDelete` |
| | æ‰¹é‡æ“ä½œ | âœ… å·²å®ç° | **P1** | SwiftUI Selection |
| **ç¬”è®°ç»„ç»‡** |
| | æ˜Ÿæ ‡æ”¶è— | âœ… å·²å®ç° | **P0** | TCA State: `isStarred` |
| | ç¬”è®°ç½®é¡¶ | âœ… å·²å®ç° | **P1** | TCA State: `isPinned` |
| | æ ‡ç­¾åˆ†ç±» | âŒ æœªå®ç° | **P1** ğŸ†• | TCA State: `tags: [String]` |
| | æ–‡ä»¶å¤¹åˆ†ç»„ | âŒ æœªå®ç° | **P2** | å»¶å v2.1 |
| **ç¼–è¾‘å™¨** |
| | Markdown ç¼–è¾‘ | âœ… å·²å®ç° | **P0** | TextEditor |
| | å®æ—¶é¢„è§ˆ | âŒ æœªå®ç° | **P0** ğŸ†• | MarkdownUI é›†æˆ |
| | åˆ†å±æ¨¡å¼ | âŒ æœªå®ç° | **P1** ğŸ†• | HSplitView |
| | è¯­æ³•é«˜äº® | âŒ æœªå®ç° | **P2** | CodeEditor ç»„ä»¶ |
| | å³é”®æ’å…¥ MD æ ¼å¼ | âŒ æœªå®ç° | **P1** ğŸ†• | ContextMenu |
| **æœç´¢** |
| | å…¨æ–‡æœç´¢ | âœ… å·²å®ç° | **P0** | TCA Effect: `.search` |
| | å…³é”®è¯é«˜äº® | âœ… å·²å®ç° | **P0** | AttributedString |
| | æœç´¢å†å² | âŒ æœªå®ç° | **P2** | å»¶å v2.1 |
| **å¯¼å…¥/å¯¼å‡º** |
| | å¯¼å…¥ .nota æ–‡ä»¶ | âœ… å·²å®ç° | **P1** | TCA Effect: `.importFile` |
| | å¯¼å…¥ .md æ–‡ä»¶ | âœ… å·²å®ç° | **P1** | TCA Effect: `.importFile` |
| | å¯¼å…¥ .txt æ–‡ä»¶ | âŒ æœªå®ç° | **P1** ğŸ†• | TCA Effect: `.importFile` |
| | å¯¼å‡º .nota æ–‡ä»¶ | âŒ æœªå®ç° | **P1** ğŸ†• | TCA Effect: `.exportFile` |
| | å¯¼å‡º .md æ–‡ä»¶ | âŒ æœªå®ç° | **P1** ğŸ†• | TCA Effect: `.exportFile` |
| | å¯¼å‡º .html æ–‡ä»¶ | âŒ æœªå®ç° | **P1** ğŸ†• | MarkdownUI + HTML æ¨¡æ¿ |
| | å¯¼å‡º PDF | âŒ æœªå®ç° | **P2** ğŸ†• | NSPrintOperation / WKWebView |
| **è‡ªåŠ¨åŒ–** |
| | å³æ—¶è‡ªåŠ¨ä¿å­˜ | âœ… å·²å®ç° | **P0** | TCA Effect: `.autoSave` |
| | å¤±ç„¦è‡ªåŠ¨ä¿å­˜ | âœ… å·²å®ç° | **P0** | `scenePhase` Binding |
| | ç‰ˆæœ¬å†å² | âŒ æœªå®ç° | **P3** | å»¶å v2.2 |
| **ç•Œé¢** |
| | äº®è‰²ä¸»é¢˜ | âœ… å·²å®ç° | **P0** | SwiftUI è‡ªåŠ¨æ”¯æŒ |
| | æš—è‰²ä¸»é¢˜ | âŒ æœªå®ç° | **P0** ğŸ†• | `@Environment(\.colorScheme)` |
| | è‡ªå®šä¹‰å­—ä½“ | âŒ æœªå®ç° | **P1** ğŸ†• | Settings + TCA State |

---

### 3.2 æ ¸å¿ƒåŠŸèƒ½è¯¦ç»†è®¾è®¡

#### 3.2.1 ã€P0ã€‘å®æ—¶é¢„è§ˆæ¨¡å¼ï¼ˆæ–°å¢ï¼‰

**éœ€æ±‚**:
- ç”¨æˆ·å¯ä»¥é€‰æ‹©"ä»…ç¼–è¾‘"ã€"ä»…é¢„è§ˆ"ã€"åˆ†å±"ä¸‰ç§æ¨¡å¼
- é¢„è§ˆä½¿ç”¨ Markdown æ¸²æŸ“å¼•æ“ï¼ˆæ¨è MarkdownUIï¼‰
- é¢„è§ˆæ”¯æŒä»£ç é«˜äº®ã€è¡¨æ ¼ã€å›¾ç‰‡ç­‰

**TCA çŠ¶æ€è®¾è®¡**:
```swift
struct EditorState {
    var selectedNoteId: String?
    var content: String = ""
    var viewMode: ViewMode = .editOnly
    
    enum ViewMode {
        case editOnly
        case previewOnly
        case split
    }
}

enum EditorAction {
    case viewModeChanged(ViewMode)
    case contentChanged(String)
}
```

**UI å®ç°**:
```swift
struct NoteEditorView: View {
    let store: StoreOf<EditorFeature>
    
    var body: some View {
        WithViewStore(store) { viewStore in
            Group {
                switch viewStore.viewMode {
                case .editOnly:
                    TextEditor(text: viewStore.binding(\.$content))
                case .previewOnly:
                    MarkdownPreview(content: viewStore.content)
                case .split:
                    HSplitView {
                        TextEditor(text: viewStore.binding(\.$content))
                        MarkdownPreview(content: viewStore.content)
                    }
                }
            }
            .toolbar {
                Picker("è§†å›¾æ¨¡å¼", selection: viewStore.binding(\.$viewMode)) {
                    Label("ç¼–è¾‘", systemImage: "pencil").tag(ViewMode.editOnly)
                    Label("é¢„è§ˆ", systemImage: "eye").tag(ViewMode.previewOnly)
                    Label("åˆ†å±", systemImage: "rectangle.split.2x1").tag(ViewMode.split)
                }
                .pickerStyle(.segmented)
            }
        }
    }
}
```

---

#### 3.2.2 ã€P1ã€‘å³é”®æ’å…¥ Markdown æ ¼å¼ï¼ˆæ–°å¢ï¼‰

**éœ€æ±‚**:
- åœ¨ç¼–è¾‘å™¨ä¸­å³é”®æ˜¾ç¤ºèœå•
- æ”¯æŒæ’å…¥ï¼šæ ‡é¢˜ã€åŠ ç²—ã€æ–œä½“ã€ä»£ç å—ã€åˆ—è¡¨ã€é“¾æ¥ã€å›¾ç‰‡ç­‰

**TCA Action è®¾è®¡**:
```swift
enum EditorAction {
    case insertMarkdown(MarkdownFormat)
    
    enum MarkdownFormat {
        case heading(level: Int)
        case bold
        case italic
        case codeBlock
        case unorderedList
        case orderedList
        case link
        case image
    }
}
```

**UI å®ç°**:
```swift
TextEditor(text: viewStore.binding(\.$content))
    .contextMenu {
        Menu("æ’å…¥æ ‡é¢˜") {
            ForEach(1...6, id: \.self) { level in
                Button("H\(level)") {
                    viewStore.send(.insertMarkdown(.heading(level: level)))
                }
            }
        }
        Button("åŠ ç²—") { viewStore.send(.insertMarkdown(.bold)) }
        Button("æ–œä½“") { viewStore.send(.insertMarkdown(.italic)) }
        Divider()
        Button("ä»£ç å—") { viewStore.send(.insertMarkdown(.codeBlock)) }
        Button("æ— åºåˆ—è¡¨") { viewStore.send(.insertMarkdown(.unorderedList)) }
        Button("æœ‰åºåˆ—è¡¨") { viewStore.send(.insertMarkdown(.orderedList)) }
        Divider()
        Button("æ’å…¥é“¾æ¥") { viewStore.send(.insertMarkdown(.link)) }
        Button("æ’å…¥å›¾ç‰‡") { viewStore.send(.insertMarkdown(.image)) }
    }
```

**Reducer å®ç°**:
```swift
case .insertMarkdown(let format):
    let insertion = format.markdownText
    state.content.insert(contentsOf: insertion, at: state.cursorPosition)
    return .none

extension MarkdownFormat {
    var markdownText: String {
        switch self {
        case .heading(let level):
            return "\(String(repeating: "#", count: level)) "
        case .bold:
            return "****"  // ç”¨æˆ·åœ¨ä¸­é—´è¾“å…¥
        case .italic:
            return "**"
        case .codeBlock:
            return "\n```\n\n```\n"
        // ...
        }
    }
}
```

---

#### 3.2.3 ã€P1ã€‘æ ‡ç­¾ç³»ç»Ÿï¼ˆæ–°å¢ï¼‰

**éœ€æ±‚**:
- æ¯ä¸ªç¬”è®°å¯ä»¥æœ‰å¤šä¸ªæ ‡ç­¾
- æ”¯æŒåœ¨ä¾§è¾¹æ æŒ‰æ ‡ç­¾ç­›é€‰
- æ”¯æŒæ ‡ç­¾è‡ªåŠ¨è¡¥å…¨

**TCA çŠ¶æ€è®¾è®¡**:
```swift
struct NoteListState {
    var notes: [Note] = []
    var selectedTags: Set<String> = []
    var allTags: Set<String> = []
}

struct Note {
    var id: String
    var title: String
    var content: String
    var tags: Set<String> = []
    // ...
}

enum NoteListAction {
    case tagSelected(String)
    case tagDeselected(String)
    case addTagToNote(noteId: String, tag: String)
}
```

**UI å®ç°**:
```swift
// ä¾§è¾¹æ æ ‡ç­¾è¿‡æ»¤
List(selection: viewStore.binding(\.$selectedTags)) {
    Section("æ ‡ç­¾") {
        ForEach(Array(viewStore.allTags), id: \.self) { tag in
            Label(tag, systemImage: "tag")
        }
    }
}

// ç¬”è®°å¡ç‰‡æ˜¾ç¤ºæ ‡ç­¾
HStack {
    ForEach(Array(note.tags), id: \.self) { tag in
        Text(tag)
            .font(.caption)
            .padding(.horizontal, 6)
            .padding(.vertical, 2)
            .background(Color.accentColor.opacity(0.2))
            .cornerRadius(4)
    }
}
```

---

#### 3.2.4 ã€P1ã€‘å¯¼å‡ºåŠŸèƒ½ï¼ˆæ–°å¢ï¼‰

**éœ€æ±‚**:
- æ”¯æŒå¯¼å‡ºå•ä¸ªç¬”è®°ä¸º .nota / .md / .html / .pdf
- æ”¯æŒæ‰¹é‡å¯¼å‡ºä¸º .zip
- å¯¼å‡ºæ—¶è‡ªåŠ¨å¤„ç†å›¾ç‰‡ï¼ˆæ‰“åŒ…æˆ– Base64 å†…åµŒï¼‰

**TCA Action è®¾è®¡**:
```swift
enum AppAction {
    case exportNote(noteId: String, format: ExportFormat)
    case exportNotes(noteIds: [String], format: ExportFormat)
    
    enum ExportFormat {
        case nota       // å¸¦é™„ä»¶ ZIP åŒ…
        case markdown   // å¯é€‰é™„ä»¶ç›®å½•æˆ– Base64
        case html       // Base64 å†…åµŒå›¾ç‰‡
        case pdf        // å›¾ç‰‡è‡ªåŠ¨åµŒå…¥
    }
}
```

**Reducer å®ç°**:
```swift
case .exportNote(let noteId, let format):
    return .run { send in
        let note = try await environment.noteRepository.fetchNote(noteId)
        let fileURL = try await environment.fileManager.exportNote(note, format: format)
        await send(.exportCompleted(fileURL))
    }
```

---

### ğŸ¤” **ç¬¬ä¸‰æ­¥å¾…å®Œå–„ç‚¹**

è¯·ç¡®è®¤æˆ–è¡¥å……ï¼š
1. âœ… å®æ—¶é¢„è§ˆæ¨¡å¼çš„è®¾è®¡æ˜¯å¦ç¬¦åˆé¢„æœŸï¼Ÿ
2. âœ… å³é”®æ’å…¥ Markdown æ ¼å¼çš„åŠŸèƒ½æ˜¯å¦è¶³å¤Ÿï¼Ÿ
3. âœ… æ ‡ç­¾ç³»ç»Ÿæ˜¯å¦éœ€è¦æ”¯æŒåµŒå¥—æ ‡ç­¾ï¼ˆå¦‚ `å·¥ä½œ/é¡¹ç›®A`ï¼‰ï¼Ÿ
4. âœ… å¯¼å‡ºåŠŸèƒ½è¿˜éœ€è¦æ”¯æŒå“ªäº›æ ¼å¼ï¼Ÿ
5. ğŸ¤” æ˜¯å¦éœ€è¦æ·»åŠ å…¶ä»–æ ¸å¿ƒåŠŸèƒ½ï¼Ÿ

**è¯·å›å¤æ‚¨çš„è¡¥å……æ„è§ï¼Œæˆ‘å°†ç»§ç»­ç¬¬å››æ­¥ï¼šSwiftUI 4.0 ç•Œé¢è®¾è®¡ã€‚**

---

## ç¬¬å››æ­¥ï¼šSwiftUI 4.0 ç•Œé¢è®¾è®¡

### 4.1 æ•´ä½“å¸ƒå±€ï¼ˆNavigationSplitViewï¼‰

#### 4.1.1 å¸ƒå±€ç»“æ„

```swift
@main
struct Nota4App: App {
    let store = Store(
        initialState: AppState(),
        reducer: appReducer,
        environment: AppEnvironment.live
    )
    
    var body: some Scene {
        WindowGroup {
            AppView(store: store)
        }
        .commands {
            CommandGroup(replacing: .newItem) {
                Button("æ–°å»ºç¬”è®°") {
                    // å‘é€ Action
                }
                .keyboardShortcut("n")
            }
        }
    }
}

struct AppView: View {
    let store: StoreOf<AppFeature>
    
    var body: some View {
        WithViewStore(store) { viewStore in
            NavigationSplitView(
                columnVisibility: viewStore.binding(\.$columnVisibility)
            ) {
                // ä¾§è¾¹æ ï¼ˆ200ptï¼‰
                SidebarView(store: store.scope(state: \.sidebar, action: \.sidebar))
                    .navigationSplitViewColumnWidth(min: 180, ideal: 200, max: 250)
            } content: {
                // ç¬”è®°åˆ—è¡¨ï¼ˆ300-400ptï¼‰
                NoteListView(store: store.scope(state: \.noteList, action: \.noteList))
                    .navigationSplitViewColumnWidth(min: 280, ideal: 350, max: 500)
            } detail: {
                // ç¼–è¾‘å™¨ï¼ˆå æ®å‰©ä½™ç©ºé—´ï¼‰
                NoteEditorView(store: store.scope(state: \.editor, action: \.editor))
            }
            .navigationSplitViewStyle(.balanced)  // âœ¨ å¹³è¡¡æ¨¡å¼ï¼Œè‡ªåŠ¨å“åº”
        }
    }
}
```

**ä¼˜åŠ¿**:
- âœ… è‡ªåŠ¨å¤„ç†çª—å£å¤§å°å˜åŒ–
- âœ… æ”¯æŒæŠ˜å /å±•å¼€ä¾§è¾¹æ å’Œåˆ—è¡¨
- âœ… ç³»ç»Ÿçº§æ‹–æ‹½è°ƒæ•´å®½åº¦
- âœ… è‡ªåŠ¨é€‚é… iPadï¼ˆå¦‚æœæœªæ¥æ”¯æŒï¼‰

---

#### 4.1.2 ASCII å¸ƒå±€å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Nota4                              ğŸ” âš™ï¸ [å·¥å…·æ ]  [çª—å£æ§åˆ¶]   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚          â”‚                  â”‚                                   â”‚
â”‚  ä¾§è¾¹æ   â”‚    ç¬”è®°åˆ—è¡¨      â”‚         ç¼–è¾‘å™¨ / é¢„è§ˆ              â”‚
â”‚ Sidebar  â”‚   NoteList       â”‚       NoteEditor                  â”‚
â”‚          â”‚                  â”‚                                   â”‚
â”‚ ğŸ“ å…¨éƒ¨  â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚ (42)     â”‚ â”‚ ğŸ“Œ ç¬”è®°æ ‡é¢˜1  â”‚ â”‚ â”‚ [âœï¸] [ğŸ‘ï¸] [â†”ï¸]  [â­] [ğŸ—‘ï¸]     â”‚â”‚
â”‚          â”‚ â”‚ é¢„è§ˆå†…å®¹...   â”‚ â”‚ â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤â”‚
â”‚ â­ æ˜Ÿæ ‡  â”‚ â”‚ 2h ago        â”‚ â”‚ â”‚                               â”‚â”‚
â”‚ (8)      â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚ â”‚  # ç¬”è®°æ ‡é¢˜                    â”‚â”‚
â”‚          â”‚                  â”‚ â”‚                               â”‚â”‚
â”‚ ğŸ·ï¸ æ ‡ç­¾  â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚ â”‚  æ­£æ–‡å†…å®¹...                   â”‚â”‚
â”‚  å·¥ä½œ    â”‚ â”‚ ç¬”è®°æ ‡é¢˜2     â”‚ â”‚ â”‚                               â”‚â”‚
â”‚  å­¦ä¹     â”‚ â”‚ é¢„è§ˆ...       â”‚ â”‚ â”‚  - åˆ—è¡¨é¡¹                      â”‚â”‚
â”‚  ç”Ÿæ´»    â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚ â”‚                               â”‚â”‚
â”‚          â”‚                  â”‚ â”‚                               â”‚â”‚
â”‚ ğŸ—‘ï¸ å·²åˆ é™¤â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚ â”‚                               â”‚â”‚
â”‚ (3)      â”‚ â”‚ ç¬”è®°æ ‡é¢˜3     â”‚ â”‚ â”‚                               â”‚â”‚
â”‚          â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

### 4.2 ä¾§è¾¹æ è®¾è®¡ï¼ˆSidebarViewï¼‰

#### 4.2.1 TCA State

```swift
struct SidebarState {
    var selectedCategory: Category = .all
    var categories: [Category] = []
    var tags: Set<String> = []
    var selectedTags: Set<String> = []
    
    enum Category: String, CaseIterable, Identifiable {
        case all = "å…¨éƒ¨ç¬”è®°"
        case starred = "æ˜Ÿæ ‡ç¬”è®°"
        case trash = "å·²åˆ é™¤"
        
        var id: String { rawValue }
        var icon: String {
            switch self {
            case .all: return "note.text"
            case .starred: return "star.fill"
            case .trash: return "trash"
            }
        }
    }
}

enum SidebarAction {
    case categorySelected(SidebarState.Category)
    case tagSelected(String)
    case tagDeselected(String)
}
```

---

#### 4.2.2 UI å®ç°

```swift
struct SidebarView: View {
    let store: StoreOf<SidebarFeature>
    
    var body: some View {
        WithViewStore(store) { viewStore in
            List(selection: viewStore.binding(\.$selectedCategory)) {
                // åˆ†ç±»
                Section("åˆ†ç±»") {
                    ForEach(SidebarState.Category.allCases) { category in
                        Label {
                            Text(category.rawValue)
                        } icon: {
                            Image(systemName: category.icon)
                        }
                        .badge(viewStore.categoryCount(category))
                    }
                }
                
                // æ ‡ç­¾
                Section("æ ‡ç­¾") {
                    ForEach(Array(viewStore.tags), id: \.self) { tag in
                        Label {
                            Text(tag)
                        } icon: {
                            Image(systemName: "tag")
                        }
                        .badge(viewStore.tagCount(tag))
                    }
                }
            }
            .listStyle(.sidebar)
            .navigationTitle("Nota4")
            .toolbar {
                ToolbarItem(placement: .navigation) {
                    Button(action: { viewStore.send(.newNote) }) {
                        Label("æ–°å»º", systemImage: "plus")
                    }
                }
            }
        }
    }
}
```

**ç‰¹ç‚¹**:
- âœ… ä½¿ç”¨ `.listStyle(.sidebar)` è·å¾—ç³»ç»Ÿçº§ä¾§è¾¹æ æ ·å¼
- âœ… `.badge()` æ˜¾ç¤ºç¬”è®°æ•°é‡
- âœ… `selection` ç»‘å®šå®ç°è‡ªåŠ¨é«˜äº®

---

### 4.3 ç¬”è®°åˆ—è¡¨è®¾è®¡ï¼ˆNoteListViewï¼‰

#### 4.3.1 TCA State

```swift
struct NoteListState {
    var notes: IdentifiedArrayOf<Note> = []
    var selectedNoteId: Note.ID?
    var selectedNoteIds: Set<Note.ID> = []  // å¤šé€‰
    var searchText: String = ""
    var isSearching: Bool = false
    var sortOrder: SortOrder = .updated
    
    enum SortOrder {
        case updated
        case created
        case title
    }
}

enum NoteListAction: BindableAction {
    case binding(BindingAction<NoteListState>)
    case noteSelected(Note.ID)
    case notesSelected(Set<Note.ID>)
    case notesLoaded(Result<[Note], Error>)
    case deleteNotes(Set<Note.ID>)
    case toggleStar(Note.ID)
}
```

---

#### 4.3.2 UI å®ç°ï¼ˆåˆ©ç”¨ SwiftUI 4.0 ç‰¹æ€§ï¼‰

```swift
struct NoteListView: View {
    let store: StoreOf<NoteListFeature>
    @State private var selectedNotes = Set<Note.ID>()
    
    var body: some View {
        WithViewStore(store) { viewStore in
            List(viewStore.notes, selection: $selectedNotes) { note in
                NoteRowView(note: note)
                    .equatable()  // âœ… æ€§èƒ½ä¼˜åŒ–ï¼šå¯ç”¨ Equatable
                    // âœ… å³ä¾§æ»‘åŠ¨ï¼šåˆ é™¤å’Œæ˜Ÿæ ‡
                    .swipeActions(edge: .trailing, allowsFullSwipe: true) {
                        Button(role: .destructive) {
                            viewStore.send(.deleteNotes([note.id]))
                        } label: {
                            Label("åˆ é™¤", systemImage: "trash")
                        }
                        .tint(.red)  // âœ… æ˜ç¡®æŒ‡å®šçº¢è‰²
                        
                        Button {
                            viewStore.send(.toggleStar(note.id))
                        } label: {
                            Label(note.isStarred ? "å–æ¶ˆæ˜Ÿæ ‡" : "æ˜Ÿæ ‡", 
                                  systemImage: note.isStarred ? "star.slash" : "star")
                        }
                        .tint(.yellow)  // âœ… æ˜ç¡®æŒ‡å®šé»„è‰²
                    }
                    // âœ… å·¦ä¾§æ»‘åŠ¨ï¼šç½®é¡¶
                    .swipeActions(edge: .leading) {
                        Button {
                            viewStore.send(.togglePin(note.id))
                        } label: {
                            Label(note.isPinned ? "å–æ¶ˆç½®é¡¶" : "ç½®é¡¶", 
                                  systemImage: note.isPinned ? "pin.slash" : "pin")
                        }
                        .tint(.orange)  // âœ… æ©™è‰²ç½®é¡¶
                    }
                    .contextMenu {
                        Button("æ‰“å¼€") { viewStore.send(.noteSelected(note.id)) }
                        Divider()
                        Button("æ˜Ÿæ ‡") { viewStore.send(.toggleStar(note.id)) }
                        Button("åˆ é™¤", role: .destructive) { 
                            viewStore.send(.deleteNotes([note.id])) 
                        }
                    }
            }
            .listStyle(.plain)
            // âœ… ä¸‹æ‹‰åˆ·æ–°ï¼ˆSwiftUI 4.0 æ–°ç‰¹æ€§ï¼‰
            .refreshable {
                await viewStore.send(.loadNotes, while: \.isLoading)
            }
            .searchable(
                text: viewStore.binding(\.$searchText),
                isPresented: viewStore.binding(\.$isSearching)
            )
            .toolbar {
                ToolbarItem {
                    Menu {
                        Picker("æ’åº", selection: viewStore.binding(\.$sortOrder)) {
                            Label("æœ€è¿‘æ›´æ–°", systemImage: "clock").tag(SortOrder.updated)
                            Label("åˆ›å»ºæ—¶é—´", systemImage: "calendar").tag(SortOrder.created)
                            Label("æ ‡é¢˜", systemImage: "textformat").tag(SortOrder.title)
                        }
                    } label: {
                        Label("æ’åº", systemImage: "arrow.up.arrow.down")
                    }
                }
                
                // æ‰¹é‡æ“ä½œï¼ˆä»…å¤šé€‰æ—¶æ˜¾ç¤ºï¼‰
                if !selectedNotes.isEmpty {
                    ToolbarItem {
                        Button(role: .destructive) {
                            viewStore.send(.deleteNotes(selectedNotes))
                            selectedNotes.removeAll()
                        } label: {
                            Label("åˆ é™¤ \(selectedNotes.count) é¡¹", systemImage: "trash")
                        }
                    }
                }
            }
            .onChange(of: selectedNotes) { newValue in
                if newValue.count == 1 {
                    viewStore.send(.noteSelected(newValue.first!))
                } else {
                    viewStore.send(.notesSelected(newValue))
                }
            }
        }
    }
}
```

**äº®ç‚¹**:
- âœ… `.swipeActions()` - iOS é£æ ¼çš„æ»‘åŠ¨æ“ä½œ
- âœ… `.searchable()` - ç³»ç»Ÿçº§æœç´¢æ 
- âœ… åŠ¨æ€å·¥å…·æ ï¼ˆå¤šé€‰æ—¶æ˜¾ç¤ºæ‰¹é‡æ“ä½œï¼‰
- âœ… `IdentifiedArrayOf` - TCA æ¨èçš„é›†åˆç±»å‹

---

#### 4.3.3 ç¬”è®°å¡ç‰‡ç»„ä»¶

```swift
struct NoteRowView: View, Equatable {  // âœ… éµå¾ª Equatable åè®®
    let note: Note
    
    var body: some View {
        VStack(alignment: .leading, spacing: 4) {
            HStack {
                // ç½®é¡¶å›¾æ ‡
                if note.isPinned {
                    Image(systemName: "pin.fill")
                        .font(.caption2)
                        .foregroundColor(.orange)
                }
                
                // æ ‡é¢˜
                Text(note.title.isEmpty ? "æ— æ ‡é¢˜" : note.title)
                    .font(.headline)
                    .lineLimit(2)
                
                Spacer()
                
                // æ˜Ÿæ ‡å›¾æ ‡
                if note.isStarred {
                    Image(systemName: "star.fill")
                        .font(.caption)
                        .foregroundColor(.yellow)
                }
            }
            
            // é¢„è§ˆ
            Text(note.preview)
                .font(.subheadline)
                .foregroundColor(.secondary)
                .lineLimit(3)
            
            // åº•éƒ¨ä¿¡æ¯
            HStack {
                // æ ‡ç­¾
                if !note.tags.isEmpty {
                    HStack(spacing: 4) {
                        ForEach(Array(note.tags.prefix(2)), id: \.self) { tag in
                            Text(tag)
                                .font(.caption2)
                                .padding(.horizontal, 6)
                                .padding(.vertical, 2)
                                .background(Color.accentColor.opacity(0.2))
                                .cornerRadius(4)
                        }
                        if note.tags.count > 2 {
                            Text("+\(note.tags.count - 2)")
                                .font(.caption2)
                                .foregroundColor(.secondary)
                        }
                    }
                }
                
                Spacer()
                
                // æ—¶é—´
                Text(note.updated.formatted(.relative(presentation: .named)))
                    .font(.caption)
                    .foregroundColor(.secondary)
            }
        }
        .padding(.vertical, 4)
    }
    
    // â­ æ€§èƒ½ä¼˜åŒ–ï¼šè‡ªå®šä¹‰ Equatableï¼Œåªæ¯”è¾ƒå½±å“ UI çš„å­—æ®µ
    static func == (lhs: Self, rhs: Self) -> Bool {
        lhs.note.id == rhs.note.id &&
        lhs.note.title == rhs.note.title &&
        lhs.note.preview == rhs.note.preview &&
        lhs.note.isStarred == rhs.note.isStarred &&
        lhs.note.isPinned == rhs.note.isPinned &&
        lhs.note.updated == rhs.note.updated &&
        lhs.note.tags == rhs.note.tags
    }
}
```

**ç‰¹ç‚¹**:
- âœ… ä½¿ç”¨ `.formatted(.relative())` æ˜¾ç¤ºç›¸å¯¹æ—¶é—´ï¼ˆå¦‚ "2h ago"ï¼‰
- âœ… æ ‡ç­¾æ˜¾ç¤ºé™åˆ¶ï¼ˆæœ€å¤š 2 ä¸ªï¼‰
- âœ… ç½®é¡¶å’Œæ˜Ÿæ ‡å›¾æ ‡

---

### 4.4 ç¼–è¾‘å™¨è®¾è®¡ï¼ˆNoteEditorViewï¼‰

#### 4.4.1 TCA State

```swift
struct EditorState {
    var selectedNoteId: Note.ID?
    var note: Note?
    var content: String = ""
    var title: String = ""
    var viewMode: ViewMode = .editOnly
    var isSaving: Bool = false
    var cursorPosition: Int = 0
    
    enum ViewMode {
        case editOnly
        case previewOnly
        case split
    }
}

enum EditorAction: BindableAction {
    case binding(BindingAction<EditorState>)
    case loadNote(Note.ID)
    case noteLoaded(Note)
    case viewModeChanged(ViewMode)
    case autoSave
    case manualSave
    case insertMarkdown(MarkdownFormat)
    case toggleStar
    case deleteNote
}
```

---

#### 4.4.2 UI å®ç°ï¼ˆåˆ†å±æ¨¡å¼ï¼‰

```swift
struct NoteEditorView: View {
    let store: StoreOf<EditorFeature>
    @FocusState private var isTitleFocused: Bool
    @FocusState private var isContentFocused: Bool
    
    var body: some View {
        WithViewStore(store) { viewStore in
            Group {
                if let note = viewStore.note {
                    VStack(spacing: 0) {
                        // æ ‡é¢˜æ 
                        TitleBar(
                            title: viewStore.binding(\.$title),
                            isStarred: note.isStarred,
                            viewMode: viewStore.binding(\.$viewMode),
                            onToggleStar: { viewStore.send(.toggleStar) },
                            onDelete: { viewStore.send(.deleteNote) }
                        )
                        .focused($isTitleFocused)
                        
                        Divider()
                        
                        // ç¼–è¾‘å™¨/é¢„è§ˆåŒº
                        editorContent(viewStore: viewStore)
                            .focused($isContentFocused)
                    }
                } else {
                    EmptyStateView()
                }
            }
            .toolbar {
                // å·¥å…·æ æŒ‰é’®
                editorToolbar(viewStore: viewStore)
            }
        }
    }
    
    @ViewBuilder
    private func editorContent(viewStore: ViewStore<EditorState, EditorAction>) -> some View {
        switch viewStore.viewMode {
        case .editOnly:
            MarkdownEditor(
                text: viewStore.binding(\.$content),
                onInsertMarkdown: { format in
                    viewStore.send(.insertMarkdown(format))
                }
            )
            
        case .previewOnly:
            ScrollView {
                MarkdownPreview(content: viewStore.content)
                    .padding()
            }
            
        case .split:
            HSplitView {
                MarkdownEditor(
                    text: viewStore.binding(\.$content),
                    onInsertMarkdown: { format in
                        viewStore.send(.insertMarkdown(format))
                    }
                )
                
                ScrollView {
                    MarkdownPreview(content: viewStore.content)
                        .padding()
                }
            }
        }
    }
    
    @ToolbarContentBuilder
    private func editorToolbar(viewStore: ViewStore<EditorState, EditorAction>) -> some ToolbarContent {
        // è§†å›¾æ¨¡å¼åˆ‡æ¢
        ToolbarItem {
            Picker("è§†å›¾æ¨¡å¼", selection: viewStore.binding(\.$viewMode)) {
                Label("ç¼–è¾‘", systemImage: "pencil").tag(ViewMode.editOnly)
                Label("é¢„è§ˆ", systemImage: "eye").tag(ViewMode.previewOnly)
                Label("åˆ†å±", systemImage: "rectangle.split.2x1").tag(ViewMode.split)
            }
            .pickerStyle(.segmented)
            .frame(width: 200)  // âœ… å›ºå®šå®½åº¦
        }
        
        // âœ… ä¼˜åŒ–åçš„ä¿å­˜çŠ¶æ€ï¼ˆä½¿ç”¨æ¸å˜å’Œé˜´å½±ï¼‰
        ToolbarItem {
            Group {
                if viewStore.isSaving {
                    ProgressView()
                        .scaleEffect(0.8)
                } else if viewStore.hasUnsavedChanges {
                    Image(systemName: "circle.fill")
                        .foregroundColor(.orange)
                        .help("æœ‰æœªä¿å­˜çš„æ›´æ”¹")
                } else {
                    Image(systemName: "checkmark.circle.fill")
                        .foregroundStyle(  // âœ… ä½¿ç”¨æ¸å˜
                            LinearGradient(
                                colors: [.green, .green.opacity(0.7)],
                                startPoint: .topLeading,
                                endPoint: .bottomTrailing
                            )
                        )
                        .shadow(color: .green.opacity(0.3), radius: 2, x: 0, y: 1)  // âœ… æ·»åŠ é˜´å½±
                        .help("å·²ä¿å­˜")
                }
            }
            .animation(.spring(), value: viewStore.isSaving)  // âœ… æµç•…åŠ¨ç”»
            .animation(.spring(), value: viewStore.hasUnsavedChanges)
        }
    }
}
```

---

#### 4.4.3 Markdown ç¼–è¾‘å™¨ç»„ä»¶

```swift
struct MarkdownEditor: View {
    @Binding var text: String
    let onInsertMarkdown: (MarkdownFormat) -> Void
    
    var body: some View {
        TextEditor(text: $text)
            .font(.system(.body, design: .monospaced))
            .padding(8)
            .contextMenu {
                markdownMenu
            }
    }
    
    @ViewBuilder
    private var markdownMenu: some View {
        // âœ… ä¼˜åŒ–ï¼šæ·»åŠ å›¾æ ‡å’Œå¿«æ·é”®æç¤º
        Section("æ ‡é¢˜") {
            Menu {
                ForEach(1...6, id: \.self) { level in
                    Button {
                        onInsertMarkdown(.heading(level: level))
                    } label: {
                        Label("H\(level)", systemImage: "number.circle")  // âœ… æ·»åŠ å›¾æ ‡
                    }
                }
            } label: {
                Label("æ’å…¥æ ‡é¢˜", systemImage: "textformat.size")
            }
        }
        
        Section("æ ¼å¼") {
            Button {
                onInsertMarkdown(.bold)
            } label: {
                Label("åŠ ç²—", systemImage: "bold")  // âœ… æ·»åŠ å›¾æ ‡
            }
            .keyboardShortcut("b")  // âœ… æ·»åŠ å¿«æ·é”®æç¤º
            
            Button {
                onInsertMarkdown(.italic)
            } label: {
                Label("æ–œä½“", systemImage: "italic")  // âœ… æ·»åŠ å›¾æ ‡
            }
            .keyboardShortcut("i")
        }
        
        Section("å—å…ƒç´ ") {
            Button {
                onInsertMarkdown(.codeBlock)
            } label: {
                Label("ä»£ç å—", systemImage: "chevron.left.forwardslash.chevron.right")
            }
            
            Button {
                onInsertMarkdown(.unorderedList)
            } label: {
                Label("æ— åºåˆ—è¡¨", systemImage: "list.bullet")
            }
            
            Button {
                onInsertMarkdown(.orderedList)
            } label: {
                Label("æœ‰åºåˆ—è¡¨", systemImage: "list.number")
            }
        }
        
        Section("æ’å…¥") {
            Button {
                onInsertMarkdown(.link)
            } label: {
                Label("é“¾æ¥", systemImage: "link")  // âœ… æ·»åŠ å›¾æ ‡
            }
            .keyboardShortcut("k")  // âœ… æ·»åŠ å¿«æ·é”®æç¤º
            
            Button {
                onInsertMarkdown(.image)
            } label: {
                Label("å›¾ç‰‡", systemImage: "photo")  // âœ… æ·»åŠ å›¾æ ‡
            }
        }
    }
}
```

---

#### 4.4.4 Markdown é¢„è§ˆç»„ä»¶ï¼ˆä½¿ç”¨ MarkdownUIï¼‰

```swift
import MarkdownUI

struct MarkdownPreview: View {
    let content: String
    
    var body: some View {
        Markdown(content)
            .markdownTheme(.gitHub)  // ä½¿ç”¨ GitHub é£æ ¼
            .markdownCodeSyntaxHighlighter(.splash(theme: .sunset))
            .textSelection(.enabled)
    }
}
```

**ä¾èµ–**:
```swift
// Package.swift
dependencies: [
    .package(url: "https://github.com/gonzalezreal/swift-markdown-ui", from: "2.0.0")
]
```

---

### 4.5 ç©ºçŠ¶æ€è®¾è®¡

```swift
struct EmptyStateView: View {
    enum EmptyType {
        case noNotes
        case noSelection
        case multiSelection(count: Int)
        case searching(keyword: String)
    }
    
    let type: EmptyType
    
    var body: some View {
        ContentUnavailableView {
            Label(title, systemImage: icon)
        } description: {
            Text(description)
        } actions: {
            actions
        }
    }
    
    private var title: String {
        switch type {
        case .noNotes:
            return "æš‚æ— ç¬”è®°"
        case .noSelection:
            return "é€‰æ‹©ä¸€ç¯‡ç¬”è®°å¼€å§‹ç¼–è¾‘"
        case .multiSelection(let count):
            return "å·²é€‰ä¸­ \(count) ç¯‡ç¬”è®°"
        case .searching(let keyword):
            return "æœªæ‰¾åˆ° \"\(keyword)\""
        }
    }
    
    private var icon: String {
        switch type {
        case .noNotes:
            return "note.text"
        case .noSelection:
            return "arrow.left"
        case .multiSelection:
            return "checkmark.circle"
        case .searching:
            return "magnifyingglass"
        }
    }
    
    private var description: String {
        switch type {
        case .noNotes:
            return "åˆ›å»ºä½ çš„ç¬¬ä¸€ç¯‡ç¬”è®°"
        case .noSelection:
            return "ä»å·¦ä¾§åˆ—è¡¨é€‰æ‹©æˆ–åˆ›å»ºæ–°ç¬”è®°"
        case .multiSelection:
            return "æ‰¹é‡æ“ä½œæ¨¡å¼"
        case .searching:
            return "å°è¯•ä¸åŒçš„å…³é”®è¯"
        }
    }
    
    @ViewBuilder
    private var actions: some View {
        switch type {
        case .noNotes:
            Button("æ–°å»ºç¬”è®°") {
                // å‘é€ Action
            }
            .buttonStyle(.borderedProminent)
        default:
            EmptyView()
        }
    }
}
```

---

### ğŸ¤” **ç¬¬å››æ­¥å¾…å®Œå–„ç‚¹**

è¯·ç¡®è®¤æˆ–è¡¥å……ï¼š
1. âœ… NavigationSplitView çš„ä¸‰æ å¸ƒå±€æ˜¯å¦ç¬¦åˆé¢„æœŸï¼Ÿ
2. âœ… ç¬”è®°åˆ—è¡¨çš„å¡ç‰‡è®¾è®¡æ˜¯å¦éœ€è¦è°ƒæ•´ï¼ˆå¦‚æ˜¾ç¤ºæ›´å¤šä¿¡æ¯ï¼‰ï¼Ÿ
3. âœ… ç¼–è¾‘å™¨çš„åˆ†å±æ¨¡å¼æ˜¯å¦æ»¡è¶³éœ€æ±‚ï¼Ÿ
4. âœ… Markdown é¢„è§ˆæ˜¯å¦éœ€è¦è‡ªå®šä¹‰ä¸»é¢˜ï¼ˆä¸ä½¿ç”¨ GitHub é£æ ¼ï¼‰ï¼Ÿ
5. ğŸ¤” æ˜¯å¦éœ€è¦æ·»åŠ å…¶ä»– UI ç»„ä»¶ï¼ˆå¦‚è®¾ç½®é¢æ¿ï¼‰ï¼Ÿ

**è¯·å›å¤æ‚¨çš„è¡¥å……æ„è§ï¼Œæˆ‘å°†ç»§ç»­ç¬¬äº”æ­¥ï¼šTCA çŠ¶æ€ç®¡ç†è®¾è®¡ã€‚**

---

## ç¬¬äº”æ­¥ï¼šTCA çŠ¶æ€ç®¡ç†è®¾è®¡

### 5.1 å®Œæ•´çš„ TCA æ¶æ„å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         AppState                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ SidebarState                                              â”‚  â”‚
â”‚  â”‚  - selectedCategory: Category                             â”‚  â”‚
â”‚  â”‚  - tags: Set<String>                                      â”‚  â”‚
â”‚  â”‚  - selectedTags: Set<String>                              â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ NoteListState                                             â”‚  â”‚
â”‚  â”‚  - notes: IdentifiedArrayOf<Note>                        â”‚  â”‚
â”‚  â”‚  - selectedNoteId: Note.ID?                               â”‚  â”‚
â”‚  â”‚  - selectedNoteIds: Set<Note.ID>                          â”‚  â”‚
â”‚  â”‚  - searchText: String                                     â”‚  â”‚
â”‚  â”‚  - isSearching: Bool                                      â”‚  â”‚
â”‚  â”‚  - sortOrder: SortOrder                                   â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ EditorState                                               â”‚  â”‚
â”‚  â”‚  - selectedNoteId: Note.ID?                               â”‚  â”‚
â”‚  â”‚  - note: Note?                                            â”‚  â”‚
â”‚  â”‚  - content: String                                        â”‚  â”‚
â”‚  â”‚  - title: String                                          â”‚  â”‚
â”‚  â”‚  - viewMode: ViewMode                                     â”‚  â”‚
â”‚  â”‚  - isSaving: Bool                                         â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                               â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         AppAction                                â”‚
â”‚  - sidebar(SidebarAction)                                        â”‚
â”‚  - noteList(NoteListAction)                                      â”‚
â”‚  - editor(EditorAction)                                          â”‚
â”‚  - appDelegate(AppDelegateAction)  // åº”ç”¨çº§äº‹ä»¶                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                               â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        AppReducer                                â”‚
â”‚  sidebarReducer.pullback(...)                                    â”‚
â”‚  noteListReducer.pullback(...)                                   â”‚
â”‚  editorReducer.pullback(...)                                     â”‚
â”‚  appDelegateReducer.pullback(...)                                â”‚
â”‚  + è·¨æ¨¡å—åè°ƒé€»è¾‘                                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                               â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      AppEnvironment                              â”‚
â”‚  - noteRepository: NoteRepository                                â”‚
â”‚  - fileManager: NotaFileManager                                  â”‚
â”‚  - mainQueue: AnySchedulerOf<DispatchQueue>                      â”‚
â”‚  - uuid: () -> UUID                                              â”‚
â”‚  - date: () -> Date                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

### 5.2 æ ¸å¿ƒçŠ¶æ€å®šä¹‰

#### 5.2.1 AppStateï¼ˆæ ¹çŠ¶æ€ï¼‰

```swift
struct AppState: Equatable {
    var sidebar: SidebarState = SidebarState()
    var noteList: NoteListState = NoteListState()
    var editor: EditorState = EditorState()
    var alert: AlertState<AppAction>?
    var columnVisibility: NavigationSplitViewVisibility = .all
}
```

---

#### 5.2.2 SidebarStateï¼ˆä¾§è¾¹æ çŠ¶æ€ï¼‰

```swift
struct SidebarState: Equatable {
    var selectedCategory: Category = .all
    var categories: IdentifiedArrayOf<Category> = [.all, .starred, .trash]
    var tags: IdentifiedArrayOf<Tag> = []
    var selectedTags: Set<String> = []
    var categoryCounts: [Category: Int] = [:]
    
    enum Category: String, CaseIterable, Identifiable {
        case all = "å…¨éƒ¨ç¬”è®°"
        case starred = "æ˜Ÿæ ‡ç¬”è®°"
        case trash = "å·²åˆ é™¤"
        
        var id: String { rawValue }
        var icon: String {
            switch self {
            case .all: return "note.text"
            case .starred: return "star.fill"
            case .trash: return "trash"
            }
        }
    }
    
    struct Tag: Equatable, Identifiable {
        let id: String
        let name: String
        var count: Int = 0
    }
}

enum SidebarAction: Equatable {
    case categorySelected(SidebarState.Category)
    case tagSelected(String)
    case tagToggled(String)
    case loadTags
    case tagsLoaded(Result<[SidebarState.Tag], Error>)
    case updateCounts([SidebarState.Category: Int])
}
```

---

#### 5.2.3 NoteListStateï¼ˆç¬”è®°åˆ—è¡¨çŠ¶æ€ï¼‰

```swift
struct NoteListState: Equatable {
    var notes: IdentifiedArrayOf<Note> = []
    var selectedNoteId: Note.ID?
    var selectedNoteIds: Set<Note.ID> = []
    var searchText: String = ""
    var isSearching: Bool = false
    var sortOrder: SortOrder = .updated
    var isLoading: Bool = false
    var filter: Filter = .none
    
    enum SortOrder: Equatable {
        case updated
        case created
        case title
    }
    
    enum Filter: Equatable {
        case none
        case category(SidebarState.Category)
        case tags(Set<String>)
        case search(String)
    }
    
    // è®¡ç®—å±æ€§ï¼šè¿‡æ»¤åçš„ç¬”è®°
    var filteredNotes: [Note] {
        notes
            .filter { note in
                switch filter {
                case .none:
                    return true
                case .category(let category):
                    switch category {
                    case .all:
                        return !note.isDeleted
                    case .starred:
                        return note.isStarred && !note.isDeleted
                    case .trash:
                        return note.isDeleted
                    }
                case .tags(let tags):
                    return !note.tags.isDisjoint(with: tags) && !note.isDeleted
                case .search(let keyword):
                    return (note.title.contains(keyword) || note.content.contains(keyword)) && !note.isDeleted
                }
            }
            .sorted { lhs, rhs in
                switch sortOrder {
                case .updated:
                    if lhs.isPinned != rhs.isPinned {
                        return lhs.isPinned  // ç½®é¡¶ä¼˜å…ˆ
                    }
                    return lhs.updated > rhs.updated
                case .created:
                    return lhs.created > rhs.created
                case .title:
                    return lhs.title < rhs.title
                }
            }
    }
}

enum NoteListAction: BindableAction, Equatable {
    case binding(BindingAction<NoteListState>)
    case loadNotes
    case notesLoaded(Result<[Note], Error>)
    case noteSelected(Note.ID)
    case notesSelected(Set<Note.ID>)
    case deleteNotes(Set<Note.ID>)
    case restoreNotes(Set<Note.ID>)
    case permanentlyDeleteNotes(Set<Note.ID>)
    case toggleStar(Note.ID)
    case togglePin(Note.ID)
    case filterChanged(NoteListState.Filter)
    case sortOrderChanged(NoteListState.SortOrder)
}
```

---

#### 5.2.4 EditorStateï¼ˆç¼–è¾‘å™¨çŠ¶æ€ï¼‰

```swift
struct EditorState: Equatable {
    var selectedNoteId: Note.ID?
    var note: Note?
    var content: String = ""
    var title: String = ""
    var viewMode: ViewMode = .editOnly
    var isSaving: Bool = false
    var lastSavedContent: String = ""
    var lastSavedTitle: String = ""
    var hasUnsavedChanges: Bool = false
    var cursorPosition: Int = 0
    
    enum ViewMode: Equatable {
        case editOnly
        case previewOnly
        case split
    }
}

enum EditorAction: BindableAction, Equatable {
    case binding(BindingAction<EditorState>)
    case loadNote(Note.ID)
    case noteLoaded(Result<Note, Error>)
    case viewModeChanged(ViewMode)
    case autoSave
    case manualSave
    case saveCompleted
    case insertMarkdown(MarkdownFormat)
    case toggleStar
    case deleteNote
    case createNote
    case noteCreated(Result<Note, Error>)
    
    enum MarkdownFormat: Equatable {
        case heading(level: Int)
        case bold
        case italic
        case codeBlock
        case unorderedList
        case orderedList
        case link
        case image
    }
}
```

---

### 5.3 Reducer å®ç°

#### 5.3.1 SidebarReducer

```swift
let sidebarReducer = Reducer<SidebarState, SidebarAction, AppEnvironment> { state, action, environment in
    switch action {
    case .categorySelected(let category):
        state.selectedCategory = category
        state.selectedTags.removeAll()  // åˆ‡æ¢åˆ†ç±»æ—¶æ¸…ç©ºæ ‡ç­¾é€‰æ‹©
        return .none
        
    case .tagSelected(let tag):
        state.selectedTags = [tag]
        return .none
        
    case .tagToggled(let tag):
        if state.selectedTags.contains(tag) {
            state.selectedTags.remove(tag)
        } else {
            state.selectedTags.insert(tag)
        }
        return .none
        
    case .loadTags:
        return .run { send in
            let tags = try await environment.noteRepository.fetchAllTags()
            await send(.tagsLoaded(.success(tags)))
        } catch: { error, send in
            await send(.tagsLoaded(.failure(error)))
        }
        
    case .tagsLoaded(.success(let tags)):
        state.tags = IdentifiedArray(uniqueElements: tags)
        return .none
        
    case .tagsLoaded(.failure(let error)):
        print("åŠ è½½æ ‡ç­¾å¤±è´¥: \(error)")
        return .none
        
    case .updateCounts(let counts):
        state.categoryCounts = counts
        return .none
    }
}
```

---

#### 5.3.2 NoteListReducerï¼ˆæ ¸å¿ƒé€»è¾‘ï¼‰

```swift
let noteListReducer = Reducer<NoteListState, NoteListAction, AppEnvironment> { state, action, environment in
    switch action {
    case .binding:
        return .none
        
    case .loadNotes:
        state.isLoading = true
        return .run { [filter = state.filter] send in
            let notes = try await environment.noteRepository.fetchNotes(filter: filter)
            await send(.notesLoaded(.success(notes)))
        } catch: { error, send in
            await send(.notesLoaded(.failure(error)))
        }
        
    case .notesLoaded(.success(let notes)):
        state.notes = IdentifiedArray(uniqueElements: notes)
        state.isLoading = false
        return .none
        
    case .notesLoaded(.failure(let error)):
        state.isLoading = false
        print("åŠ è½½ç¬”è®°å¤±è´¥: \(error)")
        return .none
        
    case .noteSelected(let id):
        state.selectedNoteId = id
        state.selectedNoteIds.removeAll()
        return .none
        
    case .notesSelected(let ids):
        state.selectedNoteIds = ids
        state.selectedNoteId = nil
        return .none
        
    case .deleteNotes(let ids):
        return .run { send in
            try await environment.noteRepository.deleteNotes(ids)
            await send(.loadNotes)
        }
        
    case .restoreNotes(let ids):
        return .run { send in
            try await environment.noteRepository.restoreNotes(ids)
            await send(.loadNotes)
        }
        
    case .permanentlyDeleteNotes(let ids):
        return .run { send in
            try await environment.noteRepository.permanentlyDeleteNotes(ids)
            try await environment.fileManager.deleteNoteFiles(ids)
            await send(.loadNotes)
        }
        
    case .toggleStar(let id):
        guard let note = state.notes[id: id] else { return .none }
        let updatedNote = Note(
            id: note.id,
            noteId: note.noteId,
            title: note.title,
            content: note.content,
            created: note.created,
            updated: environment.date(),
            isStarred: !note.isStarred,
            isPinned: note.isPinned,
            isDeleted: note.isDeleted,
            tags: note.tags
        )
        state.notes[id: id] = updatedNote
        
        return .run { send in
            try await environment.noteRepository.updateNote(updatedNote)
        }
        
    case .togglePin(let id):
        guard let note = state.notes[id: id] else { return .none }
        let updatedNote = Note(
            id: note.id,
            noteId: note.noteId,
            title: note.title,
            content: note.content,
            created: note.created,
            updated: environment.date(),
            isStarred: note.isStarred,
            isPinned: !note.isPinned,
            isDeleted: note.isDeleted,
            tags: note.tags
        )
        state.notes[id: id] = updatedNote
        
        return .run { send in
            try await environment.noteRepository.updateNote(updatedNote)
            await send(.loadNotes)  // é‡æ–°æ’åº
        }
        
    case .filterChanged(let filter):
        state.filter = filter
        return Effect(value: .loadNotes)
        
    case .sortOrderChanged(let order):
        state.sortOrder = order
        return .none
    }
}
.binding()  // âœ… å¯ç”¨ @Binding æ”¯æŒ
```

---

#### 5.3.3 EditorReducerï¼ˆè‡ªåŠ¨ä¿å­˜é€»è¾‘ï¼‰

```swift
let editorReducer = Reducer<EditorState, EditorAction, AppEnvironment> { state, action, environment in
    struct AutoSaveId: Hashable {}
    
    switch action {
    case .binding(\.$content):
        state.hasUnsavedChanges = (state.content != state.lastSavedContent || state.title != state.lastSavedTitle)
        
        // âœ… é˜²æŠ–è‡ªåŠ¨ä¿å­˜ï¼ˆ0.8 ç§’ï¼‰+ æµç•…åŠ¨ç”»
        return .run { send in
            try await environment.mainQueue.sleep(for: .seconds(0.8))
            await send(.autoSave, animation: .spring())  // âœ… æ·»åŠ åŠ¨ç”»
        }
        .cancellable(id: AutoSaveId(), cancelInFlight: true)
        
    case .binding(\.$title):
        state.hasUnsavedChanges = (state.content != state.lastSavedContent || state.title != state.lastSavedTitle)
        
        // âœ… é˜²æŠ–è‡ªåŠ¨ä¿å­˜ + æµç•…åŠ¨ç”»
        return .run { send in
            try await environment.mainQueue.sleep(for: .seconds(0.8))
            await send(.autoSave, animation: .spring())  // âœ… æ·»åŠ åŠ¨ç”»
        }
        .cancellable(id: AutoSaveId(), cancelInFlight: true)
        
    case .binding:
        return .none
        
    case .loadNote(let id):
        state.selectedNoteId = id
        return .run { send in
            let note = try await environment.noteRepository.fetchNote(id)
            await send(.noteLoaded(.success(note)))
        } catch: { error, send in
            await send(.noteLoaded(.failure(error)))
        }
        
    case .noteLoaded(.success(let note)):
        state.note = note
        state.content = note.content
        state.title = note.title
        state.lastSavedContent = note.content
        state.lastSavedTitle = note.title
        state.hasUnsavedChanges = false
        return .none
        
    case .noteLoaded(.failure(let error)):
        print("åŠ è½½ç¬”è®°å¤±è´¥: \(error)")
        return .none
        
    case .viewModeChanged(let mode):
        state.viewMode = mode
        return .none
        
    case .autoSave:
        guard state.hasUnsavedChanges, let note = state.note else {
            return .none
        }
        
        state.isSaving = true
        let updatedNote = Note(
            id: note.id,
            noteId: note.noteId,
            title: state.title,
            content: state.content,
            created: note.created,
            updated: environment.date(),
            isStarred: note.isStarred,
            isPinned: note.isPinned,
            isDeleted: note.isDeleted,
            tags: note.tags
        )
        
        return .run { send in
            try await environment.noteRepository.updateNote(updatedNote)
            try await environment.fileManager.updateNoteFile(updatedNote)
            await send(.saveCompleted)
        }
        
    case .manualSave:
        // âœ… æ‰‹åŠ¨ä¿å­˜ç«‹å³è§¦å‘ï¼Œä¸é˜²æŠ–
        return Effect.cancel(id: AutoSaveId())
            .concatenate(with: Effect(value: .autoSave))
        
    case .saveCompleted:
        state.isSaving = false
        state.lastSavedContent = state.content
        state.lastSavedTitle = state.title
        state.hasUnsavedChanges = false
        return .none
        
    case .insertMarkdown(let format):
        let insertion = format.markdownText
        // âœ… åœ¨å…‰æ ‡ä½ç½®æ’å…¥
        let index = state.content.index(state.content.startIndex, offsetBy: state.cursorPosition, limitedBy: state.content.endIndex) ?? state.content.endIndex
        state.content.insert(contentsOf: insertion, at: index)
        state.cursorPosition += insertion.count
        return .none
        
    case .toggleStar:
        guard var note = state.note else { return .none }
        note.isStarred.toggle()
        state.note = note
        
        return .run { send in
            try await environment.noteRepository.updateNote(note)
        }
        
    case .deleteNote:
        guard let noteId = state.selectedNoteId else { return .none }
        return .run { send in
            try await environment.noteRepository.deleteNote(noteId)
        }
        
    case .createNote:
        let noteId = environment.uuid().uuidString
        let now = environment.date()
        let newNote = Note(
            id: nil,
            noteId: noteId,
            title: "æ— æ ‡é¢˜",
            content: "",
            created: now,
            updated: now,
            isStarred: false,
            isPinned: false,
            isDeleted: false,
            tags: []
        )
        
        return .run { send in
            try await environment.noteRepository.createNote(newNote)
            try await environment.fileManager.createNoteFile(newNote)
            await send(.noteCreated(.success(newNote)))
        } catch: { error, send in
            await send(.noteCreated(.failure(error)))
        }
        
    case .noteCreated(.success(let note)):
        state.note = note
        state.selectedNoteId = note.noteId
        state.content = ""
        state.title = "æ— æ ‡é¢˜"
        return .none
        
    case .noteCreated(.failure(let error)):
        print("åˆ›å»ºç¬”è®°å¤±è´¥: \(error)")
        return .none
    }
}
.binding()  // âœ… å¯ç”¨ @Binding æ”¯æŒ

extension EditorAction.MarkdownFormat {
    var markdownText: String {
        switch self {
        case .heading(let level):
            return "\(String(repeating: "#", count: level)) "
        case .bold:
            return "****"
        case .italic:
            return "**"
        case .codeBlock:
            return "\n```\n\n```\n"
        case .unorderedList:
            return "\n- "
        case .orderedList:
            return "\n1. "
        case .link:
            return "[]()"
        case .image:
            return "![]()"
        }
    }
}
```

---

#### 5.3.4 AppReducerï¼ˆè·¨æ¨¡å—åè°ƒï¼‰

```swift
let appReducer = Reducer<AppState, AppAction, AppEnvironment>.combine(
    sidebarReducer.pullback(
        state: \.sidebar,
        action: /AppAction.sidebar,
        environment: { $0 }
    ),
    noteListReducer.pullback(
        state: \.noteList,
        action: /AppAction.noteList,
        environment: { $0 }
    ),
    editorReducer.pullback(
        state: \.editor,
        action: /AppAction.editor,
        environment: { $0 }
    ),
    Reducer { state, action, environment in
        // âœ… è·¨æ¨¡å—åè°ƒé€»è¾‘ï¼ˆå«åŠ¨ç”»æ§åˆ¶ï¼‰
        switch action {
        // ä¾§è¾¹æ åˆ†ç±»åˆ‡æ¢ â†’ æ›´æ–°ç¬”è®°åˆ—è¡¨è¿‡æ»¤ï¼ˆå¸¦åŠ¨ç”»ï¼‰
        case .sidebar(.categorySelected(let category)):
            state.noteList.filter = .category(category)
            return .run { send in
                await send(.noteList(.loadNotes), animation: .easeInOut)  // âœ… æ·»åŠ åŠ¨ç”»
            }
            
        // ä¾§è¾¹æ æ ‡ç­¾é€‰æ‹© â†’ æ›´æ–°ç¬”è®°åˆ—è¡¨è¿‡æ»¤ï¼ˆå¸¦åŠ¨ç”»ï¼‰
        case .sidebar(.tagToggled):
            if !state.sidebar.selectedTags.isEmpty {
                state.noteList.filter = .tags(state.sidebar.selectedTags)
            } else {
                state.noteList.filter = .category(state.sidebar.selectedCategory)
            }
            return .run { send in
                await send(.noteList(.loadNotes), animation: .easeInOut)  // âœ… æ·»åŠ åŠ¨ç”»
            }
            
        // ç¬”è®°åˆ—è¡¨é€‰ä¸­ â†’ åŠ è½½åˆ°ç¼–è¾‘å™¨ï¼ˆå¸¦åŠ¨ç”»ï¼‰
        case .noteList(.noteSelected(let id)):
            return .run { send in
                await send(.editor(.loadNote(id)), animation: .spring())  // âœ… æ·»åŠ å¼¹ç°§åŠ¨ç”»
            }
            
        // ç¬”è®°åˆ—è¡¨å¤šé€‰ â†’ æ¸…ç©ºç¼–è¾‘å™¨
        case .noteList(.notesSelected(let ids)) where ids.count > 1:
            state.editor.note = nil
            state.editor.content = ""
            state.editor.title = ""
            return .none
            
        // ç¼–è¾‘å™¨ä¿å­˜å®Œæˆ â†’ åˆ·æ–°ç¬”è®°åˆ—è¡¨
        case .editor(.saveCompleted):
            return Effect(value: .noteList(.loadNotes))
            
        // ç¬”è®°åˆ—è¡¨åŠ è½½å®Œæˆ â†’ æ›´æ–°ä¾§è¾¹æ ç»Ÿè®¡
        case .noteList(.notesLoaded(.success(let notes))):
            let counts: [SidebarState.Category: Int] = [
                .all: notes.filter { !$0.isDeleted }.count,
                .starred: notes.filter { $0.isStarred && !$0.isDeleted }.count,
                .trash: notes.filter { $0.isDeleted }.count
            ]
            return Effect(value: .sidebar(.updateCounts(counts)))
            
        default:
            return .none
        }
    }
)
```

---

### 5.4 Environmentï¼ˆä¾èµ–æ³¨å…¥ï¼‰

```swift
struct AppEnvironment {
    var noteRepository: NoteRepository
    var fileManager: NotaFileManager
    var mainQueue: AnySchedulerOf<DispatchQueue>
    var uuid: () -> UUID
    var date: () -> Date
}

// âœ… Live Environmentï¼ˆç”Ÿäº§ç¯å¢ƒï¼‰
extension AppEnvironment {
    static let live = AppEnvironment(
        noteRepository: NoteRepository.live,
        fileManager: NotaFileManager.live,
        mainQueue: .main,
        uuid: UUID.init,
        date: Date.init
    )
}

// âœ… Mock Environmentï¼ˆæµ‹è¯•ç¯å¢ƒï¼‰
extension AppEnvironment {
    static let mock = AppEnvironment(
        noteRepository: NoteRepository.mock,
        fileManager: NotaFileManager.mock,
        mainQueue: .immediate,
        uuid: { UUID(uuidString: "00000000-0000-0000-0000-000000000000")! },
        date: { Date(timeIntervalSince1970: 0) }
    )
}
```

---

### 5.5 TCA æµ‹è¯•ç¤ºä¾‹

```swift
import XCTest
import ComposableArchitecture

class NoteListReducerTests: XCTestCase {
    func testSelectNote() async {
        let store = TestStore(
            initialState: NoteListState(),
            reducer: noteListReducer,
            environment: .mock
        )
        
        let note = Note(
            id: 1,
            noteId: "test-id",
            title: "æµ‹è¯•ç¬”è®°",
            content: "å†…å®¹",
            created: Date(),
            updated: Date(),
            isStarred: false,
            isPinned: false,
            isDeleted: false,
            tags: []
        )
        
        await store.send(.notesLoaded(.success([note]))) {
            $0.notes = [note]
        }
        
        await store.send(.noteSelected("test-id")) {
            $0.selectedNoteId = "test-id"
        }
    }
    
    func testToggleStar() async {
        let note = Note(
            id: 1,
            noteId: "test-id",
            title: "æµ‹è¯•ç¬”è®°",
            content: "å†…å®¹",
            created: Date(),
            updated: Date(),
            isStarred: false,
            isPinned: false,
            isDeleted: false,
            tags: []
        )
        
        let store = TestStore(
            initialState: NoteListState(notes: [note]),
            reducer: noteListReducer,
            environment: .mock
        )
        
        await store.send(.toggleStar("test-id")) {
            $0.notes[id: "test-id"]?.isStarred = true
        }
    }
}
```

---

### ğŸ¤” **ç¬¬äº”æ­¥å¾…å®Œå–„ç‚¹**

è¯·ç¡®è®¤æˆ–è¡¥å……ï¼š
1. âœ… TCA çš„çŠ¶æ€å®šä¹‰æ˜¯å¦å®Œæ•´ï¼Ÿ
2. âœ… Reducer çš„é€»è¾‘æ˜¯å¦æ¸…æ™°ï¼ˆç‰¹åˆ«æ˜¯è·¨æ¨¡å—åè°ƒï¼‰ï¼Ÿ
3. âœ… è‡ªåŠ¨ä¿å­˜çš„é˜²æŠ–é€»è¾‘æ˜¯å¦åˆç†ï¼ˆ0.8 ç§’ï¼‰ï¼Ÿ
4. âœ… Environment çš„ä¾èµ–æ³¨å…¥è®¾è®¡æ˜¯å¦æ»¡è¶³æµ‹è¯•éœ€æ±‚ï¼Ÿ
5. ğŸ¤” æ˜¯å¦éœ€è¦æ·»åŠ å…¶ä»– Effectï¼ˆå¦‚ç½‘ç»œè¯·æ±‚ã€æ–‡ä»¶å¯¼å…¥ç­‰ï¼‰ï¼Ÿ

**è¯·å›å¤æ‚¨çš„è¡¥å……æ„è§ï¼Œæˆ‘å°†ç»§ç»­ç¬¬å…­æ­¥ï¼šæ•°æ®æ¶æ„è®¾è®¡ã€‚**

---

## ç¬¬å…­æ­¥ï¼šæ•°æ®æ¶æ„è®¾è®¡

### 6.1 æ•°æ®æ¨¡å‹

#### 6.1.1 Note æ¨¡å‹

```swift
struct Note: Codable, Equatable, Identifiable {
    // æ•°æ®åº“å­—æ®µ
    var id: Int64?              // æ•°æ®åº“ä¸»é”®
    let noteId: String          // UUIDï¼Œå”¯ä¸€æ ‡è¯†ï¼ˆæ–‡ä»¶åï¼‰
    var title: String           // ç¬”è®°æ ‡é¢˜
    var content: String         // Markdown å†…å®¹
    let created: Date           // åˆ›å»ºæ—¶é—´
    var updated: Date           // æœ€åæ›´æ–°æ—¶é—´
    var isStarred: Bool         // æ˜¯å¦æ˜Ÿæ ‡
    var isPinned: Bool          // æ˜¯å¦ç½®é¡¶
    var isDeleted: Bool         // æ˜¯å¦å·²åˆ é™¤ï¼ˆè½¯åˆ é™¤ï¼‰
    var tags: Set<String>       // æ ‡ç­¾é›†åˆ
    var checksum: String?       // MD5 æ ¡éªŒå’Œï¼ˆç”¨äºæ£€æµ‹æ–‡ä»¶å˜åŒ–ï¼‰
    
    // è®¡ç®—å±æ€§
    var preview: String {
        // æå–å‰ 100 ä¸ªå­—ç¬¦ä½œä¸ºé¢„è§ˆ
        let lines = content.split(separator: "\n")
        let preview = lines.prefix(3).joined(separator: " ")
        return String(preview.prefix(100))
    }
    
    var fileName: String {
        // æ–‡ä»¶åï¼š{noteId}.nota
        return "\(noteId).nota"
    }
}
```

---

### 6.2 æ–‡ä»¶æ ¼å¼ï¼ˆ.notaï¼‰

#### 6.2.1 æ ¼å¼è§„èŒƒ

**åŸºäº Nota1 çš„è®¾è®¡ï¼Œä½¿ç”¨ YAML Front Matterï¼š**

```yaml
---
# Nota Metadata
note_id: A464F114-7334-42E8-B58C-69E82F10E461
title: æˆ‘çš„ç¬”è®°æ ‡é¢˜
tags: ["å·¥ä½œ", "é‡è¦"]
starred: false
pinned: false
created: 2023-11-09T14:30:00+08:00
updated: 2023-11-09T15:45:00+08:00
checksum: d41d8cd98f00b204e9800998ecf8427e
---

# æˆ‘çš„ç¬”è®°æ ‡é¢˜

è¿™é‡Œæ˜¯æ­£æ–‡å†…å®¹ï¼Œæ ‡å‡†çš„ Markdown æ ¼å¼...

## å°æ ‡é¢˜
- åˆ—è¡¨é¡¹1
- åˆ—è¡¨é¡¹2

**åŠ ç²—æ–‡æœ¬** å’Œ *æ–œä½“æ–‡æœ¬*
```

**æ ¼å¼è¯´æ˜**ï¼š
- **æ‰©å±•å**: `.nota`ï¼ˆä¸“æœ‰æ ¼å¼ï¼Œé¿å…å¹¶å‘å†²çªï¼‰
- **å…ƒæ•°æ®å¤´**: YAML Front Matterï¼ˆJekyllã€Hugo é€šç”¨æ ¼å¼ï¼‰
- **æ­£æ–‡**: æ ‡å‡† Markdown
- **å…¼å®¹æ€§**: å¯æ— æŸè½¬æ¢ä¸ºçº¯ `.md`ï¼ˆç§»é™¤å…ƒæ•°æ®å¤´ï¼‰

---

#### 6.2.2 å…ƒæ•°æ®å­—æ®µè¯´æ˜

| å­—æ®µ | ç±»å‹ | å¿…å¡« | è¯´æ˜ |
|-----|------|------|------|
| `note_id` | String | âœ… | UUIDï¼Œå”¯ä¸€æ ‡è¯† |
| `title` | String | âœ… | ç¬”è®°æ ‡é¢˜ |
| `tags` | Array<String> | âŒ | æ ‡ç­¾æ•°ç»„ï¼Œé»˜è®¤ `[]` |
| `starred` | Boolean | âŒ | æ˜¯å¦æ˜Ÿæ ‡ï¼Œé»˜è®¤ `false` |
| `pinned` | Boolean | âŒ | æ˜¯å¦ç½®é¡¶ï¼Œé»˜è®¤ `false` |
| `created` | ISO8601 Date | âœ… | åˆ›å»ºæ—¶é—´ |
| `updated` | ISO8601 Date | âœ… | æ›´æ–°æ—¶é—´ |
| `checksum` | String | âŒ | MD5 æ ¡éªŒå’Œ |

---

#### 6.2.3 æ–‡ä»¶å‘½åè§„åˆ™

**æ ¼å¼**: `{noteId}.nota`

**ç¤ºä¾‹**: `A464F114-7334-42E8-B58C-69E82F10E461.nota`

**ç‰¹ç‚¹**:
- ä½¿ç”¨ UUID ä½œä¸ºæ–‡ä»¶åï¼Œé¿å…æ ‡é¢˜é‡å¤å†²çª
- æ‰©å±•å `.nota` è¡¨æ˜"æ­¤æ–‡ä»¶ç”± Nota ç®¡ç†"
- å¤–éƒ¨ç¼–è¾‘å™¨ä¸ä¼šéšæ„æ‰“å¼€ï¼Œé¿å…å¹¶å‘å†²çª

---

### 6.3 æ•°æ®åº“ Schema

#### 6.3.1 è¡¨ç»“æ„

```sql
-- ç¬”è®°è¡¨
CREATE TABLE notes (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    noteId TEXT NOT NULL UNIQUE,
    title TEXT DEFAULT '',
    content TEXT DEFAULT '',
    created DATETIME NOT NULL,
    updated DATETIME NOT NULL,
    is_starred BOOLEAN DEFAULT 0,
    is_pinned BOOLEAN DEFAULT 0,
    is_deleted BOOLEAN DEFAULT 0,
    checksum TEXT
);

-- æ ‡ç­¾è¡¨ï¼ˆå¤šå¯¹å¤šå…³ç³»ï¼‰
CREATE TABLE note_tags (
    note_id TEXT NOT NULL,
    tag TEXT NOT NULL,
    PRIMARY KEY (note_id, tag),
    FOREIGN KEY (note_id) REFERENCES notes(noteId) ON DELETE CASCADE
);

-- ç´¢å¼•
CREATE INDEX idx_noteId ON notes(noteId);
CREATE INDEX idx_is_deleted ON notes(is_deleted);
CREATE INDEX idx_is_starred ON notes(is_starred);
CREATE INDEX idx_is_pinned ON notes(is_pinned);
CREATE INDEX idx_updated ON notes(updated DESC);
CREATE INDEX idx_created ON notes(created DESC);

-- å…¨æ–‡æœç´¢ç´¢å¼•ï¼ˆSQLite FTS5ï¼‰
CREATE VIRTUAL TABLE notes_fts USING fts5(
    noteId UNINDEXED,
    title,
    content,
    tokenize = 'unicode61'  -- æ”¯æŒä¸­æ–‡åˆ†è¯
);
```

---

#### 6.3.2 GRDB æ¨¡å‹å®šä¹‰

```swift
import GRDB

extension Note: FetchableRecord, PersistableRecord {
    enum Columns {
        static let id = Column("id")
        static let noteId = Column("noteId")
        static let title = Column("title")
        static let content = Column("content")
        static let created = Column("created")
        static let updated = Column("updated")
        static let isStarred = Column("is_starred")
        static let isPinned = Column("is_pinned")
        static let isDeleted = Column("is_deleted")
        static let checksum = Column("checksum")
    }
    
    static let databaseTableName = "notes"
    
    // å®šä¹‰æŒä¹…åŒ–åˆ—
    func encode(to container: inout PersistenceContainer) {
        container[Columns.id] = id
        container[Columns.noteId] = noteId
        container[Columns.title] = title
        container[Columns.content] = content
        container[Columns.created] = created
        container[Columns.updated] = updated
        container[Columns.isStarred] = isStarred
        container[Columns.isPinned] = isPinned
        container[Columns.isDeleted] = isDeleted
        container[Columns.checksum] = checksum
    }
}
```

---

### 6.4 æ–‡ä»¶ç³»ç»Ÿç»“æ„

#### 6.4.1 ç›®å½•å¸ƒå±€

```
~/Library/Containers/com.nota4.Nota4/Data/Documents/
â”œâ”€â”€ NotaLibrary/
â”‚   â”œâ”€â”€ notes/                    # æ´»è·ƒç¬”è®°ç›®å½•
â”‚   â”‚   â”œâ”€â”€ A464F114...nota      # ç¬”è®°æ–‡ä»¶
â”‚   â”‚   â”œâ”€â”€ B578C225...nota
â”‚   â”‚   â””â”€â”€ ...
â”‚   â”œâ”€â”€ trash/                    # å·²åˆ é™¤ç¬”è®°ç›®å½•ï¼ˆè½¯åˆ é™¤ï¼‰
â”‚   â”‚   â”œâ”€â”€ C689D336...nota
â”‚   â”‚   â””â”€â”€ ...
â”‚   â”œâ”€â”€ attachments/              # å›¾ç‰‡é™„ä»¶ç›®å½• â­ v1.0 å®ç°
â”‚   â”‚   â”œâ”€â”€ {noteId}/            # æŒ‰ç¬”è®° ID åˆ†ç»„
â”‚   â”‚   â”‚   â”œâ”€â”€ img_001.png      # å›¾ç‰‡æ–‡ä»¶
â”‚   â”‚   â”‚   â”œâ”€â”€ img_002.jpg
â”‚   â”‚   â”‚   â””â”€â”€ ...
â”‚   â””â”€â”€ metadata.db              # SQLite å…ƒæ•°æ®åº“
â””â”€â”€ backups/                      # æ•°æ®åº“å¤‡ä»½ï¼ˆæœªæ¥åŠŸèƒ½ï¼‰
    â”œâ”€â”€ metadata_20231109.db
    â””â”€â”€ ...
```

---

#### 6.4.2 æ–‡ä»¶æ“ä½œæ˜ å°„

| æ“ä½œ | æºç›®å½• | ç›®æ ‡ç›®å½• | æ•°æ®åº“æ“ä½œ | æ–‡ä»¶æ“ä½œ |
|-----|-------|---------|-----------|---------|
| **åˆ›å»ºç¬”è®°** | - | `notes/` | `INSERT` | åˆ›å»º `.nota` æ–‡ä»¶ |
| **æ›´æ–°ç¬”è®°** | `notes/` | `notes/` | `UPDATE` | æ›´æ–° `.nota` æ–‡ä»¶ |
| **åˆ é™¤ç¬”è®°** | `notes/` | `trash/` | `UPDATE is_deleted=1` | ç§»åŠ¨æ–‡ä»¶ |
| **æ¢å¤ç¬”è®°** | `trash/` | `notes/` | `UPDATE is_deleted=0` | ç§»åŠ¨æ–‡ä»¶ |
| **æ°¸ä¹…åˆ é™¤** | `trash/` | - | `DELETE` | åˆ é™¤æ–‡ä»¶ |
| **å¯¼å…¥ç¬”è®°** | å¤–éƒ¨ | `notes/` | `INSERT` | å¤åˆ¶å¹¶é‡å‘½å |
| **å¯¼å‡ºç¬”è®°** | `notes/` | å¤–éƒ¨ | - | å¤åˆ¶æ–‡ä»¶ |

---

#### 6.4.3 å›¾ç‰‡å¤„ç†æ–¹æ¡ˆ â­ æ–°å¢

##### 6.4.3.1 å›¾ç‰‡å­˜å‚¨ç­–ç•¥

**ç›®å½•ç»“æ„**:
```
~/Library/Containers/com.nota4.Nota4/Data/Documents/NotaLibrary/
â”œâ”€â”€ attachments/
â”‚   â”œâ”€â”€ {noteId_1}/
â”‚   â”‚   â”œâ”€â”€ img_001.png          # åŸå§‹å›¾ç‰‡
â”‚   â”‚   â”œâ”€â”€ img_002.jpg
â”‚   â”‚   â”œâ”€â”€ thumbnail_001.png    # ç¼©ç•¥å›¾ï¼ˆå¯é€‰ï¼‰
â”‚   â”‚   â””â”€â”€ thumbnail_002.jpg
â”‚   â”œâ”€â”€ {noteId_2}/
â”‚   â”‚   â””â”€â”€ img_001.png
â”‚   â””â”€â”€ ...
```

**å‘½åè§„åˆ™**:
- **å›¾ç‰‡æ–‡ä»¶**: `img_{åºå·}.{æ‰©å±•å}`ï¼ˆå¦‚ `img_001.png`ï¼‰
- **ç¼©ç•¥å›¾**: `thumbnail_{åºå·}.{æ‰©å±•å}`ï¼ˆå¯é€‰ï¼Œç”¨äºåˆ—è¡¨é¢„è§ˆï¼‰
- **åºå·è§„åˆ™**: ä» 001 å¼€å§‹é€’å¢ï¼Œç¡®ä¿å”¯ä¸€æ€§

**æ”¯æŒçš„æ ¼å¼**:
- âœ… **PNG** (.png) - æ¨èï¼Œæ— æŸå‹ç¼©
- âœ… **JPEG** (.jpg, .jpeg) - ç…§ç‰‡ç±»å›¾ç‰‡
- âœ… **GIF** (.gif) - åŠ¨å›¾æ”¯æŒ
- âœ… **WebP** (.webp) - ç°ä»£æ ¼å¼ï¼Œé«˜å‹ç¼©æ¯”
- âš ï¸ **SVG** (.svg) - å¯é€‰æ”¯æŒï¼ˆéœ€è¦é¢å¤–å¤„ç†ï¼‰

---

##### 6.4.3.2 Markdown å›¾ç‰‡è¯­æ³•

**æ ‡å‡† Markdown è¯­æ³•**:
```markdown
![å›¾ç‰‡æè¿°](attachments/{noteId}/img_001.png)
![å¦ä¸€å¼ å›¾ç‰‡](attachments/{noteId}/img_002.jpg)
```

**ç›¸å¯¹è·¯å¾„å¤„ç†**:
- Nota4 å†…éƒ¨ä½¿ç”¨ç›¸å¯¹è·¯å¾„ï¼š`attachments/{noteId}/img_001.png`
- å¯¼å‡ºæ—¶è½¬æ¢ä¸ºï¼š
  - **å¯¼å‡º .nota**: ä¿æŒç›¸å¯¹è·¯å¾„ï¼ˆé™„ä»¶ä¸€èµ·æ‰“åŒ…ï¼‰
  - **å¯¼å‡º .md**: è½¬æ¢ä¸ºç»å¯¹è·¯å¾„æˆ– Base64 å†…åµŒ
  - **å¯¼å‡º .html**: Base64 å†…åµŒæˆ–å¤–éƒ¨ URL
  - **å¯¼å‡º .pdf**: å›¾ç‰‡è‡ªåŠ¨åµŒå…¥

---

##### 6.4.3.3 å›¾ç‰‡æ’å…¥æµç¨‹

```swift
// TCA Action
enum EditorAction {
    case insertImage(URL)  // ç”¨æˆ·é€‰æ‹©çš„å›¾ç‰‡ URL
    case imageInserted(imageId: String, relativePath: String)
    case imageInsertFailed(Error)
}

// Reducer å¤„ç†
case .insertImage(let sourceURL):
    guard let noteId = state.currentNoteId else {
        return .none
    }
    
    return .run { send in
        // 1. å¤åˆ¶å›¾ç‰‡åˆ° attachments/{noteId}/ ç›®å½•
        let imageId = await environment.imageManager.copyImage(
            from: sourceURL,
            to: noteId
        )
        
        // 2. ç”Ÿæˆç›¸å¯¹è·¯å¾„
        let relativePath = "attachments/\(noteId)/\(imageId)"
        
        // 3. è¿”å›æˆåŠŸ
        await send(.imageInserted(imageId: imageId, relativePath: relativePath))
    } catch: { error, send in
        await send(.imageInsertFailed(error))
    }

case .imageInserted(let imageId, let relativePath):
    // åœ¨å…‰æ ‡ä½ç½®æ’å…¥ Markdown å›¾ç‰‡è¯­æ³•
    let markdown = "\n![å›¾ç‰‡](\(relativePath))\n"
    state.content.insert(contentsOf: markdown, at: state.cursorPosition)
    return .none
```

---

##### 6.4.3.4 å›¾ç‰‡æ˜¾ç¤ºï¼ˆç¼–è¾‘å™¨ï¼‰

**æ–¹æ¡ˆ Aï¼šçº¯æ–‡æœ¬ç¼–è¾‘å™¨**ï¼ˆæ¨èç”¨äº v1.0ï¼‰
```swift
// ç¼–è¾‘å™¨æ˜¾ç¤ºåŸå§‹ Markdown æ–‡æœ¬
TextEditor(text: $content)
    .font(.system(.body, design: .monospaced))

// ä¼˜ç‚¹ï¼š
// - ç®€å•ï¼Œä¸å½±å“ç¼–è¾‘æµç¨‹
// - ç”¨æˆ·å¯ä»¥ç›´æ¥ä¿®æ”¹å›¾ç‰‡è·¯å¾„

// ç¼ºç‚¹ï¼š
// - æ— æ³•é¢„è§ˆå›¾ç‰‡
```

**æ–¹æ¡ˆ Bï¼šå¯Œæ–‡æœ¬ç¼–è¾‘å™¨**ï¼ˆå¯é€‰ï¼Œv1.1 å®ç°ï¼‰
```swift
// ä½¿ç”¨ NSTextView + NSTextAttachment å†…åµŒå›¾ç‰‡é¢„è§ˆ
// åœ¨ç¼–è¾‘æ—¶æ˜¾ç¤ºå°ç¼©ç•¥å›¾

// ä¼˜ç‚¹ï¼š
// - æ‰€è§å³æ‰€å¾—
// - æ›´å¥½çš„ç”¨æˆ·ä½“éªŒ

// ç¼ºç‚¹ï¼š
// - å®ç°å¤æ‚
// - éœ€è¦å¤„ç†å…‰æ ‡ä½ç½®ã€é€‰åŒºç­‰
```

**æ¨è**: **v1.0 ä½¿ç”¨æ–¹æ¡ˆ Aï¼Œv1.1 å‡çº§åˆ°æ–¹æ¡ˆ B**

---

##### 6.4.3.5 å›¾ç‰‡æ¸²æŸ“ï¼ˆé¢„è§ˆï¼‰

**ä½¿ç”¨ MarkdownUI æ¸²æŸ“**:
```swift
import MarkdownUI

struct MarkdownPreview: View {
    let content: String
    let noteId: String
    
    var body: some View {
        Markdown(content)
            .markdownTheme(.gitHub)  // æˆ–è‡ªå®šä¹‰ä¸»é¢˜
            .markdownImageProvider(
                // âœ… è‡ªå®šä¹‰å›¾ç‰‡åŠ è½½å™¨
                .asset(bundle: .main)  // åŠ è½½æœ¬åœ°å›¾ç‰‡
            )
    }
}

// è‡ªå®šä¹‰å›¾ç‰‡åŠ è½½å™¨
extension ImageProvider {
    static func localAttachment(noteId: String) -> ImageProvider {
        ImageProvider { url in
            // è§£æç›¸å¯¹è·¯å¾„
            if url.hasPrefix("attachments/") {
                let fullPath = FileManager.default.urls(
                    for: .documentDirectory,
                    in: .userDomainMask
                ).first!.appendingPathComponent("NotaLibrary/\(url)")
                
                return AsyncImage(url: fullPath) { image in
                    image.resizable().scaledToFit()
                } placeholder: {
                    ProgressView()
                }
            }
            return AsyncImage(url: url)  // å¤–éƒ¨ URL
        }
    }
}
```

---

##### 6.4.3.6 å›¾ç‰‡å¯¼å‡ºå¤„ç†

| å¯¼å‡ºæ ¼å¼ | å›¾ç‰‡å¤„ç†ç­–ç•¥ | å®ç°æ–¹å¼ |
|---------|-------------|---------|
| **.nota** | ä¿æŒç›¸å¯¹è·¯å¾„ï¼Œé™„ä»¶ä¸€èµ·æ‰“åŒ… | åˆ›å»º ZIPï¼š`{ç¬”è®°å}.nota.zip`<br>åŒ…å«ï¼š`.nota` æ–‡ä»¶ + `attachments/` ç›®å½• |
| **.md** | è½¬æ¢ä¸ºç»å¯¹è·¯å¾„æˆ– Base64 | é€‰é¡¹ 1ï¼šå¯¼å‡ºé™„ä»¶ç›®å½•ï¼Œä½¿ç”¨ç»å¯¹è·¯å¾„<br>é€‰é¡¹ 2ï¼šBase64 å†…åµŒï¼ˆå•æ–‡ä»¶ï¼‰ |
| **.html** | Base64 å†…åµŒæˆ–å¤–éƒ¨èµ„æº | ä½¿ç”¨ HTML æ¨¡æ¿ï¼Œ`<img src="data:image/png;base64,...">`<br>æˆ–å¯¼å‡ºåˆ° `{ç¬”è®°å}_files/` ç›®å½• |
| **.pdf** | å›¾ç‰‡è‡ªåŠ¨åµŒå…¥ | ä½¿ç”¨ WKWebView æ¸²æŸ“ HTML å¹¶æ‰“å°ä¸º PDF |

**å¯¼å‡º .notaï¼ˆå¸¦é™„ä»¶ï¼‰ç¤ºä¾‹**:
```swift
func exportNoteWithAttachments(note: Note) async throws -> URL {
    // 1. åˆ›å»ºä¸´æ—¶ç›®å½•
    let tempDir = FileManager.default.temporaryDirectory
        .appendingPathComponent(UUID().uuidString)
    try FileManager.default.createDirectory(at: tempDir, withIntermediateDirectories: true)
    
    // 2. å¤åˆ¶ .nota æ–‡ä»¶
    let notaFile = tempDir.appendingPathComponent("\(note.title).nota")
    try note.content.write(to: notaFile, atomically: true, encoding: .utf8)
    
    // 3. å¤åˆ¶ attachments ç›®å½•
    let attachmentsDir = documentsURL
        .appendingPathComponent("NotaLibrary/attachments/\(note.noteId)")
    let destAttachments = tempDir.appendingPathComponent("attachments")
    if FileManager.default.fileExists(atPath: attachmentsDir.path) {
        try FileManager.default.copyItem(at: attachmentsDir, to: destAttachments)
    }
    
    // 4. åˆ›å»º ZIP å‹ç¼©åŒ…
    let zipURL = tempDir.deletingLastPathComponent()
        .appendingPathComponent("\(note.title).nota.zip")
    try await Zip.compress(tempDir, to: zipURL)
    
    // 5. æ¸…ç†ä¸´æ—¶ç›®å½•
    try FileManager.default.removeItem(at: tempDir)
    
    return zipURL
}
```

**å¯¼å‡º .htmlï¼ˆBase64 å†…åµŒï¼‰ç¤ºä¾‹**:
```swift
func exportToHTML(note: Note) async throws -> String {
    var html = """
    <!DOCTYPE html>
    <html>
    <head>
        <meta charset="UTF-8">
        <title>\(note.title)</title>
        <style>
            body { font-family: -apple-system, sans-serif; padding: 20px; }
            img { max-width: 100%; height: auto; }
        </style>
    </head>
    <body>
    """
    
    // è½¬æ¢ Markdown ä¸º HTMLï¼ˆä½¿ç”¨ MarkdownUI æˆ–å…¶ä»–åº“ï¼‰
    let markdownHTML = try await convertMarkdownToHTML(note.content)
    
    // æ›¿æ¢å›¾ç‰‡è·¯å¾„ä¸º Base64
    let processedHTML = try await replaceImagesWithBase64(markdownHTML, noteId: note.noteId)
    
    html += processedHTML
    html += """
    </body>
    </html>
    """
    
    return html
}

func replaceImagesWithBase64(_ html: String, noteId: String) async throws -> String {
    var result = html
    
    // æ­£åˆ™åŒ¹é… <img src="attachments/...">
    let pattern = #"<img src="attachments/\#(noteId)/([^"]+)""#
    let regex = try NSRegularExpression(pattern: pattern)
    
    let matches = regex.matches(in: html, range: NSRange(html.startIndex..., in: html))
    
    for match in matches.reversed() {
        guard let imagePathRange = Range(match.range(at: 1), in: html) else { continue }
        let imagePath = String(html[imagePathRange])
        
        // è¯»å–å›¾ç‰‡å¹¶è½¬æ¢ä¸º Base64
        let imageURL = documentsURL
            .appendingPathComponent("NotaLibrary/attachments/\(noteId)/\(imagePath)")
        let imageData = try Data(contentsOf: imageURL)
        let base64 = imageData.base64EncodedString()
        
        // æ›¿æ¢ä¸º Base64 å†…åµŒ
        let mimeType = getMimeType(for: imagePath)
        let base64Src = "data:\(mimeType);base64,\(base64)"
        result.replaceSubrange(match.range, with: base64Src)
    }
    
    return result
}
```

---

##### 6.4.3.7 å›¾ç‰‡ç®¡ç†

**ImageManager æ¥å£**:
```swift
protocol ImageManagerProtocol {
    // å¤åˆ¶å›¾ç‰‡åˆ°é™„ä»¶ç›®å½•
    func copyImage(from sourceURL: URL, to noteId: String) async throws -> String  // è¿”å› imageId
    
    // åˆ é™¤ç¬”è®°çš„æ‰€æœ‰å›¾ç‰‡
    func deleteImages(forNote noteId: String) async throws
    
    // è·å–å›¾ç‰‡çš„æœ¬åœ° URL
    func getImageURL(noteId: String, imageId: String) -> URL
    
    // æ¸…ç†æœªä½¿ç”¨çš„å›¾ç‰‡ï¼ˆåƒåœ¾å›æ”¶ï¼‰
    func cleanupUnusedImages() async throws
}
```

---

##### 6.4.3.8 æ€§èƒ½ä¼˜åŒ–

**ç¼©ç•¥å›¾ç”Ÿæˆ**ï¼ˆå¯é€‰ï¼Œv1.1 å®ç°ï¼‰:
```swift
func generateThumbnail(for imageURL: URL) async throws -> URL {
    let thumbnailSize = CGSize(width: 200, height: 200)
    
    guard let image = NSImage(contentsOf: imageURL) else {
        throw ImageError.invalidImage
    }
    
    let thumbnail = image.resized(to: thumbnailSize)
    let thumbnailURL = imageURL.deletingLastPathComponent()
        .appendingPathComponent("thumbnail_\(imageURL.lastPathComponent)")
    
    try thumbnail.pngData()?.write(to: thumbnailURL)
    
    return thumbnailURL
}
```

**æ‡’åŠ è½½**:
```swift
// é¢„è§ˆæ¨¡å¼ä¸‹æ‡’åŠ è½½å›¾ç‰‡
AsyncImage(url: imageURL) { phase in
    switch phase {
    case .empty:
        ProgressView()
    case .success(let image):
        image.resizable().scaledToFit()
    case .failure:
        Image(systemName: "photo")
            .foregroundColor(.gray)
    @unknown default:
        EmptyView()
    }
}
.frame(maxWidth: .infinity)
.frame(height: 300)
```

---

##### 6.4.3.9 æ•°æ®ä¸€è‡´æ€§

**å›¾ç‰‡ä¸ç¬”è®°ç”Ÿå‘½å‘¨æœŸç»‘å®š**:
```swift
// åˆ é™¤ç¬”è®°æ—¶
case .deleteNote(let noteId):
    return .run { send in
        // 1. ç§»åŠ¨ç¬”è®°æ–‡ä»¶åˆ° trash/
        try await environment.noteRepository.deleteNote(noteId)
        
        // 2. ç§»åŠ¨å›¾ç‰‡ç›®å½•åˆ° trash_attachments/
        try await environment.imageManager.moveImagesToTrash(noteId)
        
        await send(.noteDeleted)
    }

// æ°¸ä¹…åˆ é™¤ç¬”è®°æ—¶
case .permanentlyDeleteNote(let noteId):
    return .run { send in
        // 1. åˆ é™¤ç¬”è®°æ–‡ä»¶
        try await environment.noteRepository.permanentlyDeleteNote(noteId)
        
        // 2. åˆ é™¤å›¾ç‰‡ç›®å½•
        try await environment.imageManager.deleteImages(forNote: noteId)
        
        await send(.noteDeleted)
    }
```

---

### 6.5 æ•°æ®åŒæ­¥ç­–ç•¥

#### 6.5.1 åŒå†™æœºåˆ¶

**æ ¸å¿ƒåŸåˆ™**: **æ–‡ä»¶æ˜¯"çœŸç†ä¹‹æº"ï¼Œæ•°æ®åº“æ˜¯"æ€§èƒ½ç¼“å­˜"**

```
å†™å…¥æ“ä½œ:
1. æ›´æ–° .nota æ–‡ä»¶å†…å®¹ï¼ˆæ­£æ–‡ï¼‰
2. æ›´æ–° .nota æ–‡ä»¶çš„ YAML å…ƒæ•°æ®å¤´
3. åŒæ­¥æ›´æ–°æ•°æ®åº“è®°å½•
4. è®¡ç®—å¹¶æ›´æ–° checksum

è¯»å–æ“ä½œ:
1. ä»æ•°æ®åº“è¯»å–å…ƒæ•°æ®ï¼ˆå¿«é€Ÿï¼‰
2. ä»æ–‡ä»¶è¯»å–å®Œæ•´å†…å®¹ï¼ˆæŒ‰éœ€ï¼‰
3. æ ¡éªŒ checksumï¼ˆæ£€æµ‹å¤–éƒ¨ä¿®æ”¹ï¼‰
```

---

#### 6.5.2 æ•°æ®ä¸€è‡´æ€§ä¿è¯

```swift
// TCA Effect å®ç°
case .autoSave:
    guard state.hasUnsavedChanges, let note = state.note else {
        return .none
    }
    
    state.isSaving = true
    let updatedNote = Note(/* æ›´æ–°å­—æ®µ */)
    
    return .run { send in
        // âœ… Step 1: æ›´æ–°æ•°æ®åº“
        try await environment.noteRepository.updateNote(updatedNote)
        
        // âœ… Step 2: æ›´æ–°æ–‡ä»¶
        try await environment.fileManager.updateNoteFile(updatedNote)
        
        // âœ… Step 3: æ›´æ–°å…¨æ–‡æœç´¢ç´¢å¼•
        try await environment.noteRepository.updateFTS(updatedNote)
        
        await send(.saveCompleted, animation: .spring())
    } catch: { error, send in
        // âŒ å›æ»šé€»è¾‘
        print("ä¿å­˜å¤±è´¥: \(error)")
        await send(.saveFailed(error))
    }
```

---

#### 6.5.3 å†²çªå¤„ç†ç­–ç•¥

| åœºæ™¯ | æ£€æµ‹æ–¹å¼ | å¤„ç†ç­–ç•¥ |
|-----|---------|---------|
| **å¤–éƒ¨ä¿®æ”¹æ–‡ä»¶** | Checksum ä¸åŒ¹é… | æç¤ºç”¨æˆ·é€‰æ‹©ï¼ˆä¿ç•™æœ¬åœ°/ä½¿ç”¨æ–‡ä»¶ï¼‰ |
| **æ–‡ä»¶ç¼ºå¤±** | æ–‡ä»¶ä¸å­˜åœ¨ | ä»æ•°æ®åº“ content å­—æ®µæ¢å¤ |
| **æ•°æ®åº“æ— è®°å½•** | æ•°æ®åº“æŸ¥è¯¢ä¸ºç©º | ä»æ–‡ä»¶å¯¼å…¥åˆ°æ•°æ®åº“ |
| **ç§»åŠ¨æ–‡ä»¶å†²çª** | ç›®æ ‡æ–‡ä»¶å·²å­˜åœ¨ | åˆ é™¤ç›®æ ‡åå†ç§»åŠ¨ |

---

### 6.6 NoteRepository è®¾è®¡

#### 6.6.1 æ¥å£å®šä¹‰

```swift
protocol NoteRepositoryProtocol {
    // åŸºæœ¬ CRUD
    func createNote(_ note: Note) async throws
    func fetchNote(byId noteId: String) async throws -> Note
    func fetchNotes(filter: NoteListState.Filter) async throws -> [Note]
    func updateNote(_ note: Note) async throws
    func deleteNote(byId noteId: String) async throws
    func permanentlyDeleteNote(byId noteId: String) async throws
    
    // æ‰¹é‡æ“ä½œ
    func deleteNotes(_ noteIds: Set<String>) async throws
    func restoreNotes(_ noteIds: Set<String>) async throws
    func permanentlyDeleteNotes(_ noteIds: Set<String>) async throws
    
    // æ ‡ç­¾æ“ä½œ
    func fetchAllTags() async throws -> [SidebarState.Tag]
    func addTag(_ tag: String, to noteId: String) async throws
    func removeTag(_ tag: String, from noteId: String) async throws
    
    // æœç´¢
    func searchNotes(keyword: String) async throws -> [Note]
    func updateFTS(_ note: Note) async throws
}
```

---

#### 6.6.2 GRDB å®ç°ç¤ºä¾‹

```swift
struct NoteRepository: NoteRepositoryProtocol {
    let dbQueue: DatabaseQueue
    
    func fetchNotes(filter: NoteListState.Filter) async throws -> [Note] {
        try await dbQueue.read { db in
            var request = Note.all()
            
            switch filter {
            case .none:
                request = request.filter(Note.Columns.isDeleted == false)
            case .category(let category):
                switch category {
                case .all:
                    request = request.filter(Note.Columns.isDeleted == false)
                case .starred:
                    request = request
                        .filter(Note.Columns.isStarred == true)
                        .filter(Note.Columns.isDeleted == false)
                case .trash:
                    request = request.filter(Note.Columns.isDeleted == true)
                }
            case .tags(let tags):
                // æ ‡ç­¾è¿‡æ»¤ï¼ˆJOIN note_tags è¡¨ï¼‰
                request = request
                    .joining(required: Note.tagAssociation.filter(tags.contains(Column("tag"))))
                    .filter(Note.Columns.isDeleted == false)
            case .search(let keyword):
                // å…¨æ–‡æœç´¢
                let pattern = FTS5Pattern(matchingAnyTokenIn: keyword)
                request = Note
                    .matching(pattern)
                    .filter(Note.Columns.isDeleted == false)
            }
            
            // æ’åºï¼šç½®é¡¶ä¼˜å…ˆï¼Œç„¶åæŒ‰æ›´æ–°æ—¶é—´
            request = request
                .order(Note.Columns.isPinned.desc, Note.Columns.updated.desc)
            
            return try request.fetchAll(db)
        }
    }
    
    func searchNotes(keyword: String) async throws -> [Note] {
        try await dbQueue.read { db in
            let pattern = FTS5Pattern(matchingAnyTokenIn: keyword)
            return try Note
                .matching(pattern)
                .filter(Note.Columns.isDeleted == false)
                .order(Note.Columns.updated.desc)
                .fetchAll(db)
        }
    }
}
```

---

### 6.7 NotaFileManager è®¾è®¡

#### 6.7.1 æ¥å£å®šä¹‰

```swift
protocol NotaFileManagerProtocol {
    // æ–‡ä»¶ CRUD
    func createNoteFile(_ note: Note) async throws
    func readNoteFile(noteId: String) async throws -> String
    func updateNoteFile(_ note: Note) async throws
    func deleteNoteFile(noteId: String) async throws
    
    // æ–‡ä»¶ç§»åŠ¨
    func moveToTrash(noteId: String) async throws
    func restoreFromTrash(noteId: String) async throws
    
    // å¯¼å…¥/å¯¼å‡º
    func importFile(from url: URL) async throws -> Note
    func exportFile(note: Note, to url: URL) async throws
    
    // å·¥å…·æ–¹æ³•
    func calculateChecksum(content: String) -> String
    func parseNotaFile(content: String) -> (metadata: [String: Any], body: String)
    func generateNotaFile(note: Note) -> String
}
```

---

#### 6.7.2 YAML è§£æå®ç°

```swift
import Yams  // Swift YAML åº“

struct NotaFileManager: NotaFileManagerProtocol {
    let notesDirectory: URL
    let trashDirectory: URL
    
    func parseNotaFile(content: String) -> (metadata: [String: Any], body: String) {
        // æå– YAML Front Matter
        let pattern = #"^---\n(.*?)\n---\n(.*)"#
        let regex = try! NSRegularExpression(pattern: pattern, options: [.dotMatchesLineSeparators])
        
        guard let match = regex.firstMatch(in: content, range: NSRange(content.startIndex..., in: content)),
              let yamlRange = Range(match.range(at: 1), in: content),
              let bodyRange = Range(match.range(at: 2), in: content) else {
            // æ— å…ƒæ•°æ®å¤´ï¼Œæ•´ä¸ªå†…å®¹ä½œä¸ºæ­£æ–‡
            return (metadata: [:], body: content)
        }
        
        let yamlString = String(content[yamlRange])
        let body = String(content[bodyRange])
        
        let metadata = try? Yams.load(yaml: yamlString) as? [String: Any] ?? [:]
        
        return (metadata: metadata ?? [:], body: body)
    }
    
    func generateNotaFile(note: Note) -> String {
        // ç”Ÿæˆ YAML Front Matter
        let yaml = """
        ---
        note_id: \(note.noteId)
        title: "\(note.title.replacingOccurrences(of: "\"", with: "\\\""))"
        tags: [\(note.tags.map { "\"\($0)\"" }.joined(separator: ", "))]
        starred: \(note.isStarred)
        pinned: \(note.isPinned)
        created: \(ISO8601DateFormatter().string(from: note.created))
        updated: \(ISO8601DateFormatter().string(from: note.updated))
        checksum: \(calculateChecksum(content: note.content))
        ---

        \(note.content)
        """
        
        return yaml
    }
    
    func calculateChecksum(content: String) -> String {
        // MD5 æ ¡éªŒå’Œ
        import CryptoKit
        let data = Data(content.utf8)
        let hash = Insecure.MD5.hash(data: data)
        return hash.map { String(format: "%02x", $0) }.joined()
    }
}
```

---

### ğŸ¤” **ç¬¬å…­æ­¥ç¡®è®¤ç‚¹**

è¯·ç¡®è®¤æˆ–è¡¥å……ï¼š
1. âœ… `.nota` æ–‡ä»¶æ ¼å¼ï¼ˆYAML Front Matterï¼‰æ˜¯å¦åˆé€‚ï¼Ÿ
2. âœ… æ•°æ®åº“ Schema æ˜¯å¦å®Œæ•´ï¼ˆæ˜¯å¦éœ€è¦å…¶ä»–å­—æ®µï¼‰ï¼Ÿ
3. âœ… æ–‡ä»¶ç³»ç»Ÿç»“æ„æ˜¯å¦åˆç†ï¼Ÿ
4. âœ… æ•°æ®åŒæ­¥ç­–ç•¥ï¼ˆåŒå†™æœºåˆ¶ï¼‰æ˜¯å¦æ¸…æ™°ï¼Ÿ
5. ğŸ¤” æ˜¯å¦éœ€è¦æ·»åŠ é™„ä»¶ç®¡ç†åŠŸèƒ½ï¼ˆå›¾ç‰‡ã€PDF ç­‰ï¼‰ï¼Ÿ

**è¯·å›å¤ "ç¡®è®¤ç¬¬å…­æ­¥" æˆ–æå‡ºä¿®æ”¹æ„è§ï¼Œæˆ‘å°†ç»§ç»­ç¬¬ä¸ƒæ­¥ï¼šäº¤äº’è®¾è®¡ã€‚**

---

## ç¬¬ä¸ƒæ­¥ï¼šäº¤äº’è®¾è®¡

### 7.1 èœå•æ è®¾è®¡

#### 7.1.1 Nota4 èœå•

```swift
CommandGroup(replacing: .appInfo) {
    Button("å…³äº Nota4") {
        viewStore.send(.showAbout)
    }
}

CommandGroup(replacing: .appSettings) {
    Button("åå¥½è®¾ç½®...") {
        viewStore.send(.showSettings)
    }
    .keyboardShortcut(",")
}
```

**èœå•é¡¹**:
```
Nota4
â”œâ”€ å…³äº Nota4
â”œâ”€ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
â”œâ”€ åå¥½è®¾ç½®...       âŒ˜,
â”œâ”€ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
â”œâ”€ éšè— Nota4        âŒ˜H
â”œâ”€ éšè—å…¶ä»–          âŒ¥âŒ˜H
â”œâ”€ æ˜¾ç¤ºå…¨éƒ¨
â”œâ”€ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
â””â”€ é€€å‡º Nota4        âŒ˜Q
```

---

#### 7.1.2 æ–‡ä»¶èœå•

```swift
CommandGroup(replacing: .newItem) {
    Button("æ–°å»ºç¬”è®°") {
        viewStore.send(.editor(.createNote))
    }
    .keyboardShortcut("n")
    
    Button("å¯¼å…¥ç¬”è®°...") {
        viewStore.send(.importNote)
    }
    .keyboardShortcut("o")
}

CommandGroup(replacing: .saveItem) {
    Button("ä¿å­˜") {
        viewStore.send(.editor(.manualSave))
    }
    .keyboardShortcut("s")
    .disabled(!viewStore.editor.hasUnsavedChanges)
}

CommandMenu("å¯¼å‡º") {
    Button("å¯¼å‡ºä¸º .nota") {
        viewStore.send(.exportNote(format: .nota))
    }
    
    Button("å¯¼å‡ºä¸º .md") {
        viewStore.send(.exportNote(format: .markdown))
    }
    
    Button("å¯¼å‡ºä¸º .html") {
        viewStore.send(.exportNote(format: .html))
    }
    
    Button("å¯¼å‡ºä¸º PDF...") {
        viewStore.send(.exportNote(format: .pdf))
    }
    .keyboardShortcut("p", modifiers: [.shift, .command])
}
```

**å®Œæ•´èœå•**:
```
æ–‡ä»¶
â”œâ”€ æ–°å»ºç¬”è®°          âŒ˜N
â”œâ”€ å¯¼å…¥ç¬”è®°...       âŒ˜O
â”œâ”€ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
â”œâ”€ ä¿å­˜             âŒ˜S
â”œâ”€ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
â”œâ”€ å¯¼å‡º
â”‚  â”œâ”€ å¯¼å‡ºä¸º .nota
â”‚  â”œâ”€ å¯¼å‡ºä¸º .md
â”‚  â”œâ”€ å¯¼å‡ºä¸º .html
â”‚  â””â”€ å¯¼å‡ºä¸º PDF...  â‡§âŒ˜P
â”œâ”€ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
â”œâ”€ åˆ é™¤ç¬”è®°         âŒ˜âŒ«
â””â”€ å…³é—­çª—å£         âŒ˜W
```

---

#### 7.1.3 ç¼–è¾‘èœå•

```swift
CommandGroup(after: .pasteboard) {
    Divider()
    
    Menu("æ’å…¥ Markdown") {
        ForEach(1...6, id: \.self) { level in
            Button("æ ‡é¢˜ H\(level)") {
                viewStore.send(.editor(.insertMarkdown(.heading(level: level))))
            }
        }
        
        Divider()
        
        Button("åŠ ç²—") {
            viewStore.send(.editor(.insertMarkdown(.bold)))
        }
        .keyboardShortcut("b")
        
        Button("æ–œä½“") {
            viewStore.send(.editor(.insertMarkdown(.italic)))
        }
        .keyboardShortcut("i")
        
        Divider()
        
        Button("ä»£ç å—") {
            viewStore.send(.editor(.insertMarkdown(.codeBlock)))
        }
        
        Button("æ— åºåˆ—è¡¨") {
            viewStore.send(.editor(.insertMarkdown(.unorderedList)))
        }
        
        Button("æœ‰åºåˆ—è¡¨") {
            viewStore.send(.editor(.insertMarkdown(.orderedList)))
        }
        
        Divider()
        
        Button("æ’å…¥é“¾æ¥") {
            viewStore.send(.editor(.insertMarkdown(.link)))
        }
        .keyboardShortcut("k")
        
        Button("æ’å…¥å›¾ç‰‡") {
            viewStore.send(.editor(.insertMarkdown(.image)))
        }
    }
}
```

**å®Œæ•´èœå•**:
```
ç¼–è¾‘
â”œâ”€ æ’¤é”€            âŒ˜Z
â”œâ”€ é‡åš            â‡§âŒ˜Z
â”œâ”€ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
â”œâ”€ å‰ªåˆ‡            âŒ˜X
â”œâ”€ å¤åˆ¶            âŒ˜C
â”œâ”€ ç²˜è´´            âŒ˜V
â”œâ”€ å…¨é€‰            âŒ˜A
â”œâ”€ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
â”œâ”€ æŸ¥æ‰¾            âŒ˜F
â”œâ”€ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
â””â”€ æ’å…¥ Markdown
   â”œâ”€ æ ‡é¢˜ H1-H6
   â”œâ”€ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   â”œâ”€ åŠ ç²—          âŒ˜B
   â”œâ”€ æ–œä½“          âŒ˜I
   â”œâ”€ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   â”œâ”€ ä»£ç å—
   â”œâ”€ æ— åºåˆ—è¡¨
   â”œâ”€ æœ‰åºåˆ—è¡¨
   â”œâ”€ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   â”œâ”€ æ’å…¥é“¾æ¥      âŒ˜K
   â””â”€ æ’å…¥å›¾ç‰‡
```

---

#### 7.1.4 æŸ¥çœ‹èœå•

```swift
CommandGroup(after: .sidebar) {
    Divider()
    
    Picker("è§†å›¾æ¨¡å¼", selection: viewStore.binding(\.$editor.viewMode)) {
        Label("ä»…ç¼–è¾‘", systemImage: "pencil").tag(EditorState.ViewMode.editOnly)
        Label("ä»…é¢„è§ˆ", systemImage: "eye").tag(EditorState.ViewMode.previewOnly)
        Label("åˆ†å±", systemImage: "rectangle.split.2x1").tag(EditorState.ViewMode.split)
    }
    
    Divider()
    
    Button("åˆ·æ–°åˆ—è¡¨") {
        viewStore.send(.noteList(.loadNotes))
    }
    .keyboardShortcut("r")
}
```

**å®Œæ•´èœå•**:
```
æŸ¥çœ‹
â”œâ”€ æ˜¾ç¤º/éšè—ä¾§è¾¹æ    âŒ˜âŒƒS
â”œâ”€ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
â”œâ”€ è§†å›¾æ¨¡å¼
â”‚  â”œâ”€ ä»…ç¼–è¾‘
â”‚  â”œâ”€ ä»…é¢„è§ˆ
â”‚  â””â”€ åˆ†å±
â”œâ”€ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
â”œâ”€ åˆ·æ–°åˆ—è¡¨         âŒ˜R
â””â”€ è¿›å…¥å…¨å±         âŒƒâŒ˜F
```

---

#### 7.1.5 ç¬”è®°èœå•ï¼ˆæ–°å¢ï¼‰

```swift
CommandMenu("ç¬”è®°") {
    Button("æ˜Ÿæ ‡ç¬”è®°") {
        viewStore.send(.noteList(.toggleStar(viewStore.editor.selectedNoteId!)))
    }
    .keyboardShortcut("s", modifiers: [.shift, .command])
    .disabled(viewStore.editor.selectedNoteId == nil)
    
    Button("ç½®é¡¶ç¬”è®°") {
        viewStore.send(.noteList(.togglePin(viewStore.editor.selectedNoteId!)))
    }
    .keyboardShortcut("p", modifiers: [.shift, .command])
    .disabled(viewStore.editor.selectedNoteId == nil)
    
    Divider()
    
    Menu("æ·»åŠ æ ‡ç­¾") {
        ForEach(viewStore.sidebar.tags) { tag in
            Button(tag.name) {
                viewStore.send(.addTag(tag.name))
            }
        }
        
        Divider()
        
        Button("æ–°å»ºæ ‡ç­¾...") {
            viewStore.send(.showNewTagDialog)
        }
    }
    
    Divider()
    
    Button("ç§»è‡³åºŸçº¸ç¯“") {
        viewStore.send(.noteList(.deleteNotes([viewStore.editor.selectedNoteId!])))
    }
    .keyboardShortcut(.delete)
    .disabled(viewStore.editor.selectedNoteId == nil)
}
```

**å®Œæ•´èœå•**:
```
ç¬”è®°
â”œâ”€ æ˜Ÿæ ‡ç¬”è®°         â‡§âŒ˜S
â”œâ”€ ç½®é¡¶ç¬”è®°         â‡§âŒ˜P
â”œâ”€ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
â”œâ”€ æ·»åŠ æ ‡ç­¾
â”‚  â”œâ”€ å·¥ä½œ
â”‚  â”œâ”€ å­¦ä¹ 
â”‚  â”œâ”€ ç”Ÿæ´»
â”‚  â”œâ”€ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
â”‚  â””â”€ æ–°å»ºæ ‡ç­¾...
â”œâ”€ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
â””â”€ ç§»è‡³åºŸçº¸ç¯“       âŒ˜âŒ«
```

---

### 7.2 å¿«æ·é”®æ±‡æ€»

| åˆ†ç±» | åŠŸèƒ½ | å¿«æ·é”® | TCA Action |
|-----|------|--------|-----------|
| **ç¬”è®°æ“ä½œ** |
| | æ–°å»ºç¬”è®° | `âŒ˜N` | `.editor(.createNote)` |
| | ä¿å­˜ç¬”è®° | `âŒ˜S` | `.editor(.manualSave)` |
| | åˆ é™¤ç¬”è®° | `âŒ˜âŒ«` | `.noteList(.deleteNotes)` |
| | å¯¼å…¥ç¬”è®° | `âŒ˜O` | `.importNote` |
| | æ˜Ÿæ ‡ç¬”è®° | `â‡§âŒ˜S` | `.noteList(.toggleStar)` |
| | ç½®é¡¶ç¬”è®° | `â‡§âŒ˜P` | `.noteList(.togglePin)` |
| **ç¼–è¾‘æ“ä½œ** |
| | æ’¤é”€ | `âŒ˜Z` | ç³»ç»Ÿå¤„ç† |
| | é‡åš | `â‡§âŒ˜Z` | ç³»ç»Ÿå¤„ç† |
| | å‰ªåˆ‡ | `âŒ˜X` | ç³»ç»Ÿå¤„ç† |
| | å¤åˆ¶ | `âŒ˜C` | ç³»ç»Ÿå¤„ç† |
| | ç²˜è´´ | `âŒ˜V` | ç³»ç»Ÿå¤„ç† |
| | å…¨é€‰ | `âŒ˜A` | ç³»ç»Ÿå¤„ç† |
| | æŸ¥æ‰¾ | `âŒ˜F` | `.toggleSearch` |
| **Markdown æ ¼å¼** |
| | åŠ ç²— | `âŒ˜B` | `.editor(.insertMarkdown(.bold))` |
| | æ–œä½“ | `âŒ˜I` | `.editor(.insertMarkdown(.italic))` |
| | æ’å…¥é“¾æ¥ | `âŒ˜K` | `.editor(.insertMarkdown(.link))` |
| **å¯¼å‡º** |
| | å¯¼å‡º PDF | `â‡§âŒ˜P` | `.exportNote(.pdf)` |
| **æŸ¥çœ‹** |
| | åˆ·æ–°åˆ—è¡¨ | `âŒ˜R` | `.noteList(.loadNotes)` |
| | åˆ‡æ¢ä¾§è¾¹æ  | `âŒ˜âŒƒS` | ç³»ç»Ÿå¤„ç† |
| | å…¨å± | `âŒƒâŒ˜F` | ç³»ç»Ÿå¤„ç† |
| **çª—å£** |
| | å…³é—­çª—å£ | `âŒ˜W` | ç³»ç»Ÿå¤„ç† |
| | æœ€å°åŒ– | `âŒ˜M` | ç³»ç»Ÿå¤„ç† |
| **åº”ç”¨** |
| | åå¥½è®¾ç½® | `âŒ˜,` | `.showSettings` |
| | éšè—åº”ç”¨ | `âŒ˜H` | ç³»ç»Ÿå¤„ç† |
| | é€€å‡ºåº”ç”¨ | `âŒ˜Q` | ç³»ç»Ÿå¤„ç† |

---

### 7.3 æ‹–æ‹½äº¤äº’

#### 7.3.1 æ‹–æ‹½å¯¼å…¥ç¬”è®°

```swift
struct NoteListView: View {
    let store: StoreOf<NoteListFeature>
    
    var body: some View {
        WithViewStore(store) { viewStore in
            List { /* ... */ }
                .onDrop(of: [.fileURL], isTargeted: nil) { providers in
                    handleDrop(providers: providers, viewStore: viewStore)
                }
        }
    }
    
    private func handleDrop(providers: [NSItemProvider], viewStore: ViewStore<NoteListState, NoteListAction>) -> Bool {
        for provider in providers {
            provider.loadItem(forTypeIdentifier: "public.file-url", options: nil) { (urlData, error) in
                guard let urlData = urlData as? Data,
                      let url = URL(dataRepresentation: urlData, relativeTo: nil) else {
                    return
                }
                
                // æ£€æŸ¥æ–‡ä»¶æ‰©å±•å
                let ext = url.pathExtension.lowercased()
                if ext == "nota" || ext == "md" || ext == "markdown" {
                    viewStore.send(.importFile(url))
                }
            }
        }
        return true
    }
}
```

**æ”¯æŒçš„æ–‡ä»¶ç±»å‹**:
- `.nota` æ–‡ä»¶
- `.md` / `.markdown` æ–‡ä»¶
- çº¯æ–‡æœ¬æ–‡ä»¶

---

#### 7.3.2 æ‹–æ‹½ç¬”è®°æ’åºï¼ˆæœªæ¥åŠŸèƒ½ï¼‰

```swift
// ğŸ”® æœªæ¥åŠŸèƒ½ï¼šæ‰‹åŠ¨æ’åº
List(viewStore.notes, selection: $selectedNotes) { note in
    NoteRowView(note: note)
        .onDrag {
            NSItemProvider(object: note.noteId as NSString)
        }
}
```

---

### 7.4 Touch Bar æ”¯æŒï¼ˆå¯é€‰ï¼‰

```swift
struct NoteEditorView: View {
    var body: some View {
        // ...
        .touchBar {
            HStack {
                Button(action: { viewStore.send(.insertMarkdown(.bold)) }) {
                    Label("ç²—ä½“", systemImage: "bold")
                }
                
                Button(action: { viewStore.send(.insertMarkdown(.italic)) }) {
                    Label("æ–œä½“", systemImage: "italic")
                }
                
                Button(action: { viewStore.send(.insertMarkdown(.link)) }) {
                    Label("é“¾æ¥", systemImage: "link")
                }
                
                Divider()
                
                Picker("è§†å›¾", selection: viewStore.binding(\.$viewMode)) {
                    Label("ç¼–è¾‘", systemImage: "pencil").tag(ViewMode.editOnly)
                    Label("é¢„è§ˆ", systemImage: "eye").tag(ViewMode.previewOnly)
                    Label("åˆ†å±", systemImage: "rectangle.split.2x1").tag(ViewMode.split)
                }
            }
        }
    }
}
```

---

### 7.5 Spotlight é›†æˆï¼ˆæœªæ¥åŠŸèƒ½ï¼‰

```swift
// ğŸ”® æœªæ¥åŠŸèƒ½ï¼šSpotlight æœç´¢
import CoreSpotlight

func indexNoteForSpotlight(_ note: Note) {
    let attributeSet = CSSearchableItemAttributeSet(contentType: .text)
    attributeSet.title = note.title
    attributeSet.contentDescription = note.preview
    attributeSet.keywords = Array(note.tags)
    attributeSet.contentModificationDate = note.updated
    
    let item = CSSearchableItem(
        uniqueIdentifier: note.noteId,
        domainIdentifier: "com.nota4.notes",
        attributeSet: attributeSet
    )
    
    CSSearchableIndex.default().indexSearchableItems([item]) { error in
        if let error = error {
            print("Spotlight ç´¢å¼•å¤±è´¥: \(error)")
        }
    }
}
```

---

### 7.6 æ‰‹åŠ¿äº¤äº’

| æ‰‹åŠ¿ | åŒºåŸŸ | åŠŸèƒ½ | å®ç° |
|-----|------|------|------|
| **å•å‡»** | ç¬”è®°åˆ—è¡¨ | é€‰ä¸­ç¬”è®° | `List` è‡ªåŠ¨å¤„ç† |
| **åŒå‡»** | ç¬”è®°åˆ—è¡¨ | ï¼ˆæœªå®šä¹‰ï¼‰ | - |
| **å³é”®** | ç¬”è®°åˆ—è¡¨ | æ˜¾ç¤ºä¸Šä¸‹æ–‡èœå• | `.contextMenu` |
| **å³é”®** | ç¼–è¾‘å™¨ | æ˜¾ç¤º Markdown èœå• | `.contextMenu` |
| **ä¸‰æŒ‡è½»æ‰«** | ç¼–è¾‘å™¨ | åˆ‡æ¢é¢„è§ˆæ¨¡å¼ | ï¼ˆæœªå®ç°ï¼‰ |
| **æåˆç¼©æ”¾** | ç¼–è¾‘å™¨ | è°ƒæ•´å­—ä½“å¤§å° | ï¼ˆæœªå®ç°ï¼‰ |

---

### ğŸ¤” **ç¬¬ä¸ƒæ­¥ç¡®è®¤ç‚¹**

è¯·ç¡®è®¤æˆ–è¡¥å……ï¼š
1. âœ… èœå•æ è®¾è®¡æ˜¯å¦å®Œæ•´ï¼Ÿ
2. âœ… å¿«æ·é”®åˆ†é…æ˜¯å¦åˆç†ï¼Ÿ
3. âœ… æ‹–æ‹½äº¤äº’æ˜¯å¦æ»¡è¶³éœ€æ±‚ï¼Ÿ
4. ğŸ¤” æ˜¯å¦éœ€è¦æ·»åŠ  Touch Bar æ”¯æŒï¼Ÿ
5. ğŸ¤” æ˜¯å¦éœ€è¦ Spotlight é›†æˆï¼ˆv2.1 å®ç°ï¼‰ï¼Ÿ

---

## ç¬¬å…«æ­¥ï¼šå®æ–½è·¯çº¿å›¾

### 8.1 MVP åŠŸèƒ½å®šä¹‰ï¼ˆv1.0.0ï¼‰

#### 8.1.1 æ ¸å¿ƒåŠŸèƒ½ï¼ˆå¿…é¡»ï¼‰

| æ¨¡å— | åŠŸèƒ½ | ä¼˜å…ˆçº§ | é¢„è®¡æ—¶é—´ |
|-----|------|--------|---------|
| **ç¬”è®°ç®¡ç†** | åˆ›å»ºã€ç¼–è¾‘ã€åˆ é™¤ã€æ¢å¤ | P0 | 3 å¤© |
| **ç¬”è®°åˆ—è¡¨** | æ˜¾ç¤ºã€æœç´¢ã€æ’åºã€è¿‡æ»¤ | P0 | 3 å¤© |
| **ç¼–è¾‘å™¨** | Markdown ç¼–è¾‘ã€è‡ªåŠ¨ä¿å­˜ | P0 | 2 å¤© |
| **é¢„è§ˆ** | Markdown æ¸²æŸ“ï¼ˆMarkdownUIï¼‰ | P0 | 2 å¤© |
| **åˆ†æ å¸ƒå±€** | NavigationSplitView | P0 | 1 å¤© |
| **æ•°æ®åº“** | GRDB + SQLite | P0 | 2 å¤© |
| **æ–‡ä»¶ç³»ç»Ÿ** | .nota æ ¼å¼è¯»å†™ | P0 | 2 å¤© |
| **çŠ¶æ€ç®¡ç†** | TCA æ¶æ„æ­å»º | P0 | 3 å¤© |
| **æµ‹è¯•** | æ ¸å¿ƒ Reducer æµ‹è¯• | P0 | 2 å¤© |

**MVP æ€»è®¡**: **20 å¤©**

---

#### 8.1.2 è¾…åŠ©åŠŸèƒ½ï¼ˆå¯é€‰ï¼‰

| åŠŸèƒ½ | ä¼˜å…ˆçº§ | é¢„è®¡æ—¶é—´ | è§„åˆ’ç‰ˆæœ¬ |
|-----|--------|---------|---------|
| æ˜Ÿæ ‡ç¬”è®° | P1 | 0.5 å¤© | v1.0.0 |
| ç½®é¡¶ç¬”è®° | P1 | 0.5 å¤© | v1.0.0 |
| å³é”®èœå• | P1 | 1 å¤© | v1.0.0 |
| å¯¼å…¥ .md | P1 | 1 å¤© | v1.0.0 |
| ä¸‹æ‹‰åˆ·æ–° | P1 | 0.5 å¤© | v1.0.0 |
| æ»‘åŠ¨æ“ä½œ | P1 | 1 å¤© | v1.0.0 |

**v1.0.0 æ€»è®¡**: **25 å¤©ï¼ˆçº¦ 5 å‘¨ï¼‰**

---

### 8.2 è¿­ä»£è®¡åˆ’

#### 8.2.1 v1.0.0 - MVPï¼ˆWeek 1-5ï¼‰

**ç›®æ ‡**: æ ¸å¿ƒåŠŸèƒ½å¯ç”¨ï¼Œå¯è‡ªç”¨æµ‹è¯•

| Week | ä»»åŠ¡ | äº¤ä»˜ç‰© |
|------|------|--------|
| **Week 1** | é¡¹ç›®åˆå§‹åŒ–ã€TCA æ¶æ„æ­å»º | ç©ºç™½ App + TCA Store |
| | - åˆ›å»º Xcode é¡¹ç›® | |
| | - æ·»åŠ ä¾èµ–ï¼ˆTCAã€GRDBã€MarkdownUIï¼‰ | |
| | - å®šä¹‰ AppStateã€AppActionã€AppReducer | |
| **Week 2** | æ•°æ®å±‚å®ç° | NoteRepository + FileManager |
| | - æ•°æ®åº“ Schema | |
| | - GRDB æ¨¡å‹å®šä¹‰ | |
| | - .nota æ–‡ä»¶è¯»å†™ | |
| | - YAML è§£æ | |
| **Week 3** | ç¬”è®°åˆ—è¡¨ + ä¾§è¾¹æ  | å¯æµè§ˆç¬”è®°åˆ—è¡¨ |
| | - NavigationSplitView å¸ƒå±€ | |
| | - NoteListView + NoteRowView | |
| | - SidebarView | |
| | - æœç´¢åŠŸèƒ½ | |
| **Week 4** | ç¼–è¾‘å™¨ + é¢„è§ˆ | å¯ç¼–è¾‘å’Œé¢„è§ˆç¬”è®° |
| | - NoteEditorView | |
| | - Markdown ç¼–è¾‘å™¨ | |
| | - MarkdownUI é¢„è§ˆ | |
| | - åˆ†å±æ¨¡å¼ | |
| | - è‡ªåŠ¨ä¿å­˜ | |
| **Week 5** | å®Œå–„ + æµ‹è¯• | å¯å‘å¸ƒçš„ MVP |
| | - æ˜Ÿæ ‡ã€ç½®é¡¶åŠŸèƒ½ | |
| | - å³é”®èœå• | |
| | - å¯¼å…¥åŠŸèƒ½ | |
| | - å•å…ƒæµ‹è¯• | |
| | - Bug ä¿®å¤ | |

---

#### 8.2.2 v1.1.0 - åŠŸèƒ½å¢å¼ºï¼ˆWeek 6-8ï¼‰

**ç›®æ ‡**: æ·»åŠ æ ‡ç­¾ç³»ç»Ÿã€å¯¼å‡ºåŠŸèƒ½ã€UI ä¼˜åŒ–

| åŠŸèƒ½ | é¢„è®¡æ—¶é—´ | è¯´æ˜ |
|-----|---------|------|
| æ ‡ç­¾ç³»ç»Ÿ | 3 å¤© | åˆ›å»ºã€ç¼–è¾‘ã€è¿‡æ»¤æ ‡ç­¾ |
| å¯¼å‡ºåŠŸèƒ½ | 2 å¤© | å¯¼å‡º .notaã€.mdã€PDF |
| å³é”®æ’å…¥ MD | 1 å¤© | ç¼–è¾‘å™¨å³é”®èœå• |
| æ€§èƒ½ä¼˜åŒ– | 2 å¤© | Equatableã€ViewStore.scope |
| UI ä¼˜åŒ– | 2 å¤© | åŠ¨ç”»ã€æ¸å˜ã€é˜´å½± |
| æ–‡æ¡£ | 2 å¤© | ç”¨æˆ·æ‰‹å†Œã€å¼€å‘æ–‡æ¡£ |

**v1.1.0 æ€»è®¡**: **12 å¤©ï¼ˆçº¦ 2.5 å‘¨ï¼‰**

---

#### 8.2.3 v1.2.0 - é«˜çº§åŠŸèƒ½ï¼ˆWeek 9-11ï¼‰

**ç›®æ ‡**: é™„ä»¶ã€ç‰ˆæœ¬å†å²ã€iCloud åŒæ­¥ï¼ˆå¯é€‰ï¼‰

| åŠŸèƒ½ | é¢„è®¡æ—¶é—´ | è¯´æ˜ |
|-----|---------|------|
| é™„ä»¶ç®¡ç† | 5 å¤© | å›¾ç‰‡ã€PDF é™„ä»¶æ”¯æŒ |
| ç‰ˆæœ¬å†å² | 3 å¤© | ç¬”è®°ç‰ˆæœ¬å›æº¯ |
| æ•°æ®åº“å¤‡ä»½ | 2 å¤© | è‡ªåŠ¨å¤‡ä»½å’Œæ¢å¤ |
| Spotlight é›†æˆ | 2 å¤© | ç³»ç»Ÿçº§æœç´¢ |
| iCloud åŒæ­¥ï¼ˆå¯é€‰ï¼‰ | 5 å¤© | CloudKit åŒæ­¥ |

**v1.2.0 æ€»è®¡**: **12-17 å¤©ï¼ˆçº¦ 3 å‘¨ï¼‰**

---

### 8.3 æŠ€æœ¯é£é™©ä¸åº”å¯¹

| é£é™© | å½±å“ | æ¦‚ç‡ | åº”å¯¹ç­–ç•¥ |
|-----|------|------|---------|
| **TCA å­¦ä¹ æ›²çº¿** | é«˜ | ä¸­ | æå‰å­¦ä¹ ï¼Œå‚è€ƒå®˜æ–¹ç¤ºä¾‹ |
| **MarkdownUI æ€§èƒ½** | ä¸­ | ä½ | å¤§æ–‡ä»¶åˆ†æ®µæ¸²æŸ“ |
| **YAML è§£æå…¼å®¹æ€§** | ä¸­ | ä½ | ä½¿ç”¨æˆç†Ÿåº“ï¼ˆYamsï¼‰ |
| **æ•°æ®åŒæ­¥å†²çª** | é«˜ | ä¸­ | Checksum æ£€æµ‹ + ç”¨æˆ·é€‰æ‹© |
| **å…¨æ–‡æœç´¢æ€§èƒ½** | ä¸­ | ä½ | ä½¿ç”¨ FTS5 ç´¢å¼• |
| **SwiftUI 4.0 Bug** | ä½ | ä½ | é™çº§åˆ° SwiftUI 3.0 ç‰¹æ€§ |
| **çŠ¶æ€ç®¡ç†å¤æ‚åº¦** | ä¸­ | ä¸­ | æ¨¡å—åŒ– Reducerï¼Œå•ä¸€èŒè´£ |

---

### 8.4 æµ‹è¯•ç­–ç•¥

#### 8.4.1 å•å…ƒæµ‹è¯•ï¼ˆTCA Reducerï¼‰

```swift
// æµ‹è¯•è¦†ç›–ç‡ç›®æ ‡ï¼š80%+

class NoteListReducerTests: XCTestCase {
    func testCreateNote() async { /* ... */ }
    func testDeleteNote() async { /* ... */ }
    func testToggleStar() async { /* ... */ }
    func testSearchNotes() async { /* ... */ }
}

class EditorReducerTests: XCTestCase {
    func testAutoSave() async { /* ... */ }
    func testLoadNote() async { /* ... */ }
    func testInsertMarkdown() async { /* ... */ }
}
```

---

#### 8.4.2 é›†æˆæµ‹è¯•

- æ•°æ®åº“è¯»å†™æµ‹è¯•
- æ–‡ä»¶ç³»ç»Ÿæ“ä½œæµ‹è¯•
- YAML è§£ææµ‹è¯•
- å…¨æ–‡æœç´¢æµ‹è¯•

---

#### 8.4.3 UI æµ‹è¯•ï¼ˆSwiftUI Previewsï¼‰

```swift
#Preview("ç¬”è®°åˆ—è¡¨") {
    NoteListView(
        store: Store(
            initialState: NoteListState(notes: Note.mockData),
            reducer: noteListReducer,
            environment: .mock
        )
    )
}

#Preview("ç¼–è¾‘å™¨ - åˆ†å±") {
    NoteEditorView(
        store: Store(
            initialState: EditorState(
                note: Note.mock,
                viewMode: .split
            ),
            reducer: editorReducer,
            environment: .mock
        )
    )
}
```

---

### 8.5 æ€§èƒ½æŒ‡æ ‡

| æŒ‡æ ‡ | ç›®æ ‡ | æµ‹é‡æ–¹å¼ |
|-----|------|---------|
| **å¯åŠ¨æ—¶é—´** | < 1 ç§’ | Instruments |
| **åˆ—è¡¨æ»šåŠ¨** | 60 FPS | Xcode Profiler |
| **æœç´¢å“åº”** | < 200ms | å•å…ƒæµ‹è¯• |
| **è‡ªåŠ¨ä¿å­˜å»¶è¿Ÿ** | 800ms | ç”¨æˆ·æ„ŸçŸ¥ |
| **å¤§æ–‡ä»¶åŠ è½½** | < 500ms (10MB) | æ€§èƒ½æµ‹è¯• |
| **å†…å­˜å ç”¨** | < 100MB | Activity Monitor |

---

### 8.6 å‘å¸ƒæ¸…å•

#### 8.6.1 v1.0.0 å‘å¸ƒå‰æ£€æŸ¥

- [ ] æ‰€æœ‰ P0 åŠŸèƒ½å·²å®ç°
- [ ] æ ¸å¿ƒ Reducer æµ‹è¯•é€šè¿‡ï¼ˆè¦†ç›–ç‡ 80%+ï¼‰
- [ ] UI æµ‹è¯•é€šè¿‡ï¼ˆä¸»è¦æµç¨‹ï¼‰
- [ ] æ— å·²çŸ¥ P0/P1 Bug
- [ ] æ–‡æ¡£å®Œæˆï¼ˆREADMEã€ç”¨æˆ·æ‰‹å†Œï¼‰
- [ ] ä»£ç ç­¾åå’Œå…¬è¯
- [ ] DMG æ‰“åŒ…
- [ ] ç‰ˆæœ¬å·æ›´æ–°ï¼ˆInfo.plistï¼‰
- [ ] å˜æ›´æ—¥å¿—ï¼ˆCHANGELOG.mdï¼‰

---

#### 8.6.2 ä¾èµ–æ¸…å•

```swift
// Package.swift
dependencies: [
    // TCA
    .package(url: "https://github.com/pointfreeco/swift-composable-architecture", from: "1.11.0"),
    
    // æ•°æ®åº“
    .package(url: "https://github.com/groue/GRDB.swift", from: "6.0.0"),
    
    // Markdown æ¸²æŸ“
    .package(url: "https://github.com/gonzalezreal/swift-markdown-ui", from: "2.0.0"),
    
    // YAML è§£æ
    .package(url: "https://github.com/jpsim/Yams", from: "5.0.0"),
]
```

---

### 8.7 é‡Œç¨‹ç¢‘æ—¶é—´çº¿

```
Week 1-5:  v1.0.0 MVP
â”‚          â”œâ”€ Week 1: é¡¹ç›®åˆå§‹åŒ–
â”‚          â”œâ”€ Week 2: æ•°æ®å±‚
â”‚          â”œâ”€ Week 3: ç¬”è®°åˆ—è¡¨
â”‚          â”œâ”€ Week 4: ç¼–è¾‘å™¨
â”‚          â””â”€ Week 5: å®Œå–„æµ‹è¯•
â”‚
Week 6-8:  v1.1.0 åŠŸèƒ½å¢å¼º
â”‚          â”œâ”€ æ ‡ç­¾ç³»ç»Ÿ
â”‚          â”œâ”€ å¯¼å‡ºåŠŸèƒ½
â”‚          â””â”€ UI ä¼˜åŒ–
â”‚
Week 9-11: v1.2.0 é«˜çº§åŠŸèƒ½
â”‚          â”œâ”€ é™„ä»¶ç®¡ç†
â”‚          â”œâ”€ ç‰ˆæœ¬å†å²
â”‚          â””â”€ Spotlight é›†æˆ
â”‚
Week 12+:  v2.0.0 æœªæ¥è§„åˆ’
           â”œâ”€ iCloud åŒæ­¥
           â”œâ”€ æ’ä»¶ç³»ç»Ÿ
           â””â”€ è‡ªå®šä¹‰ä¸»é¢˜
```

---

## ğŸ‰ PRD å®Œæˆæ€»ç»“

### âœ… å®Œæˆçš„ç« èŠ‚

1. **ç¬¬ä¸€æ­¥**ï¼šäº§å“æ¦‚è¿°ä¸é‡æ„ç›®æ ‡ âœ…
2. **ç¬¬äºŒæ­¥**ï¼šæŠ€æœ¯æ¶æ„å‡çº§ âœ…
3. **ç¬¬ä¸‰æ­¥**ï¼šæ ¸å¿ƒåŠŸèƒ½è®¾è®¡ âœ…
4. **ç¬¬å››æ­¥**ï¼šSwiftUI 4.0 ç•Œé¢è®¾è®¡ âœ…
5. **ç¬¬äº”æ­¥**ï¼šTCA çŠ¶æ€ç®¡ç†è®¾è®¡ âœ…
6. **ç¬¬å…­æ­¥**ï¼šæ•°æ®æ¶æ„è®¾è®¡ âœ…
7. **ç¬¬ä¸ƒæ­¥**ï¼šäº¤äº’è®¾è®¡ âœ…
8. **ç¬¬å…«æ­¥**ï¼šå®æ–½è·¯çº¿å›¾ âœ…

### ğŸ“Š æ–‡æ¡£ç»Ÿè®¡

- **æ€»é¡µæ•°**: çº¦ 100 é¡µï¼ˆA4ï¼‰
- **ä»£ç ç¤ºä¾‹**: 50+ ä¸ª
- **æ¶æ„å›¾**: 10+ ä¸ª
- **è¡¨æ ¼**: 30+ ä¸ª
- **åŠŸèƒ½ç‚¹**: 80+ ä¸ª

### ğŸ¯ æ ¸å¿ƒäº®ç‚¹

1. **å®Œå…¨é‡æ„**: SwiftUI 4.0 + TCA 1.11
2. **çŠ¶æ€ç®¡ç†**: å•ä¸€æ•°æ®æºï¼Œå¯é¢„æµ‹
3. **æ€§èƒ½ä¼˜åŒ–**: Equatableã€ViewStore.scope
4. **æµç•…åŠ¨ç”»**: Liquid äº¤äº’ï¼Œå¼¹ç°§åŠ¨ç”»
5. **ç°ä»£åŒ– UI**: æš—è‰²ä¸»é¢˜ã€æ¸å˜ã€é˜´å½±
6. **æ¸…æ™°è·¯çº¿å›¾**: MVP 5 å‘¨ï¼Œv1.1 2.5 å‘¨

### ğŸ“ ä¸‹ä¸€æ­¥è¡ŒåŠ¨

1. **åˆ›å»º Xcode é¡¹ç›®**
2. **æ·»åŠ ä¾èµ–**ï¼ˆTCAã€GRDBã€MarkdownUIï¼‰
3. **å®šä¹‰ AppState**
4. **å®ç° NoteRepository**
5. **å¼€å§‹ Week 1 å¼€å‘**

---

**Nota4 PRD v2.0.0 - å®Œæ•´ç‰ˆæœ¬å·²å®Œæˆï¼** ğŸš€

---

## ğŸ“ ä¸‹ä¸€æ­¥è¡ŒåŠ¨

è¯·æŒ‰ç…§ä»¥ä¸‹æ­¥éª¤å®Œå–„ PRDï¼š

1. **å®¡é˜…ç¬¬ä¸€æ­¥**ï¼ˆäº§å“æ¦‚è¿°ä¸é‡æ„ç›®æ ‡ï¼‰
   - âœ… ç¡®è®¤é‡æ„ç†ç”±æ˜¯å¦å……åˆ†
   - âœ… ç¡®è®¤æ ¸å¿ƒç›®æ ‡æ˜¯å¦æ˜ç¡®

2. **å®¡é˜…ç¬¬äºŒæ­¥**ï¼ˆæŠ€æœ¯æ¶æ„å‡çº§ï¼‰
   - âœ… ç¡®è®¤ SwiftUI 4.0 ç‰¹æ€§åº”ç”¨æ˜¯å¦åˆç†
   - âœ… ç¡®è®¤ TCA 1.11 æ¶æ„è®¾è®¡æ˜¯å¦æ¸…æ™°

3. **å®Œå–„ç¬¬ä¸‰æ­¥**ï¼ˆæ ¸å¿ƒåŠŸèƒ½è®¾è®¡ï¼‰
   - ğŸ¤” è¡¥å……æˆ–è°ƒæ•´åŠŸèƒ½ä¼˜å…ˆçº§
   - ğŸ¤” ç¡®è®¤æ–°å¢åŠŸèƒ½çš„è®¾è®¡æ–¹æ¡ˆ

4. **å®Œå–„ç¬¬å››æ­¥**ï¼ˆSwiftUI 4.0 ç•Œé¢è®¾è®¡ï¼‰
   - ğŸ¤” ç¡®è®¤å¸ƒå±€è®¾è®¡
   - ğŸ¤” è°ƒæ•´ UI ç»„ä»¶ç»†èŠ‚

5. **å®Œå–„ç¬¬äº”æ­¥**ï¼ˆTCA çŠ¶æ€ç®¡ç†è®¾è®¡ï¼‰
   - ğŸ¤” ç¡®è®¤çŠ¶æ€å®šä¹‰
   - ğŸ¤” å®¡é˜… Reducer é€»è¾‘

6. **å®Œå–„ç¬¬å…­æ­¥**ï¼ˆæ•°æ®æ¶æ„è®¾è®¡ï¼‰
7. **å®Œå–„ç¬¬ä¸ƒæ­¥**ï¼ˆäº¤äº’è®¾è®¡ï¼‰
8. **åˆ¶å®šç¬¬å…«æ­¥**ï¼ˆå®æ–½è·¯çº¿å›¾ï¼‰

---

**è¯·ä»ç¬¬ä¸€æ­¥å¼€å§‹ç¡®è®¤ï¼Œæˆ–ç›´æ¥æå‡ºæ‚¨çš„ç–‘é—®å’Œè¡¥å……æ„è§ï¼** ğŸš€

