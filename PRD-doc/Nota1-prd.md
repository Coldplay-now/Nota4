# Nota - Markdown笔记管理系统 PRD v2.0
## 产品定位
**从Markdown预览工具升级为专业的Markdown笔记管理软件**
- 核心价值：让用户用Markdown格式高效创建、管理、检索笔记
- 差异化：保持文件系统可访问性，兼顾专业性与开放性
- 目标用户：需要长期积累知识、重视数据所有权的Mac用户

## 一、模块概述
### 1. 核心目标
实现基于Markdown的笔记全生命周期管理：创建→编辑→存储→检索→归档，确保数据安全、查询高效、用户体验流畅。

### 2. 技术架构选择
**混合架构：文件系统 + SQLite双层存储**
- **文件层**：每条笔记对应一个.md文件，保证数据透明可访问
- **索引层**：SQLite存储元数据（标题、时间、摘要），提供高效查询能力
- **边界约定**：Nota只管理已导入的笔记，不监控外部文件变化

### 3. 适用范围
Mac OS 10.15+平台，覆盖笔记的导入→创建→编辑→查询→删除全流程。

## 二、数据存储架构设计
### 1. 文件系统结构
```
~/Library/Containers/com.nota.app/Data/Documents/
├── NotaLibrary/
│   ├── notes/                    # 笔记文件目录
│   │   ├── note_abc123def.md    # 单个笔记文件
│   │   ├── note_xyz789ghi.md
│   │   └── ...
│   ├── attachments/              # 附件目录（图片等）
│   │   ├── img_20231109_001.png
│   │   └── ...
│   ├── trash/                    # 已删除笔记（软删除）
│   │   └── note_deleted_xxx.md
│   └── metadata.db              # SQLite元数据库
└── backups/                      # 数据库备份
    ├── metadata_20231109.db
    └── ...
```

### 2. 文件格式设计（重要架构决策）

#### 2.1 文件格式选择：`.nota` 专有格式
**核心理念：保持Markdown兼容性，同时避免并发冲突**

**格式说明：**
- 文件扩展名：`.nota`（本质是带元数据的Markdown）
- 文件结构：YAML Front Matter + Markdown正文
- 与标准Markdown的关系：
  - ✅ 正文部分完全是标准Markdown
  - ✅ 元数据使用标准的YAML Front Matter（Jekyll、Hugo等静态站点生成器通用格式）
  - ✅ 可无损转换为纯`.md`（移除元数据头即可）

**文件示例：**
```yaml
---
# Nota Metadata
note_id: a1b2c3d4e5f67890abcdef1234567890
title: 我的笔记标题
tags: ["工作", "重要"]
starred: false
pinned: false
created: 2023-11-09T14:30:00+08:00
updated: 2023-11-09T15:45:00+08:00
checksum: d41d8cd98f00b204e9800998ecf8427e
---

# 我的笔记标题

这里是正文内容，标准的Markdown格式...

## 小标题
- 列表项1
- 列表项2
```

**设计优势：**
1. **避免并发冲突**：`.nota` 扩展名表明"此文件由Nota管理"，外部编辑器不会随意打开
2. **元数据内嵌**：标签、星标等信息存储在文件中，文件即数据库
3. **迁移友好**：提供一键导出为纯`.md`，用户不被锁定
4. **版本控制友好**：文件变化清晰可追踪（Git等工具可用）
5. **标准兼容**：YAML Front Matter是广泛认可的格式

#### 2.2 文件命名规则
- **笔记文件**：`note_{note_id}.nota`
  - note_id：32位UUID（去除连字符）
  - 示例：`note_a1b2c3d4e5f67890abcdef1234567890.nota`
- **附件文件**：`{type}_{timestamp}_{序号}.{ext}`
  - 示例：`img_20231109143022_001.png`

#### 2.3 数据同步策略（双写机制）
**文件是"真理之源"，数据库是"性能缓存"**

```
保存笔记时：
1. 更新 .nota 文件内容（正文）
2. 更新 .nota 文件的YAML元数据头（title、tags、starred等）
3. 同步更新数据库记录（用于快速查询）

加载笔记时：
1. 从数据库获取列表（快速）
2. 打开笔记时读取 .nota 文件完整内容
3. 若发现文件元数据与数据库不一致，以文件为准，同步数据库

一致性保证：
- 每次保存时计算文件checksum，存入数据库
- 打开时对比checksum，发现不一致则提示并同步
```

#### 2.4 导出功能（确保用户数据自由）
**理念：用户可以随时无损导出，不被应用锁定**

**导出选项：**
1. **导出单个笔记为 `.md`**
   - 移除YAML Front Matter元数据头
   - 保留纯Markdown正文
   - 快捷键：`Cmd+Shift+E`

2. **批量导出整个笔记库**
   - 菜单 → "文件" → "导出笔记库..."
   - 选项：
     - [ ] 导出为标准 `.md` 格式（移除元数据）
     - [ ] 保留 `.nota` 格式（含元数据）
     - [ ] 导出文件夹结构（按标签/日期组织）
     - [ ] 包含附件
   - 进度提示："正在导出 15/120 个笔记..."

3. **智能导出（可选高级功能）**
   - 支持导出为 Bear、Obsidian、Notion 等格式
   - 元数据映射规则可配置

### 3. 文件格式选择的深度分析

#### 为什么选择 `.nota` 而不是 `.md`？

**核心问题：并发编辑冲突**
```
场景：用户在Nota中编辑笔记，同时用其他编辑器（如VS Code）打开同一文件
↓
Nota自动保存（每3秒）
↓
外部编辑器也在保存
↓
结果：文件冲突，可能丢失数据 ❌
```

**`.nota` 格式的解决方案：**
1. **文件扩展名隔离**：`.nota` 不会被默认关联到文本编辑器，降低误操作风险
2. **清晰的所有权**：用户明白"这是Nota管理的文件"
3. **元数据内嵌**：标签、星标等信息存储在文件中，文件本身就是完整数据源
4. **便捷导出**：随时可导出为标准 `.md`，不绑架用户数据

**权衡考虑：**

| 维度 | `.md` 格式 | `.nota` 格式（采用） |
|------|-----------|---------------------|
| 生态兼容性 | ⭐⭐⭐⭐⭐ 任何工具可打开 | ⭐⭐⭐ 需导出后使用其他工具 |
| 并发冲突 | ⭐⭐ 高风险 | ⭐⭐⭐⭐⭐ 低风险 |
| 元数据管理 | ⭐⭐ 只能存数据库 | ⭐⭐⭐⭐⭐ 文件内嵌，便于版本控制 |
| 用户迁移成本 | ⭐⭐⭐⭐⭐ 无成本 | ⭐⭐⭐⭐ 一键导出，成本低 |
| 高级功能扩展 | ⭐⭐⭐ 受限 | ⭐⭐⭐⭐⭐ 灵活 |
| 用户信任度 | ⭐⭐⭐⭐⭐ 标准格式 | ⭐⭐⭐ 需要沟通"为什么" |

**最终决策：采用 `.nota` 格式，但提供无缝导出能力**
- ✅ 优先保证应用稳定性（避免并发冲突）
- ✅ 提供便捷导出（确保用户数据自由）
- ✅ YAML Front Matter是业界标准（Jekyll、Hugo、Obsidian都在用）
- ✅ 未来可扩展更多功能（加密、版本历史等）

**用户沟通策略：**
在首次启动或导入时，向用户说明：
```
💡 关于 .nota 格式

Nota使用 .nota 格式存储笔记，这样做是为了：
• 避免与其他编辑器发生冲突
• 在笔记中保存标签、星标等信息
• 保证数据完整性和一致性

不用担心：
✓ .nota 本质就是 Markdown（YAML + 正文）
✓ 您可以随时导出为标准 .md 格式
✓ 数据完全属于您，不会被锁定

[了解更多] [开始使用]
```

---

### 4. SQLite数据库设计
**角色：性能缓存，不是真理之源**
- **设计原则**：
  - 数据库轻量（单条记录<1KB）
  - 文件是"真理"，数据库是"索引"
  - 数据库损坏可从 `.nota` 文件重建
- **同步策略**：
  - 保存笔记时：先写文件，后写数据库（确保文件优先）
  - 加载笔记时：先查数据库（快），打开时读文件（准）
  - 发现不一致：以文件为准，同步数据库

### 4. 笔记持久化机制
- **保存触发**：
  1. 自动保存：用户编辑时，每3秒自动保存（同时更新.md文件和数据库）
  2. 主动保存：点击"保存"、切换笔记、关闭APP时立即保存
  3. 崩溃恢复：每次自动保存创建临时副本，异常退出时可恢复
- **保存流程**：
  ```
  用户编辑 → 触发保存
  ↓
  1. 写入.md文件（原子操作：先写临时文件，再rename）
  2. 更新数据库元数据（标题、摘要、update_time）
  3. 清理临时文件
  ```
- **数据安全**：
  - APP启动时校验数据库完整性，损坏则从备份恢复
  - 备份策略：每日凌晨3点自动备份，保留最近7份
  - 标题提取：从.md文件第一行`# 标题`提取，无标题则为"无标题笔记"
  - 摘要生成：取正文前50字（跳过标题行、空行、代码块）

## 三、笔记导入功能（数据边界管理）
### 1. 功能定位
**导入是用户将外部Markdown文件纳入Nota管理的唯一入口**
- 边界原则：导入后的文件归Nota管理，不再追踪外部变化
- 用户责任：是否导入、何时导入、是否重复导入由用户决策
- 冲突处理：若导入的文件与已有笔记重名/重复，由用户选择（跳过/覆盖/保留两者）

### 2. 导入方式
#### 2.1 首次启动引导（首次使用时触发）
**场景**：用户首次打开新版Nota，检测到无笔记库
- **欢迎界面**：
  ```
  欢迎使用 Nota
  选择如何开始：
  [1] 创建全新笔记库
  [2] 导入现有Markdown文件
  ```
- **选项1：全新开始**
  - 创建空的NotaLibrary目录和数据库
  - 直接进入主界面（显示空状态）
  
- **选项2：导入现有文件**
  - 弹出文件夹选择器："选择包含Markdown文件的文件夹"
  - 递归扫描该文件夹下所有.md文件（支持子目录）
  - 显示导入预览界面：
    ```
    找到 23 个Markdown文件
    
    [√] note1.md  (创建于 2023-10-01)
    [√] note2.md  (创建于 2023-10-05)
    [√] 子目录/note3.md
    ...
    
    [全选] [全不选]
    [取消] [开始导入（23个文件）]
    ```
  - 导入进度：显示进度条"正在导入 5/23..."
  - 完成提示："导入完成，已添加23条笔记"

#### 2.2 日常导入功能（主菜单常驻）
**入口**：主菜单 → "文件" → "导入笔记..."（快捷键 Cmd+Shift+I）

**导入模式：**
- **单文件导入**：选择单个.md文件导入
- **批量导入**：选择文件夹，批量导入多个文件
- **拖拽导入**：将.md文件拖入应用窗口，自动触发导入

**导入流程：**
```
用户触发导入 → 选择文件/文件夹
↓
扫描并分析文件
↓
检测重复/冲突
├─ 无冲突 → 直接导入
└─ 有冲突 → 弹出冲突解决界面
   ├─ [跳过该文件]
   ├─ [覆盖已有笔记]（会丢失原笔记）
   └─ [保留两者]（新笔记重命名为"xxx_导入"）
↓
复制文件到 NotaLibrary/notes/
↓
生成note_id，重命名为 note_{id}.md
↓
解析标题和摘要，写入数据库
↓
完成，刷新笔记列表
```

### 3. 重复检测规则
**检测维度**（按优先级）：
1. 文件内容MD5完全相同 → 判定为重复
2. 标题相同 + 创建时间相同 → 提示可能重复
3. 文件名相同但内容不同 → 提示冲突，让用户选择

### 4. 导入数据处理
**核心流程：`.md` → `.nota` 格式转换**

```
导入 .md 文件
↓
解析文件内容
├─ 检测是否包含YAML Front Matter
│  ├─ 有 → 提取元数据（可能来自其他笔记应用）
│  └─ 无 → 从内容提取元数据
↓
生成 Nota 格式的 YAML 头部
├─ note_id: 新生成UUID
├─ title: 从第一行 # 标题 提取（无则用文件名）
├─ tags: 如果原文件有，保留；否则为空数组
├─ starred: false（默认）
├─ pinned: false（默认）
├─ created: 保留原文件创建时间
├─ updated: 保留原文件修改时间
↓
保存为 .nota 文件
├─ 文件名: note_{uuid}.nota
├─ 存储位置: NotaLibrary/notes/
↓
写入数据库索引
```

**详细处理规则：**

1. **时间戳保留**
   - 导入时保留原文件的创建/修改时间
   - 写入YAML头部的 `created` 和 `updated` 字段
   - 同步到数据库的 `create_time` 和 `update_time`

2. **标题提取**
   - 从第一行提取 `# 标题`
   - 无标题则用文件名（去除`.md`后缀）
   - 多级标题取第一个（如 `### 小标题` 也算标题）

3. **文件编码**
   - 自动检测编码（UTF-8、GBK、GB2312等）
   - 统一转为UTF-8存储

4. **元数据智能识别**（适配其他笔记应用）
   - **Bear格式**：识别 `#标签` 语法，转换为tags数组
   - **Obsidian格式**：识别已有的YAML Front Matter
   - **Notion导出**：识别标题和层级结构
   - **其他**：通用Markdown按标准规则处理

5. **附件处理**（如果.md中包含本地图片引用）
   - 检测本地图片路径：`![](./images/xxx.png)` 或 `![](../pics/yyy.jpg)`
   - 弹出提示："检测到3个本地图片引用，是否一并导入？"
   - 若选择导入：
     ```
     1. 复制图片到 NotaLibrary/attachments/
     2. 重命名为统一格式：img_{timestamp}_{序号}.{ext}
     3. 更新 .nota 文件中的引用路径
        ![](./images/xxx.png) 
        → ![](../attachments/img_20231109_001.png)
     ```
   - 若跳过：保留原引用路径（可能失效）

### 5. 导入失败处理
- **单个文件导入失败**（如编码错误、文件损坏）：
  - 记录日志，显示失败提示："xxx.md导入失败：文件编码无法识别"
  - 批量导入时跳过该文件，继续导入其他文件
- **导入日志**：提供"查看导入日志"按钮，展示详细的成功/失败记录

## 四、核心功能需求
### 1. 笔记列表查询
- 展示内容：列表项默认显示"笔记标题+最后更新时间+摘要（正文前50字，无正文则显示'无内容'）"。
- 查询方式：支持"列表直接浏览"，后续可扩展搜索功能（当前版本仅基础查询）。
- 加载逻辑：首次启动加载前20条笔记，用户滚动到底部自动加载下20条（分页加载，提升性能）。

### 3. 笔记排序规则
- 默认排序：按“最后更新时间”降序排列（最新更新的笔记显示在列表顶部）。
- 排序稳定性：同一时间更新的笔记，按笔记ID降序排列（确保顺序唯一）。
- 排序触发：笔记创建/编辑/恢复删除后，自动刷新排序，列表实时重排。

### 2. 笔记创建功能
- **触发方式**：
  - 点击"新建笔记"按钮（快捷键 Cmd+N）
  - 首次启动且无笔记时，自动创建第一条笔记
- **创建流程**：
  ```
  用户触发新建 → 生成note_id
  ↓
  创建空白.md文件：note_{id}.md
  ↓
  写入默认内容："# 无标题\n\n开始写作..."
  ↓
  数据库插入记录（标题="无标题"，摘要=""，时间戳=当前时间）
  ↓
  打开编辑界面，光标定位到标题后
  ```

### 3. 软删除与数据恢复
- **删除操作**：
  - 数据库标记`is_deleted=1`，记录`delete_time`
  - 移动.md文件到`trash/`目录（文件名不变）
  - 笔记从主列表移除，进入"已删除"列表
- **恢复逻辑**：
  - 将.md文件从`trash/`移回`notes/`目录
  - 更新数据库：`is_deleted=0`，`update_time=当前时间`
  - 笔记回到主列表顶部
- **彻底删除**：
  - 自动清理：已删除笔记保留30天，超期自动删除.md文件和数据库记录
  - 手动清理：用户可在"已删除"列表手动彻底删除

### 4. 主题模式切换（Dark/Light Mode）
- **功能定位**：提供浅色模式和深色模式两种主题，用户可根据个人喜好或环境光线选择。
- **切换入口**：
  - **菜单栏**：`Nota2` → `偏好设置` → `外观` → `主题模式`（浅色/深色/跟随系统）
  - **快捷键**：`Cmd+Shift+T`（在浅色/深色之间切换）
  - **设置面板**：侧边栏底部"设置" → "外观"选项卡
- **模式选项**：
  1. **浅色模式（Light Mode）**：适合日间使用，背景明亮，文字深色
  2. **深色模式（Dark Mode）**：适合夜间使用，背景深色，文字浅色
  3. **跟随系统（System）**：自动跟随macOS系统主题设置（默认选项）
- **切换行为**：
  - 切换即时生效，无需重启应用
  - 主题偏好保存到应用设置（`app_settings`表）
  - 预览区域（WKWebView）同步切换主题
  - Markdown预览样式（preview-styles.css）自动适配
- **颜色方案**（参考UI设计原型）：
  - **浅色模式**：
    - 主背景：`#f6f7f8`（background-light）
    - 侧边栏背景：`#F5F5F5`
    - 列表项背景：`#FFFFFF`
    - 主文字：`#333333`
    - 副文字：`#666666`
    - 边框：`#E5E5E5`
    - 主色调：`#2b8cee`（primary）
  - **深色模式**：
    - 主背景：`#101922`（background-dark）
    - 侧边栏背景：`#19222c`
    - 列表项背景：`#1a2332`
    - 主文字：`#E0E0E0`
    - 副文字：`#9dabb9`
    - 边框：`#2a3441`
    - 主色调：`#2b8cee`（primary，保持不变）
- **技术实现**：
  - 使用`NSAppearance`检测系统主题
  - 使用`UserDefaults`或数据库存储用户偏好
  - 所有UI组件响应`NSAppearance`变化
  - 预览模板支持CSS变量动态切换
- **数据存储**：
  ```sql
  -- app_settings表
  INSERT INTO app_settings (key, value, update_time) 
  VALUES ('theme_mode', 'system|light|dark', CURRENT_TIMESTAMP);
  ```

## 五、数据字段定义
### SQLite表结构：notes表
| 字段名         | 字段类型       | 约束条件               | 说明                     |
|----------------|----------------|------------------------|--------------------------|
| note_id        | VARCHAR(32)    | 主键，非空             | UUID（去连字符），如a1b2c3d4... |
| file_name      | VARCHAR(64)    | 非空，唯一             | 对应的.nota文件名（note_{id}.nota） |
| title          | VARCHAR(255)   | 非空，默认"无标题"     | 从第一行`# 标题`提取     |
| summary        | TEXT           | 可空                   | 正文前50字摘要（用于列表展示） |
| create_time    | INTEGER        | 非空                   | Unix时间戳（毫秒）       |
| update_time    | INTEGER        | 非空                   | Unix时间戳（毫秒）       |
| is_deleted     | INTEGER        | 非空，默认0            | 0=正常，1=已删除         |
| delete_time    | INTEGER        | 可空                   | 删除时间戳（毫秒），is_deleted=1时非空 |
| file_size      | INTEGER        | 非空                   | .nota文件大小（字节），用于性能优化 |
| checksum       | VARCHAR(32)    | 可空                   | MD5校验（用于检测文件变化） |
| **is_starred** | **INTEGER**    | **非空，默认0**        | **⭐ 0=普通，1=星标/收藏（Phase 4功能）** |
| **is_pinned**  | **INTEGER**    | **非空，默认0**        | **📌 0=普通，1=置顶（Phase 4功能）** |
| tags           | TEXT           | 可空                   | JSON数组，如`["工作","重要"]`（Phase 4功能） |
| color          | VARCHAR(16)    | 可空                   | 笔记颜色标记（预留）     |
| custom_metadata| TEXT           | 可空                   | JSON格式自定义元数据（预留） |

**重点说明：**
- `is_starred`：收藏功能，用户可标记重要笔记，在侧边栏"星标"分类中显示
- `is_pinned`：置顶功能，置顶的笔记始终显示在列表最上方（优先级高于update_time）
- 这些字段在Phase 1就要创建（预留），Phase 4时启用UI功能

### 排序规则（考虑置顶）
```sql
-- 笔记列表查询（置顶优先）
SELECT * FROM notes 
WHERE is_deleted = 0 
ORDER BY 
  is_pinned DESC,        -- 置顶笔记优先
  update_time DESC,      -- 然后按更新时间
  note_id DESC           -- 最后按ID（保证稳定排序）
LIMIT 20 OFFSET 0;

-- 星标笔记查询
SELECT * FROM notes 
WHERE is_deleted = 0 AND is_starred = 1
ORDER BY update_time DESC;
```

### 索引设计
```sql
CREATE INDEX idx_update_time ON notes(update_time DESC, note_id DESC);
CREATE INDEX idx_delete_time ON notes(delete_time DESC) WHERE is_deleted=1;
CREATE INDEX idx_title ON notes(title) WHERE is_deleted=0;  -- 用于搜索
CREATE INDEX idx_starred ON notes(is_starred) WHERE is_starred=1;  -- 用于星标列表
CREATE INDEX idx_pinned ON notes(is_pinned, update_time DESC) WHERE is_pinned=1;  -- 用于置顶排序
```

## 六、关键交互流程
### 1. 首次启动流程
```
APP启动 → 检测NotaLibrary目录是否存在
├─ 不存在 → 首次启动
│   ↓
│   显示欢迎界面（"全新开始"或"导入现有文件"）
│   ↓
│   [选择全新开始] → 创建目录结构+空数据库 → 进入主界面（空状态）
│   [选择导入] → 导入向导 → 完成后进入主界面
│
└─ 存在 → 正常启动
    ↓
    加载数据库 → 查询前20条笔记 → 渲染列表
```

### 2. 笔记创建流程
```
用户点击"新建笔记"（Cmd+N）
↓
生成UUID作为note_id（如：a1b2c3d4e5f6...）
↓
在notes/目录创建文件：note_a1b2c3d4e5f6.md
写入默认内容："# 无标题\n\n"
↓
数据库插入记录：
  - note_id = a1b2c3d4e5f6
  - file_name = note_a1b2c3d4e5f6.md
  - title = "无标题"
  - summary = ""
  - create_time = update_time = 当前时间戳
↓
打开编辑界面，光标定位到标题行末尾
↓
用户开始编辑...
  ├─ 每3秒触发自动保存
  │   ├─ 写入.md文件（原子操作）
  │   ├─ 解析标题和摘要
  │   └─ 更新数据库（title、summary、update_time）
  │
  └─ 用户切换笔记/关闭APP
      └─ 触发最终保存 → 返回列表（新笔记显示在顶部）
```

### 3. 笔记编辑流程
```
用户点击列表中的笔记
↓
从数据库查询note_id对应的file_name
↓
读取notes/{file_name}的完整内容
↓
加载到编辑器中
↓
用户编辑...
  ├─ 每3秒自动保存（同创建流程）
  └─ 退出编辑 → 最终保存 → 返回列表
```

### 4. 笔记列表加载流程
```
进入笔记列表页
↓
查询数据库：
  SELECT * FROM notes 
  WHERE is_deleted = 0 
  ORDER BY update_time DESC, note_id DESC 
  LIMIT 20 OFFSET 0
↓
渲染列表项（标题+更新时间+摘要）
↓
用户滚动到底部
↓
加载下一页（OFFSET 20, LIMIT 20）
↓
继续滚动，持续分页加载...
```

### 5. 笔记删除/恢复流程
**删除：**
```
用户右键点击笔记 → 选择"删除"
↓
弹出确认："确定删除该笔记？可在30天内恢复"
↓
确认 → 执行删除
  ├─ 移动文件：notes/note_xxx.md → trash/note_xxx.md
  ├─ 更新数据库：is_deleted=1, delete_time=当前时间
  └─ 刷新列表（该笔记消失）
```

**恢复：**
```
用户进入"已删除"标签页
↓
右键点击笔记 → 选择"恢复"
↓
执行恢复
  ├─ 移动文件：trash/note_xxx.md → notes/note_xxx.md
  ├─ 更新数据库：is_deleted=0, update_time=当前时间
  └─ 刷新列表（笔记回到主列表顶部）
```

### 6. 笔记导入流程（详见"三、笔记导入功能"章节）

## 七、边界场景处理
### 1. 数据一致性问题
**场景1：数据库存在记录，但.md文件丢失**
- 检测时机：打开笔记时
- 处理方式：
  ```
  尝试读取文件失败
  ↓
  弹出提示："该笔记文件已损坏或丢失"
  ↓
  选项：[从备份恢复] [标记为损坏] [删除该记录]
  ```

**场景2：.md文件存在，但数据库无记录**
- 检测时机：APP启动时扫描notes/目录（可选，性能影响）
- 处理方式：
  ```
  发现孤立文件
  ↓
  后台自动解析该文件
  ↓
  在数据库中创建对应记录（标记为"自动恢复"）
  ↓
  Toast提示："检测到1个未索引的笔记，已自动恢复"
  ```

**场景3：数据库损坏**
- 检测时机：APP启动时
- 处理方式：
  ```
  SQLite打开失败
  ↓
  尝试加载最新备份（backups/目录）
  ↓
  成功 → 提示"已从备份恢复数据库"
  ↓
  失败 → 提示"数据库损坏，是否重建索引？"
    └─ 确认 → 扫描notes/目录所有.md文件 → 重建数据库
  ```

### 2. 并发编辑问题
**场景：用户在外部编辑器同时修改了.md文件**
- 由于不监控外部变化，Nota内编辑时可能产生冲突
- 保存策略：
  ```
  Nota保存时，检测文件修改时间
  ├─ 文件时间戳 > 上次加载时间 → 文件被外部修改
  │   ↓
  │   弹出警告："该文件已被外部修改，是否覆盖？"
  │   选项：[保存我的修改（覆盖）] [放弃我的修改] [另存为新笔记]
  │
  └─ 文件时间戳未变 → 正常保存
  ```

### 3. 大文件性能优化
**场景：单个笔记文件>10MB**
- 列表展示：只显示摘要（前50字），不加载完整内容
- 编辑器加载：
  - 显示加载进度条
  - 异步加载文件内容
  - 大于50MB时警告："该笔记过大，可能影响性能"

### 4. 自动清理机制
**每日凌晨3点执行：**
1. 清理超过30天的已删除笔记（trash/目录+数据库记录）
2. 备份数据库到backups/目录（保留最近7份）
3. 清理临时文件（如崩溃恢复的临时副本）

## 八、非功能需求
### 1. 性能要求
- 自动保存响应时间≤100ms（无感知）；
- 列表首次加载≤1s（20条数据）；
- 单条笔记打开≤500ms（含大文件读取）。

### 2. 兼容性要求
- 支持Mac OS 10.15+（Catalina及以上）
- 适配Intel和Apple Silicon芯片
- 适配暗黑模式/浅色模式

### 3. 数据安全要求
- 笔记存储在APP沙盒目录（~/Library/Containers/com.nota.app/Data/Documents/）
- 备份文件可选加密存储（AES-256），防止篡改
- 不上传任何用户数据，完全本地化

### 4. 可扩展性要求
**数据库预留字段：**
- `tags` TEXT：JSON格式存储标签数组，如`["工作","重要"]`
- `is_starred` INTEGER：是否星标（0/1）
- `is_pinned` INTEGER：是否置顶（0/1）
- `color` VARCHAR(16)：笔记颜色标记
- `custom_metadata` TEXT：JSON格式自定义元数据

**未来功能预留：**
- 标签系统
- 笔记加密
- 笔记分享（导出链接）
- iCloud同步
- 版本历史

# 笔记APP（Mac OS）- 扩展功能PRD补充（已删除列表+笔记搜索）
## 一、已删除列表管理功能
### 1. 功能目标
提供已删除笔记的集中管理入口，支持恢复、彻底删除操作，明确数据保留规则，避免用户误删损失。

### 2. 核心功能需求
- 入口设计：在笔记列表页顶部设置“已删除”标签页（与“全部笔记”并列，默认选中“全部笔记”），点击切换至已删除列表。
- 列表展示：
  - 显示内容：笔记标题+删除时间（原最后更新时间）+ 摘要（正文前50字）+ 倒计时提示（“距离彻底删除还有X天”）。
  - 排序规则：按“删除时间”降序排列（最近删除的笔记置顶），同一时间删除的按note_id降序。
  - 加载逻辑：同主列表，分页加载（20条/页），滚动到底部自动加载下一页。
- 操作功能：
  - 单条操作：长按笔记项，弹出“恢复”“彻底删除”选项；点击笔记项可预览内容（只读模式，不可编辑）。
  - 批量操作：支持勾选多条笔记，点击列表顶部“批量恢复”“批量彻底删除”按钮（勾选时显示，未勾选时隐藏）。
- 数据清理：
  - 自动清理：已删除笔记保留30天，到期后自动删除数据库记录+对应正文文件+备份文件。
  - 手动清理：已删除列表顶部设置“清空已删除笔记”按钮，点击后弹出二次确认（“确认清空所有已删除笔记？清空后不可恢复”），确认后立即清理所有已删除笔记。
- 空状态提示：已删除列表无数据时，显示“暂无已删除笔记”+ 图标，下方提供“返回全部笔记”快捷按钮。

### 3. 交互流程
- 进入已删除列表：用户点击“已删除”标签→ 查询数据库（条件：is_deleted=1，排序：delete_time DESC, note_id DESC）→ 分页加载并渲染列表（含倒计时）。
- 预览已删除笔记：用户点击已删除列表项→ 加载完整数据（只读模式，隐藏编辑工具）→ 预览完成返回列表。
- 单条恢复/彻底删除：用户长按列表项→ 选择“恢复”→ 数据库更新is_deleted=0、update_time=当前时间→ 笔记返回主列表顶部；选择“彻底删除”→ 弹出确认弹窗→ 确认后删除数据库记录+正文文件→ 列表移除该笔记。
- 批量操作：用户勾选多条笔记→ 点击“批量恢复”/“批量彻底删除”→ 批量执行对应操作→ 列表实时刷新。
- 清空已删除：用户点击“清空已删除笔记”→ 二次确认→ 清理所有is_deleted=1的笔记数据→ 列表显示空状态。

### 4. 数据字段补充
| 字段名         | 字段类型       | 约束条件               | 说明                     |
|----------------|----------------|------------------------|--------------------------|
| delete_time    | TIMESTAMP      | 可空                   | 笔记删除时间（精确到毫秒，is_deleted=1时非空） |

## 九、笔记搜索功能
### 1. 功能目标
支持用户快速查找目标笔记，搜索范围覆盖标题+正文，结果实时匹配、精准排序，提升查询效率。

### 2. 搜索架构设计
**两阶段搜索策略：**
1. **快速搜索（仅查数据库）**：
   - 搜索范围：`title`和`summary`字段
   - 响应速度：<100ms
   - 适用场景：关键词在标题或摘要中

2. **深度搜索（查询.md文件）**：
   - 搜索范围：完整.md文件内容
   - 触发条件：快速搜索无结果，或用户点击"搜索全文"
   - 响应速度：<500ms（取决于笔记数量）

### 3. 核心功能需求
#### 3.1 搜索入口
- **位置**：笔记列表页顶部（工具栏）
- **触发方式**：
  - 点击搜索框
  - 快捷键 `Cmd+F`
  - 直接输入字符（列表聚焦时）
- **占位提示**："搜索笔记..."

#### 3.2 搜索规则
- **匹配规则**：
  - 模糊匹配（包含即可）
  - 不区分大小写
  - 不区分全角/半角
  - 支持空格分隔多关键词（AND逻辑）
  - 支持引号精确匹配：`"完整短语"`
  
- **排除规则**：
  - 默认不搜索已删除笔记
  - 可通过搜索选项勾选"包含已删除笔记"

- **搜索优先级**：
  1. 标题完全匹配（权重：10）
  2. 标题部分匹配（权重：5）
  3. 摘要匹配（权重：3）
  4. 正文匹配（权重：1）

#### 3.3 搜索流程
```
用户输入关键词（去抖动500ms）
↓
【阶段1：快速搜索】
查询数据库：
  SELECT * FROM notes 
  WHERE is_deleted = 0 
    AND (title LIKE '%关键词%' OR summary LIKE '%关键词%')
  ORDER BY (匹配权重) DESC, update_time DESC
  LIMIT 50
↓
有结果 → 渲染结果列表
↓
无结果 → 【阶段2：深度搜索】
  后台任务：遍历notes/目录所有.md文件
  ├─ 读取文件内容
  ├─ 搜索关键词
  └─ 返回匹配的文件
  ↓
  渲染结果（显示"全文搜索结果"标签）
  ↓
  仍无结果 → 显示"未找到相关笔记"
```

#### 3.4 结果展示
**列表项内容：**
```
[笔记标题（高亮关键词）]
更新时间：2023-11-09 14:30
匹配片段：...这是包含【关键词】的上下文内容...
```

**高亮规则：**
- 关键词用黄色背景标记
- 显示匹配片段（前后各30字）
- 多个匹配时，显示权重最高的片段

**空状态：**
```
🔍 未找到相关笔记

建议：
- 检查关键词拼写
- 尝试使用其他关键词
- [搜索全文] ← 触发深度搜索
```

#### 3.5 搜索历史
- **存储位置**：SQLite独立表`search_history`
- **字段**：
  ```sql
  CREATE TABLE search_history (
    id INTEGER PRIMARY KEY,
    keyword VARCHAR(255),
    search_time INTEGER,
    result_count INTEGER
  );
  ```
- **显示规则**：
  - 最近10条
  - 按时间降序
  - 点击历史词快速搜索
- **操作**：
  - 单条删除（右键）
  - 清空全部（底部按钮）

#### 3.6 搜索选项（高级功能，可选）
点击搜索框右侧"筛选"图标，弹出选项：
```
☐ 包含已删除笔记
☐ 仅搜索标题
☐ 精确匹配
时间范围：[最近一周 ▼]
```

### 4. 交互流程
```
【搜索触发】
Cmd+F / 点击搜索框
↓
搜索框聚焦 + 显示搜索历史
↓
用户输入关键词
↓
实时搜索（去抖动500ms）
↓
显示结果列表

【操作结果】
点击笔记 → 打开编辑（关键词定位到第一个匹配位置）
Esc键 → 退出搜索，恢复列表
清除按钮 → 清空搜索词，恢复列表
```

### 5. 性能要求
| 操作 | 性能指标 | 说明 |
|------|---------|------|
| 快速搜索 | ≤100ms | 仅查数据库 |
| 深度搜索 | ≤500ms | 100条笔记以内 |
| 深度搜索 | ≤2s | 1000条笔记以内 |
| 关键词高亮 | ≤50ms | 单个结果项渲染 |
| 搜索历史加载 | ≤100ms | - |

### 6. 搜索优化方案（可选实现）
**全文搜索索引（FTS）：**
- 使用SQLite FTS5扩展
- 为`title`和`summary`建立全文索引
- 支持中文分词（需引入第三方库，如jieba）
- 搜索性能提升5-10倍

```sql
CREATE VIRTUAL TABLE notes_fts USING fts5(
  note_id, 
  title, 
  summary, 
  content=notes
);
```

### 7. 边界场景
- **大文件搜索**：单个.md文件>10MB时，深度搜索跳过并提示"该笔记过大，已跳过全文搜索"
- **特殊字符**：自动转义SQL特殊字符（`%`, `_`, `'`等）
- **空格处理**：连续多个空格视为一个
- **搜索中断**：用户快速输入时，取消上一次未完成的搜索请求

## 十、UI设计建议
### 1. 整体布局（三栏式）
```
┌─────────────────────────────────────────────────────────┐
│  Nota                    [新建] [导入]        ⚙️ [关闭]  │
├─────────────────────────────────────────────────────────┤
│         │                │                               │
│  侧边栏  │   笔记列表      │         编辑/预览区域          │
│         │                │                               │
│  [全部]  │  [搜索框...⌘F] │   # 笔记标题                  │
│  [星标]  │  ─────────────│                               │
│  [已删除]│  📝 标题1      │   笔记内容编辑区...           │
│         │  11-09 14:30  │                               │
│  ───────│  摘要文本...   │                               │
│         │  ─────────────│                               │
│  [标签]  │  📝 标题2      │                               │
│  # 工作  │  11-08 10:15  │                               │
│  # 学习  │  摘要文本...   │                               │
│         │                │                               │
│ 120条笔记│                │  [编辑] [预览]   自动保存✓    │
└─────────┴────────────────┴───────────────────────────────┘
```

### 2. 关键界面元素
#### 2.1 笔记列表项
```
┌────────────────────────────────┐
│ 📝 笔记标题（最多显示30字...）  │  ← 加粗显示
│ 2023-11-09 14:30              │  ← 灰色小字
│ 摘要文本内容，最多显示两行...   │  ← 正常字体
└────────────────────────────────┘
```

#### 2.2 搜索框
```
┌────────────────────────────────┐
│ 🔍  搜索笔记...          [X]   │
├────────────────────────────────┤  ← 下拉展开
│ 最近搜索：                      │
│ • 关键词1  (3条结果)        ╳  │
│ • 关键词2  (8条结果)        ╳  │
│                [清空搜索历史]   │
└────────────────────────────────┘
```

#### 2.3 欢迎界面（首次启动）
```
┌────────────────────────────────────┐
│                                    │
│          📝 欢迎使用 Nota           │
│     专业的Markdown笔记管理工具      │
│                                    │
│  ┌──────────────────────────────┐ │
│  │  🆕 创建全新笔记库            │ │
│  │  从零开始记录你的想法          │ │
│  └──────────────────────────────┘ │
│                                    │
│  ┌──────────────────────────────┐ │
│  │  📂 导入现有Markdown文件      │ │
│  │  从其他地方迁移笔记            │ │
│  └──────────────────────────────┘ │
│                                    │
│            [以后再说]              │
└────────────────────────────────────┘
```

#### 2.4 导入进度界面
```
┌────────────────────────────────────┐
│  正在导入笔记...                    │
│                                    │
│  ████████████████░░░░  15/23      │
│                                    │
│  当前处理：note_example.md         │
│                                    │
│  已导入：15 个                     │
│  失败：0 个                        │
│  跳过：0 个                        │
│                                    │
│           [取消导入]               │
└────────────────────────────────────┘
```

### 3. 交互细节
#### 3.1 右键菜单（笔记列表项）
```
┌─────────────────┐
│ 打开             │
│ 在新窗口打开     │
│ ───────────────│
│ 重命名          │
│ 复制            │
│ 导出为...       │
│ ───────────────│
│ 🗑️ 删除         │
└─────────────────┘
```

#### 3.2 工具栏（编辑模式）
```
[B] [I] [H1] [H2] [列表] [代码块] [插入图片] [插入链接]
```

#### 3.3 状态提示
- **自动保存成功**：右下角Toast "✓ 已保存" （1秒后消失）
- **导入完成**：顶部Banner "✓ 已导入23条笔记" + [关闭]按钮
- **错误提示**：顶部Banner "⚠️ 笔记文件丢失" + [详情]按钮

### 4. 主题模式系统（Dark/Light Mode）

#### 4.1 设计规范
**参考UI设计原型**：所有界面设计文件位于 `prd/UI design/` 目录，已包含完整的浅色/深色模式设计。

**颜色方案**（与UI设计原型保持一致）：

| 元素 | 浅色模式 | 深色模式 | 说明 |
|------|---------|---------|------|
| 主背景 | `#f6f7f8` | `#101922` | 应用主背景色 |
| 侧边栏背景 | `#F5F5F5` | `#19222c` | 左侧导航栏 |
| 列表背景 | `#FFFFFF` | `#1a2332` | 笔记列表区域 |
| 列表项悬停 | `#F0F0F0` | `rgba(255,255,255,0.05)` | 鼠标悬停效果 |
| 文字主色 | `#333333` | `#E0E0E0` | 标题、正文 |
| 文字副色 | `#666666` | `#9dabb9` | 摘要、时间戳 |
| 边框颜色 | `#E5E5E5` | `#2a3441` | 分割线、边框 |
| 主色调（Primary） | `#2b8cee` | `#2b8cee` | 按钮、选中状态（保持不变） |
| 搜索高亮 | `#FFD700` | `#FFD700` | 搜索结果关键词高亮 |
| 选中项背景 | `rgba(43,140,238,0.2)` | `rgba(43,140,238,0.2)` | 当前选中笔记 |

#### 4.2 切换功能
- **入口位置**：
  1. 菜单栏：`Nota2` → `偏好设置` → `外观` → `主题模式`
  2. 设置面板：侧边栏底部"设置" → "外观"选项卡
  3. 快捷键：`Cmd+Shift+T`（快速切换）
- **模式选项**：
  - **浅色模式（Light）**：明亮背景，适合日间使用
  - **深色模式（Dark）**：深色背景，适合夜间使用
  - **跟随系统（System）**：自动跟随macOS系统主题（默认）
- **切换行为**：
  - ✅ 切换即时生效，无需重启
  - ✅ 所有界面同步切换（侧边栏、列表、编辑器、预览）
  - ✅ 预览区域（WKWebView）自动适配主题
  - ✅ 用户偏好保存到数据库（`app_settings`表）
- **预览样式适配**：
  - `preview-styles.css` 支持CSS变量动态切换
  - 使用`prefers-color-scheme`媒体查询或CSS变量
  - 确保代码块、表格、引用等元素在两种模式下都有良好对比度

#### 4.3 实现要求
- **技术实现**：
  - 使用`NSAppearance`检测系统主题变化
  - 使用`UserDefaults`或数据库存储用户偏好
  - 所有`NSView`和`NSViewController`响应外观变化
  - 预览模板通过JavaScript动态切换CSS类
- **性能要求**：
  - 主题切换响应时间 < 100ms
  - 不影响编辑和预览性能
- **兼容性**：
  - 支持macOS 10.15+（Catalina及以上）
  - 适配Intel和Apple Silicon芯片

## 十一、实施优先级规划
### Phase 1：核心基础（MVP，2周）
**目标：能创建、编辑、保存笔记**

**必做功能：**
- [P0] 数据存储架构搭建
  - 创建文件目录结构
  - 初始化SQLite数据库
  - 实现文件读写基础方法
- [P0] 笔记创建与编辑
  - 新建笔记（Cmd+N）
  - 编辑器加载现有笔记
  - 自动保存机制（3秒）
- [P0] 笔记列表展示
  - 查询并渲染列表（前20条）
  - 按更新时间排序
  - 分页加载
- [P0] 基础UI框架
  - 三栏布局（侧边栏+列表+编辑区）
  - 笔记列表项样式
  - 编辑器集成（使用现有Markdown编辑器）
- [P1] 主题模式基础支持
  - 自动跟随系统主题（NSAppearance）
  - 浅色/深色模式样式定义
  - 预览区域主题适配

**验收标准：**
- ✅ 能创建新笔记并编辑
- ✅ 笔记自动保存，不丢失数据
- ✅ 列表显示所有笔记，按时间排序
- ✅ APP重启后数据正常加载
- ✅ 界面自动跟随系统主题切换

---

### Phase 2：导入与删除（MVP+，1周）
**目标：用户能导入现有文件，管理笔记生命周期**

**必做功能：**
- [P0] 笔记导入功能
  - 首次启动欢迎界面
  - 单文件/批量导入
  - 重复检测与冲突处理
- [P0] 软删除与恢复
  - 删除笔记（移到trash/）
  - "已删除"标签页
  - 恢复笔记

**验收标准：**
- ✅ 首次启动显示欢迎界面
- ✅ 能导入现有.md文件
- ✅ 删除的笔记可在30天内恢复

---

### Phase 3：搜索与优化（扩展功能，1周）
**目标：提升查找效率，优化用户体验**

**必做功能：**
- [P1] 笔记搜索
  - 快速搜索（数据库）
  - 深度搜索（.md文件）
  - 关键词高亮
- [P1] 搜索历史
  - 记录最近10条搜索
  - 快速重新搜索
- [P2] 性能优化
  - 大文件异步加载
  - 列表虚拟滚动（>100条笔记时）
  - 数据库查询优化（索引）
- [P1] 主题模式手动切换
  - 设置面板主题选择器
  - 快捷键切换（Cmd+Shift+T）
  - 用户偏好持久化存储

**验收标准：**
- ✅ 搜索响应时间<300ms
- ✅ 支持中文模糊搜索
- ✅ 1000条笔记时列表滚动流畅
- ✅ 用户可手动选择主题模式
- ✅ 主题偏好正确保存和恢复

---

### Phase 4：高级功能（可选，2周）
**目标：增强笔记管理能力**

**可选功能：**
- [P2] 标签系统
  - 为笔记添加标签
  - 按标签筛选
  - 标签管理
- [P2] 星标/置顶
  - 重要笔记星标
  - 置顶笔记
- [P3] 全文搜索索引（FTS5）
  - 建立全文索引
  - 中文分词支持
- [P3] 笔记导出增强
  - 批量导出
  - 导出为HTML/PDF
  - 包含附件的打包导出
- [P3] 数据备份与恢复
  - 手动备份
  - 从备份恢复
  - iCloud同步准备

---

### 功能优先级说明
- **P0（必须）**：核心功能，缺少则产品不可用
- **P1（重要）**：显著提升用户体验，应尽快实现
- **P2（期望）**：锦上添花，根据开发进度决定
- **P3（未来）**：长期规划，可作为下一版本内容

---

### 技术债务管理
**在实施过程中注意：**
1. 预留扩展字段（tags、is_starred等）
2. 接口设计考虑未来需求（如iCloud同步）
3. 关键方法编写单元测试
4. 重要操作记录日志（便于排查问题）
5. 定期性能测试（大数据量场景）

---

## 十二、风险评估与应对
### 1. 技术风险
| 风险 | 可能性 | 影响 | 应对措施 |
|------|-------|------|---------|
| SQLite并发写入冲突 | 中 | 高 | 使用WAL模式，添加写入队列 |
| 大文件导致卡顿 | 高 | 中 | 异步加载，分块读取，设置文件大小警告 |
| 数据库损坏 | 低 | 高 | 定期备份，实现重建索引功能 |
| Markdown解析性能 | 中 | 中 | 使用高性能解析库，缓存解析结果 |

### 2. 用户体验风险
| 风险 | 可能性 | 影响 | 应对措施 |
|------|-------|------|---------|
| 导入大量文件耗时长 | 高 | 中 | 显示进度条，支持后台导入 |
| 误删除笔记 | 中 | 高 | 软删除机制，30天恢复期，删除前二次确认 |
| 搜索结果不准确 | 中 | 中 | 优化匹配算法，提供搜索选项 |
| 文件系统混乱 | 低 | 中 | 明确文件命名规则，提供"数据目录"入口 |

### 3. 数据安全风险
| 风险 | 可能性 | 影响 | 应对措施 |
|------|-------|------|---------|
| 用户误操作丢失数据 | 中 | 高 | 软删除+自动备份+崩溃恢复 |
| 外部修改导致冲突 | 中 | 中 | 保存前检测时间戳，提供冲突解决选项 |
| APP崩溃丢失未保存内容 | 低 | 高 | 每次自动保存创建临时副本 |

---

## 附录：完整SQL建表语句
```sql
-- 笔记主表
CREATE TABLE notes (
    note_id VARCHAR(32) PRIMARY KEY NOT NULL,
    file_name VARCHAR(64) NOT NULL UNIQUE,
    title VARCHAR(255) NOT NULL DEFAULT '无标题',
    summary TEXT,
    create_time INTEGER NOT NULL,
    update_time INTEGER NOT NULL,
    is_deleted INTEGER NOT NULL DEFAULT 0,
    delete_time INTEGER,
    file_size INTEGER NOT NULL DEFAULT 0,
    checksum VARCHAR(32),
    -- 扩展字段
    tags TEXT,  -- JSON: ["标签1", "标签2"]
    is_starred INTEGER DEFAULT 0,
    is_pinned INTEGER DEFAULT 0,
    color VARCHAR(16),
    custom_metadata TEXT  -- JSON扩展字段
);

-- 索引
CREATE INDEX idx_update_time ON notes(update_time DESC, note_id DESC);
CREATE INDEX idx_delete_time ON notes(delete_time DESC) WHERE is_deleted=1;
CREATE INDEX idx_title ON notes(title) WHERE is_deleted=0;
CREATE INDEX idx_starred ON notes(is_starred) WHERE is_starred=1;

-- 搜索历史表
CREATE TABLE search_history (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    keyword VARCHAR(255) NOT NULL,
    search_time INTEGER NOT NULL,
    result_count INTEGER DEFAULT 0
);

CREATE INDEX idx_search_time ON search_history(search_time DESC);

-- 应用设置表
CREATE TABLE app_settings (
    key VARCHAR(64) PRIMARY KEY,
    value TEXT,
    update_time INTEGER
);
```

---

## 十三、与现有代码库的兼容性说明

### 1. 当前技术栈
Nota v1.1 使用以下技术：
- **架构**：SwiftUI + AppKit混合架构
- **窗口管理**：多独立窗口模式
- **数据模型**：内存中的Document数组
- **文件格式**：.md / .markdown / .txt
- **保存机制**：手动保存

### 2. 核心冲突点
| 当前实现 | PRD要求 | 冲突等级 |
|---------|--------|---------|
| 多独立窗口 | 三栏布局笔记列表 | 🔴 极高 |
| 内存数据模型 | SQLite + 文件系统 | 🔴 极高 |
| `.md` 格式 | `.nota` 格式（YAML+Markdown） | 🔴 极高 |
| 手动保存 | 自动保存（每3秒） | 🟡 中等 |
| 无笔记库概念 | 统一笔记库管理 | 🔴 高 |

### 3. 推荐迁移策略：渐进式重构

#### Phase 0：基础设施准备（2周）
**不影响现有功能，搭建新架构基础**
- 引入依赖：GRDB.swift（数据库）、Yams（YAML解析）
- 创建新的数据层抽象（NoteRepository）
- 实现 `.nota` 文件格式解析器
- 编写单元测试

#### Phase 1：数据库建立（2周）
**后台同步，用户无感知**
- 初始化SQLite数据库
- 保存 .md 文件时同步写入数据库
- 添加"笔记库"菜单（可选进入新模式预览）
- 保留原有多窗口编辑功能

#### Phase 2：UI架构迁移（4周）⚠️ 最关键
**逐步切换到新UI，提供兼容模式**
- 实现三栏布局主界面
- 迁移编辑器和预览功能到新布局
- 在设置中提供"经典模式"开关
- 新用户默认使用新UI，老用户可选择

#### Phase 3：核心功能实现（3周）
**PRD功能逐步上线**
- 导入功能（.md → .nota）
- 自动保存机制
- 搜索功能
- 软删除与恢复
- 导出功能（.nota → .md，保持数据自由）

#### Phase 4：高级功能（2周）
**增强功能，非必需**
- 标签系统
- 星标/置顶
- 全文索引优化
- 性能优化

**总计：13周（约3个月）**

### 4. 兼容性保证

#### 数据格式兼容
```
新版本同时支持：
✅ 打开 .md 文件（自动转换为 .nota）
✅ 打开 .nota 文件（原生格式）
✅ 导出为 .md 文件（随时可导出）
✅ 设置中可选"兼容模式"（保存为 .md）
```

#### 功能兼容
```
保留现有功能：
✅ 多窗口模式（设置中可切换）
✅ 实时预览
✅ HTML/PDF导出
✅ 主题切换
✅ 所有快捷键
```

#### 数据迁移
```
首次启动新版本：
1. 检测旧版本数据
2. 弹出导入向导
3. 扫描常用目录的 .md 文件
4. 用户选择导入
5. 自动创建备份
6. 迁移完成
```

### 5. 风险应对措施

**关键风险：UI重构可能导致用户流失**
- ✅ 提供"经典模式"（保留旧版UI）
- ✅ 首次启动引导教程
- ✅ Beta测试阶段收集反馈
- ✅ 渐进式发布（先给部分用户）

**数据安全风险：**
- ✅ 迁移前强制备份
- ✅ 保留 .md 导出功能
- ✅ 数据库损坏可从文件重建
- ✅ 不删除用户原有 .md 文件

**性能风险：**
- ✅ 建立性能基准测试（1000条笔记）
- ✅ 关键路径优化（列表渲染、搜索、保存）
- ✅ 监控指标：列表<1s，搜索<300ms，保存<100ms

### 6. 技术选型建议

```swift
// 推荐的Swift包依赖
dependencies: [
    .package(url: "https://github.com/groue/GRDB.swift", from: "6.0.0"),
    .package(url: "https://github.com/jpsim/Yams", from: "5.0.0"),
]
```

**核心库选择理由：**
- **GRDB.swift**：Swift原生数据库ORM，类型安全，支持迁移和FTS5
- **Yams**：Swift实现的YAML解析器，符合标准，性能优秀

### 7. 详细风险评估
完整的技术风险评估和迁移方案请参阅：
📄 **`prd/PRD_RISK_ASSESSMENT.md`**

该文档包含：
- 当前代码库深度分析
- 冲突点详细说明
- 工作量估算
- 详细的Phase规划
- 应急预案

---

## 结语
本PRD定义了Nota从Markdown预览工具到笔记管理系统的完整转型方案。核心设计思想：

1. **数据透明**：文件系统+数据库双层架构，保证数据开放性
2. **边界清晰**：导入后归Nota管理，不监控外部变化  
3. **体验优先**：自动保存、软删除、快速搜索，降低用户心智负担
4. **可扩展性**：预留字段和接口，为未来功能打好基础
5. **渐进式迁移**：降低重构风险，保留用户习惯，平滑过渡

**关键决策确认：**
- ✅ 采用 `.nota` 格式（YAML Front Matter + Markdown）
- ✅ 数据库预留 `is_starred` 和 `is_pinned` 字段
- ✅ 提供便捷导出，确保用户数据自由
- ✅ 渐进式重构，预计3-4个月完成

建议按Phase 0→1→2→3→4的顺序实施，确保每个阶段都能交付可用的产品版本。

**下一步：** 请查阅 `PRD_RISK_ASSESSMENT.md` 了解详细的技术实施方案。

