# Markdown é¢„è§ˆæ¸²æŸ“å¢å¼º PRD

**ç‰ˆæœ¬**: v1.2  
**æ—¥æœŸ**: 2025-11-16  
**çŠ¶æ€**: è§„åˆ’ä¸­ï¼ˆå·²å®Œæˆ TCA æ¶æ„è®¾è®¡ï¼‰  
**ä¼˜å…ˆçº§**: P0ï¼ˆæ ¸å¿ƒåŠŸèƒ½ï¼‰

---

## ğŸ“‹ ç›®å½•

- [1. äº§å“æ¦‚è¿°](#1-äº§å“æ¦‚è¿°)
- [2. ç°çŠ¶è¯„ä¼°](#2-ç°çŠ¶è¯„ä¼°)
- [3. åŠŸèƒ½è§„åˆ’](#3-åŠŸèƒ½è§„åˆ’)
- [4. æŠ€æœ¯æ–¹æ¡ˆ](#4-æŠ€æœ¯æ–¹æ¡ˆ)
  - [4.1 æŠ€æœ¯æ ˆé€‰æ‹©](#41-æŠ€æœ¯æ ˆé€‰æ‹©)
  - [4.2 æ•´ä½“æ¶æ„](#42-æ•´ä½“æ¶æ„)
  - [4.3 ä¸»é¢˜ç³»ç»Ÿè®¾è®¡](#43-ä¸»é¢˜ç³»ç»Ÿè®¾è®¡) â­ æ–°å¢
  - [4.4 UI äº¤äº’è®¾è®¡](#44-ui-äº¤äº’è®¾è®¡) â­ æ–°å¢
  - [4.5 TCA çŠ¶æ€ç®¡ç†](#45-tca-çŠ¶æ€ç®¡ç†) â­ æ–°å¢
  - [4.6 æ ¸å¿ƒå®ç°](#46-æ ¸å¿ƒå®ç°)
- [5. å®æ–½è®¡åˆ’](#5-å®æ–½è®¡åˆ’)
- [6. æµ‹è¯•è®¡åˆ’](#6-æµ‹è¯•è®¡åˆ’)
- [7. æ€§èƒ½ä¼˜åŒ–](#7-æ€§èƒ½ä¼˜åŒ–)
- [8. é£é™©è¯„ä¼°](#8-é£é™©è¯„ä¼°)

---

## 1. äº§å“æ¦‚è¿°

### 1.1 èƒŒæ™¯

å½“å‰ Nota4 å·²ç»å®ç°äº†åŸºç¡€çš„ Markdown é¢„è§ˆåŠŸèƒ½ï¼Œä½†ç¼ºå°‘ä¸“ä¸šç¬”è®°åº”ç”¨çš„æ ‡é…ç‰¹æ€§ï¼š
- âŒ ä»£ç å—æ²¡æœ‰è¯­æ³•é«˜äº®
- âŒ ä¸æ”¯æŒ Mermaid å›¾è¡¨
- âŒ ä¸æ”¯æŒæ•°å­¦å…¬å¼
- âŒ æ²¡æœ‰ç›®å½•ï¼ˆTOCï¼‰ç”Ÿæˆ
- âŒ å¤–éƒ¨å›¾ç‰‡é“¾æ¥æ— æ³•é¢„è§ˆ
- âŒ æ ·å¼ä¸å¤Ÿç¾è§‚

### 1.2 ç›®æ ‡ç”¨æˆ·

1. **å¼€å‘è€…**ï¼šéœ€è¦ä»£ç å—è¯­æ³•é«˜äº®ã€Mermaid å›¾è¡¨
2. **å­¦ç”Ÿ/ç ”ç©¶è€…**ï¼šéœ€è¦æ•°å­¦å…¬å¼æ¸²æŸ“
3. **çŸ¥è¯†å·¥ä½œè€…**ï¼šéœ€è¦ç¾è§‚çš„æ’ç‰ˆã€å›¾ç‰‡é¢„è§ˆ
4. **é•¿æ–‡å†™ä½œè€…**ï¼šéœ€è¦ TOC å¯¼èˆª

### 1.3 æ ¸å¿ƒä»·å€¼

- âœ… **ä¸“ä¸šæ€§**ï¼šåª²ç¾ Typoraã€Obsidian çš„æ¸²æŸ“æ•ˆæœ
- âœ… **æ˜“ç”¨æ€§**ï¼šæ‰€è§å³æ‰€å¾—ï¼Œå®æ—¶é¢„è§ˆ
- âœ… **å®Œæ•´æ€§**ï¼šæ”¯æŒæ‰€æœ‰å¸¸è§ Markdown æ‰©å±•è¯­æ³•
- âœ… **ç¾è§‚æ€§**ï¼šç°ä»£åŒ–è®¾è®¡ï¼Œå¯æ‰“å°
- âœ… **å¯æ‰©å±•æ€§**ï¼šä¸»é¢˜ç³»ç»Ÿæ”¯æŒè‡ªå®šä¹‰å’Œåˆ†äº«

### 1.4 UI äº¤äº’åŸåˆ™

- âœ… **é…ç½®é›†ä¸­åŒ–**ï¼šæ‰€æœ‰ä¸»é¢˜å’Œæ ·å¼é…ç½®ç»Ÿä¸€åœ¨"é¦–é€‰é¡¹"ä¸­ç®¡ç†
- âœ… **é¢„è§ˆç®€æ´åŒ–**ï¼šé¢„è§ˆç•Œé¢ä¸æä¾›ä¸»é¢˜åˆ‡æ¢ç­‰é…ç½®é€‰é¡¹ï¼Œä¿æŒçº¯ç²¹çš„å†…å®¹å±•ç¤º
- âœ… **çŠ¶æ€ä¸€è‡´æ€§**ï¼šé€šè¿‡ TCA çŠ¶æ€ç®¡ç†ç¡®ä¿ä¸»é¢˜å˜æ›´åœ¨å…¨å±€ç”Ÿæ•ˆ
- âœ… **å“åº”å¼æ›´æ–°**ï¼šä¸»é¢˜åˆ‡æ¢åæ‰€æœ‰é¢„è§ˆçª—å£è‡ªåŠ¨æ›´æ–°

---

## 2. ç°çŠ¶è¯„ä¼°

### 2.1 å·²å®ç°åŠŸèƒ½

| åŠŸèƒ½ | çŠ¶æ€ | å®ç°ç¨‹åº¦ | è¯´æ˜ |
|------|------|---------|------|
| åŸºç¡€ Markdown | âœ… å·²å®ç° | 80% | æ”¯æŒæ ‡é¢˜ã€åˆ—è¡¨ã€å¼•ç”¨ç­‰ |
| ä»£ç å— | âš ï¸ éƒ¨åˆ†å®ç° | 40% | æ˜¾ç¤ºä»£ç ï¼Œä½†æ— è¯­æ³•é«˜äº® |
| å›¾ç‰‡ | âš ï¸ éƒ¨åˆ†å®ç° | 50% | æœ¬åœ°å›¾ç‰‡å¯é¢„è§ˆï¼Œå¤–é“¾ä¸æ”¯æŒ |
| é“¾æ¥ | âœ… å·²å®ç° | 100% | æ”¯æŒè¶…é“¾æ¥ |
| è¡¨æ ¼ | âœ… å·²å®ç° | 90% | åŸºç¡€è¡¨æ ¼æ”¯æŒ |

### 2.2 ç¼ºå¤±åŠŸèƒ½

| åŠŸèƒ½ | çŠ¶æ€ | ä¼˜å…ˆçº§ | æŠ€æœ¯å¤æ‚åº¦ |
|------|------|--------|-----------|
| ä»£ç è¯­æ³•é«˜äº® | âŒ æœªå®ç° | **P0** | ğŸŸ¡ ä¸­ç­‰ |
| Mermaid å›¾è¡¨ | âŒ æœªå®ç° | **P0** | ğŸŸ¡ ä¸­ç­‰ |
| æ•°å­¦å…¬å¼ | âŒ æœªå®ç° | **P0** | ğŸŸ¡ ä¸­ç­‰ |
| TOC ç›®å½• | âŒ æœªå®ç° | **P0** | ğŸŸ¢ ç®€å• |
| å¤–éƒ¨å›¾ç‰‡é“¾æ¥ | âŒ æœªå®ç° | **P0** | ğŸŸ¢ ç®€å• |
| æ ·å¼ä¼˜åŒ– | âš ï¸ å¾…æ”¹è¿› | **P0** | ğŸŸ¢ ç®€å• |
| **ä¸»é¢˜ç³»ç»Ÿ** | âŒ æœªå®ç° | **P0** | ğŸŸ¡ ä¸­ç­‰ |
| **æ ·å¼æ¨¡æ¿** | âŒ æœªå®ç° | **P0** | ğŸŸ¡ ä¸­ç­‰ |
| å¯¼å‡ºä¼˜åŒ– | âš ï¸ å¾…æ”¹è¿› | **P1** | ğŸŸ¢ ç®€å• |

---

## 3. åŠŸèƒ½è§„åˆ’

### 3.1 åŠŸèƒ½æ¸…å•

#### **3.1.1 åŸºç¡€æ¸²æŸ“ä¼˜åŒ–ï¼ˆP0ï¼‰**

| åŠŸèƒ½ | ä¼˜å…ˆçº§ | å·¥æ—¶ | è¯´æ˜ |
|------|--------|------|------|
| Markdown æ ·å¼ç¾åŒ– | **P0** | 3h | ç°ä»£åŒ– CSS è®¾è®¡ï¼Œå‚è€ƒ GitHub æ ·å¼ |
| å“åº”å¼å¸ƒå±€ | **P0** | 2h | é€‚é…ä¸åŒçª—å£å¤§å° |
| æ‰“å°ä¼˜åŒ– | **P0** | 1h | æ‰“å°å‹å¥½çš„ CSS |

#### **3.1.2 ä»£ç å¢å¼ºï¼ˆP0ï¼‰**

| åŠŸèƒ½ | ä¼˜å…ˆçº§ | å·¥æ—¶ | è¯´æ˜ |
|------|--------|------|------|
| ä»£ç å—è¯­æ³•é«˜äº® | **P0** | 3h | æ”¯æŒ 50+ è¯­è¨€ï¼Œå¤šç§ä¸»é¢˜ |
| è¡Œå·æ˜¾ç¤º | **P0** | 1h | å¯é€‰æ˜¾ç¤ºè¡Œå· |
| ä»£ç å¤åˆ¶æŒ‰é’® | **P1** | 1h | ä¸€é”®å¤åˆ¶ä»£ç  |

#### **3.1.3 å›¾è¡¨ä¸å¯è§†åŒ–ï¼ˆP0ï¼‰**

| åŠŸèƒ½ | ä¼˜å…ˆçº§ | å·¥æ—¶ | è¯´æ˜ |
|------|--------|------|------|
| Mermaid å›¾è¡¨ | **P0** | 4h | æµç¨‹å›¾ã€æ—¶åºå›¾ã€ç”˜ç‰¹å›¾ç­‰ |
| å›¾è¡¨ä¸»é¢˜ | **P1** | 1h | é€‚é…æ˜æš—ä¸»é¢˜ |

#### **3.1.4 æ•°å­¦å…¬å¼ï¼ˆP0ï¼‰**

| åŠŸèƒ½ | ä¼˜å…ˆçº§ | å·¥æ—¶ | è¯´æ˜ |
|------|--------|------|------|
| è¡Œå†…å…¬å¼ `$...$` | **P0** | 2h | ä½¿ç”¨ KaTeX æ¸²æŸ“ |
| å—å…¬å¼ `$$...$$` | **P0** | 1h | ç‹¬ç«‹æ®µè½å…¬å¼ |

#### **3.1.5 å›¾ç‰‡å¢å¼ºï¼ˆP0ï¼‰**

| åŠŸèƒ½ | ä¼˜å…ˆçº§ | å·¥æ—¶ | è¯´æ˜ |
|------|--------|------|------|
| å¤–éƒ¨å›¾ç‰‡é“¾æ¥ | **P0** | 2h | æ”¯æŒ HTTP/HTTPS å›¾ç‰‡ |
| å›¾ç‰‡ç¼“å­˜ | **P1** | 2h | æœ¬åœ°ç¼“å­˜ï¼Œæå‡åŠ è½½é€Ÿåº¦ |
| å›¾ç‰‡ç‚¹å‡»æ”¾å¤§ | **P1** | 2h | ç‚¹å‡»æŸ¥çœ‹å¤§å›¾ |
| å›¾ç‰‡åŠ è½½å¤±è´¥æç¤º | **P0** | 1h | å‹å¥½çš„é”™è¯¯æç¤º |

#### **3.1.6 å¯¼èˆªå¢å¼ºï¼ˆP0ï¼‰**

| åŠŸèƒ½ | ä¼˜å…ˆçº§ | å·¥æ—¶ | è¯´æ˜ |
|------|--------|------|------|
| TOC ç›®å½•ç”Ÿæˆ | **P0** | 2h | è‡ªåŠ¨æå–æ ‡é¢˜å±‚çº§ |
| ç›®å½•ç‚¹å‡»è·³è½¬ | **P0** | 1h | æ»šåŠ¨åˆ°å¯¹åº”ä½ç½® |
| ç›®å½•æŠ˜å /å±•å¼€ | **P1** | 1h | æ”¯æŒæŠ˜å å­æ ‡é¢˜ |

#### **3.1.7 ä¸»é¢˜ç³»ç»Ÿï¼ˆP0ï¼‰**

| åŠŸèƒ½ | ä¼˜å…ˆçº§ | å·¥æ—¶ | è¯´æ˜ |
|------|--------|------|------|
| ä¸»é¢˜é…ç½®æ¨¡å‹ | **P0** | 2h | å®šä¹‰ä¸»é¢˜ç»“æ„ï¼Œæ”¯æŒæ‰©å±• |
| å†…ç½®ä¸»é¢˜ï¼ˆLight/Darkï¼‰ | **P0** | 3h | æä¾›é»˜è®¤æ˜æš—ä¸»é¢˜ |
| ä¸»é¢˜åŠ¨æ€åŠ è½½ | **P0** | 2h | è¿è¡Œæ—¶åˆ‡æ¢ä¸»é¢˜ |
| ä¸»é¢˜ç®¡ç†å™¨ | **P0** | 2h | ä¸»é¢˜æ³¨å†Œã€åˆ‡æ¢ã€æŒä¹…åŒ– |

#### **3.1.8 æ ·å¼æ¨¡æ¿ï¼ˆP0ï¼‰**

| åŠŸèƒ½ | ä¼˜å…ˆçº§ | å·¥æ—¶ | è¯´æ˜ |
|------|--------|------|------|
| CSS æ–‡ä»¶å¤–ç½® | **P0** | 2h | å°†CSSä»ä»£ç ä¸­åˆ†ç¦» |
| CSS å˜é‡ç³»ç»Ÿ | **P0** | 2h | æ”¯æŒå¯é…ç½®çš„æ ·å¼å˜é‡ |
| æ¨¡æ¿æ–‡ä»¶ç»“æ„ | **P0** | 1h | å®šä¹‰ä¸»é¢˜ç›®å½•ç»“æ„ |
| è‡ªå®šä¹‰ä¸»é¢˜å¯¼å…¥ | **P1** | 3h | ç”¨æˆ·å¯å¯¼å…¥è‡ªå®šä¹‰CSS |
| ä¸»é¢˜å¯¼å‡ºåˆ†äº« | **P1** | 2h | å¯¼å‡ºä¸»é¢˜é…ç½®æ–‡ä»¶ |

---

### 3.2 åŠŸèƒ½ä¼˜å…ˆçº§æ€»ç»“

**P0ï¼ˆå¿…é¡»å®ç°ï¼‰**ï¼š
- âœ… Markdown æ ·å¼ç¾åŒ–
- âœ… ä»£ç å—è¯­æ³•é«˜äº®
- âœ… Mermaid å›¾è¡¨æ¸²æŸ“
- âœ… æ•°å­¦å…¬å¼æ¸²æŸ“
- âœ… TOC ç›®å½•ç”Ÿæˆ
- âœ… å¤–éƒ¨å›¾ç‰‡é“¾æ¥æ”¯æŒ
- âœ… **ä¸»é¢˜ç³»ç»Ÿæ¶æ„**
- âœ… **CSS æ ·å¼æ¨¡æ¿åŒ–**
- âœ… **å†…ç½®æ˜æš—ä¸»é¢˜**

**P1ï¼ˆé‡è¦åŠŸèƒ½ï¼‰**ï¼š
- ğŸ“‹ ä»£ç å¤åˆ¶æŒ‰é’®
- ğŸ“‹ å›¾ç‰‡ç¼“å­˜
- ğŸ“‹ å›¾ç‰‡ç‚¹å‡»æ”¾å¤§
- ğŸ“‹ **è‡ªå®šä¹‰ä¸»é¢˜å¯¼å…¥**
- ğŸ“‹ **ä¸»é¢˜å¯¼å‡ºåˆ†äº«**

**P2ï¼ˆå¯é€‰åŠŸèƒ½ï¼‰**ï¼š
- ğŸ“‹ å¯¼å‡ºæ¨¡æ¿å®šåˆ¶
- ğŸ“‹ Markdown æ‰©å±•è¯­æ³•ï¼ˆè„šæ³¨ã€ä»»åŠ¡åˆ—è¡¨é«˜äº®ç­‰ï¼‰
- ğŸ“‹ **åœ¨çº¿ä¸»é¢˜å¸‚åœº**

---

## 4. æŠ€æœ¯æ–¹æ¡ˆ

### 4.1 æŠ€æœ¯æ ˆé€‰æ‹©

| åŠŸèƒ½æ¨¡å— | æŠ€æœ¯æ–¹æ¡ˆ | ç†ç”± |
|---------|---------|------|
| **Markdown è§£æ** | [Ink](https://github.com/JohnSundell/Ink) | çº¯ Swiftã€è½»é‡ã€å¿«é€Ÿ |
| **ä»£ç é«˜äº®** | [Splash](https://github.com/JohnSundell/Splash) | çº¯ Swiftã€æ”¯æŒå¤šè¯­è¨€ |
| **Mermaid å›¾è¡¨** | [Mermaid.js](https://mermaid.js.org/) (WebKit) | åŠŸèƒ½å®Œæ•´ã€ç¤¾åŒºæ´»è·ƒ |
| **æ•°å­¦å…¬å¼** | [KaTeX](https://katex.org/) (WebKit) | å¿«é€Ÿã€ä½“ç§¯å°ã€ç¦»çº¿å¯ç”¨ |
| **å›¾ç‰‡åŠ è½½** | URLSession + ImageCache | åŸç”Ÿ API + è‡ªå®šä¹‰ç¼“å­˜ |
| **æ¸²æŸ“å®¹å™¨** | WKWebView | æ”¯æŒ JavaScriptã€CSSã€ç¦»çº¿èµ„æº |

---

### 4.2 æ•´ä½“æ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚     NoteEditorView (SwiftUI)            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  Editor    â”‚    â”‚ Preview         â”‚ â”‚
â”‚  â”‚ (NSTextView)â”‚â—„â”€â”€â–ºâ”‚ (MarkdownPreview)â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
                            â–¼
            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
            â”‚ MarkdownRenderer (Service)â”‚
            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â–¼                   â–¼                   â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Ink Parser   â”‚  â”‚ Splash       â”‚  â”‚ WebKit       â”‚
â”‚ (Markdownâ†’   â”‚  â”‚ (Code        â”‚  â”‚ (Mermaid/    â”‚
â”‚  HTML)       â”‚  â”‚  Highlight)  â”‚  â”‚  KaTeX)      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
                            â–¼
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚ WKWebView    â”‚
                    â”‚ (Final       â”‚
                    â”‚  Rendering)  â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

### 4.3 ä¸»é¢˜ç³»ç»Ÿè®¾è®¡

#### **4.3.1 ä¸»é¢˜é…ç½®æ¨¡å‹**

```swift
import Foundation

/// ä¸»é¢˜é…ç½®
struct ThemeConfig: Codable, Identifiable {
    let id: String
    let name: String
    let displayName: String
    let author: String?
    let version: String
    let description: String?
    
    // æ ·å¼æ–‡ä»¶
    let cssFileName: String
    
    // ä»£ç é«˜äº®ä¸»é¢˜
    let codeHighlightTheme: CodeTheme
    
    // Mermaid å›¾è¡¨ä¸»é¢˜
    let mermaidTheme: String  // "default", "dark", "forest", "neutral"
    
    // é¢œè‰²å˜é‡ï¼ˆå¯é€‰ï¼Œç”¨äºåŠ¨æ€é…ç½®ï¼‰
    let colors: ThemeColors?
    
    // å­—ä½“é…ç½®ï¼ˆå¯é€‰ï¼‰
    let fonts: ThemeFonts?
    
    // åˆ›å»ºæ—¶é—´
    let createdAt: Date
    let updatedAt: Date
}

/// ä¸»é¢˜é¢œè‰²é…ç½®
struct ThemeColors: Codable {
    var primaryColor: String       // ä¸»è‰²è°ƒ
    var backgroundColor: String    // èƒŒæ™¯è‰²
    var textColor: String          // æ–‡æœ¬è‰²
    var secondaryTextColor: String // æ¬¡è¦æ–‡æœ¬è‰²
    var linkColor: String          // é“¾æ¥è‰²
    var codeBackgroundColor: String // ä»£ç èƒŒæ™¯è‰²
    var borderColor: String        // è¾¹æ¡†è‰²
    var accentColor: String        // å¼ºè°ƒè‰²
}

/// å­—ä½“é…ç½®
struct ThemeFonts: Codable {
    var bodyFont: String    // æ­£æ–‡å­—ä½“
    var headingFont: String // æ ‡é¢˜å­—ä½“
    var codeFont: String    // ä»£ç å­—ä½“
    var fontSize: Int       // åŸºç¡€å­—ä½“å¤§å°ï¼ˆpxï¼‰
    var lineHeight: Double  // è¡Œé«˜
}

/// ä»£ç é«˜äº®ä¸»é¢˜
enum CodeTheme: String, Codable {
    case xcode = "xcode"
    case github = "github"
    case monokai = "monokai"
    case dracula = "dracula"
    case solarizedLight = "solarized-light"
    case solarizedDark = "solarized-dark"
}
```

---

#### **4.3.2 ä¸»é¢˜ç®¡ç†å™¨**

```swift
import Foundation

/// ä¸»é¢˜ç®¡ç†å™¨ï¼ˆå•ä¾‹ï¼‰
actor ThemeManager {
    static let shared = ThemeManager()
    
    // MARK: - Properties
    
    private(set) var availableThemes: [ThemeConfig] = []
    private(set) var currentTheme: ThemeConfig
    
    private let themesDirectory: URL
    private let userThemesDirectory: URL
    
    // MARK: - Initialization
    
    private init() {
        // å†…ç½®ä¸»é¢˜ç›®å½•
        themesDirectory = Bundle.main.url(
            forResource: "Themes",
            withExtension: nil
        )!
        
        // ç”¨æˆ·è‡ªå®šä¹‰ä¸»é¢˜ç›®å½•
        let appSupport = FileManager.default.urls(
            for: .applicationSupportDirectory,
            in: .userDomainMask
        )[0]
        userThemesDirectory = appSupport
            .appendingPathComponent("Nota4/Themes")
        
        // åˆ›å»ºç”¨æˆ·ä¸»é¢˜ç›®å½•
        try? FileManager.default.createDirectory(
            at: userThemesDirectory,
            withIntermediateDirectories: true
        )
        
        // åŠ è½½é»˜è®¤ä¸»é¢˜
        currentTheme = ThemeConfig.defaultLight
        
        // å¼‚æ­¥åŠ è½½æ‰€æœ‰ä¸»é¢˜
        Task {
            await loadAllThemes()
        }
    }
    
    // MARK: - Public Methods
    
    /// åŠ è½½æ‰€æœ‰ä¸»é¢˜
    func loadAllThemes() async {
        var themes: [ThemeConfig] = []
        
        // åŠ è½½å†…ç½®ä¸»é¢˜
        themes.append(contentsOf: loadBuiltInThemes())
        
        // åŠ è½½ç”¨æˆ·ä¸»é¢˜
        themes.append(contentsOf: loadUserThemes())
        
        availableThemes = themes
        
        print("ğŸ“š [THEME] Loaded \(themes.count) themes")
    }
    
    /// åˆ‡æ¢ä¸»é¢˜
    func switchTheme(to themeId: String) async throws {
        guard let theme = availableThemes.first(where: { $0.id == themeId }) else {
            throw ThemeError.themeNotFound(themeId)
        }
        
        currentTheme = theme
        
        // æŒä¹…åŒ–ç”¨æˆ·é€‰æ‹©
        UserDefaults.standard.set(themeId, forKey: "selectedThemeId")
        
        // å‘é€é€šçŸ¥ï¼ˆé€šçŸ¥ UI æ›´æ–°ï¼‰
        await MainActor.run {
            NotificationCenter.default.post(
                name: .themeDidChange,
                object: theme
            )
        }
        
        print("ğŸ¨ [THEME] Switched to: \(theme.displayName)")
    }
    
    /// å¯¼å…¥è‡ªå®šä¹‰ä¸»é¢˜
    func importTheme(from url: URL) async throws -> ThemeConfig {
        // 1. éªŒè¯ä¸»é¢˜åŒ…
        let validator = ThemeValidator()
        try validator.validate(themePackageURL: url)
        
        // 2. è§£å‹ä¸»é¢˜åŒ…åˆ°ç”¨æˆ·ç›®å½•
        let themeId = url.deletingPathExtension().lastPathComponent
        let destination = userThemesDirectory.appendingPathComponent(themeId)
        
        if FileManager.default.fileExists(atPath: destination.path) {
            throw ThemeError.themeAlreadyExists(themeId)
        }
        
        try FileManager.default.copyItem(at: url, to: destination)
        
        // 3. è¯»å–ä¸»é¢˜é…ç½®
        let configURL = destination.appendingPathComponent("theme.json")
        let data = try Data(contentsOf: configURL)
        let theme = try JSONDecoder().decode(ThemeConfig.self, from: data)
        
        // 4. æ·»åŠ åˆ°å¯ç”¨ä¸»é¢˜åˆ—è¡¨
        availableThemes.append(theme)
        
        print("âœ… [THEME] Imported: \(theme.displayName)")
        
        return theme
    }
    
    /// å¯¼å‡ºä¸»é¢˜
    func exportTheme(_ themeId: String, to destinationURL: URL) async throws {
        guard let theme = availableThemes.first(where: { $0.id == themeId }) else {
            throw ThemeError.themeNotFound(themeId)
        }
        
        // æŸ¥æ‰¾ä¸»é¢˜æ–‡ä»¶
        let themeDir = userThemesDirectory.appendingPathComponent(themeId)
        
        guard FileManager.default.fileExists(atPath: themeDir.path) else {
            throw ThemeError.cannotExportBuiltInTheme
        }
        
        // æ‰“åŒ…ä¸»é¢˜
        try FileManager.default.copyItem(at: themeDir, to: destinationURL)
        
        print("ğŸ“¤ [THEME] Exported: \(theme.displayName)")
    }
    
    /// åˆ é™¤ç”¨æˆ·ä¸»é¢˜
    func deleteTheme(_ themeId: String) async throws {
        guard let theme = availableThemes.first(where: { $0.id == themeId }) else {
            throw ThemeError.themeNotFound(themeId)
        }
        
        // ä¸å…è®¸åˆ é™¤å†…ç½®ä¸»é¢˜
        guard !theme.id.hasPrefix("builtin-") else {
            throw ThemeError.cannotDeleteBuiltInTheme
        }
        
        // åˆ é™¤ä¸»é¢˜æ–‡ä»¶
        let themeDir = userThemesDirectory.appendingPathComponent(themeId)
        try FileManager.default.removeItem(at: themeDir)
        
        // ä»åˆ—è¡¨ä¸­ç§»é™¤
        availableThemes.removeAll { $0.id == themeId }
        
        // å¦‚æœåˆ é™¤çš„æ˜¯å½“å‰ä¸»é¢˜ï¼Œåˆ‡æ¢åˆ°é»˜è®¤ä¸»é¢˜
        if currentTheme.id == themeId {
            try await switchTheme(to: "builtin-light")
        }
        
        print("ğŸ—‘ï¸ [THEME] Deleted: \(theme.displayName)")
    }
    
    /// è·å–ä¸»é¢˜çš„ CSS å†…å®¹
    func getCSS(for theme: ThemeConfig) async throws -> String {
        // 1. å°è¯•ä»å†…ç½®èµ„æºåŠ è½½
        if let builtInURL = themesDirectory?.appendingPathComponent(theme.cssFileName),
           FileManager.default.fileExists(atPath: builtInURL.path) {
            return try String(contentsOf: builtInURL)
        }
        
        // 2. å°è¯•ä»ç”¨æˆ·ä¸»é¢˜åŠ è½½
        let userURL = userThemesDirectory
            .appendingPathComponent(theme.id)
            .appendingPathComponent(theme.cssFileName)
        
        if FileManager.default.fileExists(atPath: userURL.path) {
            return try String(contentsOf: userURL)
        }
        
        throw ThemeError.cssFileNotFound(theme.cssFileName)
    }
    
    // MARK: - Private Methods
    
    private func loadBuiltInThemes() -> [ThemeConfig] {
        // è¿”å›ç¡¬ç¼–ç çš„å†…ç½®ä¸»é¢˜
        return [
            ThemeConfig.defaultLight,
            ThemeConfig.defaultDark,
            ThemeConfig.github,
            ThemeConfig.notion
        ]
    }
    
    private func loadUserThemes() -> [ThemeConfig] {
        var themes: [ThemeConfig] = []
        
        guard let enumerator = FileManager.default.enumerator(
            at: userThemesDirectory,
            includingPropertiesForKeys: nil
        ) else {
            return themes
        }
        
        for case let fileURL as URL in enumerator {
            if fileURL.lastPathComponent == "theme.json" {
                do {
                    let data = try Data(contentsOf: fileURL)
                    let theme = try JSONDecoder().decode(ThemeConfig.self, from: data)
                    themes.append(theme)
                } catch {
                    print("âš ï¸ [THEME] Failed to load: \(fileURL.path)")
                }
            }
        }
        
        return themes
    }
}

// MARK: - Errors

enum ThemeError: LocalizedError {
    case themeNotFound(String)
    case themeAlreadyExists(String)
    case cssFileNotFound(String)
    case invalidThemePackage
    case cannotDeleteBuiltInTheme
    case cannotExportBuiltInTheme
    
    var errorDescription: String? {
        switch self {
        case .themeNotFound(let id):
            return "ä¸»é¢˜æœªæ‰¾åˆ°: \(id)"
        case .themeAlreadyExists(let id):
            return "ä¸»é¢˜å·²å­˜åœ¨: \(id)"
        case .cssFileNotFound(let name):
            return "CSS æ–‡ä»¶æœªæ‰¾åˆ°: \(name)"
        case .invalidThemePackage:
            return "æ— æ•ˆçš„ä¸»é¢˜åŒ…"
        case .cannotDeleteBuiltInTheme:
            return "æ— æ³•åˆ é™¤å†…ç½®ä¸»é¢˜"
        case .cannotExportBuiltInTheme:
            return "æ— æ³•å¯¼å‡ºå†…ç½®ä¸»é¢˜"
        }
    }
}

// MARK: - Notifications

extension Notification.Name {
    static let themeDidChange = Notification.Name("themeDidChange")
}
```

---

#### **4.3.3 å†…ç½®ä¸»é¢˜å®šä¹‰**

```swift
extension ThemeConfig {
    /// é»˜è®¤æµ…è‰²ä¸»é¢˜
    static let defaultLight = ThemeConfig(
        id: "builtin-light",
        name: "light",
        displayName: "æµ…è‰²",
        author: "Nota4",
        version: "1.0.0",
        description: "é»˜è®¤æµ…è‰²ä¸»é¢˜",
        cssFileName: "light.css",
        codeHighlightTheme: .xcode,
        mermaidTheme: "default",
        colors: ThemeColors(
            primaryColor: "#0066cc",
            backgroundColor: "#ffffff",
            textColor: "#333333",
            secondaryTextColor: "#666666",
            linkColor: "#0066cc",
            codeBackgroundColor: "#f5f5f5",
            borderColor: "#e0e0e0",
            accentColor: "#0066cc"
        ),
        fonts: ThemeFonts(
            bodyFont: "-apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif",
            headingFont: "-apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif",
            codeFont: "'SF Mono', Monaco, Menlo, 'Courier New', monospace",
            fontSize: 16,
            lineHeight: 1.6
        ),
        createdAt: Date(),
        updatedAt: Date()
    )
    
    /// é»˜è®¤æ·±è‰²ä¸»é¢˜
    static let defaultDark = ThemeConfig(
        id: "builtin-dark",
        name: "dark",
        displayName: "æ·±è‰²",
        author: "Nota4",
        version: "1.0.0",
        description: "é»˜è®¤æ·±è‰²ä¸»é¢˜",
        cssFileName: "dark.css",
        codeHighlightTheme: .dracula,
        mermaidTheme: "dark",
        colors: ThemeColors(
            primaryColor: "#4da6ff",
            backgroundColor: "#1e1e1e",
            textColor: "#e0e0e0",
            secondaryTextColor: "#aaaaaa",
            linkColor: "#4da6ff",
            codeBackgroundColor: "#2d2d2d",
            borderColor: "#404040",
            accentColor: "#4da6ff"
        ),
        fonts: ThemeFonts(
            bodyFont: "-apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif",
            headingFont: "-apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif",
            codeFont: "'SF Mono', Monaco, Menlo, 'Courier New', monospace",
            fontSize: 16,
            lineHeight: 1.6
        ),
        createdAt: Date(),
        updatedAt: Date()
    )
    
    /// GitHub é£æ ¼ä¸»é¢˜
    static let github = ThemeConfig(
        id: "builtin-github",
        name: "github",
        displayName: "GitHub",
        author: "Nota4",
        version: "1.0.0",
        description: "GitHub é£æ ¼ä¸»é¢˜",
        cssFileName: "github.css",
        codeHighlightTheme: .github,
        mermaidTheme: "neutral",
        colors: nil,  // ä½¿ç”¨ CSS æ–‡ä»¶ä¸­çš„æ ·å¼
        fonts: nil,
        createdAt: Date(),
        updatedAt: Date()
    )
    
    /// Notion é£æ ¼ä¸»é¢˜
    static let notion = ThemeConfig(
        id: "builtin-notion",
        name: "notion",
        displayName: "Notion",
        author: "Nota4",
        version: "1.0.0",
        description: "Notion é£æ ¼ä¸»é¢˜",
        cssFileName: "notion.css",
        codeHighlightTheme: .github,
        mermaidTheme: "default",
        colors: nil,
        fonts: nil,
        createdAt: Date(),
        updatedAt: Date()
    )
}
```

---

#### **4.3.4 ä¸»é¢˜æ–‡ä»¶ç»“æ„**

```
Nota4/
â””â”€â”€ Resources/
    â””â”€â”€ Themes/
        â”œâ”€â”€ light.css                # æµ…è‰²ä¸»é¢˜æ ·å¼
        â”œâ”€â”€ dark.css                 # æ·±è‰²ä¸»é¢˜æ ·å¼
        â”œâ”€â”€ github.css               # GitHub é£æ ¼
        â”œâ”€â”€ notion.css               # Notion é£æ ¼
        â””â”€â”€ template/                # ä¸»é¢˜æ¨¡æ¿ï¼ˆç”¨äºåˆ›å»ºè‡ªå®šä¹‰ä¸»é¢˜ï¼‰
            â”œâ”€â”€ theme.json           # ä¸»é¢˜é…ç½®ç¤ºä¾‹
            â”œâ”€â”€ style.css            # CSS æ¨¡æ¿
            â””â”€â”€ README.md            # ä¸»é¢˜å¼€å‘æŒ‡å—

ç”¨æˆ·ä¸»é¢˜å­˜å‚¨ä½ç½®ï¼š
~/Library/Application Support/Nota4/Themes/
â””â”€â”€ my-custom-theme/
    â”œâ”€â”€ theme.json               # ä¸»é¢˜é…ç½®
    â”œâ”€â”€ style.css                # è‡ªå®šä¹‰æ ·å¼
    â””â”€â”€ preview.png              # ä¸»é¢˜é¢„è§ˆå›¾ï¼ˆå¯é€‰ï¼‰
```

---

#### **4.3.5 CSS å˜é‡ç³»ç»Ÿ**

ä¸»é¢˜ CSS æ–‡ä»¶åº”ä½¿ç”¨ CSS å˜é‡ï¼Œä¾¿äºåŠ¨æ€é…ç½®ï¼š

```css
/* light.css */
:root {
    /* é¢œè‰²å˜é‡ */
    --primary-color: #0066cc;
    --background-color: #ffffff;
    --text-color: #333333;
    --secondary-text-color: #666666;
    --link-color: #0066cc;
    --link-hover-color: #0052a3;
    --code-background-color: #f5f5f5;
    --code-border-color: #e0e0e0;
    --border-color: #e0e0e0;
    --accent-color: #0066cc;
    --blockquote-border-color: #0066cc;
    --table-header-bg: #f5f5f5;
    
    /* å­—ä½“å˜é‡ */
    --body-font: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'PingFang SC', sans-serif;
    --heading-font: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
    --code-font: 'SF Mono', Monaco, Menlo, 'Courier New', monospace;
    
    /* å°ºå¯¸å˜é‡ */
    --font-size: 16px;
    --line-height: 1.6;
    --heading-line-height: 1.3;
    --code-font-size: 0.9em;
    
    /* é—´è·å˜é‡ */
    --spacing-xs: 0.25rem;
    --spacing-sm: 0.5rem;
    --spacing-md: 1rem;
    --spacing-lg: 1.5rem;
    --spacing-xl: 2rem;
    
    /* åœ†è§’å˜é‡ */
    --border-radius-sm: 3px;
    --border-radius-md: 6px;
    --border-radius-lg: 8px;
}

/* ä½¿ç”¨å˜é‡ */
body {
    font-family: var(--body-font);
    font-size: var(--font-size);
    line-height: var(--line-height);
    color: var(--text-color);
    background: var(--background-color);
}

a {
    color: var(--link-color);
}

a:hover {
    color: var(--link-hover-color);
}

code {
    background: var(--code-background-color);
    border: 1px solid var(--code-border-color);
    border-radius: var(--border-radius-sm);
    font-family: var(--code-font);
    font-size: var(--code-font-size);
}

/* å…¶ä»–æ ·å¼... */
```

---

### 4.4 UI äº¤äº’è®¾è®¡

#### **4.4.1 é¦–é€‰é¡¹ - ä¸»é¢˜è®¾ç½®å¡ç‰‡**

**ä½ç½®**ï¼š`Preferences -> Appearance -> Preview Theme`

**åŠŸèƒ½å¸ƒå±€**ï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  é¢„è§ˆä¸»é¢˜                                     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                             â”‚
â”‚  [â—‹ æµ…è‰²]  [â— æ·±è‰²]  [â—‹ GitHub]  [â—‹ Notion] â”‚
â”‚                                             â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚
â”‚                                             â”‚
â”‚  è‡ªå®šä¹‰ä¸»é¢˜åˆ—è¡¨ï¼š                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚
â”‚  â”‚ â€¢ My Custom Theme    [å¯¼å‡º][åˆ é™¤] â”‚       â”‚
â”‚  â”‚ â€¢ Dark Blue          [å¯¼å‡º][åˆ é™¤] â”‚       â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚
â”‚                                             â”‚
â”‚  [+ å¯¼å…¥ä¸»é¢˜]                                â”‚
â”‚                                             â”‚
â”‚  é¢„è§ˆç¤ºä¾‹ï¼š                                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚
â”‚  â”‚ # æ ‡é¢˜ç¤ºä¾‹                       â”‚       â”‚
â”‚  â”‚ è¿™æ˜¯ä¸€æ®µ**ç²—ä½“**æ–‡æœ¬             â”‚       â”‚
â”‚  â”‚ ```swift                        â”‚       â”‚
â”‚  â”‚ func hello() { }                â”‚       â”‚
â”‚  â”‚ ```                             â”‚       â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**äº¤äº’è§„åˆ™**ï¼š

1. **ä¸»é¢˜é€‰æ‹©**ï¼š
   - ç‚¹å‡»ä»»æ„ä¸»é¢˜å¡ç‰‡å³å¯åˆ‡æ¢
   - å½“å‰ä¸»é¢˜æ˜¾ç¤ºé€‰ä¸­çŠ¶æ€ï¼ˆè“è‰²è¾¹æ¡† + å‹¾é€‰å›¾æ ‡ï¼‰
   - åˆ‡æ¢åç«‹å³ä¿å­˜åˆ° UserDefaults
   - æ‰€æœ‰æ‰“å¼€çš„é¢„è§ˆçª—å£è‡ªåŠ¨æ›´æ–°

2. **å¯¼å…¥ä¸»é¢˜**ï¼š
   - ç‚¹å‡»"å¯¼å…¥ä¸»é¢˜"æŒ‰é’®æ‰“å¼€æ–‡ä»¶é€‰æ‹©å™¨
   - æ”¯æŒ `.notatheme` æ ¼å¼ï¼ˆåŒ…å« theme.json + CSS æ–‡ä»¶çš„ç›®å½•ï¼‰
   - éªŒè¯ä¸»é¢˜åŒ…æ ¼å¼ï¼Œå¤±è´¥æ˜¾ç¤ºé”™è¯¯æç¤º
   - å¯¼å…¥æˆåŠŸåè‡ªåŠ¨æ·»åŠ åˆ°è‡ªå®šä¹‰ä¸»é¢˜åˆ—è¡¨

3. **å¯¼å‡ºä¸»é¢˜**ï¼š
   - åªèƒ½å¯¼å‡ºç”¨æˆ·è‡ªå®šä¹‰ä¸»é¢˜ï¼ˆå†…ç½®ä¸»é¢˜ä¸å¯å¯¼å‡ºï¼‰
   - ç‚¹å‡»"å¯¼å‡º"æ‰“å¼€ä¿å­˜å¯¹è¯æ¡†
   - å¯¼å‡ºä¸º `.notatheme` ç›®å½•åŒ…

4. **åˆ é™¤ä¸»é¢˜**ï¼š
   - åªèƒ½åˆ é™¤ç”¨æˆ·è‡ªå®šä¹‰ä¸»é¢˜
   - åˆ é™¤å‰æ˜¾ç¤ºç¡®è®¤å¯¹è¯æ¡†
   - å¦‚æœåˆ é™¤çš„æ˜¯å½“å‰ä¸»é¢˜ï¼Œè‡ªåŠ¨åˆ‡æ¢åˆ°"æµ…è‰²"

5. **å®æ—¶é¢„è§ˆ**ï¼š
   - é¢„è§ˆç¤ºä¾‹åŒºåŸŸå®æ—¶æ˜¾ç¤ºå½“å‰ä¸»é¢˜æ•ˆæœ
   - åŒ…å«æ ‡é¢˜ã€ä»£ç å—ã€åˆ—è¡¨ç­‰å¸¸è§å…ƒç´ 

---

#### **4.4.2 é¢„è§ˆç•Œé¢ - çº¯ç²¹çš„å†…å®¹å±•ç¤º**

**è®¾è®¡åŸåˆ™**ï¼š
- âŒ **ä¸æä¾›ä¸»é¢˜åˆ‡æ¢æŒ‰é’®** - é¿å…ç•Œé¢æ··ä¹±
- âŒ **ä¸æ˜¾ç¤ºä¸»é¢˜åç§°** - ä¿æŒå†…å®¹èšç„¦
- âœ… **è‡ªåŠ¨å“åº”ä¸»é¢˜å˜æ›´** - ç›‘å¬å…¨å±€ä¸»é¢˜å˜æ›´é€šçŸ¥
- âœ… **æ— ç¼é‡æ–°æ¸²æŸ“** - ä¸»é¢˜åˆ‡æ¢æ—¶å¹³æ»‘è¿‡æ¸¡

**å®ç°æ–¹å¼**ï¼š
```swift
// PreviewView åªè´Ÿè´£å±•ç¤ºï¼Œä¸ç®¡ç†ä¸»é¢˜é…ç½®
struct MarkdownPreviewView: View {
    let markdown: String
    let store: StoreOf<PreviewFeature>
    
    var body: some View {
        WebView(html: viewStore.renderedHTML)
            .onReceive(NotificationCenter.default.publisher(for: .themeDidChange)) { _ in
                // ä¸»é¢˜å˜æ›´æ—¶è‡ªåŠ¨é‡æ–°æ¸²æŸ“
                viewStore.send(.themeChanged)
            }
    }
}
```

---

### 4.5 TCA çŠ¶æ€ç®¡ç†

#### **4.5.1 æ¶æ„åŸåˆ™**

åœ¨ TCAï¼ˆThe Composable Architectureï¼‰ä¸­ç®¡ç†ä¸»é¢˜ç³»ç»Ÿéœ€è¦éµå¾ªä»¥ä¸‹åŸåˆ™ï¼š

1. **å•ä¸€æ•°æ®æºï¼ˆSingle Source of Truthï¼‰**ï¼š
   - ä¸»é¢˜çŠ¶æ€ç»Ÿä¸€å­˜å‚¨åœ¨ `AppState` æˆ– `PreferencesState` ä¸­
   - æ‰€æœ‰ç»„ä»¶é€šè¿‡è®¢é˜…çŠ¶æ€å˜åŒ–æ¥å“åº”ä¸»é¢˜æ›´æ–°

2. **å•å‘æ•°æ®æµï¼ˆUnidirectional Data Flowï¼‰**ï¼š
   - ç”¨æˆ·æ“ä½œ â†’ Action â†’ Reducer â†’ State æ›´æ–° â†’ View é‡æ–°æ¸²æŸ“

3. **å‰¯ä½œç”¨éš”ç¦»ï¼ˆSide Effect Isolationï¼‰**ï¼š
   - ä¸»é¢˜åŠ è½½ã€å¯¼å…¥ã€å¯¼å‡ºç­‰å¼‚æ­¥æ“ä½œé€šè¿‡ `Effect` å¤„ç†
   - ä½¿ç”¨ `@Dependency` æ³¨å…¥ `ThemeManager`

4. **å¯æµ‹è¯•æ€§ï¼ˆTestabilityï¼‰**ï¼š
   - `ThemeManager` é€šè¿‡ä¾èµ–æ³¨å…¥ï¼Œæµ‹è¯•æ—¶å¯æ›¿æ¢ä¸º Mock
   - Reducer çº¯å‡½æ•°ï¼Œæ˜“äºå•å…ƒæµ‹è¯•

---

#### **4.5.2 State å®šä¹‰**

```swift
import ComposableArchitecture

// MARK: - Theme State

/// ä¸»é¢˜åŠŸèƒ½çš„çŠ¶æ€
struct ThemeState: Equatable {
    /// å½“å‰é€‰ä¸­çš„ä¸»é¢˜ ID
    var currentThemeId: String = "builtin-light"
    
    /// æ‰€æœ‰å¯ç”¨çš„ä¸»é¢˜åˆ—è¡¨
    var availableThemes: IdentifiedArrayOf<ThemeConfig> = []
    
    /// ä¸»é¢˜åŠ è½½çŠ¶æ€
    var isLoadingThemes: Bool = false
    
    /// ä¸»é¢˜å¯¼å…¥/å¯¼å‡ºçŠ¶æ€
    var importExportState: ImportExportState = .idle
    
    /// é”™è¯¯ä¿¡æ¯
    var errorMessage: String?
    
    // MARK: - Computed Properties
    
    /// å½“å‰ä¸»é¢˜é…ç½®
    var currentTheme: ThemeConfig? {
        availableThemes[id: currentThemeId]
    }
    
    /// å†…ç½®ä¸»é¢˜åˆ—è¡¨
    var builtInThemes: [ThemeConfig] {
        availableThemes.filter { $0.id.hasPrefix("builtin-") }
    }
    
    /// ç”¨æˆ·è‡ªå®šä¹‰ä¸»é¢˜åˆ—è¡¨
    var customThemes: [ThemeConfig] {
        availableThemes.filter { !$0.id.hasPrefix("builtin-") }
    }
}

/// å¯¼å…¥/å¯¼å‡ºçŠ¶æ€
enum ImportExportState: Equatable {
    case idle
    case importing
    case exporting
    case success
    case failure(String)
}
```

---

#### **4.5.3 Action å®šä¹‰**

```swift
// MARK: - Theme Actions

enum ThemeAction: Equatable {
    // MARK: - Lifecycle
    case onAppear
    case loadThemes
    case themesLoaded(TaskResult<[ThemeConfig]>)
    
    // MARK: - Theme Selection
    case selectTheme(String)
    case themeSelected(TaskResult<ThemeConfig>)
    
    // MARK: - Import/Export
    case importThemeButtonTapped
    case importTheme(URL)
    case importThemeResponse(TaskResult<ThemeConfig>)
    
    case exportTheme(String)
    case exportThemeResponse(TaskResult<Void>)
    
    // MARK: - Delete
    case deleteTheme(String)
    case deleteThemeResponse(TaskResult<String>)
    case confirmDelete(String)
    case cancelDelete
    
    // MARK: - Error Handling
    case dismissError
}
```

---

#### **4.5.4 Reducer å®ç°**

```swift
import ComposableArchitecture

// MARK: - Theme Reducer

struct ThemeFeature: Reducer {
    struct State: Equatable {
        var theme: ThemeState = ThemeState()
        // ... å…¶ä»–çŠ¶æ€
    }
    
    enum Action: Equatable {
        case theme(ThemeAction)
        // ... å…¶ä»– Action
    }
    
    @Dependency(\.themeManager) var themeManager
    @Dependency(\.mainQueue) var mainQueue
    
    var body: some ReducerOf<Self> {
        Reduce { state, action in
            switch action {
            // MARK: - Lifecycle
            case .theme(.onAppear):
                return .send(.theme(.loadThemes))
                
            case .theme(.loadThemes):
                state.theme.isLoadingThemes = true
                return .run { send in
                    await send(.theme(.themesLoaded(
                        TaskResult {
                            await themeManager.loadAllThemes()
                            return await themeManager.availableThemes
                        }
                    )))
                }
                
            case let .theme(.themesLoaded(.success(themes))):
                state.theme.isLoadingThemes = false
                state.theme.availableThemes = IdentifiedArray(uniqueElements: themes)
                // æ¢å¤ä¸Šæ¬¡é€‰æ‹©çš„ä¸»é¢˜
                if let savedThemeId = UserDefaults.standard.string(forKey: "selectedThemeId") {
                    state.theme.currentThemeId = savedThemeId
                }
                return .none
                
            case let .theme(.themesLoaded(.failure(error))):
                state.theme.isLoadingThemes = false
                state.theme.errorMessage = error.localizedDescription
                return .none
                
            // MARK: - Theme Selection
            case let .theme(.selectTheme(themeId)):
                guard state.theme.currentThemeId != themeId else { return .none }
                
                return .run { send in
                    await send(.theme(.themeSelected(
                        TaskResult {
                            try await themeManager.switchTheme(to: themeId)
                            return await themeManager.currentTheme
                        }
                    )))
                }
                
            case let .theme(.themeSelected(.success(theme))):
                state.theme.currentThemeId = theme.id
                // é€šçŸ¥æ‰€æœ‰é¢„è§ˆçª—å£æ›´æ–°
                // NotificationCenter ä¼šåœ¨ ThemeManager å†…éƒ¨å‘é€
                return .none
                
            case let .theme(.themeSelected(.failure(error))):
                state.theme.errorMessage = error.localizedDescription
                return .none
                
            // MARK: - Import Theme
            case let .theme(.importTheme(url)):
                state.theme.importExportState = .importing
                return .run { send in
                    await send(.theme(.importThemeResponse(
                        TaskResult {
                            try await themeManager.importTheme(from: url)
                        }
                    )))
                }
                
            case let .theme(.importThemeResponse(.success(theme))):
                state.theme.importExportState = .success
                state.theme.availableThemes.append(theme)
                // 2ç§’åé‡ç½®çŠ¶æ€
                return .run { send in
                    try await mainQueue.sleep(for: .seconds(2))
                    await send(.theme(.dismissError))
                }
                
            case let .theme(.importThemeResponse(.failure(error))):
                state.theme.importExportState = .failure(error.localizedDescription)
                return .none
                
            // MARK: - Export Theme
            case let .theme(.exportTheme(themeId)):
                state.theme.importExportState = .exporting
                // æ‰“å¼€ä¿å­˜å¯¹è¯æ¡†ç”± View å±‚å¤„ç†
                return .none
                
            // MARK: - Delete Theme
            case let .theme(.confirmDelete(themeId)):
                return .run { send in
                    await send(.theme(.deleteThemeResponse(
                        TaskResult {
                            try await themeManager.deleteTheme(themeId)
                            return themeId
                        }
                    )))
                }
                
            case let .theme(.deleteThemeResponse(.success(themeId))):
                state.theme.availableThemes.remove(id: themeId)
                // å¦‚æœåˆ é™¤çš„æ˜¯å½“å‰ä¸»é¢˜ï¼Œåˆ‡æ¢åˆ°é»˜è®¤ä¸»é¢˜
                if state.theme.currentThemeId == themeId {
                    return .send(.theme(.selectTheme("builtin-light")))
                }
                return .none
                
            case let .theme(.deleteThemeResponse(.failure(error))):
                state.theme.errorMessage = error.localizedDescription
                return .none
                
            // MARK: - Error Handling
            case .theme(.dismissError):
                state.theme.errorMessage = nil
                state.theme.importExportState = .idle
                return .none
                
            default:
                return .none
            }
        }
    }
}
```

---

#### **4.5.5 Dependency æ³¨å…¥**

```swift
import ComposableArchitecture

// MARK: - ThemeManager Dependency

extension ThemeManager: DependencyKey {
    static let liveValue: ThemeManager = .shared
    
    static let testValue: ThemeManager = {
        // æµ‹è¯•ç”¨çš„ Mock ThemeManager
        let manager = ThemeManager()
        // é…ç½®æµ‹è¯•æ•°æ®
        return manager
    }()
}

extension DependencyValues {
    var themeManager: ThemeManager {
        get { self[ThemeManager.self] }
        set { self[ThemeManager.self] = newValue }
    }
}
```

---

#### **4.5.6 é¢„è§ˆåŠŸèƒ½é›†æˆ**

```swift
// MARK: - Preview Feature State

struct PreviewFeature: Reducer {
    struct State: Equatable {
        var markdown: String = ""
        var renderedHTML: String = ""
        var isRendering: Bool = false
        
        // ä¸ç›´æ¥å­˜å‚¨ä¸»é¢˜ï¼Œè€Œæ˜¯é€šè¿‡å…¨å±€çŠ¶æ€è·å–
        var currentThemeId: String = ""
    }
    
    enum Action: Equatable {
        case markdownChanged(String)
        case renderMarkdown
        case renderCompleted(String)
        case themeChanged  // å“åº”å…¨å±€ä¸»é¢˜å˜æ›´
    }
    
    @Dependency(\.markdownRenderer) var markdownRenderer
    @Dependency(\.themeManager) var themeManager
    
    var body: some ReducerOf<Self> {
        Reduce { state, action in
            switch action {
            case let .markdownChanged(markdown):
                state.markdown = markdown
                return .send(.renderMarkdown)
                    .debounce(id: "render", for: .milliseconds(300), scheduler: mainQueue)
                
            case .renderMarkdown:
                state.isRendering = true
                let markdown = state.markdown
                
                return .run { send in
                    let html = try await markdownRenderer.renderToHTML(
                        markdown: markdown,
                        options: .default  // ä½¿ç”¨å½“å‰ä¸»é¢˜
                    )
                    await send(.renderCompleted(html))
                }
                
            case let .renderCompleted(html):
                state.renderedHTML = html
                state.isRendering = false
                return .none
                
            case .themeChanged:
                // ä¸»é¢˜å˜æ›´æ—¶é‡æ–°æ¸²æŸ“
                state.currentThemeId = await themeManager.currentTheme.id
                return .send(.renderMarkdown)
            }
        }
    }
}
```

---

#### **4.5.7 TCA æœ€ä½³å®è·µæ€»ç»“**

| åŸåˆ™ | è¯´æ˜ | ç¤ºä¾‹ |
|------|------|------|
| **çŠ¶æ€ä¸å¯å˜** | State æ˜¯ structï¼Œé€šè¿‡ Reducer çº¯å‡½æ•°æ›´æ–° | `state.theme.currentThemeId = themeId` |
| **å‰¯ä½œç”¨éš”ç¦»** | å¼‚æ­¥æ“ä½œé€šè¿‡ Effect å¤„ç† | `.run { send in ... }` |
| **ä¾èµ–æ³¨å…¥** | ä½¿ç”¨ `@Dependency` æ³¨å…¥å¤–éƒ¨ä¾èµ– | `@Dependency(\.themeManager)` |
| **å¯æµ‹è¯•æ€§** | Reducer çº¯å‡½æ•°ï¼Œå‰¯ä½œç”¨å¯æ¨¡æ‹Ÿ | `ThemeManager.testValue` |
| **æ¨¡å—åŒ–** | åŠŸèƒ½ç‹¬ç«‹ï¼Œé€šè¿‡ `Scope` ç»„åˆ | `ThemeFeature` ç‹¬ç«‹å®ç° |
| **é”™è¯¯å¤„ç†** | ä½¿ç”¨ `TaskResult` ç»Ÿä¸€å¤„ç†æˆåŠŸ/å¤±è´¥ | `.themesLoaded(TaskResult<[Theme]>)` |
| **é˜²æŠ–ä¼˜åŒ–** | ä½¿ç”¨ `.debounce()` å‡å°‘é¢‘ç¹æ›´æ–° | æ¸²æŸ“é˜²æŠ– 300ms |

---

### 4.6 æ ¸å¿ƒå®ç°

#### **4.6.1 MarkdownRenderer æœåŠ¡ï¼ˆæ›´æ–°ç‰ˆï¼‰**

```swift
import Foundation
import Ink
import Splash

/// Markdown æ¸²æŸ“æœåŠ¡
actor MarkdownRenderer {
    // MARK: - Properties
    
    private let parser = MarkdownParser()
    private let highlighter = SyntaxHighlighter(format: HTMLOutputFormat())
    private let imageCache = ImageCache.shared
    private let themeManager = ThemeManager.shared
    
    // MARK: - Public Methods
    
    /// æ¸²æŸ“ Markdown ä¸ºå®Œæ•´ HTML
    func renderToHTML(
        markdown: String,
        options: RenderOptions = .default
    ) async throws -> String {
        // 1. é¢„å¤„ç†ï¼ˆæå– Mermaidã€æ•°å­¦å…¬å¼ã€ä»£ç å—ï¼‰
        let preprocessed = preprocess(markdown)
        
        // 2. Markdown â†’ HTMLï¼ˆä½¿ç”¨ Inkï¼‰
        var html = parser.html(from: preprocessed.markdown)
        
        // 3. æ³¨å…¥ä»£ç é«˜äº®
        html = highlightCodeBlocks(html)
        
        // 4. æ³¨å…¥ Mermaid å›¾è¡¨
        html = injectMermaidCharts(html, charts: preprocessed.mermaidCharts)
        
        // 5. æ³¨å…¥æ•°å­¦å…¬å¼
        html = injectMathFormulas(html, formulas: preprocessed.mathFormulas)
        
        // 6. å¤„ç†å¤–éƒ¨å›¾ç‰‡é“¾æ¥
        html = try await processImageLinks(html)
        
        // 7. ç”Ÿæˆ TOCï¼ˆå¦‚æœéœ€è¦ï¼‰
        let toc = options.includeTOC ? generateTOC(from: markdown) : nil
        
        // 8. æ„å»ºå®Œæ•´ HTML
        return await buildFullHTML(
            content: html,
            toc: toc,
            options: options
        )
    }
    
    // MARK: - Private Methods
    
    /// é¢„å¤„ç† Markdownï¼ˆæå–ç‰¹æ®Šå—ï¼‰
    private func preprocess(_ markdown: String) -> PreprocessedMarkdown {
        var result = markdown
        var mermaidCharts: [String] = []
        var mathFormulas: [MathFormula] = []
        
        // æå– Mermaid ä»£ç å—
        let mermaidPattern = "```mermaid\\n([\\s\\S]*?)```"
        if let regex = try? NSRegularExpression(pattern: mermaidPattern) {
            let matches = regex.matches(
                in: result,
                range: NSRange(result.startIndex..., in: result)
            )
            
            for (index, match) in matches.enumerated().reversed() {
                if let range = Range(match.range(at: 1), in: result) {
                    let chart = String(result[range])
                    mermaidCharts.insert(chart, at: 0)
                    
                    // æ›¿æ¢ä¸ºå ä½ç¬¦
                    let fullRange = Range(match.range, in: result)!
                    result.replaceSubrange(
                        fullRange,
                        with: "<div class=\"mermaid-placeholder\" data-index=\"\\(index)\"></div>"
                    )
                }
            }
        }
        
        // æå–æ•°å­¦å…¬å¼ï¼ˆå—å…¬å¼ $$...$$ï¼‰
        let blockMathPattern = "\\$\\$([\\s\\S]*?)\\$\\$"
        if let regex = try? NSRegularExpression(pattern: blockMathPattern) {
            let matches = regex.matches(
                in: result,
                range: NSRange(result.startIndex..., in: result)
            )
            
            for (index, match) in matches.enumerated().reversed() {
                if let range = Range(match.range(at: 1), in: result) {
                    let formula = String(result[range])
                    mathFormulas.insert(.block(formula), at: 0)
                    
                    let fullRange = Range(match.range, in: result)!
                    result.replaceSubrange(
                        fullRange,
                        with: "<div class=\"math-placeholder block\" data-index=\"\\(index)\"></div>"
                    )
                }
            }
        }
        
        // æå–è¡Œå†…å…¬å¼ï¼ˆ$...$ï¼‰
        let inlineMathPattern = "\\$([^$]+?)\\$"
        if let regex = try? NSRegularExpression(pattern: inlineMathPattern) {
            let matches = regex.matches(
                in: result,
                range: NSRange(result.startIndex..., in: result)
            )
            
            for (index, match) in matches.enumerated().reversed() {
                if let range = Range(match.range(at: 1), in: result) {
                    let formula = String(result[range])
                    mathFormulas.insert(.inline(formula), at: 0)
                    
                    let fullRange = Range(match.range, in: result)!
                    result.replaceSubrange(
                        fullRange,
                        with: "<span class=\"math-placeholder inline\" data-index=\"\\(index)\"></span>"
                    )
                }
            }
        }
        
        return PreprocessedMarkdown(
            markdown: result,
            mermaidCharts: mermaidCharts,
            mathFormulas: mathFormulas
        )
    }
    
    /// ä»£ç å—è¯­æ³•é«˜äº®
    private func highlightCodeBlocks(_ html: String) -> String {
        var result = html
        
        // åŒ¹é…ä»£ç å—
        let pattern = "<pre><code class=\"language-(\\w+)\">([\\s\\S]*?)</code></pre>"
        guard let regex = try? NSRegularExpression(pattern: pattern) else {
            return result
        }
        
        let matches = regex.matches(
            in: result,
            range: NSRange(result.startIndex..., in: result)
        )
        
        for match in matches.reversed() {
            guard let langRange = Range(match.range(at: 1), in: result),
                  let codeRange = Range(match.range(at: 2), in: result) else {
                continue
            }
            
            let language = String(result[langRange])
            let code = String(result[codeRange])
                .replacingOccurrences(of: "&lt;", with: "<")
                .replacingOccurrences(of: "&gt;", with: ">")
                .replacingOccurrences(of: "&amp;", with: "&")
            
            // ä½¿ç”¨ Splash é«˜äº®
            let highlighted = highlighter.highlight(code)
            
            let fullRange = Range(match.range, in: result)!
            result.replaceSubrange(
                fullRange,
                with: """
                <pre class="code-block" data-language="\(language)">
                    <code class="language-\(language)">\(highlighted)</code>
                </pre>
                """
            )
        }
        
        return result
    }
    
    /// æ³¨å…¥ Mermaid å›¾è¡¨
    private func injectMermaidCharts(_ html: String, charts: [String]) -> String {
        var result = html
        
        for (index, chart) in charts.enumerated() {
            let placeholder = "<div class=\"mermaid-placeholder\" data-index=\"\\(index)\"></div>"
            let mermaidDiv = """
            <div class="mermaid">
            \(chart)
            </div>
            """
            result = result.replacingOccurrences(of: placeholder, with: mermaidDiv)
        }
        
        return result
    }
    
    /// æ³¨å…¥æ•°å­¦å…¬å¼
    private func injectMathFormulas(_ html: String, formulas: [MathFormula]) -> String {
        var result = html
        
        for (index, formula) in formulas.enumerated() {
            switch formula {
            case .block(let latex):
                let placeholder = "<div class=\"math-placeholder block\" data-index=\"\\(index)\"></div>"
                let mathDiv = """
                <div class="math-block">
                    <span class="katex-formula" data-formula="\(escapeHTML(latex))"></span>
                </div>
                """
                result = result.replacingOccurrences(of: placeholder, with: mathDiv)
                
            case .inline(let latex):
                let placeholder = "<span class=\"math-placeholder inline\" data-index=\"\\(index)\"></span>"
                let mathSpan = """
                <span class="math-inline katex-formula" data-formula="\(escapeHTML(latex))"></span>
                """
                result = result.replacingOccurrences(of: placeholder, with: mathSpan)
            }
        }
        
        return result
    }
    
    /// å¤„ç†å¤–éƒ¨å›¾ç‰‡é“¾æ¥
    private func processImageLinks(_ html: String) async throws -> String {
        var result = html
        
        // åŒ¹é…å›¾ç‰‡æ ‡ç­¾
        let pattern = "<img src=\"([^\"]+)\" alt=\"([^\"]*)\"[^>]*>"
        guard let regex = try? NSRegularExpression(pattern: pattern) else {
            return result
        }
        
        let matches = regex.matches(
            in: result,
            range: NSRange(result.startIndex..., in: result)
        )
        
        for match in matches.reversed() {
            guard let srcRange = Range(match.range(at: 1), in: result) else {
                continue
            }
            
            let src = String(result[srcRange])
            
            // å¤„ç†å¤–éƒ¨é“¾æ¥
            if src.hasPrefix("http://") || src.hasPrefix("https://") {
                // æ·»åŠ  loading å’Œ error å¤„ç†
                let fullRange = Range(match.range, in: result)!
                let original = String(result[fullRange])
                
                let enhanced = original
                    .replacingOccurrences(of: "<img ", with: "<img loading=\"lazy\" onerror=\"this.src='data:image/svg+xml,%3Csvg xmlns=%22http://www.w3.org/2000/svg%22 width=%22200%22 height=%22150%22%3E%3Crect fill=%22%23f0f0f0%22 width=%22200%22 height=%22150%22/%3E%3Ctext x=%2250%25%22 y=%2250%25%22 dominant-baseline=%22middle%22 text-anchor=%22middle%22 fill=%22%23999%22%3EåŠ è½½å¤±è´¥%3C/text%3E%3C/svg%3E'\" ")
                
                result.replaceSubrange(fullRange, with: enhanced)
            }
        }
        
        return result
    }
    
    /// ç”Ÿæˆ TOC
    private func generateTOC(from markdown: String) -> String {
        var toc = "<nav class=\"toc\">\n<h2>ç›®å½•</h2>\n<ul>\n"
        
        let lines = markdown.components(separatedBy: .newlines)
        var currentLevel = 0
        
        for line in lines {
            if line.hasPrefix("#") {
                let level = line.prefix(while: { $0 == "#" }).count
                let title = line.dropFirst(level).trimmingCharacters(in: .whitespaces)
                let id = title.lowercased().replacingOccurrences(of: " ", with: "-")
                
                // å¤„ç†å±‚çº§å˜åŒ–
                if level > currentLevel {
                    for _ in currentLevel..<level {
                        toc += "<ul>\n"
                    }
                } else if level < currentLevel {
                    for _ in level..<currentLevel {
                        toc += "</ul>\n</li>\n"
                    }
                }
                
                toc += "<li><a href=\"#\(id)\">\(escapeHTML(title))</a></li>\n"
                currentLevel = level
            }
        }
        
        // å…³é—­æ‰€æœ‰æœªå…³é—­çš„æ ‡ç­¾
        for _ in 0..<currentLevel {
            toc += "</ul>\n"
        }
        
        toc += "</nav>"
        return toc
    }
    
    /// æ„å»ºå®Œæ•´ HTML
    private func buildFullHTML(
        content: String,
        toc: String?,
        options: RenderOptions
    ) async -> String {
        let css = await getCSS(themeId: options.themeId)
        let theme = await (options.themeId != nil ? 
            themeManager.availableThemes.first(where: { $0.id == options.themeId }) : 
            themeManager.currentTheme) ?? ThemeConfig.defaultLight
        
        return """
        <!DOCTYPE html>
        <html lang="zh-CN">
        <head>
            <meta charset="UTF-8">
            <meta name="viewport" content="width=device-width, initial-scale=1.0">
            <title>Preview</title>
            \(css)
            \(getMermaidScript())
            \(getKaTeXScript())
        </head>
        <body data-theme="\(theme.id)">
            <div class="container">
                \(toc ?? "")
                <article class="content">
                \(content)
                </article>
            </div>
            <script>
                // åˆå§‹åŒ– Mermaid
                mermaid.initialize({ 
                    startOnLoad: true, 
                    theme: '\(theme.mermaidTheme)' 
                });
                
                // åˆå§‹åŒ– KaTeX
                document.querySelectorAll('.katex-formula').forEach(el => {
                    const formula = el.dataset.formula;
                    const isBlock = el.parentElement.classList.contains('math-block');
                    katex.render(formula, el, {
                        displayMode: isBlock,
                        throwOnError: false
                    });
                });
            </script>
        </body>
        </html>
        """
    }
    
    // MARK: - Helper Methods
    
    private func escapeHTML(_ text: String) -> String {
        text
            .replacingOccurrences(of: "&", with: "&amp;")
            .replacingOccurrences(of: "<", with: "&lt;")
            .replacingOccurrences(of: ">", with: "&gt;")
            .replacingOccurrences(of: "\"", with: "&quot;")
            .replacingOccurrences(of: "'", with: "&#39;")
    }
    
    private func getCSS(themeId: String?) async -> String {
        // è·å–ä¸»é¢˜
        let theme: ThemeConfig
        if let id = themeId,
           let selectedTheme = await themeManager.availableThemes.first(where: { $0.id == id }) {
            theme = selectedTheme
        } else {
            theme = await themeManager.currentTheme
        }
        
        // åŠ è½½ CSS æ–‡ä»¶
        do {
            let css = try await themeManager.getCSS(for: theme)
            
            // å¦‚æœä¸»é¢˜æœ‰é¢œè‰²é…ç½®ï¼Œæ³¨å…¥ CSS å˜é‡
            var finalCSS = css
            if let colors = theme.colors {
                let variables = generateCSSVariables(colors: colors, fonts: theme.fonts)
                finalCSS = variables + "\n" + css
            }
            
            return "<style>\(finalCSS)</style>"
        } catch {
            print("âš ï¸ [RENDERER] Failed to load CSS: \(error)")
            // é™çº§æ–¹æ¡ˆï¼šä½¿ç”¨å†…ç½®é»˜è®¤æ ·å¼
            return "<style>\(CSSStyles.fallback)</style>"
        }
    }
    
    private func generateCSSVariables(colors: ThemeColors, fonts: ThemeFonts?) -> String {
        var css = ":root {\n"
        
        // é¢œè‰²å˜é‡
        css += "    --primary-color: \(colors.primaryColor);\n"
        css += "    --background-color: \(colors.backgroundColor);\n"
        css += "    --text-color: \(colors.textColor);\n"
        css += "    --secondary-text-color: \(colors.secondaryTextColor);\n"
        css += "    --link-color: \(colors.linkColor);\n"
        css += "    --code-background-color: \(colors.codeBackgroundColor);\n"
        css += "    --border-color: \(colors.borderColor);\n"
        css += "    --accent-color: \(colors.accentColor);\n"
        
        // å­—ä½“å˜é‡
        if let fonts = fonts {
            css += "    --body-font: \(fonts.bodyFont);\n"
            css += "    --heading-font: \(fonts.headingFont);\n"
            css += "    --code-font: \(fonts.codeFont);\n"
            css += "    --font-size: \(fonts.fontSize)px;\n"
            css += "    --line-height: \(fonts.lineHeight);\n"
        }
        
        css += "}\n"
        return css
    }
    
    private func getMermaidScript() -> String {
        // ä»æœ¬åœ°èµ„æºåŠ è½½æˆ–ä½¿ç”¨ CDN
        return """
        <script src="https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.min.js"></script>
        """
    }
    
    private func getKaTeXScript() -> String {
        return """
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css">
        <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"></script>
        """
    }
}

// MARK: - Supporting Types

struct PreprocessedMarkdown {
    let markdown: String
    let mermaidCharts: [String]
    let mathFormulas: [MathFormula]
}

enum MathFormula {
    case inline(String)
    case block(String)
}

struct RenderOptions {
    var themeId: String? = nil  // nil è¡¨ç¤ºä½¿ç”¨å½“å‰ä¸»é¢˜
    var includeTOC: Bool = false
    var codeLineNumbers: Bool = false
    
    static let `default` = RenderOptions()
}
```

---

#### **4.4.2 CSS é™çº§æ–¹æ¡ˆ**

```swift
enum CSSStyles {
    /// é™çº§æ–¹æ¡ˆï¼šå½“æ— æ³•åŠ è½½ä¸»é¢˜ CSS æ—¶ä½¿ç”¨
    static let fallback = """
    /* åŸºç¡€æ ·å¼ */
    * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
    }
    
    body {
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'PingFang SC', 'Hiragino Sans GB', sans-serif;
        font-size: 16px;
        line-height: 1.6;
        color: #333;
        background: #fff;
        padding: 2rem;
    }
    
    body.dark {
        color: #e0e0e0;
        background: #1e1e1e;
    }
    
    .container {
        max-width: 900px;
        margin: 0 auto;
    }
    
    /* ç›®å½•æ ·å¼ */
    .toc {
        background: #f8f8f8;
        border: 1px solid #e0e0e0;
        border-radius: 8px;
        padding: 1.5rem;
        margin-bottom: 2rem;
    }
    
    body.dark .toc {
        background: #2d2d2d;
        border-color: #404040;
    }
    
    .toc h2 {
        font-size: 1.2rem;
        margin-bottom: 1rem;
    }
    
    .toc ul {
        list-style: none;
        padding-left: 1rem;
    }
    
    .toc li {
        margin: 0.5rem 0;
    }
    
    .toc a {
        color: #0066cc;
        text-decoration: none;
    }
    
    .toc a:hover {
        text-decoration: underline;
    }
    
    /* æ–‡ç« å†…å®¹ */
    .content {
        line-height: 1.8;
    }
    
    /* æ ‡é¢˜ */
    h1, h2, h3, h4, h5, h6 {
        margin: 1.5rem 0 1rem 0;
        font-weight: 600;
        line-height: 1.3;
    }
    
    h1 { font-size: 2rem; border-bottom: 2px solid #e0e0e0; padding-bottom: 0.5rem; }
    h2 { font-size: 1.6rem; border-bottom: 1px solid #e0e0e0; padding-bottom: 0.3rem; }
    h3 { font-size: 1.3rem; }
    h4 { font-size: 1.1rem; }
    h5 { font-size: 1rem; }
    h6 { font-size: 0.9rem; color: #666; }
    
    /* æ®µè½ */
    p {
        margin: 1rem 0;
    }
    
    /* é“¾æ¥ */
    a {
        color: #0066cc;
        text-decoration: none;
    }
    
    a:hover {
        text-decoration: underline;
    }
    
    body.dark a {
        color: #4da6ff;
    }
    
    /* åˆ—è¡¨ */
    ul, ol {
        margin: 1rem 0;
        padding-left: 2rem;
    }
    
    li {
        margin: 0.3rem 0;
    }
    
    /* å¼•ç”¨ */
    blockquote {
        border-left: 4px solid #0066cc;
        padding-left: 1rem;
        margin: 1rem 0;
        color: #666;
        font-style: italic;
    }
    
    body.dark blockquote {
        border-color: #4da6ff;
        color: #aaa;
    }
    
    /* ä»£ç å— */
    code {
        background: #f5f5f5;
        border: 1px solid #e0e0e0;
        border-radius: 3px;
        padding: 0.2rem 0.4rem;
        font-family: 'SF Mono', Monaco, Menlo, 'Courier New', monospace;
        font-size: 0.9em;
    }
    
    body.dark code {
        background: #2d2d2d;
        border-color: #404040;
    }
    
    pre {
        background: #f8f8f8;
        border: 1px solid #e0e0e0;
        border-radius: 6px;
        padding: 1rem;
        margin: 1rem 0;
        overflow-x: auto;
        position: relative;
    }
    
    body.dark pre {
        background: #2d2d2d;
        border-color: #404040;
    }
    
    pre code {
        background: none;
        border: none;
        padding: 0;
        display: block;
    }
    
    /* ä»£ç é«˜äº®ï¼ˆSplash è¾“å‡ºï¼‰ */
    .code-block {
        position: relative;
    }
    
    .code-block::before {
        content: attr(data-language);
        position: absolute;
        top: 0.5rem;
        right: 0.5rem;
        background: rgba(0, 0, 0, 0.1);
        padding: 0.2rem 0.5rem;
        border-radius: 3px;
        font-size: 0.75rem;
        text-transform: uppercase;
        color: #666;
    }
    
    /* è¡¨æ ¼ */
    table {
        border-collapse: collapse;
        width: 100%;
        margin: 1rem 0;
        overflow: hidden;
        border-radius: 6px;
    }
    
    th, td {
        border: 1px solid #e0e0e0;
        padding: 0.75rem 1rem;
        text-align: left;
    }
    
    th {
        background: #f5f5f5;
        font-weight: 600;
    }
    
    body.dark th, body.dark td {
        border-color: #404040;
    }
    
    body.dark th {
        background: #2d2d2d;
    }
    
    /* å›¾ç‰‡ */
    img {
        max-width: 100%;
        height: auto;
        border-radius: 6px;
        margin: 1rem 0;
        display: block;
    }
    
    /* åˆ†éš”çº¿ */
    hr {
        border: none;
        border-top: 2px solid #e0e0e0;
        margin: 2rem 0;
    }
    
    body.dark hr {
        border-color: #404040;
    }
    
    /* Mermaid å›¾è¡¨ */
    .mermaid {
        background: #fff;
        border: 1px solid #e0e0e0;
        border-radius: 6px;
        padding: 1rem;
        margin: 1rem 0;
        text-align: center;
    }
    
    body.dark .mermaid {
        background: #2d2d2d;
        border-color: #404040;
    }
    
    /* æ•°å­¦å…¬å¼ */
    .math-block {
        margin: 1rem 0;
        overflow-x: auto;
        text-align: center;
    }
    
    .math-inline {
        display: inline-block;
        vertical-align: middle;
    }
    
    /* æ‰“å°ä¼˜åŒ– */
    @media print {
        body {
            padding: 0;
            font-size: 12pt;
        }
        
        .container {
            max-width: none;
        }
        
        .toc {
            page-break-after: always;
        }
        
        h1, h2, h3, h4, h5, h6 {
            page-break-after: avoid;
        }
        
        pre, .mermaid {
            page-break-inside: avoid;
        }
        
        a {
            color: #000;
        }
        
        a[href^="http"]::after {
            content: " (" attr(href) ")";
            font-size: 0.8em;
            color: #666;
        }
    }
    """
}
```

---

#### **4.3.3 å›¾ç‰‡ç¼“å­˜å®ç°**

```swift
import Foundation
import AppKit

/// å›¾ç‰‡ç¼“å­˜ç®¡ç†å™¨
actor ImageCache {
    static let shared = ImageCache()
    
    private var memoryCache: [URL: NSImage] = [:]
    private let diskCacheDir: URL
    private let maxMemoryCacheSize = 50 // æœ€å¤šç¼“å­˜ 50 å¼ å›¾ç‰‡
    
    private init() {
        let cacheDir = FileManager.default.urls(
            for: .cachesDirectory,
            in: .userDomainMask
        )[0].appendingPathComponent("Nota4/ImageCache")
        
        try? FileManager.default.createDirectory(
            at: cacheDir,
            withIntermediateDirectories: true
        )
        
        self.diskCacheDir = cacheDir
    }
    
    /// è·å–å›¾ç‰‡ï¼ˆå…ˆæŸ¥å†…å­˜ï¼Œå†æŸ¥ç£ç›˜ï¼Œæœ€åä¸‹è½½ï¼‰
    func image(for url: URL) async throws -> NSImage {
        // 1. æ£€æŸ¥å†…å­˜ç¼“å­˜
        if let cached = memoryCache[url] {
            print("ğŸ“· [IMAGE] Memory cache hit: \(url.lastPathComponent)")
            return cached
        }
        
        // 2. æ£€æŸ¥ç£ç›˜ç¼“å­˜
        let diskPath = diskCacheDir.appendingPathComponent(url.lastPathComponent)
        if FileManager.default.fileExists(atPath: diskPath.path),
           let image = NSImage(contentsOf: diskPath) {
            print("ğŸ“· [IMAGE] Disk cache hit: \(url.lastPathComponent)")
            // å­˜å…¥å†…å­˜ç¼“å­˜
            await cacheInMemory(url: url, image: image)
            return image
        }
        
        // 3. ä¸‹è½½å›¾ç‰‡
        print("ğŸ“· [IMAGE] Downloading: \(url.absoluteString)")
        let (data, _) = try await URLSession.shared.data(from: url)
        
        guard let image = NSImage(data: data) else {
            throw ImageCacheError.invalidImageData
        }
        
        // 4. ç¼“å­˜åˆ°å†…å­˜å’Œç£ç›˜
        await cacheInMemory(url: url, image: image)
        try? data.write(to: diskPath)
        
        return image
    }
    
    /// å­˜å…¥å†…å­˜ç¼“å­˜
    private func cacheInMemory(url: URL, image: NSImage) async {
        // å¦‚æœç¼“å­˜å·²æ»¡ï¼Œç§»é™¤æœ€æ—§çš„
        if memoryCache.count >= maxMemoryCacheSize {
            if let firstKey = memoryCache.keys.first {
                memoryCache.removeValue(forKey: firstKey)
            }
        }
        
        memoryCache[url] = image
    }
    
    /// æ¸…ç©ºç¼“å­˜
    func clearCache() async {
        memoryCache.removeAll()
        try? FileManager.default.removeItem(at: diskCacheDir)
        try? FileManager.default.createDirectory(
            at: diskCacheDir,
            withIntermediateDirectories: true
        )
        print("ğŸ§¹ [IMAGE] Cache cleared")
    }
}

enum ImageCacheError: Error {
    case invalidImageData
}
```

---

### 4.4 ä¾èµ–æ›´æ–°

éœ€è¦åœ¨ `Package.swift` ä¸­æ·»åŠ ä»¥ä¸‹ä¾èµ–ï¼š

```swift
dependencies: [
    // ç°æœ‰ä¾èµ–...
    .package(url: "https://github.com/JohnSundell/Ink.git", from: "0.6.0"),
    .package(url: "https://github.com/JohnSundell/Splash.git", from: "0.16.0")
],
targets: [
    .executableTarget(
        name: "Nota4",
        dependencies: [
            // ç°æœ‰ä¾èµ–...
            "Ink",
            "Splash"
        ]
    )
]
```

**æ³¨æ„**ï¼šMermaid å’Œ KaTeX é€šè¿‡ CDN åŠ è½½ï¼Œæ— éœ€ SPM ä¾èµ–ã€‚

---

## 5. å®æ–½è®¡åˆ’

### 5.1 ä¸‰é˜¶æ®µå®æ–½

#### **Phase 1: åŸºç¡€æ¸²æŸ“ + ä»£ç é«˜äº®**ï¼ˆ1 å¤©ï¼Œ6hï¼‰

**ç›®æ ‡**ï¼šå®ŒæˆåŸºç¡€æ¸²æŸ“æ¶æ„å’Œä»£ç é«˜äº®

| ä»»åŠ¡ | å·¥æ—¶ | äº§å‡º |
|------|------|------|
| é›†æˆ Ink åº“ | 1h | Markdown â†’ HTML è½¬æ¢ |
| é›†æˆ Splash åº“ | 1h | ä»£ç è¯­æ³•é«˜äº® |
| å®ç° MarkdownRenderer | 2h | æ ¸å¿ƒæ¸²æŸ“æœåŠ¡ |
| CSS æ ·å¼è®¾è®¡ | 1.5h | ç°ä»£åŒ–æ ·å¼è¡¨ |
| é›†æˆåˆ° MarkdownPreview | 0.5h | UI å±‚é›†æˆ |

**éªŒæ”¶æ ‡å‡†**ï¼š
- âœ… åŸºç¡€ Markdown æ­£ç¡®æ¸²æŸ“
- âœ… ä»£ç å—æœ‰è¯­æ³•é«˜äº®
- âœ… æ ·å¼ç¾è§‚ï¼Œé€‚é…æ˜æš—ä¸»é¢˜

---

#### **Phase 2: å›¾è¡¨ + å…¬å¼**ï¼ˆ1 å¤©ï¼Œ7hï¼‰

**ç›®æ ‡**ï¼šæ”¯æŒ Mermaid å’Œæ•°å­¦å…¬å¼

| ä»»åŠ¡ | å·¥æ—¶ | äº§å‡º |
|------|------|------|
| Mermaid.js é›†æˆ | 2h | æµç¨‹å›¾ã€æ—¶åºå›¾ç­‰ |
| KaTeX é›†æˆ | 2h | è¡Œå†…å’Œå—å…¬å¼ |
| é¢„å¤„ç†é€»è¾‘ | 2h | æå–ç‰¹æ®Šå— |
| æµ‹è¯•éªŒè¯ | 1h | å„ç§å›¾è¡¨å’Œå…¬å¼ |

**éªŒæ”¶æ ‡å‡†**ï¼š
- âœ… Mermaid å›¾è¡¨æ­£ç¡®æ¸²æŸ“
- âœ… æ•°å­¦å…¬å¼æ­£ç¡®æ¸²æŸ“
- âœ… æ”¯æŒå¤æ‚åµŒå¥—

---

#### **Phase 3: ä¸»é¢˜ç³»ç»Ÿ**ï¼ˆ1.5 å¤©ï¼Œ12hï¼‰

**ç›®æ ‡**ï¼šå®ç°å®Œæ•´çš„ä¸»é¢˜ç³»ç»Ÿæ¶æ„ + TCA é›†æˆ

| ä»»åŠ¡ | å·¥æ—¶ | äº§å‡º |
|------|------|------|
| ä¸»é¢˜é…ç½®æ¨¡å‹ | 1h | ThemeConfigã€ThemeColorsã€ThemeFonts |
| ä¸»é¢˜ç®¡ç†å™¨å®ç° | 2h | ThemeManager å•ä¾‹ |
| å†…ç½®ä¸»é¢˜å®šä¹‰ | 1.5h | Lightã€Darkã€GitHubã€Notion |
| CSS æ–‡ä»¶å¤–ç½® | 2h | åˆ›å»ºç‹¬ç«‹ CSS æ–‡ä»¶ |
| CSS å˜é‡ç³»ç»Ÿ | 1h | å®šä¹‰å¯é…ç½®çš„ CSS å˜é‡ |
| **TCA çŠ¶æ€ç®¡ç†** | **2h** | **ThemeStateã€ThemeActionã€ThemeFeature** |
| **é¦–é€‰é¡¹ UI å®ç°** | **1.5h** | **ä¸»é¢˜è®¾ç½®å¡ç‰‡ç•Œé¢** |
| **é¢„è§ˆè‡ªåŠ¨æ›´æ–°** | **0.5h** | **ç›‘å¬ä¸»é¢˜å˜æ›´é€šçŸ¥** |
| é›†æˆåˆ°æ¸²æŸ“å™¨ | 0.5h | MarkdownRenderer é›†æˆä¸»é¢˜ |

**éªŒæ”¶æ ‡å‡†**ï¼š
- âœ… ä¸»é¢˜ç®¡ç†å™¨æ­£å¸¸å·¥ä½œ
- âœ… å¯ä»¥åŠ¨æ€åˆ‡æ¢ä¸»é¢˜
- âœ… 4 ä¸ªå†…ç½®ä¸»é¢˜æ­£ç¡®æ¸²æŸ“
- âœ… CSS å˜é‡ç³»ç»Ÿç”Ÿæ•ˆ
- âœ… ä¸»é¢˜é…ç½®æŒä¹…åŒ–
- âœ… **TCA çŠ¶æ€ç®¡ç†ç¬¦åˆæœ€ä½³å®è·µ**
- âœ… **é¦–é€‰é¡¹ç•Œé¢å®Œæ•´å¯ç”¨**
- âœ… **é¢„è§ˆçª—å£è‡ªåŠ¨å“åº”ä¸»é¢˜å˜æ›´**

---

#### **Phase 4: TOC + å›¾ç‰‡å¢å¼º**ï¼ˆåŠå¤©ï¼Œ4hï¼‰

**ç›®æ ‡**ï¼šå®Œå–„å¯¼èˆªå’Œå›¾ç‰‡æ”¯æŒ

| ä»»åŠ¡ | å·¥æ—¶ | äº§å‡º |
|------|------|------|
| TOC ç”Ÿæˆ | 1.5h | è‡ªåŠ¨ç›®å½• |
| å¤–éƒ¨å›¾ç‰‡é“¾æ¥æ”¯æŒ | 1h | HTTP/HTTPS å›¾ç‰‡ |
| å›¾ç‰‡ç¼“å­˜ | 1h | ImageCache å®ç° |
| é”™è¯¯å¤„ç†ä¼˜åŒ– | 0.5h | å‹å¥½çš„é”™è¯¯æç¤º |

**éªŒæ”¶æ ‡å‡†**ï¼š
- âœ… TOC æ­£ç¡®ç”Ÿæˆï¼Œå¯ç‚¹å‡»è·³è½¬
- âœ… å¤–éƒ¨å›¾ç‰‡æ­£å¸¸æ˜¾ç¤º
- âœ… å›¾ç‰‡åŠ è½½å¤±è´¥æœ‰æç¤º
- âœ… å›¾ç‰‡ç¼“å­˜ç”Ÿæ•ˆ

---

### 5.2 æ€»å·¥æ—¶ä¼°ç®—

| é˜¶æ®µ | å·¥æ—¶ | è¯´æ˜ |
|------|------|------|
| Phase 1 | 6h | åŸºç¡€æ¸²æŸ“ + ä»£ç é«˜äº® |
| Phase 2 | 7h | å›¾è¡¨ + å…¬å¼ |
| Phase 3 | 12h | **ä¸»é¢˜ç³»ç»Ÿ + TCA + UI** |
| Phase 4 | 4h | TOC + å›¾ç‰‡å¢å¼º |
| æµ‹è¯• + ä¼˜åŒ– | 4h | å…¨é¢æµ‹è¯•å’Œæ€§èƒ½ä¼˜åŒ– |
| **æ€»è®¡** | **33h** | **çº¦ 4 ä¸ªå·¥ä½œæ—¥** |

**æ³¨**ï¼š
- ä¸»é¢˜ç³»ç»Ÿæ˜¯æ–°å¢çš„æ ¸å¿ƒåŠŸèƒ½ï¼Œæä¾›äº†æœªæ¥æ‰©å±•çš„åŸºç¡€æ¶æ„
- TCA çŠ¶æ€ç®¡ç†ç¡®ä¿çŠ¶æ€ä¸€è‡´æ€§å’Œå¯æµ‹è¯•æ€§
- UI äº¤äº’éµå¾ª"é…ç½®é›†ä¸­åŒ–ã€é¢„è§ˆç®€æ´åŒ–"åŸåˆ™

---

## 6. æµ‹è¯•è®¡åˆ’

### 6.1 åŠŸèƒ½æµ‹è¯•

#### **6.1.1 åŸºç¡€ Markdown**
- [ ] æ ‡é¢˜ï¼ˆH1-H6ï¼‰
- [ ] æ®µè½å’Œæ¢è¡Œ
- [ ] åŠ ç²—ã€æ–œä½“ã€åˆ é™¤çº¿
- [ ] æœ‰åºåˆ—è¡¨
- [ ] æ— åºåˆ—è¡¨
- [ ] ä»»åŠ¡åˆ—è¡¨
- [ ] å¼•ç”¨å—
- [ ] é“¾æ¥
- [ ] å›¾ç‰‡
- [ ] è¡¨æ ¼
- [ ] åˆ†éš”çº¿

#### **6.1.2 ä»£ç é«˜äº®**
- [ ] JavaScript é«˜äº®
- [ ] Python é«˜äº®
- [ ] Swift é«˜äº®
- [ ] Java é«˜äº®
- [ ] HTML/CSS é«˜äº®
- [ ] SQL é«˜äº®
- [ ] Bash/Shell é«˜äº®
- [ ] è¡Œå·æ˜¾ç¤ºï¼ˆå¯é€‰ï¼‰
- [ ] è¯­è¨€æ ‡ç­¾æ˜¾ç¤º

#### **6.1.3 Mermaid å›¾è¡¨**
- [ ] æµç¨‹å›¾ï¼ˆFlowchartï¼‰
- [ ] æ—¶åºå›¾ï¼ˆSequence Diagramï¼‰
- [ ] ç”˜ç‰¹å›¾ï¼ˆGantt Chartï¼‰
- [ ] ç±»å›¾ï¼ˆClass Diagramï¼‰
- [ ] çŠ¶æ€å›¾ï¼ˆState Diagramï¼‰
- [ ] é¥¼å›¾ï¼ˆPie Chartï¼‰
- [ ] æ˜æš—ä¸»é¢˜é€‚é…

#### **6.1.4 æ•°å­¦å…¬å¼**
- [ ] è¡Œå†…å…¬å¼ `$x^2$`
- [ ] å—å…¬å¼ `$$\sum_{i=1}^{n}$$`
- [ ] å¤æ‚å…¬å¼ï¼ˆçŸ©é˜µã€ç§¯åˆ†ç­‰ï¼‰
- [ ] å¸Œè…Šå­—æ¯
- [ ] ç‰¹æ®Šç¬¦å·

#### **6.1.5 å›¾ç‰‡æ”¯æŒ**
- [ ] æœ¬åœ°å›¾ç‰‡ï¼ˆç›¸å¯¹è·¯å¾„ï¼‰
- [ ] æœ¬åœ°å›¾ç‰‡ï¼ˆç»å¯¹è·¯å¾„ï¼‰
- [ ] HTTP å¤–é“¾å›¾ç‰‡
- [ ] HTTPS å¤–é“¾å›¾ç‰‡
- [ ] å›¾ç‰‡åŠ è½½ä¸­çŠ¶æ€
- [ ] å›¾ç‰‡åŠ è½½å¤±è´¥æç¤º
- [ ] å›¾ç‰‡ç¼“å­˜ç”Ÿæ•ˆ

#### **6.1.6 TOC ç›®å½•**
- [ ] è‡ªåŠ¨æå–æ ‡é¢˜
- [ ] å¤šçº§å±‚çº§
- [ ] ç‚¹å‡»è·³è½¬
- [ ] æ»šåŠ¨å®šä½

#### **6.1.7 ä¸»é¢˜ç³»ç»Ÿ**
- [ ] åŠ è½½å†…ç½®ä¸»é¢˜ï¼ˆLightã€Darkã€GitHubã€Notionï¼‰
- [ ] åŠ¨æ€åˆ‡æ¢ä¸»é¢˜
- [ ] ä¸»é¢˜é…ç½®æŒä¹…åŒ–
- [ ] å¯¼å…¥è‡ªå®šä¹‰ä¸»é¢˜
- [ ] å¯¼å‡ºç”¨æˆ·ä¸»é¢˜
- [ ] åˆ é™¤ç”¨æˆ·ä¸»é¢˜
- [ ] CSS å˜é‡æ­£ç¡®æ³¨å…¥
- [ ] ä¸»é¢˜åˆ‡æ¢åé¢„è§ˆå®æ—¶æ›´æ–°
- [ ] ä¸»é¢˜ä¸ä»£ç é«˜äº®é…åˆ
- [ ] ä¸»é¢˜ä¸ Mermaid å›¾è¡¨é…åˆ
- [ ] æ— æ•ˆä¸»é¢˜é™çº§å¤„ç†

#### **6.1.8 TCA çŠ¶æ€ç®¡ç†**
- [ ] ThemeState æ­£ç¡®åˆå§‹åŒ–
- [ ] ä¸»é¢˜åˆ‡æ¢ Action æ­£ç¡®å¤„ç†
- [ ] ThemeManager ä¾èµ–æ­£ç¡®æ³¨å…¥
- [ ] å¼‚æ­¥åŠ è½½ä¸»é¢˜æ­£ç¡®å¤„ç†
- [ ] é”™è¯¯çŠ¶æ€æ­£ç¡®æ˜¾ç¤º
- [ ] TaskResult æ­£ç¡®å¤„ç†æˆåŠŸ/å¤±è´¥
- [ ] çŠ¶æ€æŒä¹…åŒ–åˆ° UserDefaults
- [ ] ä¸»é¢˜åˆ é™¤åè‡ªåŠ¨åˆ‡æ¢åˆ°é»˜è®¤ä¸»é¢˜
- [ ] Reducer æµ‹è¯•è¦†ç›–æ‰€æœ‰ Action
- [ ] é˜²æŠ–æœºåˆ¶æ­£ç¡®å·¥ä½œï¼ˆé¢„è§ˆæ¸²æŸ“ï¼‰

#### **6.1.9 UI äº¤äº’**
- [ ] é¦–é€‰é¡¹ä¸»é¢˜å¡ç‰‡æ­£ç¡®æ˜¾ç¤º
- [ ] å½“å‰ä¸»é¢˜æ˜¾ç¤ºé€‰ä¸­çŠ¶æ€
- [ ] ç‚¹å‡»ä¸»é¢˜å¡ç‰‡æ­£ç¡®åˆ‡æ¢
- [ ] å¯¼å…¥ä¸»é¢˜æŒ‰é’®æ‰“å¼€æ–‡ä»¶é€‰æ‹©å™¨
- [ ] å¯¼å…¥æˆåŠŸæ˜¾ç¤ºæç¤º
- [ ] å¯¼å…¥å¤±è´¥æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯
- [ ] å¯¼å‡ºæŒ‰é’®æ‰“å¼€ä¿å­˜å¯¹è¯æ¡†
- [ ] åˆ é™¤ä¸»é¢˜æ˜¾ç¤ºç¡®è®¤å¯¹è¯æ¡†
- [ ] é¢„è§ˆç¤ºä¾‹å®æ—¶æ˜¾ç¤ºä¸»é¢˜æ•ˆæœ
- [ ] é¢„è§ˆç•Œé¢ä¸æ˜¾ç¤ºä¸»é¢˜é…ç½®é€‰é¡¹
- [ ] é¢„è§ˆç•Œé¢è‡ªåŠ¨å“åº”ä¸»é¢˜å˜æ›´

---

### 6.2 æ€§èƒ½æµ‹è¯•

| åœºæ™¯ | é¢„æœŸæ€§èƒ½ | æµ‹è¯•æ–¹æ³• |
|------|---------|---------|
| æ¸²æŸ“ 1000 è¡Œ Markdown | < 1s | è®¡æ—¶æµ‹è¯• |
| æ¸²æŸ“ 10 ä¸ªä»£ç å— | < 0.5s | è®¡æ—¶æµ‹è¯• |
| æ¸²æŸ“ 5 ä¸ª Mermaid å›¾è¡¨ | < 2s | è®¡æ—¶æµ‹è¯• |
| æ¸²æŸ“ 20 ä¸ªæ•°å­¦å…¬å¼ | < 1s | è®¡æ—¶æµ‹è¯• |
| åŠ è½½ 10 å¼ å¤–éƒ¨å›¾ç‰‡ | < 3s | ç½‘ç»œæµ‹è¯• |
| å†…å­˜å ç”¨ï¼ˆæ­£å¸¸ä½¿ç”¨ï¼‰ | < 200MB | å†…å­˜ç›‘æ§ |

---

### 6.3 å…¼å®¹æ€§æµ‹è¯•

#### **Markdown è¯­æ³•å…¼å®¹**
- [ ] CommonMark è§„èŒƒ
- [ ] GitHub Flavored Markdown (GFM)
- [ ] è¡¨æ ¼æ‰©å±•è¯­æ³•
- [ ] ä»»åŠ¡åˆ—è¡¨è¯­æ³•

#### **æµè§ˆå™¨å…¼å®¹**ï¼ˆWKWebViewï¼‰
- [ ] macOS 13+
- [ ] æ˜æš—ä¸»é¢˜åˆ‡æ¢
- [ ] é«˜ DPI æ˜¾ç¤º

---

### 6.4 è¾¹ç•Œæµ‹è¯•

- [ ] ç©ºæ–‡æ¡£
- [ ] è¶…é•¿æ–‡æ¡£ï¼ˆ>10000 è¡Œï¼‰
- [ ] ç‰¹æ®Šå­—ç¬¦ï¼ˆ<, >, &, "ï¼‰
- [ ] åµŒå¥—ç»“æ„ï¼ˆåˆ—è¡¨ä¸­çš„ä»£ç å—ï¼‰
- [ ] æ— æ•ˆçš„ Mermaid è¯­æ³•
- [ ] æ— æ•ˆçš„æ•°å­¦å…¬å¼
- [ ] 404 å›¾ç‰‡é“¾æ¥
- [ ] è¶…å¤§å›¾ç‰‡ï¼ˆ>10MBï¼‰

---

## 7. æ€§èƒ½ä¼˜åŒ–

### 7.1 æ¸²æŸ“ä¼˜åŒ–

**ç­–ç•¥**ï¼š
1. **å¢é‡æ¸²æŸ“**ï¼šåªé‡æ–°æ¸²æŸ“å˜åŒ–çš„éƒ¨åˆ†
2. **é˜²æŠ–å¤„ç†**ï¼šç¼–è¾‘æ—¶å»¶è¿Ÿ 300ms å†æ¸²æŸ“
3. **WebKit ç¼“å­˜**ï¼šå¤ç”¨ WKWebView å®ä¾‹

**å®ç°**ï¼š
```swift
class PreviewCoordinator {
    private var renderTask: Task<Void, Never>?
    private let renderDelay: Duration = .milliseconds(300)
    
    func scheduleRender(markdown: String) {
        renderTask?.cancel()
        
        renderTask = Task {
            try? await Task.sleep(for: renderDelay)
            
            guard !Task.isCancelled else { return }
            
            await performRender(markdown)
        }
    }
}
```

---

### 7.2 å›¾ç‰‡åŠ è½½ä¼˜åŒ–

**ç­–ç•¥**ï¼š
1. **æ‡’åŠ è½½**ï¼šä½¿ç”¨ `loading="lazy"` å±æ€§
2. **ç¼“å­˜æœºåˆ¶**ï¼šå†…å­˜ + ç£ç›˜åŒå±‚ç¼“å­˜
3. **å¹¶å‘æ§åˆ¶**ï¼šé™åˆ¶åŒæ—¶ä¸‹è½½æ•°é‡

**å®ç°**ï¼š
```swift
actor ImageDownloader {
    private let maxConcurrent = 3
    private var currentDownloads = 0
    
    func download(url: URL) async throws -> Data {
        // ç­‰å¾…å¯ç”¨æ§½ä½
        while currentDownloads >= maxConcurrent {
            try await Task.sleep(for: .milliseconds(100))
        }
        
        currentDownloads += 1
        defer { currentDownloads -= 1 }
        
        return try await URLSession.shared.data(from: url).0
    }
}
```

---

### 7.3 å†…å­˜ç®¡ç†

**ç­–ç•¥**ï¼š
1. **é™åˆ¶ç¼“å­˜å¤§å°**ï¼šå†…å­˜ç¼“å­˜æœ€å¤š 50 å¼ å›¾ç‰‡
2. **åŠæ—¶é‡Šæ”¾**ï¼šåˆ‡æ¢ç¬”è®°æ—¶æ¸…ç†ç¼“å­˜
3. **ç›‘æ§å†…å­˜**ï¼šè¶…è¿‡é˜ˆå€¼è‡ªåŠ¨æ¸…ç†

---

## 8. é£é™©è¯„ä¼°

### 8.1 æŠ€æœ¯é£é™©

| é£é™© | å¯èƒ½æ€§ | å½±å“ | ç¼“è§£æªæ–½ |
|------|-------|------|---------|
| Mermaid æ¸²æŸ“å¤±è´¥ | ä¸­ | ä¸­ | æ·»åŠ é”™è¯¯å¤„ç†ï¼Œæ˜¾ç¤ºåŸå§‹ä»£ç  |
| KaTeX å…¬å¼é”™è¯¯ | ä¸­ | ä½ | å®¹é”™æ¨¡å¼ï¼Œæ˜¾ç¤º LaTeX æºç  |
| å¤–éƒ¨å›¾ç‰‡åŠ è½½æ…¢ | é«˜ | ä¸­ | æ·»åŠ ç¼“å­˜å’Œ loading æç¤º |
| WebKit å†…å­˜æ³„æ¼ | ä½ | é«˜ | å®šæœŸé‡Šæ”¾ WKWebView |
| å¤§æ–‡æ¡£æ¸²æŸ“æ…¢ | ä¸­ | ä¸­ | å¢é‡æ¸²æŸ“ + é˜²æŠ– |

---

### 8.2 æ€§èƒ½é£é™©

| é£é™© | å¯èƒ½æ€§ | å½±å“ | ç¼“è§£æªæ–½ |
|------|-------|------|---------|
| å®æ—¶é¢„è§ˆå¡é¡¿ | ä¸­ | é«˜ | é˜²æŠ– 300ms + å¢é‡æ¸²æŸ“ |
| å›¾ç‰‡åŠ è½½é˜»å¡ | ä¸­ | ä¸­ | å¼‚æ­¥åŠ è½½ + æ‡’åŠ è½½ |
| å†…å­˜å ç”¨è¿‡é«˜ | ä½ | ä¸­ | é™åˆ¶ç¼“å­˜å¤§å° |

---

### 8.3 ç”¨æˆ·ä½“éªŒé£é™©

| é£é™© | å¯èƒ½æ€§ | å½±å“ | ç¼“è§£æªæ–½ |
|------|-------|------|---------|
| è¯­æ³•ä¸å…¼å®¹ | ä¸­ | ä¸­ | æ”¯æŒ GFMï¼Œæ–‡æ¡£è¯´æ˜ |
| å›¾è¡¨æ¸²æŸ“æ•ˆæœå·® | ä½ | ä½ | ä½¿ç”¨ Mermaid å®˜æ–¹åº“ |
| æ ·å¼ä¸ç¾è§‚ | ä½ | ä¸­ | å‚è€ƒ GitHub/Typora |

---

## 9. æˆåŠŸæ ‡å‡†

### 9.1 åŠŸèƒ½å®Œæ•´æ€§
- âœ… æ”¯æŒæ‰€æœ‰åŸºç¡€ Markdown è¯­æ³•
- âœ… ä»£ç å—è¯­æ³•é«˜äº®ï¼ˆ50+ è¯­è¨€ï¼‰
- âœ… Mermaid å›¾è¡¨æ¸²æŸ“ï¼ˆ6+ ç±»å‹ï¼‰
- âœ… æ•°å­¦å…¬å¼æ¸²æŸ“ï¼ˆè¡Œå†… + å—ï¼‰
- âœ… TOC ç›®å½•ç”Ÿæˆ
- âœ… å¤–éƒ¨å›¾ç‰‡é“¾æ¥æ”¯æŒ

### 9.2 æ€§èƒ½æŒ‡æ ‡
- âœ… 1000 è¡Œæ–‡æ¡£æ¸²æŸ“ < 1s
- âœ… å®æ—¶é¢„è§ˆæ— æ˜æ˜¾å¡é¡¿
- âœ… å†…å­˜å ç”¨ < 200MB
- âœ… å›¾ç‰‡ç¼“å­˜å‘½ä¸­ç‡ > 80%

### 9.3 ç”¨æˆ·ä½“éªŒ
- âœ… æ ·å¼ç¾è§‚ï¼Œåª²ç¾ Typora
- âœ… æ˜æš—ä¸»é¢˜è‡ªé€‚åº”
- âœ… æ‰“å°æ•ˆæœè‰¯å¥½
- âœ… é”™è¯¯æç¤ºå‹å¥½

---

## 10. åç»­ä¼˜åŒ–ï¼ˆP2ï¼‰

### 10.1 é«˜çº§åŠŸèƒ½
- ğŸ“‹ ä»£ç å¤åˆ¶æŒ‰é’®
- ğŸ“‹ å›¾ç‰‡ç‚¹å‡»æ”¾å¤§
- ğŸ“‹ å¯¼å‡º PDF ä½¿ç”¨æ¸²æŸ“æ•ˆæœ
- ğŸ“‹ Markdown æ‰©å±•è¯­æ³•ï¼ˆè„šæ³¨ã€ä»»åŠ¡åˆ—è¡¨é«˜äº®ï¼‰
- ğŸ“‹ **åœ¨çº¿ä¸»é¢˜å¸‚åœº/ç¤¾åŒº**
- ğŸ“‹ **ä¸»é¢˜ç¼–è¾‘å™¨ï¼ˆå¯è§†åŒ–é…ç½®ï¼‰**
- ğŸ“‹ **ä¸»é¢˜é¢„è§ˆåŠŸèƒ½**

### 10.2 æ€§èƒ½ä¼˜åŒ–
- ğŸ“‹ è™šæ‹Ÿæ»šåŠ¨ï¼ˆè¶…é•¿æ–‡æ¡£ï¼‰
- ğŸ“‹ Worker çº¿ç¨‹æ¸²æŸ“
- ğŸ“‹ ç¦»çº¿ Mermaid/KaTeX èµ„æº
- ğŸ“‹ **ä¸»é¢˜ CSS é¢„ç¼–è¯‘å’Œç¼“å­˜**

---

## 11. å‚è€ƒèµ„æ–™

- [Ink - Markdown Parser](https://github.com/JohnSundell/Ink)
- [Splash - Syntax Highlighter](https://github.com/JohnSundell/Splash)
- [Mermaid.js å®˜æ–¹æ–‡æ¡£](https://mermaid.js.org/)
- [KaTeX å®˜æ–¹æ–‡æ¡£](https://katex.org/)
- [CommonMark è§„èŒƒ](https://commonmark.org/)
- [GitHub Flavored Markdown (GFM)](https://github.github.com/gfm/)

---

**æ–‡æ¡£å˜æ›´è®°å½•**ï¼š
- 2025-11-16 v1.2: å¢åŠ  UI äº¤äº’è®¾è®¡å’Œ TCA çŠ¶æ€ç®¡ç†è§„èŒƒ
  - æ–°å¢ 1.4 UI äº¤äº’åŸåˆ™ç« èŠ‚
  - æ–°å¢ 4.4 UI äº¤äº’è®¾è®¡ç« èŠ‚ï¼ˆé¦–é€‰é¡¹é…ç½® + é¢„è§ˆç®€æ´åŒ–ï¼‰
  - æ–°å¢ 4.5 TCA çŠ¶æ€ç®¡ç†ç« èŠ‚ï¼ˆå®Œæ•´çš„ State/Action/Reducer è®¾è®¡ï¼‰
  - æ˜ç¡®é…ç½®é›†ä¸­åŒ–åŸåˆ™ï¼šæ‰€æœ‰ä¸»é¢˜é…ç½®åœ¨é¦–é€‰é¡¹ç®¡ç†
  - æ˜ç¡®é¢„è§ˆç®€æ´åŒ–åŸåˆ™ï¼šé¢„è§ˆç•Œé¢ä¸æä¾›ä¸»é¢˜é…ç½®
  - å¢åŠ  TCA æœ€ä½³å®è·µæ€»ç»“å’Œä¾èµ–æ³¨å…¥è§„èŒƒ
  - å¢åŠ ä¸»é¢˜ç³»ç»Ÿ UI äº¤äº’æµ‹è¯•é¡¹
  - å¢åŠ  TCA çŠ¶æ€ç®¡ç†æµ‹è¯•é¡¹
  - æ€»å·¥æ—¶ä» 29h å¢åŠ åˆ° 33hï¼ˆçº¦ 4 ä¸ªå·¥ä½œæ—¥ï¼‰
- 2025-11-16 v1.1: å¢åŠ ä¸»é¢˜ç³»ç»Ÿå’Œæ ·å¼æ¨¡æ¿æ‰©å±•æ€§è®¾è®¡
  - æ–°å¢ 4.3 ä¸»é¢˜ç³»ç»Ÿè®¾è®¡ç« èŠ‚
  - æ–°å¢ ThemeManagerã€ThemeConfig ç­‰æ ¸å¿ƒç»„ä»¶
  - å°†ä¸»é¢˜ç³»ç»Ÿæå‡ä¸º P0 ä¼˜å…ˆçº§
  - æ›´æ–° MarkdownRenderer ä»¥æ”¯æŒåŠ¨æ€ä¸»é¢˜
  - å¢åŠ ä¸»é¢˜å¯¼å…¥/å¯¼å‡ºåŠŸèƒ½è§„åˆ’
  - æ›´æ–°æµ‹è¯•è®¡åˆ’å’Œå®æ–½è®¡åˆ’
  - æ€»å·¥æ—¶ä» 20h å¢åŠ åˆ° 29h
- 2025-11-16 v1.0: åˆå§‹ç‰ˆæœ¬ï¼Œå®Œæ•´è§„åˆ’é¢„è§ˆæ¸²æŸ“å¢å¼ºåŠŸèƒ½

