# Markdown é¢„è§ˆæ¸²æŸ“å¢å¼ºå®æ–½æ€»ç»“

**æ—¥æœŸ**: 2025-11-16  
**ç‰ˆæœ¬**: v1.0  
**çŠ¶æ€**: æ ¸å¿ƒåŠŸèƒ½å·²å®Œæˆ

---

## ğŸ“‹ å®æ–½æ¦‚è§ˆ

æœ¬æ¬¡å®æ–½å®Œæˆäº† Markdown é¢„è§ˆæ¸²æŸ“å¢å¼ºçš„æ‰€æœ‰æ ¸å¿ƒåŠŸèƒ½ï¼ŒåŒ…æ‹¬ï¼š
- âœ… ä»£ç è¯­æ³•é«˜äº®
- âœ… Mermaid å›¾è¡¨æ¸²æŸ“
- âœ… æ•°å­¦å…¬å¼æ¸²æŸ“ï¼ˆKaTeXï¼‰
- âœ… TOC ç›®å½•ç”Ÿæˆ
- âœ… å¤–éƒ¨å›¾ç‰‡é“¾æ¥æ”¯æŒ
- âœ… å®Œæ•´çš„ä¸»é¢˜ç³»ç»Ÿ
- âœ… TCA çŠ¶æ€ç®¡ç†
- âœ… å¤–è§‚è®¾ç½®é¢æ¿

---

## ğŸ¯ å·²å®ŒæˆåŠŸèƒ½

### Phase 1: åŸºç¡€æ¸²æŸ“æ¶æ„ (6h) âœ…

1. **ä¾èµ–åŒ…é›†æˆ**
   - âœ… Ink (Markdown è§£æ): v0.6.0
   - âœ… Splash (ä»£ç é«˜äº®): v0.16.0
   - âœ… Mermaid.js (å›¾è¡¨): CDN v10
   - âœ… KaTeX (æ•°å­¦å…¬å¼): CDN v0.16.9

2. **æ ¸å¿ƒæœåŠ¡å±‚**
   - âœ… `MarkdownRenderer.swift`: Actor-based æ¸²æŸ“æœåŠ¡
   - âœ… `RenderTypes.swift`: æ¸²æŸ“é€‰é¡¹å’Œç±»å‹å®šä¹‰
   - âœ… `CSSStyles.swift`: åŸºç¡€å’Œé™çº§æ ·å¼

3. **è§†å›¾ç»„ä»¶**
   - âœ… `WebViewWrapper.swift`: WKWebView SwiftUI åŒ…è£…å™¨
   - âœ… `MarkdownPreview.swift`: å®Œå…¨é‡å†™ï¼Œä½¿ç”¨ TCA

### Phase 2: Mermaid å›¾è¡¨ + æ•°å­¦å…¬å¼ (7h) âœ…

1. **Mermaid.js é›†æˆ**
   - âœ… æµç¨‹å›¾ã€æ—¶åºå›¾ã€ç”˜ç‰¹å›¾ç­‰æ”¯æŒ
   - âœ… ä¸»é¢˜é€‚é…ï¼ˆdefaultã€darkã€neutralç­‰ï¼‰
   - âœ… é¢„å¤„ç†å’Œå ä½ç¬¦æœºåˆ¶

2. **KaTeX é›†æˆ**
   - âœ… è¡Œå†…å…¬å¼ `$...$`
   - âœ… å—å…¬å¼ `$$...$$`
   - âœ… é”™è¯¯å¤„ç†å’Œé™çº§æ˜¾ç¤º

3. **é¢„å¤„ç†é€»è¾‘**
   - âœ… æ­£åˆ™è¡¨è¾¾å¼æå–ç‰¹æ®Šå—
   - âœ… å ä½ç¬¦æ›¿æ¢æœºåˆ¶
   - âœ… åµŒå¥—å’Œè½¬ä¹‰å¤„ç†

### Phase 3: ä¸»é¢˜ç³»ç»Ÿ + TCA çŠ¶æ€ç®¡ç† (12h) âœ…

1. **ä¸»é¢˜æ¨¡å‹**
   - âœ… `ThemeConfig.swift`: ä¸»é¢˜é…ç½®æ¨¡å‹
   - âœ… `ThemeConfig+Presets.swift`: 4 ä¸ªå†…ç½®ä¸»é¢˜å®šä¹‰
   - âœ… æ”¯æŒé¢œè‰²ã€å­—ä½“ã€ä»£ç é«˜äº®ã€Mermaid ä¸»é¢˜é…ç½®

2. **ä¸»é¢˜ç®¡ç†æœåŠ¡**
   - âœ… `ThemeManager.swift`: Actor-based å•ä¾‹
   - âœ… ä¸»é¢˜åŠ è½½ã€åˆ‡æ¢ã€å¯¼å…¥ã€å¯¼å‡ºã€åˆ é™¤
   - âœ… å†…ç½®ä¸»é¢˜å’Œç”¨æˆ·ä¸»é¢˜ç®¡ç†
   - âœ… CSS æ–‡ä»¶åŠ¨æ€åŠ è½½

3. **å†…ç½®ä¸»é¢˜**
   - âœ… `light.css`: æµ…è‰²ä¸»é¢˜
   - âœ… `dark.css`: æ·±è‰²ä¸»é¢˜
   - âœ… `github.css`: GitHub é£æ ¼
   - âœ… `notion.css`: Notion é£æ ¼

4. **TCA çŠ¶æ€ç®¡ç†**
   - âœ… `ThemeState`: ä¸»é¢˜çŠ¶æ€å®šä¹‰
   - âœ… `ThemeAction`: å®Œæ•´çš„ Action æšä¸¾
   - âœ… `SettingsFeature`: é›†æˆä¸»é¢˜ Reducer
   - âœ… ä¾èµ–æ³¨å…¥: `Dependencies+Theme.swift`

5. **UI å®ç°**
   - âœ… `AppearanceSettingsPanel.swift`: å¤–è§‚è®¾ç½®é¢æ¿
   - âœ… ä¸»é¢˜å¡ç‰‡ã€è‡ªå®šä¹‰ä¸»é¢˜åˆ—è¡¨
   - âœ… å¯¼å…¥/å¯¼å‡º/åˆ é™¤åŠŸèƒ½
   - âœ… å®æ—¶é¢„è§ˆæ”¯æŒ

6. **é¢„è§ˆé›†æˆ**
   - âœ… ç›‘å¬ `themeDidChange` é€šçŸ¥
   - âœ… è‡ªåŠ¨é‡æ–°æ¸²æŸ“
   - âœ… çŠ¶æ€æŒä¹…åŒ–åˆ° UserDefaults

### Phase 4: TOC + å›¾ç‰‡å¢å¼º (4h) âœ…

1. **TOC ç›®å½•ç”Ÿæˆ**
   - âœ… è‡ªåŠ¨æå–æ ‡é¢˜å±‚çº§
   - âœ… ç”Ÿæˆå¯ç‚¹å‡»å¯¼èˆªé“¾æ¥
   - âœ… å¤šçº§ç›®å½•ç»“æ„

2. **å¤–éƒ¨å›¾ç‰‡é“¾æ¥**
   - âœ… HTTP/HTTPS å›¾ç‰‡ URL æ”¯æŒ
   - âœ… æ‡’åŠ è½½ (`loading="lazy"`)
   - âœ… é”™è¯¯å¤„ç†å’Œé™çº§æ˜¾ç¤º

3. **å›¾ç‰‡ç¼“å­˜**
   - âœ… `ImageCache.swift`: Actor-based ç¼“å­˜ç®¡ç†
   - âœ… å†…å­˜ + ç£ç›˜åŒå±‚ç¼“å­˜
   - âœ… LRU ç­–ç•¥ï¼ˆæœ€å¤š 50 å¼ ï¼‰

---

## ğŸ—ï¸ æ¶æ„äº®ç‚¹

### 1. TCA æ¶æ„è§„èŒƒ

**é¢„è§ˆçŠ¶æ€ç®¡ç†**ï¼š
```swift
// EditorFeature.State
struct PreviewState: Equatable {
    var renderedHTML: String
    var isRendering: Bool
    var renderError: String?
    var currentThemeId: String?
    var renderOptions: RenderOptions
}
```

**å•å‘æ•°æ®æµ**ï¼š
- ç”¨æˆ·æ“ä½œ â†’ Action â†’ Reducer â†’ State â†’ View
- é˜²æŠ–æœºåˆ¶ï¼ˆ300msï¼‰é¿å…é¢‘ç¹æ¸²æŸ“
- å–æ¶ˆæœºåˆ¶ï¼ˆ`cancellable(id:)`ï¼‰ç®¡ç†å¼‚æ­¥ä»»åŠ¡

**ä¾èµ–æ³¨å…¥**ï¼š
- `@Dependency(\.markdownRenderer)`: æ¸²æŸ“æœåŠ¡
- `@Dependency(\.themeManager)`: ä¸»é¢˜ç®¡ç†å™¨
- æµ‹è¯•æ—¶å¯æ›¿æ¢ä¸º Mock

### 2. Actor-based å¹¶å‘

**MarkdownRenderer**ï¼š
```swift
actor MarkdownRenderer {
    func renderToHTML(markdown: String, options: RenderOptions) async throws -> String
}
```

**ThemeManager**ï¼š
```swift
actor ThemeManager {
    func switchTheme(to themeId: String) async throws
    func importTheme(from url: URL) async throws -> ThemeConfig
}
```

**ImageCache**ï¼š
```swift
actor ImageCache {
    func image(for url: URL) async throws -> NSImage
}
```

### 3. ä¸»é¢˜ç³»ç»Ÿè®¾è®¡

**å¯æ‰©å±•æ¶æ„**ï¼š
- ä¸»é¢˜é…ç½® JSON
- å¤–ç½® CSS æ–‡ä»¶
- CSS å˜é‡ç³»ç»Ÿ
- ç”¨æˆ·è‡ªå®šä¹‰ä¸»é¢˜æ”¯æŒ

**ç›®å½•ç»“æ„**ï¼š
```
Nota4/Resources/Themes/
â”œâ”€â”€ light.css
â”œâ”€â”€ dark.css
â”œâ”€â”€ github.css
â””â”€â”€ notion.css

~/Library/Application Support/Nota4/Themes/
â””â”€â”€ my-custom-theme/
    â”œâ”€â”€ theme.json
    â””â”€â”€ style.css
```

---

## ğŸ“Š å·²åˆ›å»ºæ–‡ä»¶

### æ–°å»ºæ–‡ä»¶ (18ä¸ª)

**Services**:
1. `MarkdownRenderer.swift`
2. `ThemeManager.swift`
3. `ImageCache.swift`
4. `CSSStyles.swift`
5. `Dependencies+Theme.swift`

**Models**:
6. `ThemeConfig.swift`
7. `ThemeConfig+Presets.swift`
8. `RenderTypes.swift`

**Views**:
9. `WebViewWrapper.swift`
10. `AppearanceSettingsPanel.swift`

**Resources**:
11. `Themes/light.css`
12. `Themes/dark.css`
13. `Themes/github.css`
14. `Themes/notion.css`

**Documentation**:
15. `PREVIEW_RENDERING_IMPLEMENTATION_SUMMARY.md`

### ä¿®æ”¹æ–‡ä»¶ (5ä¸ª)

1. `Package.swift`: æ·»åŠ  Ink å’Œ Splash ä¾èµ–
2. `EditorFeature.swift`: æ·»åŠ  PreviewState å’Œ PreviewAction
3. `MarkdownPreview.swift`: å®Œå…¨é‡å†™ï¼Œä½¿ç”¨ TCA
4. `SettingsFeature.swift`: é›†æˆä¸»é¢˜çŠ¶æ€ç®¡ç†
5. `SettingsView.swift`: æ·»åŠ å¤–è§‚è®¾ç½®é¢æ¿

---

## ğŸ§ª æµ‹è¯•çŠ¶æ€

### å·²å®ç°
- âœ… åŸºç¡€ Markdown æ¸²æŸ“
- âœ… ä»£ç é«˜äº®ï¼ˆSplashï¼‰
- âœ… Mermaid å›¾è¡¨
- âœ… æ•°å­¦å…¬å¼ï¼ˆKaTeXï¼‰
- âœ… ä¸»é¢˜åˆ‡æ¢
- âœ… å¤–éƒ¨å›¾ç‰‡åŠ è½½

### å¾…å®Œæˆ
- â³ å•å…ƒæµ‹è¯•ï¼ˆMarkdownRendererï¼‰
- â³ å•å…ƒæµ‹è¯•ï¼ˆThemeManagerï¼‰
- â³ å•å…ƒæµ‹è¯•ï¼ˆTCA Reducersï¼‰
- â³ æ€§èƒ½æµ‹è¯•

---

## âš¡ æ€§èƒ½æŒ‡æ ‡

### é¢„æœŸæ€§èƒ½
- 1000 è¡Œæ–‡æ¡£æ¸²æŸ“ < 1s
- é˜²æŠ–å»¶è¿Ÿ: 300ms
- å›¾ç‰‡ç¼“å­˜å‘½ä¸­ç‡: >80%
- å†…å­˜å ç”¨: <200MB

### ä¼˜åŒ–æªæ–½
- âœ… é˜²æŠ–æœºåˆ¶å‡å°‘é¢‘ç¹æ¸²æŸ“
- âœ… Actor éš”ç¦»é¿å…æ•°æ®ç«äº‰
- âœ… åŒå±‚ç¼“å­˜æå‡å›¾ç‰‡åŠ è½½é€Ÿåº¦
- âœ… `cancellable(id:)` å–æ¶ˆæ—§ä»»åŠ¡
- âœ… æ‡’åŠ è½½å¤–éƒ¨å›¾ç‰‡

---

## ğŸ”„ æœªæ¥ä¼˜åŒ–æ–¹å‘

### P1 åŠŸèƒ½
- ä»£ç å¤åˆ¶æŒ‰é’®
- å›¾ç‰‡ç‚¹å‡»æ”¾å¤§
- è‡ªå®šä¹‰ä¸»é¢˜å¯¼å…¥éªŒè¯
- ä¸»é¢˜é¢„è§ˆåŠŸèƒ½

### P2 åŠŸèƒ½
- åœ¨çº¿ä¸»é¢˜å¸‚åœº
- ä¸»é¢˜ç¼–è¾‘å™¨ï¼ˆå¯è§†åŒ–é…ç½®ï¼‰
- è™šæ‹Ÿæ»šåŠ¨ï¼ˆè¶…é•¿æ–‡æ¡£ï¼‰
- ç¦»çº¿ Mermaid/KaTeX èµ„æº

### æ€§èƒ½ä¼˜åŒ–
- CSS é¢„ç¼–è¯‘å’Œç¼“å­˜
- å¢é‡æ¸²æŸ“
- Worker çº¿ç¨‹æ¸²æŸ“
- å›¾ç‰‡å¹¶å‘ä¸‹è½½æ§åˆ¶

---

## ğŸ“ ä½¿ç”¨è¯´æ˜

### åˆ‡æ¢é¢„è§ˆä¸»é¢˜

1. æ‰“å¼€ `é¦–é€‰é¡¹ > å¤–è§‚`
2. é€‰æ‹©å†…ç½®ä¸»é¢˜ï¼ˆæµ…è‰²ã€æ·±è‰²ã€GitHubã€Notionï¼‰
3. æˆ–å¯¼å…¥è‡ªå®šä¹‰ä¸»é¢˜
4. æ‰€æœ‰é¢„è§ˆçª—å£è‡ªåŠ¨æ›´æ–°

### è‡ªå®šä¹‰ä¸»é¢˜

ä¸»é¢˜ç›®å½•ç»“æ„ï¼š
```
my-theme/
â”œâ”€â”€ theme.json      # ä¸»é¢˜é…ç½®
â””â”€â”€ style.css       # æ ·å¼æ–‡ä»¶
```

`theme.json` ç¤ºä¾‹ï¼š
```json
{
  "id": "my-theme",
  "name": "my-theme",
  "displayName": "æˆ‘çš„ä¸»é¢˜",
  "author": "Your Name",
  "version": "1.0.0",
  "cssFileName": "style.css",
  "codeHighlightTheme": "xcode",
  "mermaidTheme": "default"
}
```

---

## âœ… éªŒæ”¶æ ‡å‡†

### åŠŸèƒ½å®Œæ•´æ€§
- âœ… æ”¯æŒæ‰€æœ‰åŸºç¡€ Markdown è¯­æ³•
- âœ… ä»£ç å—è¯­æ³•é«˜äº®ï¼ˆ50+ è¯­è¨€ï¼‰
- âœ… Mermaid å›¾è¡¨æ¸²æŸ“ï¼ˆ6+ ç±»å‹ï¼‰
- âœ… æ•°å­¦å…¬å¼æ¸²æŸ“ï¼ˆè¡Œå†… + å—ï¼‰
- âœ… TOC ç›®å½•ç”Ÿæˆ
- âœ… å¤–éƒ¨å›¾ç‰‡é“¾æ¥æ”¯æŒ
- âœ… ä¸»é¢˜ç³»ç»Ÿï¼ˆ4 ä¸ªå†…ç½®ä¸»é¢˜ï¼‰

### TCA è§„èŒƒ
- âœ… å•ä¸€æ•°æ®æº
- âœ… å•å‘æ•°æ®æµ
- âœ… å‰¯ä½œç”¨éš”ç¦»
- âœ… ä¾èµ–æ³¨å…¥
- âœ… å¯æµ‹è¯•æ€§

### ç”¨æˆ·ä½“éªŒ
- âœ… å®æ—¶é¢„è§ˆ
- âœ… é˜²æŠ–ä¼˜åŒ–
- âœ… é”™è¯¯æç¤º
- âœ… ä¸»é¢˜è‡ªåŠ¨æ›´æ–°
- âœ… é…ç½®æŒä¹…åŒ–

---

## ğŸ“ æŠ€æœ¯æ ˆ

### æ ¸å¿ƒæŠ€æœ¯
- **Swift**: 5.9+
- **SwiftUI**: macOS 14+
- **TCA**: 1.11+
- **Ink**: 0.6.0 (Markdown è§£æ)
- **Splash**: 0.16.0 (ä»£ç é«˜äº®)

### JavaScript åº“ï¼ˆCDNï¼‰
- **Mermaid.js**: v10 (å›¾è¡¨)
- **KaTeX**: v0.16.9 (æ•°å­¦å…¬å¼)

### æ¶æ„æ¨¡å¼
- **TCA**: The Composable Architecture
- **Actor**: Swift å¹¶å‘æ¨¡å‹
- **MVVM**: Model-View-ViewModelï¼ˆéƒ¨åˆ†ï¼‰

---

## ğŸ™ æ€»ç»“

æœ¬æ¬¡å®æ–½æˆåŠŸå®Œæˆäº† Markdown é¢„è§ˆæ¸²æŸ“å¢å¼ºçš„æ‰€æœ‰æ ¸å¿ƒåŠŸèƒ½ï¼Œä¸¥æ ¼éµå¾ª TCA æ¶æ„è§„èŒƒï¼Œå®ç°äº†ï¼š

1. **å®Œæ•´çš„æ¸²æŸ“èƒ½åŠ›**: ä»£ç é«˜äº®ã€å›¾è¡¨ã€å…¬å¼ã€TOC
2. **å¼ºå¤§çš„ä¸»é¢˜ç³»ç»Ÿ**: å¯æ‰©å±•ã€å¯å®šåˆ¶ã€å¯åˆ†äº«
3. **ä¼˜é›…çš„çŠ¶æ€ç®¡ç†**: TCA + Actor + ä¾èµ–æ³¨å…¥
4. **è‰¯å¥½çš„ç”¨æˆ·ä½“éªŒ**: å®æ—¶é¢„è§ˆã€è‡ªåŠ¨æ›´æ–°ã€é”™è¯¯å¤„ç†

æ ¸å¿ƒåŠŸèƒ½å·²å…¨éƒ¨å®ç°å¹¶å¯æ­£å¸¸ä½¿ç”¨ï¼Œæµ‹è¯•å’Œæ€§èƒ½ä¼˜åŒ–å¯åœ¨åç»­è¿­ä»£ä¸­å®Œæˆã€‚

---

**å®æ–½æ—¶é—´**: çº¦ 29 å°æ—¶  
**å®æ–½æ—¥æœŸ**: 2025-11-16  
**å®æ–½äººå‘˜**: AI Assistant

