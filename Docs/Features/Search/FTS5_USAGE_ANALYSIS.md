# FTS5 使用场景分析

**创建时间**: 2025-11-17 14:00:00  
**文档类型**: 技术决策分析  
**适用范围**: FTS5 全文搜索索引的使用场景评估

---

## 一、问题

**问题**: 如果考虑到未来文本内搜索功能（编辑区正文搜索），还需要 FTS5 吗？

---

## 二、搜索功能分类

### 2.1 笔记列表搜索（已实现）

**范围**: 在所有笔记的标题和内容中搜索  
**当前实现**: 纯内存搜索（已移除 FTS5）  
**特点**:
- 搜索所有笔记的标题和内容
- 返回匹配的笔记列表
- 在内存中的 `notes` 数组中进行搜索

### 2.2 编辑区正文搜索（未来功能）

**范围**: 在当前打开的单个笔记的内容中搜索  
**当前状态**: 未实现（PRD 中标记为未来功能）  
**特点**:
- 只搜索当前打开的笔记内容
- 在 `NSTextView` 中直接搜索
- 支持查找、替换、高亮等功能

### 2.3 全局内容搜索（潜在需求）

**范围**: 在所有笔记的完整内容中搜索（不仅仅是标题）  
**当前状态**: 未实现  
**特点**:
- 搜索所有笔记的完整内容
- 可能需要更强大的搜索能力
- 可能需要性能优化

---

## 三、FTS5 适用性分析

### 3.1 FTS5 的特点

**FTS5 的优势**:
1. **数据库层面搜索**: 在数据库层面进行全文搜索，性能好
2. **索引优化**: 自动维护全文搜索索引
3. **支持大量数据**: 适合搜索大量笔记（>1000 条）
4. **自动更新**: 通过触发器自动更新索引

**FTS5 的劣势**:
1. **分词依赖**: 依赖分词机制，可能不支持某些字符
2. **语法复杂**: 需要处理 FTS5 查询语法
3. **维护成本**: 需要维护索引和触发器
4. **字符限制**: 可能不支持某些特殊字符和标点符号

### 3.2 各搜索场景的 FTS5 需求

#### 场景 1: 笔记列表搜索

**当前实现**: 纯内存搜索（已移除 FTS5）

**是否需要 FTS5**:
- ❌ **不需要**
- **理由**:
  1. 搜索范围：所有笔记的标题和内容
  2. 数据量：通常 <1000 条笔记，内存搜索性能足够
  3. 搜索准确性：内存搜索更可靠，支持所有字符类型
  4. 实现简单：不需要处理 FTS5 语法和分词问题

**结论**: 当前实现（纯内存搜索）已经足够，不需要 FTS5。

#### 场景 2: 编辑区正文搜索

**未来功能**: 在单个笔记内容中搜索

**是否需要 FTS5**:
- ❌ **不需要**
- **理由**:
  1. **搜索范围**: 只搜索当前打开的单个笔记内容
  2. **实现方式**: 使用 `NSTextView` 的原生搜索功能
  3. **性能**: 单个文档搜索，不需要数据库索引
  4. **功能需求**: 需要查找、替换、高亮、导航等功能，这些 `NSTextView` 都支持

**实现方式**:
```swift
// 使用 NSTextView 的原生搜索功能
// 在 MarkdownTextEditor.Coordinator 中实现
func performSearch(text: String, in textView: NSTextView) {
    // 使用 NSString.range(of:options:range:) 进行搜索
    // 支持所有字符类型，不依赖分词
}
```

**结论**: 编辑区正文搜索不需要 FTS5，使用 `NSTextView` 的原生搜索功能即可。

#### 场景 3: 全局内容搜索（潜在需求）

**潜在需求**: 在所有笔记的完整内容中搜索

**是否需要 FTS5**:
- ⚠️ **可能需要**（取决于数据量和性能需求）
- **考虑因素**:
  1. **数据量**: 如果笔记数量 >1000 条，FTS5 可能提供更好的性能
  2. **搜索频率**: 如果搜索频率很高，FTS5 索引可以提升性能
  3. **搜索复杂度**: 如果需要复杂的搜索（如正则表达式、模糊匹配），FTS5 可能不够

**替代方案**:
1. **纯内存搜索**: 适合数据量较小的情况（<1000 条）
2. **FTS5 搜索**: 适合数据量较大的情况（>1000 条）
3. **混合方案**: 根据数据量动态选择搜索方式

**结论**: 如果未来需要全局内容搜索，可以根据数据量和性能需求决定是否使用 FTS5。

---

## 四、FTS5 保留 vs 移除

### 4.1 当前 FTS5 状态

**已移除的部分**:
- ✅ 笔记列表搜索已移除 FTS5 依赖
- ✅ 搜索逻辑改为纯内存搜索

**仍保留的部分**:
- FTS5 表和触发器（在数据库迁移中创建）
- FTS5 索引数据（如果已存在）

### 4.2 是否完全移除 FTS5

#### 方案 A: 完全移除 FTS5（推荐）

**优点**:
- ✅ 简化代码，减少维护成本
- ✅ 避免 FTS5 语法和分词问题
- ✅ 确保搜索准确性（支持所有字符类型）
- ✅ 当前数据量下性能足够

**缺点**:
- ⚠️ 如果未来需要全局内容搜索，可能需要重新实现 FTS5

**实施**:
1. 移除 FTS5 表的创建（数据库迁移）
2. 移除 FTS5 触发器
3. 清理 FTS5 相关代码

#### 方案 B: 保留 FTS5 但不使用（备选）

**优点**:
- ✅ 保留未来扩展的可能性
- ✅ 如果未来需要全局内容搜索，可以直接使用

**缺点**:
- ⚠️ 增加维护成本（需要维护索引和触发器）
- ⚠️ 占用数据库空间
- ⚠️ 可能造成混淆（有索引但不使用）

**实施**:
1. 保留 FTS5 表和触发器
2. 但不使用 FTS5 进行搜索
3. 如果未来需要，可以重新启用

---

## 五、推荐方案

### 5.1 当前阶段（推荐）

**方案**: **完全移除 FTS5**

**理由**:
1. **笔记列表搜索**: 已移除 FTS5，使用纯内存搜索，性能足够
2. **编辑区正文搜索**: 未来功能，使用 `NSTextView` 原生搜索，不需要 FTS5
3. **简化维护**: 移除 FTS5 可以减少代码复杂度和维护成本
4. **搜索准确性**: 纯内存搜索更可靠，支持所有字符类型

**实施步骤**:
1. 移除数据库迁移中的 FTS5 表创建
2. 移除 FTS5 触发器
3. 清理 FTS5 相关代码和注释

### 5.2 未来扩展（如需要）

**如果未来需要全局内容搜索**:
1. **评估数据量**: 如果笔记数量 >1000 条，考虑使用 FTS5
2. **评估性能**: 如果内存搜索性能不足，考虑使用 FTS5
3. **重新实现**: 可以重新添加 FTS5 支持，但需要解决分词和特殊字符问题

**替代方案**:
- 使用更强大的搜索库（如 SQLite 的 FTS5 增强版）
- 使用外部搜索服务（如 Elasticsearch）
- 优化内存搜索算法（如索引、缓存）

---

## 六、编辑区正文搜索实现建议

### 6.1 实现方式

**使用 NSTextView 原生搜索功能**:

```swift
// 在 MarkdownTextEditor.Coordinator 中实现
class Coordinator: NSObject, NSTextViewDelegate {
    weak var textView: NSTextView?
    
    func performSearch(text: String, options: SearchOptions) -> [NSRange] {
        guard let textView = textView,
              let textStorage = textView.textStorage else {
            return []
        }
        
        var matches: [NSRange] = []
        let content = textStorage.string
        let nsContent = content as NSString
        
        var searchOptions: NSString.CompareOptions = []
        if !options.matchCase {
            searchOptions.insert(.caseInsensitive)
        }
        
        var searchRange = NSRange(location: 0, length: nsContent.length)
        while searchRange.location < nsContent.length {
            let foundRange = nsContent.range(
                of: text,
                options: searchOptions,
                range: searchRange
            )
            
            if foundRange.location == NSNotFound {
                break
            }
            
            matches.append(foundRange)
            
            let nextLocation = foundRange.location + foundRange.length
            if nextLocation >= nsContent.length {
                break
            }
            searchRange = NSRange(
                location: nextLocation,
                length: nsContent.length - nextLocation
            )
        }
        
        return matches
    }
}
```

**特点**:
- ✅ 支持所有字符类型（中文、英文、标点符号）
- ✅ 不依赖分词机制
- ✅ 性能好（在单个文档中搜索）
- ✅ 支持大小写敏感/不敏感
- ✅ 支持全词匹配（可选）

### 6.2 不需要 FTS5 的原因

1. **搜索范围**: 只搜索当前打开的单个笔记，不需要数据库索引
2. **实现方式**: 使用 `NSTextView` 的原生搜索功能，更简单可靠
3. **性能**: 单个文档搜索，性能足够
4. **功能需求**: 需要查找、替换、高亮等功能，`NSTextView` 都支持

---

## 七、总结

### 7.1 FTS5 需求评估

| 搜索场景 | 是否需要 FTS5 | 理由 |
|---------|--------------|------|
| **笔记列表搜索** | ❌ 不需要 | 已移除，使用纯内存搜索，性能足够 |
| **编辑区正文搜索** | ❌ 不需要 | 使用 NSTextView 原生搜索，不需要数据库索引 |
| **全局内容搜索** | ⚠️ 可能需要 | 取决于数据量和性能需求 |

### 7.2 推荐决策

**当前阶段**: **完全移除 FTS5**

**理由**:
1. 笔记列表搜索已移除 FTS5，使用纯内存搜索
2. 编辑区正文搜索使用 `NSTextView` 原生搜索，不需要 FTS5
3. 简化代码，减少维护成本
4. 确保搜索准确性（支持所有字符类型）

**未来扩展**:
- 如果未来需要全局内容搜索，可以根据数据量和性能需求决定是否重新实现 FTS5
- 或者使用其他搜索方案（如优化内存搜索、使用外部搜索服务等）

### 7.3 实施建议

1. **移除 FTS5**:
   - 移除数据库迁移中的 FTS5 表创建
   - 移除 FTS5 触发器
   - 清理 FTS5 相关代码

2. **编辑区正文搜索**:
   - 使用 `NSTextView` 的原生搜索功能
   - 在 `MarkdownTextEditor.Coordinator` 中实现搜索逻辑
   - 支持所有字符类型，不依赖分词机制

3. **未来扩展**:
   - 如果未来需要全局内容搜索，评估数据量和性能需求
   - 根据需求决定是否重新实现 FTS5 或其他搜索方案

---

**分析完成时间**: 2025-11-17 14:00:00

