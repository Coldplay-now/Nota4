# AI 编辑器功能测试计划

**创建时间**: 2025-01-17

## 测试概述

本文档描述了 AI 编辑器功能的测试计划，包括单元测试和集成测试。

## 单元测试

### LLMService 测试

**文件**: `Nota4Tests/Services/LLMServiceTests.swift`

#### 测试用例

1. **testMockServiceGenerateContentStream**
   - 测试 Mock 服务的流式内容生成
   - 验证流式输出能够正确收集内容

2. **testMockServiceGenerateContent**
   - 测试 Mock 服务的非流式内容生成
   - 验证返回的内容不为空

3. **testMissingApiKeyError**
   - 测试缺少 API Key 时的错误处理
   - 验证抛出 `missingApiKey` 错误

4. **testInvalidEndpointError**
   - 测试无效端点时的错误处理
   - 验证抛出 `invalidEndpoint` 错误

5. **testContextInclusion**
   - 测试包含上下文时的内容生成
   - 验证上下文能够正确传递

### EditorFeature AI 编辑器测试

**文件**: `Nota4Tests/Features/EditorFeatureTests.swift`

#### 测试用例

1. **testShowAIEditorDialog**
   - 测试显示 AI 编辑器对话框
   - 验证状态正确初始化

2. **testDismissAIEditorDialog**
   - 测试关闭 AI 编辑器对话框
   - 验证状态正确重置

3. **testAIEditorPromptChanged**
   - 测试用户提示词输入变化
   - 验证状态正确更新

4. **testAIEditorIncludeContextChanged**
   - 测试上下文开关变化
   - 验证状态正确更新

5. **testAIContentChunkReceived**
   - 测试接收流式内容块
   - 验证内容正确累积

6. **testConfirmInsertAIContent**
   - 测试确认插入 AI 生成内容
   - 验证内容正确插入到编辑器末尾
   - 验证插入格式（前后空行 + HTML 注释标记）

7. **testCancelInsertAIContent**
   - 测试取消插入内容
   - 验证预览状态正确重置

8. **testRetryGenerateContent**
   - 测试重试生成内容
   - 验证错误状态清除并重新生成

## 集成测试和手动测试

### 测试环境准备

1. **配置 API**
   - 打开应用设置（首选项）
   - 进入 "AI 助手" 分类
   - 配置以下信息：
     - API 端点: `https://api.deepseek.com/v1/chat/completions`
     - API Key: 输入有效的 DeepSeek API Key
     - 模型名称: `deepseek-chat`
   - 点击 "应用" 保存配置

2. **系统提示词**
   - 在设置面板中查看默认系统提示词
   - 可以编辑修改系统提示词
   - 验证提示词能够正确保存

### 手动测试步骤

#### 测试 1: 基础 AI 内容生成

1. 打开或创建一篇笔记
2. 点击工具栏中的 "AI 编辑" 按钮（sparkles 图标）
3. 验证对话框正确显示
4. 在输入框中输入提示词，例如："写一篇关于 Swift 编程的简短介绍"
5. 确保 "包含当前笔记内容作为上下文" 开关为关闭状态
6. 点击 "生成" 按钮
7. 验证：
   - 显示加载状态（生成按钮显示进度指示器）
   - 内容预览区域显示流式输出的内容
   - 内容逐步显示（流式效果）
8. 等待生成完成
9. 验证：
   - 生成按钮变为 "确认插入"
   - 预览区域显示完整内容
   - 无错误消息

#### 测试 2: 确认插入内容

1. 在测试 1 的基础上，点击 "确认插入" 按钮
2. 验证：
   - 对话框关闭
   - 编辑器内容末尾添加了生成的内容
   - 插入格式正确：
     - 前后各两个空行
     - 包含 `<!-- AI生成内容开始 -->` 和 `<!-- AI生成内容结束 -->` 标记
3. 验证内容自动保存

#### 测试 3: 包含上下文生成

1. 在笔记中输入一些内容，例如："这是一篇关于机器学习的笔记"
2. 打开 AI 编辑器对话框
3. 输入提示词："总结以上内容"
4. 开启 "包含当前笔记内容作为上下文" 开关
5. 点击 "生成"
6. 验证生成的内容与笔记内容相关

#### 测试 4: 错误处理

1. 在设置中清空 API Key
2. 打开 AI 编辑器对话框
3. 输入提示词并点击 "生成"
4. 验证：
   - 显示错误消息："API Key 未配置"
   - 显示 "重试" 按钮
5. 点击 "重试" 按钮
6. 验证错误消息清除，但生成仍然失败（因为 API Key 仍为空）

#### 测试 5: 取消操作

1. 打开 AI 编辑器对话框
2. 输入提示词并生成内容
3. 在预览阶段，点击 "取消" 按钮（如果有）
4. 或者直接关闭对话框
5. 验证：
   - 对话框关闭
   - 编辑器内容未改变

#### 测试 6: 字符限制

1. 打开 AI 编辑器对话框
2. 输入超过 500 字符的提示词
3. 验证：
   - 提示词被截断到 500 字符
   - 显示字符计数（接近 500 时）

#### 测试 7: 流式输出效果

1. 打开 AI 编辑器对话框
2. 输入提示词："写一篇长文章"
3. 点击 "生成"
4. 验证：
   - 内容逐字显示（流式效果）
   - 预览区域自动滚动到底部
   - 生成过程中可以查看实时内容

#### 测试 8: 设置面板配置

1. 打开设置（首选项）
2. 切换到 "AI 助手" 分类
3. 验证：
   - 显示 API 配置区域（端点、API Key、模型）
   - 显示系统提示词编辑区域
4. 修改 API Key
5. 点击 "应用"
6. 验证配置保存成功
7. 重新打开设置，验证配置已保存

#### 测试 9: 取消设置更改

1. 打开设置
2. 修改 AI 配置
3. 点击 "取消"
4. 验证：
   - 设置关闭
   - 配置恢复为原始值

#### 测试 10: 工具栏按钮状态

1. 未打开笔记时，验证 "AI 编辑" 按钮为禁用状态
2. 打开笔记后，验证 "AI 编辑" 按钮为启用状态
3. 点击按钮，验证对话框正确显示

## 测试结果记录

### 单元测试结果

- [ ] LLMService 测试全部通过
- [ ] EditorFeature AI 编辑器测试全部通过

### 手动测试结果

- [ ] 测试 1: 基础 AI 内容生成
- [ ] 测试 2: 确认插入内容
- [ ] 测试 3: 包含上下文生成
- [ ] 测试 4: 错误处理
- [ ] 测试 5: 取消操作
- [ ] 测试 6: 字符限制
- [ ] 测试 7: 流式输出效果
- [ ] 测试 8: 设置面板配置
- [ ] 测试 9: 取消设置更改
- [ ] 测试 10: 工具栏按钮状态

## 已知问题

（测试过程中发现的问题记录在这里）

## 测试完成标准

- 所有单元测试通过
- 所有手动测试用例通过
- 无严重 bug
- 用户体验流畅

## 备注

- 测试需要有效的 DeepSeek API Key
- 流式输出效果可能因网络速度而异
- 建议在不同网络环境下测试错误处理

