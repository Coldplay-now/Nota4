# æœ‰åºåˆ—è¡¨å±‚çº§ç¼©è¿›åŠŸèƒ½è®¾è®¡

> **è®¾è®¡æ—¥æœŸ**: 2025-11-19 16:23:56  
> **åŠŸèƒ½**: æœ‰åºåˆ—è¡¨ Tab é”®ç¼©è¿›å’Œå±‚çº§åºå·è‡ªåŠ¨è½¬æ¢  
> **çŠ¶æ€**: è®¾è®¡é˜¶æ®µ

---

## ğŸ“‹ éœ€æ±‚æ¦‚è¿°

åœ¨ç¼–è¾‘æ¨¡å¼ä¸‹ï¼Œå½“ç”¨æˆ·åœ¨æœ‰åºåˆ—è¡¨é¡¹ä¸­æŒ‰ Tab é”®æ—¶ï¼Œåº”è¯¥ï¼š
1. å¢åŠ åˆ—è¡¨é¡¹çš„ç¼©è¿›å±‚çº§
2. è‡ªåŠ¨å°†åºå·ä»æ•°å­—è½¬æ¢ä¸ºå¯¹åº”å±‚çº§çš„æ ¼å¼ï¼ˆå¦‚ a. b. c.ï¼‰
3. æ”¯æŒ Shift+Tab å‡å°‘ç¼©è¿›å±‚çº§
4. ä¿æŒ TCA çŠ¶æ€ç®¡ç†æœºåˆ¶

---

## ğŸ¯ è®¾è®¡ç›®æ ‡

### åŠŸèƒ½ç›®æ ‡
- âœ… æ”¯æŒ Tab é”®å¢åŠ ç¼©è¿›
- âœ… æ”¯æŒ Shift+Tab å‡å°‘ç¼©è¿›
- âœ… è‡ªåŠ¨è½¬æ¢åºå·æ ¼å¼ï¼ˆ1. â†’ a. â†’ i. â†’ A. â†’ I.ï¼‰
- âœ… ä¿æŒåˆ—è¡¨é¡¹çš„è¿ç»­æ€§
- âœ… æ”¯æŒå¤šè¡Œåˆ—è¡¨é¡¹çš„æ‰¹é‡ç¼©è¿›

### æŠ€æœ¯ç›®æ ‡
- âœ… éµå¾ª TCA çŠ¶æ€ç®¡ç†è§„èŒƒ
- âœ… æ”¯æŒ undo/redo
- âœ… ä¸å½±å“å…¶ä»–ç¼–è¾‘åŠŸèƒ½
- âœ… æ€§èƒ½ä¼˜åŒ–ï¼Œå“åº”è¿…é€Ÿ

---

## ğŸ” è®¾è®¡æ€è·¯åˆ†æ

### æ–¹æ¡ˆ1ï¼šæ ‡å‡† Markdown å±‚çº§åºå·ï¼ˆæ¨èï¼‰

**åºå·è§„åˆ™**ï¼š
- **ç¬¬1å±‚ï¼ˆ0ä¸ªç¼©è¿›ï¼‰**: `1. 2. 3. ...` (é˜¿æ‹‰ä¼¯æ•°å­—)
- **ç¬¬2å±‚ï¼ˆ2ä¸ªç©ºæ ¼ï¼‰**: `a. b. c. ...` (å°å†™å­—æ¯)
- **ç¬¬3å±‚ï¼ˆ4ä¸ªç©ºæ ¼ï¼‰**: `i. ii. iii. ...` (å°å†™ç½—é©¬æ•°å­—)
- **ç¬¬4å±‚ï¼ˆ6ä¸ªç©ºæ ¼ï¼‰**: `A. B. C. ...` (å¤§å†™å­—æ¯)
- **ç¬¬5å±‚ï¼ˆ8ä¸ªç©ºæ ¼ï¼‰**: `I. II. III. ...` (å¤§å†™ç½—é©¬æ•°å­—)

**ä¼˜ç‚¹**ï¼š
- ç¬¦åˆ Markdown è§„èŒƒ
- å±‚çº§æ¸…æ™°ï¼Œæ˜“äºè¯†åˆ«
- ä¸å¤§å¤šæ•° Markdown æ¸²æŸ“å™¨å…¼å®¹

**ç¼ºç‚¹**ï¼š
- éœ€è¦å®ç°ç½—é©¬æ•°å­—è½¬æ¢
- å±‚çº§è¾ƒæ·±æ—¶åºå·å¯èƒ½è¾ƒé•¿

**ç¤ºä¾‹**ï¼š
```markdown
1. ç¬¬ä¸€é¡¹
2. ç¬¬äºŒé¡¹
   a. å­é¡¹ 2.1
   b. å­é¡¹ 2.2
      i. å­é¡¹ 2.2.1
      ii. å­é¡¹ 2.2.2
   c. å­é¡¹ 2.3
3. ç¬¬ä¸‰é¡¹
```

---

### æ–¹æ¡ˆ2ï¼šç®€åŒ–å±‚çº§åºå·

**åºå·è§„åˆ™**ï¼š
- **ç¬¬1å±‚**: `1. 2. 3. ...` (é˜¿æ‹‰ä¼¯æ•°å­—)
- **ç¬¬2å±‚**: `a. b. c. ...` (å°å†™å­—æ¯)
- **ç¬¬3å±‚**: `i. ii. iii. ...` (å°å†™ç½—é©¬æ•°å­—)
- **ç¬¬4å±‚åŠä»¥ä¸Š**: å¾ªç¯ä½¿ç”¨å°å†™å­—æ¯

**ä¼˜ç‚¹**ï¼š
- å®ç°ç®€å•
- å±‚çº§ä¸ä¼šè¿‡æ·±

**ç¼ºç‚¹**ï¼š
- ç¬¬4å±‚åŠä»¥ä¸Šå¯èƒ½æ··æ·†

---

### æ–¹æ¡ˆ3ï¼šåµŒå¥—åºå·ï¼ˆå¦‚ 1.1, 1.2ï¼‰

**åºå·è§„åˆ™**ï¼š
- **ç¬¬1å±‚**: `1. 2. 3. ...`
- **ç¬¬2å±‚**: `1.1 1.2 1.3 ...` æˆ– `2.1 2.2 2.3 ...`
- **ç¬¬3å±‚**: `1.1.1 1.1.2 ...`

**ä¼˜ç‚¹**ï¼š
- åºå·æœ‰æ˜ç¡®çš„å±‚çº§å…³ç³»
- æ˜“äºç†è§£

**ç¼ºç‚¹**ï¼š
- ä¸ç¬¦åˆæ ‡å‡† Markdown è§„èŒƒ
- åºå·å¯èƒ½å¾ˆé•¿
- ç¼©è¿›æ—¶åºå·éœ€è¦é‡æ–°è®¡ç®—

---

## âœ… æ¨èæ–¹æ¡ˆï¼šæ–¹æ¡ˆ1ï¼ˆæ ‡å‡† Markdown å±‚çº§åºå·ï¼‰

### ç†ç”±
1. **ç¬¦åˆæ ‡å‡†**ï¼šéµå¾ª Markdown è§„èŒƒï¼Œå…¼å®¹æ€§å¥½
2. **å±‚çº§æ¸…æ™°**ï¼šä¸åŒæ ¼å¼çš„åºå·æ˜“äºåŒºåˆ†å±‚çº§
3. **ç”¨æˆ·ä½“éªŒ**ï¼šç¬¦åˆç”¨æˆ·å¯¹ Markdown ç¼–è¾‘å™¨çš„é¢„æœŸ

---

## ğŸ—ï¸ æŠ€æœ¯å®ç°è®¾è®¡

### 1. ç¼©è¿›æ£€æµ‹å’Œè®¡ç®—

#### 1.1 æ£€æµ‹å½“å‰è¡Œçš„ç¼©è¿›å±‚çº§

```swift
/// æ£€æµ‹è¡Œçš„ç¼©è¿›å±‚çº§
func detectIndentLevel(line: String) -> Int {
    var indentCount = 0
    var index = line.startIndex
    
    while index < line.endIndex {
        if line[index] == " " {
            indentCount += 1
            index = line.index(after: index)
        } else if line[index] == "\t" {
            // Tab é”®é€šå¸¸ç­‰äº 4 ä¸ªç©ºæ ¼
            indentCount += 4
            index = line.index(after: index)
        } else {
            break
        }
    }
    
    // æ¯ 2 ä¸ªç©ºæ ¼ä¸ºä¸€ä¸ªå±‚çº§ï¼ˆMarkdown æ ‡å‡†ï¼‰
    return indentCount / 2
}
```

#### 1.2 è®¡ç®—ç›®æ ‡å±‚çº§

```swift
/// è®¡ç®— Tab/Shift+Tab åçš„ç›®æ ‡å±‚çº§
func calculateTargetLevel(currentLevel: Int, isShiftPressed: Bool) -> Int {
    if isShiftPressed {
        // Shift+Tab: å‡å°‘ç¼©è¿›
        return max(0, currentLevel - 1)
    } else {
        // Tab: å¢åŠ ç¼©è¿›
        return min(5, currentLevel + 1)  // æœ€å¤š5å±‚
    }
}
```

---

### 2. åºå·æ ¼å¼è½¬æ¢

#### 2.1 åºå·æ ¼å¼æšä¸¾

```swift
enum ListNumberStyle {
    case arabic(Int)        // 1, 2, 3, ...
    case lowercaseLetter(Int) // a, b, c, ... (1-based: a=1, b=2, ...)
    case lowercaseRoman(Int)  // i, ii, iii, ... (1-based)
    case uppercaseLetter(Int) // A, B, C, ... (1-based)
    case uppercaseRoman(Int)  // I, II, III, ... (1-based)
    
    /// æ ¹æ®å±‚çº§è·å–åºå·æ ·å¼
    static func style(for level: Int) -> ListNumberStyle.Type {
        switch level {
        case 0: return arabic
        case 1: return lowercaseLetter
        case 2: return lowercaseRoman
        case 3: return uppercaseLetter
        case 4: return uppercaseRoman
        default: return lowercaseLetter  // è¶…è¿‡5å±‚ï¼Œå¾ªç¯ä½¿ç”¨å°å†™å­—æ¯
        }
    }
    
    /// è½¬æ¢ä¸ºå­—ç¬¦ä¸²æ ¼å¼
    func toString() -> String {
        switch self {
        case .arabic(let n):
            return "\(n)."
        case .lowercaseLetter(let n):
            return "\(Character(UnicodeScalar(96 + n)!))."  // a=97, b=98, ...
        case .lowercaseRoman(let n):
            return "\(romanNumeral(n, uppercase: false))."
        case .uppercaseLetter(let n):
            return "\(Character(UnicodeScalar(64 + n)!))."  // A=65, B=66, ...
        case .uppercaseRoman(let n):
            return "\(romanNumeral(n, uppercase: true))."
        }
    }
}
```

#### 2.2 ç½—é©¬æ•°å­—è½¬æ¢

```swift
/// å°†æ•°å­—è½¬æ¢ä¸ºç½—é©¬æ•°å­—
func romanNumeral(_ number: Int, uppercase: Bool) -> String {
    guard number > 0 && number < 4000 else {
        return "\(number)"  // è¶…å‡ºèŒƒå›´ï¼Œè¿”å›åŸæ•°å­—
    }
    
    let values = [1000, 900, 500, 400, 100, 90, 50, 40, 10, 9, 5, 4, 1]
    let symbols = uppercase 
        ? ["M", "CM", "D", "CD", "C", "XC", "L", "XL", "X", "IX", "V", "IV", "I"]
        : ["m", "cm", "d", "cd", "c", "xc", "l", "xl", "x", "ix", "v", "iv", "i"]
    
    var result = ""
    var remaining = number
    
    for (index, value) in values.enumerated() {
        let count = remaining / value
        if count > 0 {
            result += String(repeating: symbols[index], count: count)
            remaining -= value * count
        }
    }
    
    return result
}
```

---

### 3. åˆ—è¡¨é¡¹åºå·è®¡ç®—

#### 3.1 æ£€æµ‹åŒçº§åˆ—è¡¨é¡¹

```swift
/// æ£€æµ‹å½“å‰åˆ—è¡¨é¡¹åœ¨åŒçº§ä¸­çš„åºå·
func detectListNumber(
    text: String,
    currentLineIndex: Int,
    indentLevel: Int
) -> Int {
    let lines = text.components(separatedBy: .newlines)
    var number = 1
    
    // å‘å‰æŸ¥æ‰¾ï¼Œæ‰¾åˆ°ç¬¬ä¸€ä¸ªåŒçº§æˆ–æ›´é«˜çº§çš„åˆ—è¡¨é¡¹
    for i in stride(from: currentLineIndex - 1, through: 0, by: -1) {
        let line = lines[i]
        let lineIndent = detectIndentLevel(line: line)
        
        if lineIndent < indentLevel {
            // æ‰¾åˆ°äº†æ›´é«˜çº§çš„åˆ—è¡¨é¡¹ï¼Œåœæ­¢æŸ¥æ‰¾
            break
        } else if lineIndent == indentLevel {
            // æ‰¾åˆ°äº†åŒçº§åˆ—è¡¨é¡¹ï¼Œæå–åºå·å¹¶é€’å¢
            if let listNumber = extractListNumber(from: line) {
                number = listNumber + 1
                break
            }
        }
    }
    
    return number
}
```

#### 3.2 æå–åˆ—è¡¨åºå·

```swift
/// ä»åˆ—è¡¨è¡Œä¸­æå–åºå·
func extractListNumber(from line: String) -> Int? {
    // ç§»é™¤å‰å¯¼ç©ºæ ¼
    let trimmed = line.trimmingCharacters(in: .whitespaces)
    
    // åŒ¹é…æœ‰åºåˆ—è¡¨ï¼šæ•°å­—. æˆ– å­—æ¯. æˆ– ç½—é©¬æ•°å­—.
    if let match = trimmed.range(of: #"^(\d+|[a-z]|[A-Z]|[ivxlcdm]+)\.\s"#, options: .regularExpression) {
        let numberStr = String(trimmed[..<match.upperBound].dropLast(2))
        
        // å°è¯•è§£æä¸ºæ•°å­—
        if let number = Int(numberStr) {
            return number
        }
        
        // å°è¯•è§£æä¸ºå­—æ¯
        if numberStr.count == 1, let char = numberStr.first {
            if char.isLowercase {
                return Int(char.asciiValue! - 96)  // a=1, b=2, ...
            } else if char.isUppercase {
                return Int(char.asciiValue! - 64)  // A=1, B=2, ...
            }
        }
        
        // å°è¯•è§£æä¸ºç½—é©¬æ•°å­—
        if let roman = parseRomanNumeral(numberStr) {
            return roman
        }
    }
    
    return nil
}
```

---

### 4. Tab é”®å¤„ç†é€»è¾‘

#### 4.1 æ‹¦æˆª Tab é”®

```swift
func textView(_ textView: NSTextView, doCommandBy commandSelector: Selector) -> Bool {
    // æ‹¦æˆª Tab é”®
    if commandSelector == #selector(NSTextView.insertTab(_:)) {
        return handleTabKey(textView: textView, isShiftPressed: false)
    }
    // æ‹¦æˆª Shift+Tab é”®
    if commandSelector == #selector(NSTextView.insertBacktab(_:)) {
        return handleTabKey(textView: textView, isShiftPressed: true)
    }
    // æ‹¦æˆªå›è½¦é”®ï¼ˆå·²æœ‰å®ç°ï¼‰
    if commandSelector == #selector(NSTextView.insertNewline(_:)) {
        return handleEnterKey(textView: textView)
    }
    return false
}
```

#### 4.2 å¤„ç† Tab é”®

```swift
private func handleTabKey(textView: NSTextView, isShiftPressed: Bool) -> Bool {
    let text = textView.string
    let selection = textView.selectedRange()
    
    // è·å–å½“å‰è¡Œ
    let nsText = text as NSString
    let lineRange = nsText.lineRange(for: selection)
    let lineText = nsText.substring(with: lineRange)
    
    // æ£€æµ‹æ˜¯å¦æ˜¯åˆ—è¡¨é¡¹
    guard let listInfo = detectListType(line: lineText.trimmingCharacters(in: .whitespacesAndNewlines)) else {
        // ä¸æ˜¯åˆ—è¡¨é¡¹ï¼Œæ‰§è¡Œé»˜è®¤ Tab è¡Œä¸ºï¼ˆæ’å…¥åˆ¶è¡¨ç¬¦æˆ–ç©ºæ ¼ï¼‰
        return false
    }
    
    // åªå¤„ç†æœ‰åºåˆ—è¡¨
    guard case .ordered(let currentNumber) = listInfo else {
        // æ— åºåˆ—è¡¨æˆ–ä»»åŠ¡åˆ—è¡¨ï¼Œæ‰§è¡Œé»˜è®¤ Tab è¡Œä¸º
        return false
    }
    
    // æ£€æµ‹å½“å‰ç¼©è¿›å±‚çº§
    let currentIndentLevel = detectIndentLevel(line: lineText)
    let targetIndentLevel = calculateTargetLevel(
        currentLevel: currentIndentLevel,
        isShiftPressed: isShiftPressed
    )
    
    // å¦‚æœå±‚çº§æ²¡æœ‰å˜åŒ–ï¼Œä¸å¤„ç†
    if currentIndentLevel == targetIndentLevel {
        return false
    }
    
    // è®¡ç®—æ–°çš„ç¼©è¿›å’Œåºå·
    let newIndent = String(repeating: " ", count: targetIndentLevel * 2)
    let listNumber = detectListNumber(
        text: text,
        currentLineIndex: nsText.lineNumber(for: selection.location),
        indentLevel: targetIndentLevel
    )
    let newMarker = generateListMarker(level: targetIndentLevel, number: listNumber)
    
    // ç§»é™¤æ—§çš„åˆ—è¡¨æ ‡è®°å’Œç¼©è¿›ï¼Œæ·»åŠ æ–°çš„
    let content = extractListContent(from: lineText)
    let newLine = "\(newIndent)\(newMarker) \(content)"
    
    // æ›¿æ¢å½“å‰è¡Œ
    let replacementRange = lineRange
    guard textView.shouldChangeText(in: replacementRange, replacementString: newLine) else {
        return false
    }
    
    if let textStorage = textView.textStorage {
        textStorage.replaceCharacters(in: replacementRange, with: newLine)
        textView.didChangeText()
        
        // æ›´æ–°é€‰ä¸­èŒƒå›´
        let newSelection = NSRange(
            location: replacementRange.location + newIndent.count + newMarker.count + 1,
            length: 0
        )
        textView.setSelectedRange(newSelection)
        textView.scrollRangeToVisible(newSelection)
        
        // é€šçŸ¥çˆ¶ç»„ä»¶å†…å®¹å·²æ”¹å˜
        DispatchQueue.main.async { [weak self] in
            guard let self = self else { return }
            self.parent.text = textView.string
            self.parent.onSelectionChange(newSelection)
        }
    }
    
    return true
}
```

---

### 5. è¾…åŠ©å‡½æ•°

#### 5.1 ç”Ÿæˆåˆ—è¡¨æ ‡è®°

```swift
/// æ ¹æ®å±‚çº§å’Œåºå·ç”Ÿæˆåˆ—è¡¨æ ‡è®°
func generateListMarker(level: Int, number: Int) -> String {
    switch level {
    case 0:
        return "\(number)."
    case 1:
        // a, b, c, ...
        let char = Character(UnicodeScalar(96 + number)!)
        return "\(char)."
    case 2:
        // i, ii, iii, ...
        return "\(romanNumeral(number, uppercase: false))."
    case 3:
        // A, B, C, ...
        let char = Character(UnicodeScalar(64 + number)!)
        return "\(char)."
    case 4:
        // I, II, III, ...
        return "\(romanNumeral(number, uppercase: true))."
    default:
        // è¶…è¿‡5å±‚ï¼Œå¾ªç¯ä½¿ç”¨å°å†™å­—æ¯
        let char = Character(UnicodeScalar(96 + number)!)
        return "\(char)."
    }
}
```

#### 5.2 æå–åˆ—è¡¨å†…å®¹

```swift
/// ä»åˆ—è¡¨è¡Œä¸­æå–å†…å®¹ï¼ˆå»é™¤ç¼©è¿›å’Œæ ‡è®°ï¼‰
func extractListContent(from line: String) -> String {
    let trimmed = line.trimmingCharacters(in: .whitespacesAndNewlines)
    
    // åŒ¹é…å¹¶ç§»é™¤åˆ—è¡¨æ ‡è®°
    if let match = trimmed.range(of: #"^(\d+|[a-z]|[A-Z]|[ivxlcdmIVXLCDM]+)\.\s*"#, options: .regularExpression) {
        return String(trimmed[match.upperBound...])
    }
    
    return trimmed
}
```

---

## ğŸ“ ç¼©è¿›è§„åˆ™

### Markdown æ ‡å‡†ç¼©è¿›

- **æ¯å±‚çº§ç¼©è¿›**: 2 ä¸ªç©ºæ ¼ï¼ˆMarkdown æ ‡å‡†ï¼‰
- **æœ€å¤§å±‚çº§**: 5 å±‚ï¼ˆè¶…è¿‡åå¾ªç¯ä½¿ç”¨å°å†™å­—æ¯ï¼‰
- **Tab é”®è¡Œä¸º**: å¢åŠ  1 ä¸ªå±‚çº§ï¼ˆ2 ä¸ªç©ºæ ¼ï¼‰
- **Shift+Tab è¡Œä¸º**: å‡å°‘ 1 ä¸ªå±‚çº§ï¼ˆå‡å°‘ 2 ä¸ªç©ºæ ¼ï¼‰

### ç¼©è¿›ç¤ºä¾‹

```markdown
1. ç¬¬ä¸€å±‚
2. ç¬¬ä¸€å±‚
   a. ç¬¬äºŒå±‚
   b. ç¬¬äºŒå±‚
      i. ç¬¬ä¸‰å±‚
      ii. ç¬¬ä¸‰å±‚
         A. ç¬¬å››å±‚
         B. ç¬¬å››å±‚
            I. ç¬¬äº”å±‚
            II. ç¬¬äº”å±‚
```

---

## ğŸ”„ äº¤äº’æµç¨‹

### Tab é”®å¢åŠ ç¼©è¿›

```
ç”¨æˆ·åœ¨æœ‰åºåˆ—è¡¨é¡¹ä¸­æŒ‰ Tab
  â†“
æ£€æµ‹å½“å‰è¡Œæ˜¯å¦ä¸ºæœ‰åºåˆ—è¡¨é¡¹
  â†“
æ£€æµ‹å½“å‰ç¼©è¿›å±‚çº§ï¼ˆå¦‚ï¼šç¬¬1å±‚ï¼Œåºå· 2.ï¼‰
  â†“
è®¡ç®—ç›®æ ‡å±‚çº§ï¼ˆç¬¬2å±‚ï¼‰
  â†“
æŸ¥æ‰¾åŒçº§åˆ—è¡¨é¡¹ï¼Œè®¡ç®—åºå·ï¼ˆå¦‚ï¼šç¬¬2å±‚çš„ç¬¬1é¡¹ï¼‰
  â†“
ç”Ÿæˆæ–°çš„åˆ—è¡¨æ ‡è®°ï¼ˆa.ï¼‰
  â†“
æ›¿æ¢å½“å‰è¡Œçš„ç¼©è¿›å’Œæ ‡è®°
  â†“
æ›´æ–° TCA çŠ¶æ€
  â†“
å…‰æ ‡ç§»åŠ¨åˆ°æ–°æ ‡è®°å
```

### Shift+Tab å‡å°‘ç¼©è¿›

```
ç”¨æˆ·åœ¨æœ‰åºåˆ—è¡¨é¡¹ä¸­æŒ‰ Shift+Tab
  â†“
æ£€æµ‹å½“å‰è¡Œæ˜¯å¦ä¸ºæœ‰åºåˆ—è¡¨é¡¹
  â†“
æ£€æµ‹å½“å‰ç¼©è¿›å±‚çº§ï¼ˆå¦‚ï¼šç¬¬2å±‚ï¼Œåºå· a.ï¼‰
  â†“
è®¡ç®—ç›®æ ‡å±‚çº§ï¼ˆç¬¬1å±‚ï¼‰
  â†“
æŸ¥æ‰¾åŒçº§åˆ—è¡¨é¡¹ï¼Œè®¡ç®—åºå·ï¼ˆå¦‚ï¼šç¬¬1å±‚çš„ç¬¬3é¡¹ï¼‰
  â†“
ç”Ÿæˆæ–°çš„åˆ—è¡¨æ ‡è®°ï¼ˆ3.ï¼‰
  â†“
æ›¿æ¢å½“å‰è¡Œçš„ç¼©è¿›å’Œæ ‡è®°
  â†“
æ›´æ–° TCA çŠ¶æ€
  â†“
å…‰æ ‡ç§»åŠ¨åˆ°æ–°æ ‡è®°å
```

---

## ğŸ¨ è¾¹ç•Œæƒ…å†µå¤„ç†

### 1. ç©ºåˆ—è¡¨é¡¹

**åœºæ™¯**: ç”¨æˆ·åœ¨æœ‰å†…å®¹çš„åˆ—è¡¨é¡¹ä¸­æŒ‰ Tab

**å¤„ç†**: æ­£å¸¸å¤„ç†ï¼Œä¿æŒå†…å®¹ä¸å˜ï¼Œåªæ”¹å˜ç¼©è¿›å’Œæ ‡è®°

### 2. åˆ—è¡¨é¡¹ä¸­é—´æŒ‰ Tab

**åœºæ™¯**: å…‰æ ‡åœ¨åˆ—è¡¨é¡¹å†…å®¹ä¸­é—´æŒ‰ Tab

**å¤„ç†**: 
- å¦‚æœå…‰æ ‡åœ¨åˆ—è¡¨æ ‡è®°ä¹‹åï¼Œæ‰§è¡Œç¼©è¿›æ“ä½œ
- å¦‚æœå…‰æ ‡åœ¨åˆ—è¡¨æ ‡è®°ä¹‹å‰ï¼Œæ‰§è¡Œé»˜è®¤ Tab è¡Œä¸ºï¼ˆæ’å…¥ç©ºæ ¼ï¼‰

### 3. å¤šè¡Œé€‰ä¸­

**åœºæ™¯**: ç”¨æˆ·é€‰ä¸­å¤šè¡Œåˆ—è¡¨é¡¹æŒ‰ Tab

**å¤„ç†**: 
- æ‰¹é‡å¤„ç†æ‰€æœ‰é€‰ä¸­çš„åˆ—è¡¨é¡¹
- æ¯è¡Œç‹¬ç«‹è®¡ç®—ç¼©è¿›å’Œåºå·
- ä¿æŒç›¸å¯¹å±‚çº§å…³ç³»

### 4. æ··åˆåˆ—è¡¨

**åœºæ™¯**: é€‰ä¸­çš„è¡ŒåŒ…å«æœ‰åºåˆ—è¡¨ã€æ— åºåˆ—è¡¨å’Œæ™®é€šæ–‡æœ¬

**å¤„ç†**: 
- åªå¤„ç†æœ‰åºåˆ—è¡¨é¡¹
- å…¶ä»–è¡Œä¿æŒä¸å˜æˆ–æ‰§è¡Œé»˜è®¤ Tab è¡Œä¸º

### 5. å±‚çº§è¾¹ç•Œ

**åœºæ™¯**: ç¬¬1å±‚æŒ‰ Shift+Tab æˆ–ç¬¬5å±‚æŒ‰ Tab

**å¤„ç†**: 
- ç¬¬1å±‚æŒ‰ Shift+Tabï¼šä¸å¤„ç†ï¼ˆå·²ç»æ˜¯é¡¶å±‚ï¼‰
- ç¬¬5å±‚æŒ‰ Tabï¼šå¯ä»¥ç»§ç»­å¢åŠ ï¼Œä½†åºå·å¾ªç¯ä½¿ç”¨å°å†™å­—æ¯

---

## ğŸ”§ TCA çŠ¶æ€ç®¡ç†

### çŠ¶æ€æ›´æ–°æµç¨‹

```
ç”¨æˆ·æŒ‰ Tab/Shift+Tab
  â†“
MarkdownTextEditor.Coordinator.handleTabKey
  â†“
æ£€æµ‹åˆ—è¡¨ç±»å‹å’Œç¼©è¿›å±‚çº§
  â†“
è®¡ç®—æ–°çš„ç¼©è¿›å’Œæ ‡è®°
  â†“
æ›¿æ¢æ–‡æœ¬ï¼ˆä½¿ç”¨ shouldChangeText å’Œ didChangeTextï¼‰
  â†“
æ›´æ–° textView.string
  â†“
é€šè¿‡ parent.text å’Œ parent.onSelectionChange æ›´æ–° TCA çŠ¶æ€
  â†“
è§¦å‘è‡ªåŠ¨ä¿å­˜ï¼ˆå¦‚æœéœ€è¦ï¼‰
```

### çŠ¶æ€æ›´æ–°åŸåˆ™

1. **åŸå­æ€§**: ä¸€æ¬¡ Tab æ“ä½œåªæ›´æ–°ä¸€æ¬¡çŠ¶æ€
2. **åŒæ­¥æ€§**: çŠ¶æ€æ›´æ–°åœ¨ä¸»çº¿ç¨‹å¼‚æ­¥æ‰§è¡Œ
3. **ä¸€è‡´æ€§**: textView çš„å†…å®¹å’Œ TCA state.content ä¿æŒä¸€è‡´
4. **Undo/Redo**: é€šè¿‡ shouldChangeText å’Œ didChangeText è‡ªåŠ¨æ”¯æŒ

---

## ğŸ“Š åºå·è®¡ç®—ç®—æ³•

### åŒçº§åˆ—è¡¨é¡¹æ£€æµ‹

```swift
/// æ£€æµ‹å½“å‰åˆ—è¡¨é¡¹åœ¨åŒçº§ä¸­çš„åºå·
func detectListNumber(
    text: String,
    currentLineIndex: Int,
    indentLevel: Int
) -> Int {
    let lines = text.components(separatedBy: .newlines)
    var number = 1
    
    // å‘å‰æŸ¥æ‰¾åŒçº§åˆ—è¡¨é¡¹
    for i in stride(from: currentLineIndex - 1, through: 0, by: -1) {
        let line = lines[i]
        let lineIndent = detectIndentLevel(line: line)
        
        if lineIndent < indentLevel {
            // æ‰¾åˆ°æ›´é«˜çº§çš„åˆ—è¡¨é¡¹ï¼Œåœæ­¢
            break
        } else if lineIndent == indentLevel {
            // æ‰¾åˆ°åŒçº§åˆ—è¡¨é¡¹
            if let listNumber = extractListNumber(from: line) {
                number = listNumber + 1
                break
            }
        } else if lineIndent > indentLevel {
            // å­çº§åˆ—è¡¨é¡¹ï¼Œç»§ç»­æŸ¥æ‰¾
            continue
        }
    }
    
    return number
}
```

### åºå·é‡ç½®é€»è¾‘

å½“ç¼©è¿›å±‚çº§æ”¹å˜æ—¶ï¼Œåºå·éœ€è¦é‡æ–°è®¡ç®—ï¼š
- **å¢åŠ ç¼©è¿›**: ä» 1 å¼€å§‹è®¡æ•°ï¼ˆæ–°å±‚çº§çš„ç¬¬ä¸€é¡¹ï¼‰
- **å‡å°‘ç¼©è¿›**: æŸ¥æ‰¾åŒçº§åˆ—è¡¨é¡¹ï¼Œè®¡ç®—ä¸‹ä¸€ä¸ªåºå·

---

## ğŸ§ª æµ‹è¯•ç”¨ä¾‹

### æµ‹è¯•ç”¨ä¾‹ 1: åŸºæœ¬ Tab ç¼©è¿›

**è¾“å…¥**:
```markdown
1. ç¬¬ä¸€é¡¹
2. ç¬¬äºŒé¡¹
```

**æ“ä½œ**: åœ¨ "2. ç¬¬äºŒé¡¹" è¡ŒæŒ‰ Tab

**é¢„æœŸè¾“å‡º**:
```markdown
1. ç¬¬ä¸€é¡¹
   a. ç¬¬äºŒé¡¹
```

### æµ‹è¯•ç”¨ä¾‹ 2: Shift+Tab å‡å°‘ç¼©è¿›

**è¾“å…¥**:
```markdown
1. ç¬¬ä¸€é¡¹
   a. ç¬¬äºŒé¡¹
```

**æ“ä½œ**: åœ¨ "a. ç¬¬äºŒé¡¹" è¡ŒæŒ‰ Shift+Tab

**é¢„æœŸè¾“å‡º**:
```markdown
1. ç¬¬ä¸€é¡¹
2. ç¬¬äºŒé¡¹
```

### æµ‹è¯•ç”¨ä¾‹ 3: å¤šå±‚çº§ç¼©è¿›

**è¾“å…¥**:
```markdown
1. ç¬¬ä¸€é¡¹
2. ç¬¬äºŒé¡¹
```

**æ“ä½œ**: 
1. åœ¨ "2. ç¬¬äºŒé¡¹" è¡ŒæŒ‰ Tab â†’ å˜æˆ "a. ç¬¬äºŒé¡¹"
2. å†æŒ‰ Tab â†’ å˜æˆ "i. ç¬¬äºŒé¡¹"
3. å†æŒ‰ Tab â†’ å˜æˆ "A. ç¬¬äºŒé¡¹"
4. å†æŒ‰ Tab â†’ å˜æˆ "I. ç¬¬äºŒé¡¹"

**é¢„æœŸè¾“å‡º**:
```markdown
1. ç¬¬ä¸€é¡¹
         I. ç¬¬äºŒé¡¹
```

### æµ‹è¯•ç”¨ä¾‹ 4: åºå·è¿ç»­æ€§

**è¾“å…¥**:
```markdown
1. ç¬¬ä¸€é¡¹
2. ç¬¬äºŒé¡¹
3. ç¬¬ä¸‰é¡¹
```

**æ“ä½œ**: åœ¨ "2. ç¬¬äºŒé¡¹" è¡ŒæŒ‰ Tab

**é¢„æœŸè¾“å‡º**:
```markdown
1. ç¬¬ä¸€é¡¹
   a. ç¬¬äºŒé¡¹
2. ç¬¬ä¸‰é¡¹
```

æ³¨æ„ï¼šåŸæ¥çš„ "3. ç¬¬ä¸‰é¡¹" å˜æˆ "2. ç¬¬ä¸‰é¡¹"ï¼ˆå› ä¸ºå‰é¢å°‘äº†ä¸€é¡¹ï¼‰

### æµ‹è¯•ç”¨ä¾‹ 5: å¤šè¡Œé€‰ä¸­

**è¾“å…¥**:
```markdown
1. ç¬¬ä¸€é¡¹
2. ç¬¬äºŒé¡¹
3. ç¬¬ä¸‰é¡¹
```

**æ“ä½œ**: é€‰ä¸­ "2. ç¬¬äºŒé¡¹" å’Œ "3. ç¬¬ä¸‰é¡¹" ä¸¤è¡Œï¼ŒæŒ‰ Tab

**é¢„æœŸè¾“å‡º**:
```markdown
1. ç¬¬ä¸€é¡¹
   a. ç¬¬äºŒé¡¹
   b. ç¬¬ä¸‰é¡¹
```

---

## ğŸš€ å®ç°ä¼˜å…ˆçº§

### Phase 1: åŸºç¡€åŠŸèƒ½ï¼ˆå¿…é¡»å®ç°ï¼‰
1. âœ… Tab é”®å¢åŠ ç¼©è¿›ï¼ˆå•è¡Œï¼‰
2. âœ… Shift+Tab å‡å°‘ç¼©è¿›ï¼ˆå•è¡Œï¼‰
3. âœ… åºå·æ ¼å¼è½¬æ¢ï¼ˆ1. â†’ a. â†’ i.ï¼‰
4. âœ… åŒçº§åºå·è®¡ç®—

### Phase 2: å¢å¼ºåŠŸèƒ½ï¼ˆä¼˜å…ˆå®ç°ï¼‰
1. âš ï¸ å¤šè¡Œé€‰ä¸­æ‰¹é‡ç¼©è¿›
2. âš ï¸ åºå·è¿ç»­æ€§ç»´æŠ¤ï¼ˆç¼©è¿›åé‡æ–°ç¼–å·ï¼‰
3. âš ï¸ å…‰æ ‡ä½ç½®æ™ºèƒ½å¤„ç†

### Phase 3: ä¼˜åŒ–åŠŸèƒ½ï¼ˆå¯é€‰å®ç°ï¼‰
1. âš ï¸ ç½—é©¬æ•°å­—è½¬æ¢ä¼˜åŒ–
2. âš ï¸ æ€§èƒ½ä¼˜åŒ–ï¼ˆå¤§é‡åˆ—è¡¨é¡¹ï¼‰
3. âš ï¸ åŠ¨ç”»æ•ˆæœ

---

## ğŸ’¡ è®¾è®¡è€ƒè™‘

### 1. åºå·é‡ç½®ç­–ç•¥

**é€‰é¡¹A**: ç¼©è¿›ååºå·ä» 1 å¼€å§‹ï¼ˆæ¨èï¼‰
- ä¼˜ç‚¹ï¼šç®€å•ç›´è§‚
- ç¼ºç‚¹ï¼šå¯èƒ½ä¸ç”¨æˆ·é¢„æœŸä¸ç¬¦

**é€‰é¡¹B**: ä¿æŒåŸåºå·ï¼ˆå¦‚æœå¯èƒ½ï¼‰
- ä¼˜ç‚¹ï¼šä¿æŒè¿ç»­æ€§
- ç¼ºç‚¹ï¼šå®ç°å¤æ‚ï¼Œå¯èƒ½ä¸ç¬¦åˆ Markdown è§„èŒƒ

**æ¨è**: é€‰é¡¹Aï¼Œå› ä¸ºç¬¦åˆ Markdown è§„èŒƒ

### 2. ç¼©è¿›å•ä½

**é€‰é¡¹A**: 2 ä¸ªç©ºæ ¼ï¼ˆMarkdown æ ‡å‡†ï¼‰
- ä¼˜ç‚¹ï¼šç¬¦åˆè§„èŒƒ
- ç¼ºç‚¹ï¼šä¸ Tab é”®çš„é»˜è®¤è¡Œä¸ºä¸ä¸€è‡´

**é€‰é¡¹B**: 4 ä¸ªç©ºæ ¼ï¼ˆTab é”®é»˜è®¤ï¼‰
- ä¼˜ç‚¹ï¼šä¸ Tab é”®è¡Œä¸ºä¸€è‡´
- ç¼ºç‚¹ï¼šä¸ç¬¦åˆ Markdown è§„èŒƒ

**æ¨è**: é€‰é¡¹Aï¼Œä½¿ç”¨ 2 ä¸ªç©ºæ ¼ï¼Œç¬¦åˆ Markdown è§„èŒƒ

### 3. åºå·æ ¼å¼é€‰æ‹©

**æ ‡å‡†æ–¹æ¡ˆ**ï¼ˆæ¨èï¼‰:
- 1. â†’ a. â†’ i. â†’ A. â†’ I.

**ç®€åŒ–æ–¹æ¡ˆ**:
- 1. â†’ a. â†’ i. â†’ a. (å¾ªç¯)

**æ¨è**: æ ‡å‡†æ–¹æ¡ˆï¼Œæ›´ç¬¦åˆç”¨æˆ·é¢„æœŸ

---

## ğŸ“ å®ç°æ³¨æ„äº‹é¡¹

### 1. ä¸ç°æœ‰åŠŸèƒ½çš„å…¼å®¹æ€§

- âœ… ä¸å½±å“åˆ—è¡¨è‡ªåŠ¨ç»­è¡ŒåŠŸèƒ½
- âœ… ä¸å½±å“å…¶ä»–ç¼–è¾‘åŠŸèƒ½
- âœ… æ”¯æŒ undo/redo

### 2. æ€§èƒ½è€ƒè™‘

- å¤§é‡åˆ—è¡¨é¡¹æ—¶ï¼Œåºå·è®¡ç®—å¯èƒ½éœ€è¦ä¼˜åŒ–
- å¤šè¡Œé€‰ä¸­æ‰¹é‡å¤„ç†æ—¶ï¼Œé¿å…é¢‘ç¹çš„çŠ¶æ€æ›´æ–°

### 3. ç”¨æˆ·ä½“éªŒ

- æ“ä½œå“åº”è¦è¿…é€Ÿ
- å…‰æ ‡ä½ç½®è¦åˆç†
- è§†è§‰åé¦ˆè¦æ¸…æ™°

---

## ğŸ”— ç›¸å…³æ–‡ä»¶

### éœ€è¦ä¿®æ”¹çš„æ–‡ä»¶
1. `Nota4/Nota4/Features/Editor/MarkdownTextEditor.swift`
   - æ·»åŠ  Tab é”®æ‹¦æˆª
   - å®ç°ç¼©è¿›é€»è¾‘
   - å®ç°åºå·è½¬æ¢

### å¯èƒ½éœ€è¦åˆ›å»ºçš„æ–‡ä»¶
1. `Nota4/Nota4/Features/Editor/ListIndentHelper.swift`ï¼ˆå¯é€‰ï¼‰
   - åˆ—è¡¨ç¼©è¿›å·¥å…·å‡½æ•°
   - åºå·æ ¼å¼è½¬æ¢
   - ç½—é©¬æ•°å­—è½¬æ¢

---

## ğŸ“š å‚è€ƒèµ„æ–™

1. [Markdown åˆ—è¡¨è§„èŒƒ](https://daringfireball.net/projects/markdown/syntax#list)
2. [CSS åˆ—è¡¨æ ·å¼](https://developer.mozilla.org/en-US/docs/Web/CSS/list-style-type)
3. [CommonMark è§„èŒƒ](https://spec.commonmark.org/0.30/#lists)

---

**è®¾è®¡å®Œæˆæ—¥æœŸ**: 2025-11-19 16:23:56  
**è®¾è®¡äººå‘˜**: AI Assistant  
**çŠ¶æ€**: âœ… è®¾è®¡å®Œæˆï¼Œç­‰å¾…å®ç°

