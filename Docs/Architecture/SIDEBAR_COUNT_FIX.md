# ä¾§è¾¹æ ç¬”è®°è®¡æ•°ä¿®å¤

**æ—¥æœŸ**: 2025å¹´11æœˆ16æ—¥ 19:58:29  
**é—®é¢˜**: ä¾§è¾¹æ åˆ†ç±»ä¸æ˜¯åœ¨æ‰€æœ‰æƒ…å†µä¸‹éƒ½æ˜¾ç¤ºç¬”è®°æ•°é‡

---

## ğŸ› é—®é¢˜æè¿°

### ç”¨æˆ·åé¦ˆ
> "ä»»ä½•æƒ…å†µä¸‹ï¼Œç¬”è®°ç±»å‹æ é‡Œé¢éƒ½è¦æœ‰ç¬”è®°æ•°é‡ã€‚ç°åœ¨ä¼¼ä¹ä¸æ˜¯éƒ½åŒæ—¶æ˜¾ç¤ºçš„ã€‚"

### é—®é¢˜ç°è±¡

ä»ç”¨æˆ·æä¾›çš„æˆªå›¾å¯ä»¥çœ‹å‡ºï¼š

**æƒ…å†µ 1**:
- å…¨éƒ¨ç¬”è®° - âŒ æœªæ˜¾ç¤ºæ•°é‡
- æ˜Ÿæ ‡ç¬”è®° - âŒ æœªæ˜¾ç¤ºæ•°é‡
- å·²åˆ é™¤ - âœ… æ˜¾ç¤º 3

**æƒ…å†µ 2**:
- å…¨éƒ¨ç¬”è®° - âœ… æ˜¾ç¤º 17
- æ˜Ÿæ ‡ç¬”è®° - âœ… æ˜¾ç¤º 3
- å·²åˆ é™¤ - âŒ æœªæ˜¾ç¤ºæ•°é‡

### æ ¹æœ¬åŸå› 

ç»è¿‡åˆ†æï¼Œå‘ç°äº†ä¸¤ä¸ªé—®é¢˜ï¼š

1. **SwiftUI Badge è¡Œä¸º**
   - `badge(Int)` å½“å€¼ä¸º 0 æ—¶å¯èƒ½ä¸æ˜¾ç¤º
   - å¯¼è‡´æ•°é‡ä¸º 0 çš„åˆ†ç±»æ²¡æœ‰æ˜¾ç¤ºæ•°å­—

2. **åˆå§‹åŒ–æ—¶æœº**
   - `categoryCounts` åˆå§‹åŒ–ä¸ºç©ºå­—å…¸ `[:]`
   - åœ¨ç¬”è®°åŠ è½½å‰ï¼Œä¾§è¾¹æ æ²¡æœ‰è®¡æ•°æ•°æ®
   - éœ€è¦åœ¨ä¾§è¾¹æ å‡ºç°æ—¶ä¸»åŠ¨åŠ è½½è®¡æ•°

---

## âœ… ä¿®å¤æ–¹æ¡ˆ

### 1. ä¿®æ”¹ Badge æ˜¾ç¤ºæ–¹å¼

#### Beforeï¼ˆä¿®å¤å‰ï¼‰
```swift
.badge(store.categoryCounts[category] ?? 0)
```

**é—®é¢˜**: SwiftUI çš„ `badge(Int)` åœ¨å€¼ä¸º 0 æ—¶å¯èƒ½ä¸æ˜¾ç¤ºã€‚

#### Afterï¼ˆä¿®å¤åï¼‰
```swift
.badge(Text("\(store.categoryCounts[category] ?? 0)"))
```

**ä¼˜åŠ¿**: ä½¿ç”¨ `Text` æ˜ç¡®æ˜¾ç¤ºæ•°å­—ï¼Œå³ä½¿æ˜¯ 0 ä¹Ÿä¼šæ˜¾ç¤ºã€‚

### 2. åˆå§‹åŒ– categoryCounts

#### Beforeï¼ˆä¿®å¤å‰ï¼‰
```swift
var categoryCounts: [Category: Int] = [:]
```

**é—®é¢˜**: ç©ºå­—å…¸å¯¼è‡´åˆå§‹çŠ¶æ€æ²¡æœ‰ä»»ä½•è®¡æ•°ã€‚

#### Afterï¼ˆä¿®å¤åï¼‰
```swift
var categoryCounts: [Category: Int] = [
    .all: 0,
    .starred: 0,
    .trash: 0
]
```

**ä¼˜åŠ¿**: æ‰€æœ‰åˆ†ç±»éƒ½æœ‰åˆå§‹å€¼ 0ï¼Œç¡®ä¿å§‹ç»ˆæœ‰æ•°æ®æ˜¾ç¤ºã€‚

### 3. æ·»åŠ ä¸»åŠ¨åŠ è½½è®¡æ•°çš„åŠŸèƒ½

#### æ–°å¢ Action
```swift
case loadCounts
```

#### å®ç° Reducer é€»è¾‘
```swift
case .loadCounts:
    return .run { send in
        // é€šè¿‡åŠ è½½ç¬”è®°æ¥è®¡ç®—æ•°é‡
        let allNotes = try await noteRepository.fetchNotes(filter: .all)
        let counts: [State.Category: Int] = [
            .all: allNotes.filter { !$0.isDeleted }.count,
            .starred: allNotes.filter { $0.isStarred && !$0.isDeleted }.count,
            .trash: allNotes.filter { $0.isDeleted }.count
        ]
        await send(.updateCounts(counts))
    } catch: { error, send in
        print("âŒ åŠ è½½è®¡æ•°å¤±è´¥: \(error)")
    }
```

#### åœ¨ onAppear æ—¶è§¦å‘
```swift
.onAppear {
    store.send(.loadTags)
    store.send(.loadCounts)  // æ–°å¢ï¼šåŠ è½½è®¡æ•°
}
```

---

## ğŸ“‹ ä¿®æ”¹çš„æ–‡ä»¶

### 1. SidebarView.swift

**ä¿®æ”¹ 1: Badge æ˜¾ç¤ºæ–¹å¼**
```swift
// Before
.badge(store.categoryCounts[category] ?? 0)

// After
.badge(Text("\(store.categoryCounts[category] ?? 0)"))
```

**ä¿®æ”¹ 2: onAppear æ·»åŠ  loadCounts**
```swift
.onAppear {
    store.send(.loadTags)
    store.send(.loadCounts)  // æ–°å¢
}
```

### 2. SidebarFeature.swift

**ä¿®æ”¹ 1: åˆå§‹åŒ– categoryCounts**
```swift
var categoryCounts: [Category: Int] = [
    .all: 0,
    .starred: 0,
    .trash: 0
]
```

**ä¿®æ”¹ 2: æ·»åŠ  loadCounts Action**
```swift
enum Action: BindableAction {
    // ... å…¶ä»– actions
    case loadCounts  // æ–°å¢
    case updateCounts([State.Category: Int])
}
```

**ä¿®æ”¹ 3: å®ç° loadCounts Reducer**
```swift
case .loadCounts:
    return .run { send in
        let allNotes = try await noteRepository.fetchNotes(filter: .all)
        let counts: [State.Category: Int] = [
            .all: allNotes.filter { !$0.isDeleted }.count,
            .starred: allNotes.filter { $0.isStarred && !$0.isDeleted }.count,
            .trash: allNotes.filter { $0.isDeleted }.count
        ]
        await send(.updateCounts(counts))
    } catch: { error, send in
        print("âŒ åŠ è½½è®¡æ•°å¤±è´¥: \(error)")
    }
```

---

## ğŸ”„ æ•°æ®æ›´æ–°æµç¨‹

### åˆå§‹åŠ è½½

```
åº”ç”¨å¯åŠ¨
    â†“
SidebarView.onAppear
    â†“
store.send(.loadCounts)
    â†“
SidebarFeature.loadCounts
    â”œâ”€ ä»æ•°æ®åº“åŠ è½½æ‰€æœ‰ç¬”è®°
    â”œâ”€ è®¡ç®—æ¯ä¸ªåˆ†ç±»çš„æ•°é‡
    â””â”€ å‘é€ updateCounts
    â†“
æ›´æ–° categoryCounts
    â†“
UI æ˜¾ç¤ºè®¡æ•°ï¼ˆæ‰€æœ‰åˆ†ç±»éƒ½æ˜¾ç¤ºï¼‰
```

### ç¬”è®°åˆ—è¡¨å˜åŒ–æ—¶

```
ç¬”è®°åˆ—è¡¨åŠ è½½å®Œæˆ
    â†“
NoteListFeature.notesLoaded
    â†“
AppFeature æ¥æ”¶
    â”œâ”€ è®¡ç®—å„åˆ†ç±»æ•°é‡
    â””â”€ å‘é€ sidebar(.updateCounts)
    â†“
SidebarFeature.updateCounts
    â†“
æ›´æ–° categoryCounts
    â†“
UI è‡ªåŠ¨åˆ·æ–°æ˜¾ç¤ºæ–°æ•°é‡
```

---

## ğŸ¯ ä¿®å¤æ•ˆæœ

### Beforeï¼ˆä¿®å¤å‰ï¼‰
```
åˆ†ç±»
â”œâ”€â”€ ğŸ“ å…¨éƒ¨ç¬”è®°         â† æœ‰æ—¶ä¸æ˜¾ç¤º
â”œâ”€â”€ â­ æ˜Ÿæ ‡ç¬”è®°         â† æœ‰æ—¶ä¸æ˜¾ç¤º
â””â”€â”€ ğŸ—‘ï¸ å·²åˆ é™¤      3    â† æœ‰æ—¶ä¸æ˜¾ç¤º
```

### Afterï¼ˆä¿®å¤åï¼‰
```
åˆ†ç±»
â”œâ”€â”€ ğŸ“ å…¨éƒ¨ç¬”è®°    17   â† å§‹ç»ˆæ˜¾ç¤º
â”œâ”€â”€ â­ æ˜Ÿæ ‡ç¬”è®°     3   â† å§‹ç»ˆæ˜¾ç¤º
â””â”€â”€ ğŸ—‘ï¸ å·²åˆ é™¤      0   â† å§‹ç»ˆæ˜¾ç¤ºï¼ˆå³ä½¿ä¸º0ï¼‰
```

---

## ğŸ§ª æµ‹è¯•éªŒè¯

### æµ‹è¯•æ­¥éª¤

1. **å¯åŠ¨åº”ç”¨**
   ```bash
   cd Nota4 && make run
   ```

2. **æ£€æŸ¥åˆå§‹çŠ¶æ€**
   - æŸ¥çœ‹å·¦ä¾§è¾¹æ 
   - **éªŒè¯**: æ‰€æœ‰ä¸‰ä¸ªåˆ†ç±»éƒ½æ˜¾ç¤ºæ•°å­—
   - **éªŒè¯**: å³ä½¿æ•°é‡ä¸º 0 ä¹Ÿæ˜¾ç¤º "0"

3. **åˆ›å»ºç¬”è®°**
   - åˆ›å»ºä¸€ç¯‡æ–°ç¬”è®°
   - **éªŒè¯**: "å…¨éƒ¨ç¬”è®°"æ•°é‡ +1

4. **åˆ é™¤ç¬”è®°**
   - åˆ é™¤ä¸€ç¯‡ç¬”è®°
   - **éªŒè¯**: "å…¨éƒ¨ç¬”è®°"æ•°é‡ -1
   - **éªŒè¯**: "å·²åˆ é™¤"æ•°é‡ +1

5. **æ ‡è®°æ˜Ÿæ ‡**
   - å°†ç¬”è®°æ ‡è®°ä¸ºæ˜Ÿæ ‡
   - **éªŒè¯**: "æ˜Ÿæ ‡ç¬”è®°"æ•°é‡ +1

6. **å¯¼å…¥ç¬”è®°**
   - å¯¼å…¥ä¸€ä¸ª Markdown æ–‡ä»¶
   - **éªŒè¯**: "å…¨éƒ¨ç¬”è®°"æ•°é‡å¢åŠ 

7. **è¾¹ç•Œæƒ…å†µ**
   - åˆ é™¤æ‰€æœ‰ç¬”è®°åˆ°å›æ”¶ç«™
   - **éªŒè¯**: "å…¨éƒ¨ç¬”è®°"æ˜¾ç¤º "0"
   - **éªŒè¯**: "å·²åˆ é™¤"æ˜¾ç¤ºæ­£ç¡®æ•°é‡

### éªŒè¯ç‚¹

- [ ] åº”ç”¨å¯åŠ¨æ—¶ï¼Œæ‰€æœ‰åˆ†ç±»éƒ½æ˜¾ç¤ºè®¡æ•°
- [ ] æ•°é‡ä¸º 0 æ—¶ä¹Ÿæ˜¾ç¤º "0"
- [ ] åˆ›å»ºç¬”è®°åè®¡æ•°æ›´æ–°
- [ ] åˆ é™¤ç¬”è®°åè®¡æ•°æ›´æ–°
- [ ] æ˜Ÿæ ‡åˆ‡æ¢åè®¡æ•°æ›´æ–°
- [ ] å¯¼å…¥ç¬”è®°åè®¡æ•°æ›´æ–°
- [ ] æ‰€æœ‰è®¡æ•°å§‹ç»ˆå¯è§

---

## ğŸ“Š ä»£ç ç»Ÿè®¡

| æ–‡ä»¶ | å˜æ›´ç±»å‹ | è¡Œæ•°å˜åŒ– |
|------|---------|---------|
| `SidebarView.swift` | Badge æ˜¾ç¤º + onAppear | +2 è¡Œ |
| `SidebarFeature.swift` | åˆå§‹åŒ– + Action + Reducer | +20 è¡Œ |
| **æ€»è®¡** | | **+22 è¡Œ** |

---

## ğŸ” æŠ€æœ¯ç»†èŠ‚

### SwiftUI Badge è¡Œä¸º

SwiftUI çš„ `.badge()` ä¿®é¥°ç¬¦æœ‰ä»¥ä¸‹ç‰¹æ€§ï¼š

1. **badge(Int)**
   - å½“å€¼ä¸º 0 æ—¶ï¼Œbadge å¯èƒ½ä¸æ˜¾ç¤º
   - è¿™æ˜¯ SwiftUI çš„é»˜è®¤ä¼˜åŒ–è¡Œä¸º

2. **badge(Text)**
   - æ˜ç¡®æä¾› Text è§†å›¾
   - å§‹ç»ˆæ˜¾ç¤ºï¼Œå³ä½¿å†…å®¹ä¸º "0"
   - æ›´å¯æ§çš„æ˜¾ç¤ºè¡Œä¸º

### TCA æ•°æ®æµ

```swift
// æ–¹å¼ 1: é€šè¿‡ NoteList æ›´æ–°ï¼ˆç°æœ‰é€»è¾‘ï¼‰
NoteList â†’ AppFeature â†’ Sidebar
é€‚ç”¨äºï¼šç¬”è®°åˆ—è¡¨å·²åŠ è½½çš„æƒ…å†µ

// æ–¹å¼ 2: ä¾§è¾¹æ ä¸»åŠ¨åŠ è½½ï¼ˆæ–°å¢é€»è¾‘ï¼‰
Sidebar.onAppear â†’ loadCounts â†’ updateCounts
é€‚ç”¨äºï¼šåº”ç”¨åˆšå¯åŠ¨æˆ–éœ€è¦ä¸»åŠ¨åˆ·æ–°çš„æƒ…å†µ
```

### åŒé‡æ›´æ–°æœºåˆ¶

ä¸ºç¡®ä¿ä¾§è¾¹æ è®¡æ•°å§‹ç»ˆæ­£ç¡®ï¼Œç³»ç»Ÿé‡‡ç”¨åŒé‡æ›´æ–°æœºåˆ¶ï¼š

1. **è¢«åŠ¨æ›´æ–°**ï¼ˆç°æœ‰é€»è¾‘ï¼‰
   - å½“ç¬”è®°åˆ—è¡¨åŠ è½½å®Œæˆæ—¶
   - é€šè¿‡ AppFeature ä¸­è½¬æ›´æ–°
   - ä¼˜ç‚¹ï¼šé›†ä¸­ç®¡ç†ï¼Œæ•°æ®ä¸€è‡´

2. **ä¸»åŠ¨æ›´æ–°**ï¼ˆæ–°å¢é€»è¾‘ï¼‰
   - ä¾§è¾¹æ å‡ºç°æ—¶ä¸»åŠ¨åŠ è½½
   - ç›´æ¥ä»æ•°æ®åº“è·å–æœ€æ–°æ•°æ®
   - ä¼˜ç‚¹ï¼šç‹¬ç«‹æ€§å¼ºï¼Œå¯åŠ¨å¿«

---

## ğŸ¯ æ”¹è¿›æ•ˆæœ

### ç”¨æˆ·ä½“éªŒ

âœ… **å¯è§æ€§**: æ‰€æœ‰åˆ†ç±»å§‹ç»ˆæ˜¾ç¤ºæ•°é‡  
âœ… **ä¸€è‡´æ€§**: 0 å’Œé 0 æ•°é‡éƒ½æ¸…æ™°æ˜¾ç¤º  
âœ… **å®æ—¶æ€§**: æ“ä½œåç«‹å³æ›´æ–°  
âœ… **å¯é æ€§**: åŒé‡æ›´æ–°æœºåˆ¶ç¡®ä¿å‡†ç¡®  

### æŠ€æœ¯ä¼˜åŠ¿

âœ… **åˆå§‹åŒ–**: æœ‰æ˜ç¡®çš„åˆå§‹å€¼  
âœ… **æ˜¾ç¤º**: ä½¿ç”¨ Text ç¡®ä¿å§‹ç»ˆå¯è§  
âœ… **åŠ è½½**: ä¸»åŠ¨+è¢«åŠ¨åŒé‡æœºåˆ¶  
âœ… **æ€§èƒ½**: ä»…åœ¨éœ€è¦æ—¶åŠ è½½æ•°æ®  

---

## ğŸ”® åç»­ä¼˜åŒ–æ–¹å‘

### å¯èƒ½çš„å¢å¼º

1. **ç¼“å­˜æœºåˆ¶**
   - ç¼“å­˜è®¡æ•°ç»“æœï¼Œå‡å°‘æ•°æ®åº“æŸ¥è¯¢
   - ä»…åœ¨ç¬”è®°å˜åŒ–æ—¶é‡æ–°è®¡ç®—

2. **å¢é‡æ›´æ–°**
   - ä¸é‡æ–°åŠ è½½æ‰€æœ‰ç¬”è®°
   - æ ¹æ®æ“ä½œç±»å‹å¢å‡è®¡æ•°

3. **åŠ¨ç”»æ•ˆæœ**
   - æ•°å­—å˜åŒ–æ—¶æ·»åŠ åŠ¨ç”»
   - æå‡ç”¨æˆ·ä½“éªŒ

4. **æ‰©å±•ç»Ÿè®¡**
   - æ˜¾ç¤ºä»Šæ—¥æ–°å¢/ä¿®æ”¹æ•°é‡
   - æ˜¾ç¤ºæœ€è¿‘ 7 å¤©çš„è¶‹åŠ¿

---

## ğŸ“ ç›¸å…³æ–‡æ¡£

- [UI æ”¹è¿›æ–‡æ¡£](./UI_IMPROVEMENTS.md)
- [å¯¼å…¥åŠŸèƒ½ä¿®å¤](./IMPORT_FEATURE_FIX.md)
- [ä¸»é¢˜ç³»ç»Ÿæ–‡æ¡£](./THEME_SYSTEM_FIX.md)

---

## ğŸ‰ æ€»ç»“

æœ¬æ¬¡ä¿®å¤æˆåŠŸè§£å†³äº†ä¾§è¾¹æ åˆ†ç±»è®¡æ•°ä¸æ€»æ˜¯æ˜¾ç¤ºçš„é—®é¢˜ï¼š

âœ… **ä¿®æ”¹ Badge æ˜¾ç¤º** - ä½¿ç”¨ Text ç¡®ä¿å§‹ç»ˆæ˜¾ç¤º  
âœ… **åˆå§‹åŒ–è®¡æ•°** - æ‰€æœ‰åˆ†ç±»éƒ½æœ‰åˆå§‹å€¼ 0  
âœ… **ä¸»åŠ¨åŠ è½½** - ä¾§è¾¹æ å‡ºç°æ—¶åŠ è½½è®¡æ•°  
âœ… **åŒé‡æ›´æ–°** - è¢«åŠ¨+ä¸»åŠ¨ç¡®ä¿å‡†ç¡®æ€§  

**ç°åœ¨æ‰€æœ‰åˆ†ç±»åœ¨ä»»ä½•æƒ…å†µä¸‹éƒ½ä¼šæ˜¾ç¤ºç¬”è®°æ•°é‡ï¼** ğŸš€

